<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RegistrationDBServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compliance-portal</a> &gt; <a href="index.source.html" class="el_package">com.currenciesdirect.gtg.compliance.dbport</a> &gt; <span class="el_source">RegistrationDBServiceImpl.java</span></div><h1>RegistrationDBServiceImpl.java</h1><pre class="source lang-java linenums">package com.currenciesdirect.gtg.compliance.dbport;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.UUID;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Component;

import com.currenciesdirect.gtg.compliance.commons.domain.IDomain;
import com.currenciesdirect.gtg.compliance.commons.domain.activity.ActivityType;
import com.currenciesdirect.gtg.compliance.commons.domain.profile.request.Contact;
import com.currenciesdirect.gtg.compliance.core.IRegistrationDBService;
import com.currenciesdirect.gtg.compliance.core.ITransform;
import com.currenciesdirect.gtg.compliance.core.domain.ActivityLogDataWrapper;
import com.currenciesdirect.gtg.compliance.core.domain.ActivityLogRequest;
import com.currenciesdirect.gtg.compliance.core.domain.ActivityLogs;
import com.currenciesdirect.gtg.compliance.core.domain.BroadcastEventToDB;
import com.currenciesdirect.gtg.compliance.core.domain.ComplianceAccount;
import com.currenciesdirect.gtg.compliance.core.domain.ComplianceContact;
import com.currenciesdirect.gtg.compliance.core.domain.ComplianceStatus;
import com.currenciesdirect.gtg.compliance.core.domain.Constants;
import com.currenciesdirect.gtg.compliance.core.domain.ContactWrapper;
import com.currenciesdirect.gtg.compliance.core.domain.EventDBDto;
import com.currenciesdirect.gtg.compliance.core.domain.IRegistrationDetails;
import com.currenciesdirect.gtg.compliance.core.domain.OnfidoStatusEnum;
import com.currenciesdirect.gtg.compliance.core.domain.Page;
import com.currenciesdirect.gtg.compliance.core.domain.RegistrationAccount;
import com.currenciesdirect.gtg.compliance.core.domain.RegistrationResponse;
import com.currenciesdirect.gtg.compliance.core.domain.RegistrationViewMoreRequest;
import com.currenciesdirect.gtg.compliance.core.domain.Sort;
import com.currenciesdirect.gtg.compliance.core.domain.SourceEnum;
import com.currenciesdirect.gtg.compliance.core.domain.StatusReason;
import com.currenciesdirect.gtg.compliance.core.domain.StatusReasonData;
import com.currenciesdirect.gtg.compliance.core.domain.TransactionValuesEnum;
import com.currenciesdirect.gtg.compliance.core.domain.ViewMoreResponse;
import com.currenciesdirect.gtg.compliance.core.domain.registration.ProfileActivityLogDto;
import com.currenciesdirect.gtg.compliance.core.domain.registration.RegUpdateDBDto;
import com.currenciesdirect.gtg.compliance.core.domain.registration.RegistrationDetailsDBDto;
import com.currenciesdirect.gtg.compliance.core.domain.registration.RegistrationDetailsDto;
import com.currenciesdirect.gtg.compliance.core.domain.registration.RegistrationQueueData;
import com.currenciesdirect.gtg.compliance.core.domain.registration.RegistrationQueueDto;
import com.currenciesdirect.gtg.compliance.core.domain.registration.RegistrationSearchCriteria;
import com.currenciesdirect.gtg.compliance.core.domain.savedsearch.SavedSearch;
import com.currenciesdirect.gtg.compliance.dbport.enums.BroadCastEntityTypeEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.BroadCastStatusEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.CustomerTypeEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.EntityTypeEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.ProfileComplianceStatus;
import com.currenciesdirect.gtg.compliance.dbport.enums.ServiceStatusEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.WatchListCategoryEnum;
import com.currenciesdirect.gtg.compliance.dbport.report.RegistrationReportQueryConstant;
import com.currenciesdirect.gtg.compliance.exception.CompliancePortalErrors;
import com.currenciesdirect.gtg.compliance.exception.CompliancePortalException;
import com.currenciesdirect.gtg.compliance.iam.core.domain.UserProfile;
import com.currenciesdirect.gtg.compliance.util.DateTimeFormatter;
import com.currenciesdirect.gtg.compliance.util.JsonConverterUtil;
import com.currenciesdirect.gtg.compliance.util.SearchCriteriaUtil;
import com.currenciesdirect.gtg.compliance.util.StringUtils;

/**
 * The Class RegistrationDBServiceImpl.
 */
@Component(&quot;regDBServiceImpl&quot;)
<span class="fc" id="L72">public class RegistrationDBServiceImpl extends AbstractDBServiceRegistration implements IRegistrationDBService {</span>

	private static final String REASON = &quot;Reason&quot;;
	private static final String WATCHLIST_CATEGORY_FILTER = &quot;{WATCHLIST_CATEGORY_FILTER}&quot;;

	@Autowired
	@Qualifier(&quot;registrationDetailsTransformer&quot;)
	private ITransform&lt;RegistrationDetailsDto, RegistrationDetailsDBDto&gt; registrationDetailsTransformer;

	@Autowired
	@Qualifier(&quot;regActivityLogTransformer&quot;)
	private ITransform&lt;ActivityLogs, RegUpdateDBDto&gt; regActivityLogTransformer;


	
	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.currenciesdirect.gtg.compliance.core.IRegistrationQueueDBService#
	 * getRegistrationQueue(com.currenciesdirect.gtg.compliance.core.domain.
	 * SearchCriteria)
	 */
	@Override
	public RegistrationQueueDto getRegistrationQueueWithCriteria(RegistrationSearchCriteria searchCriteria)
			throws CompliancePortalException {
<span class="fc" id="L98">		int offSet = SearchCriteriaUtil.getPageOffsetRows(searchCriteria);</span>
<span class="fc" id="L99">		int rowsToFetch = SearchCriteriaUtil.getPageSize();</span>
<span class="fc" id="L100">		int minRowNum = SearchCriteriaUtil.getMinRowNumber(searchCriteria);</span>
<span class="fc" id="L101">		String regQueue = &quot;RegistrationQueue&quot;;</span>
<span class="fc" id="L102">		RegQueueContactFilterQueryBuilder contactFilter = new RegQueueContactFilterQueryBuilder(searchCriteria.getFilter(),</span>
<span class="fc" id="L103">				RegistrationQueryConstant.REGISTRATION_QUEUE_CONTACT_FILTER.getQuery(),</span>
				 true);
<span class="fc" id="L105">		String watchListCategoryFilter = getWatchListCategoryFilter(searchCriteria);</span>
<span class="fc" id="L106">		String contactFilterQuery = contactFilter.getQuery();</span>
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">		if (null != watchListCategoryFilter) {</span>
<span class="nc" id="L108">			contactFilterQuery = contactFilterQuery.replace(WATCHLIST_CATEGORY_FILTER, watchListCategoryFilter);</span>
		} else {
<span class="fc" id="L110">			contactFilterQuery = contactFilterQuery.replace(WATCHLIST_CATEGORY_FILTER, &quot;&quot;);</span>
		}
<span class="fc" id="L112">		 contactFilterQuery = buildContactFilterQuery(searchCriteria, contactFilter);</span>
			
<span class="fc" id="L114">		String accountFilterQuery = buildAccountFilterQuery(searchCriteria);</span>

<span class="fc" id="L116">		String regFilterQuery = buildAccountAndContactAttributeFilterQuery(searchCriteria, contactFilter,</span>
				contactFilterQuery,watchListCategoryFilter, accountFilterQuery);
		
		//ADD for AT-3269
<span class="fc" id="L120">		String legalEntityJoin = &quot;&quot;;</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">		if (null != searchCriteria.getFilter().getLegalEntity()</span>
<span class="nc bnc" id="L122" title="All 2 branches missed.">				&amp;&amp; searchCriteria.getFilter().getLegalEntity().length &gt; 0) {</span>
<span class="nc" id="L123">			String[] legalEntity = searchCriteria.getFilter().getLegalEntity();</span>
<span class="nc" id="L124">			String value = appendAllValues(legalEntity);</span>
<span class="nc" id="L125">			legalEntityJoin = &quot;JOIN LegalEntity le ON acc.LegalEntityID = le.ID AND le.code In (&quot;+ value + &quot;)&quot;;</span>
		}
		
<span class="fc" id="L128">		String listQuery = RegistrationQueryConstant.GET_REGISTRATION_QUEUE.getQuery()</span>
<span class="fc" id="L129">				.replace(&quot;{REGISTRATION_QUEUE_CONTACT_FILTER}&quot;, contactFilterQuery)</span>
<span class="fc" id="L130">				.replace(&quot;{REGISTRATION_QUEUE_ACCOUNT_FILTER}&quot;, accountFilterQuery)</span>
<span class="fc" id="L131">				.replace(&quot;{REGISTRATION_QUEUE_FILTER}&quot;, regFilterQuery)</span>
<span class="fc" id="L132">				.replace(&quot;{JOIN_LEGAL_ENTITY}&quot;, legalEntityJoin);</span>
		
<span class="fc" id="L134">		listQuery = executeSort(searchCriteria.getFilter().getSort(),listQuery);</span>
		
<span class="fc" id="L136">		String countQuery = RegistrationQueryConstant.GET_REGISTRATION_QUEUE_COUNT.getQuery()</span>
<span class="fc" id="L137">				.replace(&quot;{REGISTRATION_QUEUE_CONTACT_FILTER}&quot;, contactFilterQuery)</span>
<span class="fc" id="L138">				.replace(&quot;{REGISTRATION_QUEUE_ACCOUNT_FILTER}&quot;, accountFilterQuery)</span>
<span class="fc" id="L139">				.replace(&quot;{REGISTRATION_QUEUE_FILTER}&quot;, regFilterQuery)</span>
<span class="fc" id="L140">				.replace(&quot;{JOIN_LEGAL_ENTITY}&quot;, legalEntityJoin);</span>
		
<span class="fc" id="L142">		RegistrationQueueDto registrationQueueDto = new RegistrationQueueDto();</span>
<span class="fc" id="L143">		Connection connection = null;</span>
		try {
<span class="fc" id="L145">			connection = getConnection(Boolean.TRUE);</span>
<span class="fc" id="L146">			registrationQueueDto= getRegisrationQueueData(connection, offSet, rowsToFetch, listQuery, countQuery);</span>
<span class="fc" id="L147">			Integer pageSize = SearchCriteriaUtil.getPageSize();</span>
<span class="fc" id="L148">			Integer totalRecords = registrationQueueDto.getTotalRecords();</span>
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">			if (totalRecords != null) {</span>
<span class="fc" id="L150">				Integer totalPages = totalRecords / pageSize;</span>
<span class="pc bpc" id="L151" title="1 of 2 branches missed.">				if (totalRecords % pageSize != 0) {</span>
<span class="nc" id="L152">					totalPages += 1;</span>
				}
<span class="fc" id="L154">				Page page = new Page();</span>
<span class="pc bpc" id="L155" title="1 of 2 branches missed.">				if (totalRecords == 0) {</span>
<span class="fc" id="L156">					page.setMinRecord(0);</span>
				} else {
<span class="nc" id="L158">					page.setMinRecord(minRowNum);</span>
				}
<span class="fc" id="L160">				int tMaxRecord=minRowNum + registrationQueueDto.getRegistrationQueue().size() - 1;</span>
<span class="pc bpc" id="L161" title="1 of 2 branches missed.">				if(tMaxRecord&lt;totalRecords)</span>
<span class="nc" id="L162">					page.setMaxRecord(tMaxRecord);</span>
				else
<span class="fc" id="L164">					page.setMaxRecord(totalRecords);</span>
<span class="fc" id="L165">				page.setPageSize(pageSize);</span>
<span class="fc" id="L166">				page.setTotalPages(totalPages);</span>
<span class="fc" id="L167">				page.setTotalRecords(totalRecords);</span>
<span class="fc" id="L168">				page.setCurrentPage(SearchCriteriaUtil.getCurrentPage(searchCriteria));</span>
<span class="fc" id="L169">				registrationQueueDto.setPage(page);</span>
<span class="fc" id="L170">				List&lt;String&gt; organization = null;</span>
<span class="fc" id="L171">				organization = getOrganization(connection);</span>
<span class="fc" id="L172">				registrationQueueDto.setOrganization(organization);</span>
<span class="fc" id="L173">				registrationQueueDto.setSource(SourceEnum.getSourceValues());</span>
<span class="fc" id="L174">				registrationQueueDto.setTransValue(TransactionValuesEnum.getTransactionValues());</span>
<span class="fc" id="L175">				List&lt;String&gt; owner = null;</span>
<span class="fc" id="L176">				owner= getLockedUserName(connection);</span>
<span class="fc" id="L177">				registrationQueueDto.setOwner(owner);	</span>
<span class="fc" id="L178">				searchCriteria.setPage(registrationQueueDto.getPage());</span>
<span class="fc" id="L179">				registrationQueueDto.setSearchCriteria(JsonConverterUtil.convertToJsonWithNull(searchCriteria));</span>
				
<span class="fc" id="L181">				registrationQueueDto.setOnfidoStatus(OnfidoStatusEnum.getOnfidoStatusValues());</span>
				
<span class="fc" id="L183">				List&lt;String&gt; currency = null;</span>
<span class="fc" id="L184">				currency = getCurrency(connection);</span>
<span class="fc" id="L185">				registrationQueueDto.setCurrency(currency);</span>
<span class="fc" id="L186">				SavedSearch savedSearch = null;</span>
<span class="fc" id="L187">				savedSearch = getSaveSearches(searchCriteria.getFilter().getUserProfile().getId(),regQueue,connection);</span>
<span class="fc" id="L188">				registrationQueueDto.setSavedSearch(savedSearch);</span>
<span class="fc" id="L189">				List&lt;String&gt; legalEntity = null;</span>
<span class="fc" id="L190">				legalEntity = getLegalEntity(connection);</span>
<span class="fc" id="L191">				registrationQueueDto.setLegalEntity(legalEntity);</span>
			}
			
<span class="nc" id="L194">		} catch (Exception e) {</span>
<span class="nc" id="L195">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L197">			closeConnection(connection);</span>
		}
<span class="fc" id="L199">		return registrationQueueDto;</span>
	}


	private String buildAccountAndContactAttributeFilterQuery(RegistrationSearchCriteria searchCriteria,
			RegQueueContactFilterQueryBuilder contactFilter, String contactFilterQuery,String watchListCategoryFilter, String accountFilterQuery) {
<span class="fc" id="L205">		String contactJoin = &quot;&quot;;</span>
<span class="pc bpc" id="L206" title="2 of 4 branches missed.">		if (contactFilterQuery.contains(Constants.WHERE) || null != watchListCategoryFilter){</span>
<span class="nc" id="L207">			contactJoin = RegistrationQueryConstant.CONTACT_FILTER_JOIN.getQuery();</span>
		}
			
<span class="fc" id="L210">		String accountJoin = &quot;&quot;;</span>
<span class="pc bpc" id="L211" title="1 of 2 branches missed.">		if(accountFilterQuery.contains(Constants.WHERE)){</span>
<span class="nc" id="L212">			accountJoin = RegistrationQueryConstant.ACCOUNT_FILTER_JOIN.getQuery();</span>
		}
		
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">		if(contactFilter.isFilterAppliedForAccountAndContact()){</span>
<span class="nc" id="L216">			contactJoin = RegistrationQueryConstant.CONTACT_FILTER_LEFT_JOIN.getQuery();</span>
<span class="nc" id="L217">			accountJoin = RegistrationQueryConstant.ACCOUNT_FILTER_LEFT_JOIN.getQuery();</span>
		}
<span class="fc" id="L219">		String orgJoin = &quot;&quot;;</span>
<span class="pc bpc" id="L220" title="1 of 2 branches missed.">		if(null != searchCriteria.getFilter().getOrganization() &amp;&amp; </span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">				searchCriteria.getFilter().getOrganization().length&gt;0){</span>
<span class="nc" id="L222">			orgJoin = RegistrationQueryConstant.ORG_TABLE_JOIN.getQuery();</span>
		}
		
<span class="fc" id="L225">		String legalEntityJoin = &quot;&quot;;</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">		if (null != searchCriteria.getFilter().getLegalEntity()</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">				&amp;&amp; searchCriteria.getFilter().getLegalEntity().length &gt; 0) {</span>
<span class="nc" id="L228">			legalEntityJoin = RegistrationQueryConstant.LEGEL_ENTITY_TABLE_JOIN.getQuery();</span>
		}

<span class="fc" id="L231">		String deviceJoin = &quot;&quot;;</span>
<span class="pc bpc" id="L232" title="1 of 2 branches missed.">		if(null!=searchCriteria.getFilter().getDeviceId()) {</span>
<span class="nc" id="L233">			deviceJoin =  RegistrationQueryConstant.DEVICE_ID_JOIN.getQuery();</span>
		}
		
<span class="fc" id="L236">		String onfidoJoin = &quot;&quot;;</span>
<span class="pc bpc" id="L237" title="3 of 4 branches missed.">		if(null!=searchCriteria.getFilter().getOnfidoStatus() &amp;&amp; null == searchCriteria.getFilter().getOrganization()) {</span>
<span class="nc" id="L238">			onfidoJoin =  RegistrationReportQueryConstant.ONFIDO_JOIN.getQuery();  </span>
		}
		
<span class="fc" id="L241">		FilterQueryBuilder regFilter = new RegQueueFilterQueryBuilder(searchCriteria.getFilter(),</span>
<span class="fc" id="L242">				RegistrationQueryConstant.REGISTRATION_QUEUE_FILTER.getQuery(),</span>
<span class="fc" id="L243">				searchCriteria.getIsFilterApply(), true);</span>
<span class="fc" id="L244">		String regFilterQuery = regFilter.getQuery();</span>
<span class="fc" id="L245">		String userJoin = &quot;&quot;;</span>
<span class="pc bpc" id="L246" title="1 of 2 branches missed.">		if(regFilterQuery.contains(RegQueDBColumns.REGOWNER.getName()))</span>
		{
<span class="nc" id="L248">			userJoin = RegistrationQueryConstant.USER_FILTER_JOIN.getQuery();</span>
		}
		
<span class="pc bpc" id="L251" title="3 of 4 branches missed.">		if(contactJoin.length()&gt;1 &amp;&amp; accountJoin.length()&gt;1){</span>
<span class="nc" id="L252">			regFilterQuery = addFilterToQuery(regFilterQuery);</span>
				
		}else{
<span class="fc" id="L255">			contactJoin = contactJoin.replace(&quot;LEFT&quot;, &quot;&quot;);</span>
<span class="fc" id="L256">			accountJoin = accountJoin.replace(&quot;LEFT&quot;, &quot;&quot;);</span>
		}
		
<span class="fc" id="L259">		regFilterQuery = regFilterQuery.replace(&quot;{CONTACT_FILTER_JOIN}&quot;, contactJoin)</span>
<span class="fc" id="L260">				.replace(&quot;{ACCOUNT_FILTER_JOIN}&quot;, accountJoin)</span>
<span class="fc" id="L261">				.replace(&quot;{ORG_TABLE_JOIN}&quot;, orgJoin)</span>
<span class="fc" id="L262">				.replace(&quot;{USER_FILTER_JOIN}&quot;, userJoin)</span>
<span class="fc" id="L263">				.replace(&quot;{LEGAL_ENTITY_JOIN}&quot;, legalEntityJoin)</span>
<span class="fc" id="L264">				.replace(&quot;{DEVICE_ID_JOIN}&quot;, deviceJoin)</span>
<span class="fc" id="L265">				.replace(&quot;{ONFIDO_JOIN}&quot;, onfidoJoin);</span>

<span class="fc" id="L267">		return regFilterQuery;</span>
	}

	private String addFilterToQuery(String regFilter) {
		String regFilterQuery;
		
<span class="nc bnc" id="L273" title="All 2 branches missed.">		if(regFilter.contains(Constants.WHERE)){</span>
<span class="nc" id="L274">			regFilterQuery = regFilter+&quot; AND &quot;+ RegistrationQueryConstant.REPORT_FILTER_NULL_CHECK.getQuery();</span>
		}else{
<span class="nc" id="L276">			regFilterQuery = regFilter+&quot; WHERE &quot;+ RegistrationQueryConstant.REPORT_FILTER_NULL_CHECK.getQuery();</span>
		}
<span class="nc" id="L278">		return regFilterQuery;</span>
	}


	private String buildAccountFilterQuery(RegistrationSearchCriteria searchCriteria) {
<span class="fc" id="L283">		FilterQueryBuilder accountFilter = new RegQueueAccountFilterQueryBuilder(searchCriteria.getFilter(),</span>
<span class="fc" id="L284">				RegistrationQueryConstant.REGISTRATION_QUEUE_ACCOUNT_FILTER.getQuery(),</span>
				 true);
<span class="fc" id="L286">		return accountFilter.getQuery();</span>
	}

	
	private String buildContactFilterQuery(RegistrationSearchCriteria searchCriteria,
			RegQueueContactFilterQueryBuilder contactFilter) {
<span class="fc" id="L292">		String countryJoin = &quot;&quot;;</span>
<span class="fc" id="L293">		String contactFilterQuery = contactFilter.getQuery();</span>
<span class="fc" id="L294">		String watchListCategoryFilter = getWatchListCategoryFilter(searchCriteria);</span>
<span class="pc bpc" id="L295" title="1 of 2 branches missed.">		if(null!= watchListCategoryFilter ){</span>
<span class="nc" id="L296">			contactFilterQuery = contactFilterQuery.replace(WATCHLIST_CATEGORY_FILTER, watchListCategoryFilter)  ;</span>
		}else{
<span class="fc" id="L298">			contactFilterQuery = contactFilterQuery.replace(WATCHLIST_CATEGORY_FILTER, &quot;&quot;)  ;</span>
		}
		
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">	    if(contactFilter.isCountryOfResidenceFilterApplied()){</span>
<span class="nc" id="L302">			countryJoin = RegistrationQueryConstant.REGISTRATION_QUEUE_COUNTRY_OF_RESIDENCE_FILTER.getQuery();</span>
		}
		
<span class="fc" id="L305">		contactFilterQuery = contactFilterQuery.replace(&quot;{REGISTRATION_QUEUE_COUNTRY_OF_RESIDENCE_FILTER}&quot;, countryJoin);</span>
<span class="fc" id="L306">		return contactFilterQuery;</span>
	}

	
	private String getWatchListCategoryFilter(RegistrationSearchCriteria regSearchCriteria) {
<span class="fc" id="L311">		String watchCategosyStatus = null;</span>
<span class="fc" id="L312">		boolean hasAllPermission = false;</span>
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">		if (regSearchCriteria.getFilter().getUserProfile().getPermissions().getCanManageWatchListCategory1()) {</span>
<span class="fc" id="L314">			watchCategosyStatus = WatchListCategoryEnum.CATEGORY_1.getCategoryDbStatus().toString();</span>
		}
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">		if (regSearchCriteria.getFilter().getUserProfile().getPermissions().getCanManageWatchListCategory2()) {</span>
<span class="pc bpc" id="L317" title="1 of 2 branches missed.">			if (null != watchCategosyStatus)</span>
<span class="fc" id="L318">				hasAllPermission = true;</span>
			else
<span class="nc" id="L320">				watchCategosyStatus = WatchListCategoryEnum.CATEGORY_2.getCategoryDbStatus().toString();</span>

		}
<span class="pc bpc" id="L323" title="1 of 2 branches missed.">		if (hasAllPermission)</span>
<span class="fc" id="L324">			watchCategosyStatus = null;</span>
		else {
<span class="nc bnc" id="L326" title="All 2 branches missed.">			if (null != watchCategosyStatus)</span>
<span class="nc" id="L327">				watchCategosyStatus = RegistrationQueryConstant.WATCHLIST_CATEGORY_FILTER.getQuery().replace(&quot;?&quot;, watchCategosyStatus);</span>
		}

<span class="fc" id="L330">		return watchCategosyStatus;</span>
	}

	private String executeSort(Sort sort, String listQuery) {
<span class="fc" id="L334">		String columnName = &quot;a.updatedon&quot;;</span>
<span class="fc" id="L335">		boolean isAsc = false;</span>
<span class="pc bpc" id="L336" title="3 of 4 branches missed.">		if(sort != null &amp;&amp; sort.getIsAscend() != null){</span>
<span class="nc" id="L337">			isAsc = sort.getIsAscend();</span>
		}		
<span class="fc" id="L339">		return addSort(columnName, isAsc,listQuery);</span>
	}

	private void setNewOrUpdatedData(RegistrationQueueData registrationQueueData)
	{
<span class="fc" id="L344">		registrationQueueData.setNewOrUpdated(Constants.N);</span>
<span class="pc bpc" id="L345" title="2 of 4 branches missed.">		if(registrationQueueData.getAccountVersion() != null &amp;&amp; registrationQueueData.getAccountVersion() &gt; 1)</span>
		{
<span class="nc" id="L347">			registrationQueueData.setNewOrUpdated(Constants.U);</span>
		} 
<span class="fc" id="L349">	}</span>

	private void setRegisteredDate(Timestamp registeredDate,RegistrationQueueData registrationQueueData)
	{
<span class="fc" id="L353">		registrationQueueData.setRegisteredDate(Constants.DASH_UI);</span>
<span class="pc bpc" id="L354" title="1 of 2 branches missed.">		if (registeredDate != null) {</span>
<span class="fc" id="L355">			registrationQueueData.setRegisteredDate(DateTimeFormatter.dateTimeFormatter(registeredDate));</span>
		}		
<span class="fc" id="L357">	}</span>
	
	private void setLockedData(String lockedBy,ResultSet listRs,RegistrationQueueData registrationQueueData) throws SQLException {
<span class="pc bpc" id="L360" title="5 of 6 branches missed.">		if (lockedBy != null &amp;&amp; !lockedBy.isEmpty() &amp;&amp; !lockedBy.equalsIgnoreCase(Constants.DUMMY_USER)) {</span>
<span class="nc" id="L361">			registrationQueueData</span>
<span class="nc" id="L362">					.setUserResourceLockId(listRs.getInt(RegQueDBColumns.USER_RESOURCE_LOCK_ID.getName()));</span>
<span class="nc" id="L363">			registrationQueueData.setLocked(Boolean.TRUE);</span>
<span class="nc" id="L364">			registrationQueueData.setLockedBy(lockedBy);</span>
		}
<span class="fc" id="L366">	}</span>
	/**
	 * Gets the regisration queue dta.
	 *
	 * @param connection
	 *            the connection
	 * @param minRowNum
	 *            the min row num
	 * @param maxRowNum
	 *            the max row num
	 * @return the regisration queue datagetRegisrationQueueDta
	 * @throws CompliancePortalException
	 *             the compliance portal exception
	 */
	private RegistrationQueueDto getRegisrationQueueData(Connection connection, int offSet, int rowsToFetch,
			String query, String countQuery) throws CompliancePortalException {
<span class="fc" id="L382">		RegistrationQueueDto queueDto = new RegistrationQueueDto();</span>
<span class="fc" id="L383">		List&lt;RegistrationQueueData&gt; registrationQueueDataList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L384">		PreparedStatement listStatement = null;</span>
<span class="fc" id="L385">		PreparedStatement countStatement = null;</span>
<span class="fc" id="L386">		ResultSet listRs = null;</span>
<span class="fc" id="L387">		ResultSet countRs = null;</span>
<span class="fc" id="L388">		Integer totalRecords = 0;</span>
		try {	
<span class="fc" id="L390">			listStatement = connection.prepareStatement(query);</span>
<span class="fc" id="L391">			listStatement.setInt(1, offSet);</span>
<span class="fc" id="L392">			listStatement.setInt(2, rowsToFetch);</span>
<span class="fc" id="L393">			listRs = listStatement.executeQuery();</span>
<span class="fc bfc" id="L394" title="All 2 branches covered.">			while (listRs.next()) {</span>
<span class="fc" id="L395">				RegistrationQueueData registrationQueueData = new RegistrationQueueData();</span>
<span class="fc" id="L396">				registrationQueueData.setContactId(listRs.getInt(RegQueDBColumns.CONTACTID.getName()));</span>
<span class="fc" id="L397">				registrationQueueData.setAccountId(listRs.getInt(RegQueDBColumns.ACCOUNTID.getName()));</span>
<span class="fc" id="L398">				registrationQueueData.setContactName(listRs.getString(RegQueDBColumns.CONTACTNAME.getName()));</span>
<span class="fc" id="L399">				registrationQueueData.setTradeAccountNum(listRs.getString(RegQueDBColumns.TRADEACCOUNTNUM.getName()));</span>
<span class="fc" id="L400">				Timestamp registeredOn = listRs.getTimestamp(RegQueDBColumns.REGISTEREDON.getName());</span>
<span class="pc bpc" id="L401" title="1 of 2 branches missed.">				if (registeredOn != null) {</span>
<span class="fc" id="L402">					registrationQueueData.setRegisteredOn(DateTimeFormatter.dateTimeFormatter(registeredOn));</span>
				}

<span class="fc" id="L405">				registrationQueueData.setOrganisation( listRs.getString(RegQueDBColumns.ORGANIZATION.getName()));</span>
<span class="fc" id="L406">				registrationQueueData.setLegalEntity(listRs.getString(RegQueDBColumns.LEGALENTITY.getName()));</span>
<span class="fc" id="L407">				registrationQueueData.setEidCheck(ServiceStatusEnum.getStatusFromDatabaseStatus(listRs.getInt(RegQueDBColumns.KYCSTATUS.getName())));</span>
<span class="fc" id="L408">				registrationQueueData.setFraugster(ServiceStatusEnum.getStatusFromDatabaseStatus(listRs.getInt(RegQueDBColumns.FRAUGSTERSTATUS.getName())));</span>
<span class="fc" id="L409">				registrationQueueData.setSanction(ServiceStatusEnum.getStatusFromDatabaseStatus(listRs.getInt(RegQueDBColumns.SANCTIONSTATUS.getName())));</span>
<span class="fc" id="L410">				registrationQueueData.setBlacklist(ServiceStatusEnum.getStatusFromDatabaseStatus(listRs.getInt(RegQueDBColumns.BLACKLISTSTATUS.getName())));</span>
<span class="fc" id="L411">				registrationQueueData.setBuyCurrency(listRs.getString(RegQueDBColumns.BUYCURRENCY.getName()));</span>
<span class="fc" id="L412">				registrationQueueData.setSellCurrency(listRs.getString(RegQueDBColumns.SELLCURRENCY.getName()));</span>
<span class="fc" id="L413">				registrationQueueData.setTransactionValue(StringUtils.getNumberFormat(listRs.getString(RegQueDBColumns.TRANSACTIONVALUE.getName())));</span>
<span class="fc" id="L414">				registrationQueueData.setSource(listRs.getString(RegQueDBColumns.SOURCE.getName()));</span>
<span class="fc" id="L415">				registrationQueueData.setType(CustomerTypeEnum.getUiStatusFromDatabaseStatus(listRs.getInt(RegQueDBColumns.TYPE.getName())));</span>
<span class="fc" id="L416">				registrationQueueData.setCountryOfResidence(listRs.getString(RegQueDBColumns.COUNTRY_OF_RESIDENCE.getName()));</span>
<span class="fc" id="L417">				registrationQueueData.setAccountVersion(listRs.getInt(RegQueDBColumns.ACCOUNT_VERSION.getName()));</span>
<span class="fc" id="L418">				registrationQueueData.setCustomCheck(ServiceStatusEnum.getStatusFromDatabaseStatus(listRs.getInt(RegQueDBColumns.CUSOMCHECKSTATUS.getName())));</span>
<span class="fc" id="L419">				setNewOrUpdatedData(registrationQueueData);</span>
<span class="fc" id="L420">				Timestamp registeredDate = listRs.getTimestamp(RegQueDBColumns.REGISTERED_DATE.getName());</span>
<span class="fc" id="L421">				setRegisteredDate(registeredDate, registrationQueueData);</span>
				
<span class="fc" id="L423">				String lockedBy = listRs.getString(RegQueDBColumns.LOCKED_BY.getName());</span>
<span class="fc" id="L424">				setLockedData(lockedBy, listRs, registrationQueueData);</span>
<span class="fc" id="L425">				String userResourceCreatedOn = listRs.getString(RegQueDBColumns.USER_RESOURCE_CREATEDON.getName());</span>
<span class="pc bpc" id="L426" title="3 of 4 branches missed.">				if (userResourceCreatedOn != null &amp;&amp; !userResourceCreatedOn.isEmpty()) {</span>
<span class="nc" id="L427">					registrationQueueData.setUserResourceCreatedOn(listRs.getString(RegQueDBColumns.USER_RESOURCE_CREATEDON.getName()));</span>
				}
<span class="fc" id="L429">				String userResourceWorkflowTime = listRs.getString(RegQueDBColumns.USER_RESOURCE_WORKFLOWTIME.getName());</span>
<span class="pc bpc" id="L430" title="3 of 4 branches missed.">				if (userResourceWorkflowTime != null &amp;&amp; !userResourceWorkflowTime.isEmpty()) {</span>
<span class="nc" id="L431">					registrationQueueData.setUserResourceWorkflowTime(listRs.getString(RegQueDBColumns.USER_RESOURCE_WORKFLOWTIME.getName()));</span>
				}
<span class="fc" id="L433">				String userResourceEntityType = listRs.getString(RegQueDBColumns.USER_RESOURCE_ENTITYTYPE.getName());</span>
<span class="pc bpc" id="L434" title="3 of 4 branches missed.">				if (userResourceEntityType != null &amp;&amp; !userResourceEntityType.isEmpty()) {</span>
<span class="nc" id="L435">					registrationQueueData.setUserResourceEntityType(listRs.getString(RegQueDBColumns.USER_RESOURCE_ENTITYTYPE.getName()));</span>
				}
<span class="fc" id="L437">				registrationQueueDataList.add(registrationQueueData);</span>

<span class="fc" id="L439">			}</span>
<span class="fc" id="L440">			countStatement = connection.prepareStatement(countQuery);</span>
<span class="fc" id="L441">			countRs = countStatement.executeQuery();</span>
<span class="pc bpc" id="L442" title="1 of 2 branches missed.">			if(countRs.next())</span>
<span class="nc" id="L443">				totalRecords= countRs.getInt(RegQueDBColumns.TOTALROWS.getName());	</span>
<span class="fc" id="L444">		queueDto.setRegistrationQueue(registrationQueueDataList);</span>
<span class="fc" id="L445">		queueDto.setTotalRecords(totalRecords);</span>
<span class="nc" id="L446">		} catch (Exception e) {</span>
<span class="nc" id="L447">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L449">			closeResultset(listRs);</span>
<span class="fc" id="L450">			closePrepareStatement(listStatement);</span>
<span class="fc" id="L451">			closeResultset(countRs);</span>
<span class="fc" id="L452">			closePrepareStatement(countStatement);</span>
		}
<span class="fc" id="L454">		return queueDto;</span>
	}

	/*
	 * (non-Javadoc)
	 * 
	 * @see
	 * com.currenciesdirect.gtg.compliance.core.IRegistrationQueueDBService#
	 * getRegistrationDetails(java.lang.Integer)
	 */
	@Override
	public IRegistrationDetails getRegistrationDetails(Integer contactId, 
			RegistrationSearchCriteria registrationSearchCriteria) throws CompliancePortalException {
<span class="nc" id="L467">		RegistrationDetailsDBDto detailsDBDto = new RegistrationDetailsDBDto();</span>
<span class="nc" id="L468">		Connection connection = null;</span>
<span class="nc" id="L469">		PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L470">		ResultSet rs = null;</span>
<span class="nc" id="L471">		Integer accountid=null;</span>
		
		try {
<span class="nc" id="L474">			connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L475">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.GET_CONTACT_DETAILS_WITH_EVENT.getQuery());</span>
<span class="nc" id="L476">			preparedStatement.setInt(1, contactId);</span>
<span class="nc" id="L477">			rs = preparedStatement.executeQuery();</span>
<span class="nc" id="L478">			Integer count = 0;</span>
<span class="nc" id="L479">			detailsDBDto.setEventDBDto(new HashMap&lt;String, List&lt;EventDBDto&gt;&gt;());</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L481" title="All 2 branches missed.">				if (count == 0) {</span>
<span class="nc" id="L482">					detailsDBDto.setContactName(rs.getString(&quot;Name&quot;));</span>
<span class="nc" id="L483">					detailsDBDto.setCrmAccountId(rs.getString(&quot;CRMAccountID&quot;));</span>
<span class="nc" id="L484">					detailsDBDto.setCrmContactId(rs.getString(&quot;CRMContactID&quot;));</span>
<span class="nc" id="L485">					detailsDBDto.setTradeContactId(rs.getString(&quot;TradeContactID&quot;));</span>
<span class="nc" id="L486">					detailsDBDto.setTradeAccountNum(rs.getString(&quot;TradeAccountNumber&quot;));</span>
<span class="nc" id="L487">					detailsDBDto.setConComplianceStatus(rs.getString(&quot;ContactComplianceStatus&quot;));</span>
<span class="nc" id="L488">					detailsDBDto.setAccountAttrib(rs.getString(&quot;AccountAttrib&quot;));</span>
<span class="nc" id="L489">					detailsDBDto.setContactAttrib(rs.getString(&quot;contactAttrib&quot;));</span>
<span class="nc" id="L490">					detailsDBDto.setAccountId(rs.getInt(&quot;AccountId&quot;));</span>
<span class="nc" id="L491">					detailsDBDto.setContactId(rs.getInt(&quot;ID&quot;));</span>
<span class="nc" id="L492">					detailsDBDto.setAccComplianceStatus(rs.getString(&quot;AccountComplianceStatus&quot;));</span>
<span class="nc" id="L493">					detailsDBDto.setOrgnization(rs.getString(&quot;Organization&quot;));</span>
<span class="nc" id="L494">					detailsDBDto.setRegComp(rs.getTimestamp(&quot;RegComplete&quot;));</span>
<span class="nc" id="L495">					detailsDBDto.setRegCompAccount(rs.getTimestamp(&quot;RegCompleteAcc&quot;));</span>
<span class="nc" id="L496">					detailsDBDto.setRegistrationInDate(rs.getTimestamp(&quot;RegistrationInDate&quot;));</span>
<span class="nc" id="L497">					detailsDBDto.setComplianceExpiry(rs.getTimestamp(&quot;ComplianceExpiry&quot;));</span>
<span class="nc" id="L498">					detailsDBDto.setRegIn(rs.getTimestamp(&quot;RegIn&quot;));</span>
<span class="nc" id="L499">					detailsDBDto.setLegalEntity(rs.getString(&quot;LegalEntity&quot;));</span>
<span class="nc" id="L500">					detailsDBDto.setUserResourceId(rs.getInt(&quot;userResourceLockId&quot;));</span>
<span class="nc" id="L501">					detailsDBDto.setCountryOfResidenceFullName(rs.getString(&quot;countryFullName&quot;));</span>
<span class="nc" id="L502">					detailsDBDto.setIsOnQueue(rs.getBoolean(&quot;isOnQueue&quot;));</span>
<span class="nc" id="L503">					detailsDBDto.setDataAnonStatus(rs.getString(&quot;dataAnonStatus&quot;));</span>
<span class="nc" id="L504">					detailsDBDto.setCustomCheckStatus(ServiceStatusEnum.getStatusFromDatabaseStatus(rs.getInt(&quot;CustomCheckStatus&quot;)));</span>
<span class="nc" id="L505">					detailsDBDto.setPoiExists(rs.getString(&quot;poiExists&quot;));</span>
<span class="nc" id="L506">					detailsDBDto.setAccountTMFlag(rs.getInt(&quot;accountTMFlag&quot;));</span>
<span class="nc" id="L507">					detailsDBDto.setIntuitionRiskLevel(rs.getString(&quot;riskLevel&quot;));</span>
<span class="nc" id="L508">					detailsDBDto.setAccountVersion(rs.getInt(&quot;AccountVersion&quot;));</span>
					
<span class="nc" id="L510">					String lockedBy = rs.getString(&quot;LockedBy&quot;);</span>
					
<span class="nc" id="L512">					checkAndSetLockedBy(detailsDBDto, rs, lockedBy);	</span>
					
				}
<span class="nc" id="L515">				String serviceName = rs.getString(&quot;ServiceName&quot;);</span>
<span class="nc" id="L516">				List&lt;EventDBDto&gt; eventListByservice = detailsDBDto.getEventDBDto().get(serviceName);</span>
<span class="nc bnc" id="L517" title="All 2 branches missed.">				if (eventListByservice == null) {</span>
<span class="nc" id="L518">					detailsDBDto.getEventDBDto().put(serviceName, new ArrayList&lt;EventDBDto&gt;());</span>
				}
<span class="nc" id="L520">				EventDBDto eventDBDto = new EventDBDto();</span>
<span class="nc" id="L521">				eventDBDto.setId(rs.getInt(&quot;EventServiceLogId&quot;));</span>
<span class="nc" id="L522">				eventDBDto.setUpdatedBy(rs.getString(&quot;EventUpdatedBy&quot;));</span>
<span class="nc" id="L523">				eventDBDto.setUpdatedOn(rs.getTimestamp(&quot;EventUpdatedOn&quot;));</span>
<span class="nc" id="L524">				eventDBDto.setSummary(rs.getString(&quot;EventSummary&quot;));</span>
<span class="nc" id="L525">				eventDBDto.setStatus(ServiceStatusEnum.getUiStatusFromDatabaseStatus(rs.getInt(&quot;EventStatus&quot;) ));</span>
<span class="nc" id="L526">				detailsDBDto.getEventDBDto().get(serviceName).add(eventDBDto);</span>
<span class="nc" id="L527">				count++;</span>
<span class="nc" id="L528">			}</span>

<span class="nc" id="L530">			accountid = detailsDBDto.getAccountId();</span>
<span class="nc" id="L531">			detailsDBDto.setOtherContacts(</span>
<span class="nc" id="L532">					getOtherContacts(detailsDBDto.getAccountId(), detailsDBDto.getContactId(), connection));</span>
<span class="nc" id="L533">			detailsDBDto.setWatachList(getAccountWatchlistWithSelected(detailsDBDto.getContactId(), connection,registrationSearchCriteria.getFilter().getUserProfile()));</span>
<span class="nc" id="L534">			detailsDBDto.setActivityLogs(getActivityLogsByContact(contactId,accountid, connection));</span>
<span class="nc" id="L535">			detailsDBDto.setContactStatusReason(getContactStatusReasons(contactId, connection));</span>
<span class="nc" id="L536">			detailsDBDto.setDocumentList(getUploadDocumentList(connection));</span>
<span class="nc" id="L537">			detailsDBDto.setKycSupportedCountryList(getKycCountryList(connection));</span>
			
<span class="nc bnc" id="L539" title="All 2 branches missed.">			if(null != accountid){</span>
<span class="nc" id="L540">				detailsDBDto.setAlertComplianceLog(getAlertComplianceLog(accountid));	</span>
			}
<span class="nc" id="L542">		} catch (Exception e) {</span>
<span class="nc" id="L543">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="nc" id="L545">			closeResultset(rs);</span>
<span class="nc" id="L546">			closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L547">			closeConnection(connection);</span>

		}
<span class="nc" id="L550">		return registrationDetailsTransformer.transform(detailsDBDto);</span>
	}

	private void checkAndSetLockedBy(RegistrationDetailsDBDto detailsDBDto, ResultSet rs, String lockedBy) throws SQLException {
<span class="nc bnc" id="L554" title="All 4 branches missed.">		if(null != lockedBy &amp;&amp; !lockedBy.equalsIgnoreCase(Constants.DUMMY_USER)) {</span>
<span class="nc" id="L555">			detailsDBDto.setLockedBy(rs.getString(&quot;LockedBy&quot;));</span>
		}
<span class="nc" id="L557">	}</span>

	private StatusReason getContactStatusReasons(Integer contactId, Connection connection)
			throws CompliancePortalException {

<span class="nc" id="L562">		StatusReason contactStatusReason = new StatusReason();</span>
<span class="nc" id="L563">		List&lt;StatusReasonData&gt; contactStatusReasonList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L564">		contactStatusReason.setStatusReasonData(contactStatusReasonList);</span>
<span class="nc" id="L565">		PreparedStatement statement = null;</span>
<span class="nc" id="L566">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L568">			statement = connection.prepareStatement(RegistrationQueryConstant.GET_CONTACT_STATUS_REASON.getQuery());</span>
<span class="nc" id="L569">			statement.setInt(1, contactId);</span>
<span class="nc" id="L570">			rs = statement.executeQuery();</span>
<span class="nc bnc" id="L571" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L572">				StatusReasonData contactStatusReasonData = new StatusReasonData();</span>
<span class="nc" id="L573">				contactStatusReasonData.setName(rs.getString(REASON));</span>
<span class="nc" id="L574">				Integer contactIdDb = rs.getInt(&quot;ContactId&quot;);</span>
<span class="nc bnc" id="L575" title="All 2 branches missed.">				if (contactIdDb != -1) {</span>
<span class="nc" id="L576">					contactStatusReasonData.setValue(Boolean.TRUE);</span>
				} else {
<span class="nc" id="L578">					contactStatusReasonData.setValue(Boolean.FALSE);</span>
				}
<span class="nc" id="L580">				contactStatusReasonList.add(contactStatusReasonData);</span>
<span class="nc" id="L581">			}</span>

<span class="nc" id="L583">		} catch (Exception e) {</span>
<span class="nc" id="L584">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="nc" id="L586">			closeResultset(rs);</span>
<span class="nc" id="L587">			closePrepareStatement(statement);</span>
		}
<span class="nc" id="L589">		return contactStatusReason;</span>
	}

	/**
	 * Gets the activity logs by contact.
	 *
	 * @param contactId the contact id
	 * @param connection the connection
	 * @return the activity logs by contact
	 * @throws CompliancePortalException the compliance portal exception
	 */
	private ActivityLogs getActivityLogsByContact(Integer contactId,Integer accountId, Connection connection)
			throws CompliancePortalException {
<span class="nc" id="L602">		ActivityLogs activityLogs = new ActivityLogs();</span>
<span class="nc" id="L603">		List&lt;ActivityLogDataWrapper&gt; activityLogDataList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L604">		activityLogs.setActivityLogData(activityLogDataList);</span>
<span class="nc" id="L605">		PreparedStatement statement = null;</span>
<span class="nc" id="L606">		ResultSet rs = null;</span>
		
		try {
<span class="nc" id="L609">			statement = connection.prepareStatement(RegistrationQueryConstant.GET_ACTIVITY_LOGS_OF_CONTACT.getQuery());</span>
<span class="nc" id="L610">			statement.setInt(1, contactId);</span>
<span class="nc" id="L611">			statement.setInt(2, accountId);</span>
<span class="nc" id="L612">			rs = statement.executeQuery();</span>
<span class="nc bnc" id="L613" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L614">				ActivityLogDataWrapper activityLogData = new ActivityLogDataWrapper();</span>
<span class="nc" id="L615">				activityLogData.setActivity(rs.getString(&quot;Activity&quot;));</span>
<span class="nc" id="L616">				activityLogData.setActivityType(ActivityType.getActivityLogDisplay(rs.getString(&quot;ActivityType&quot;)));</span>
<span class="nc" id="L617">				activityLogData.setCreatedBy(rs.getString(&quot;User&quot;));</span>
<span class="nc" id="L618">				Timestamp createdOn = rs.getTimestamp(&quot;CreatedOn&quot;);</span>
<span class="nc bnc" id="L619" title="All 2 branches missed.">				activityLogData.setCreatedOn(createdOn != null ? DateTimeFormatter.dateTimeFormatter(createdOn) : null);</span>
<span class="nc" id="L620">				activityLogData.setComment(rs.getString(&quot;Comment&quot;));				</span>
<span class="nc" id="L621">				activityLogDataList.add(activityLogData);</span>
				
<span class="nc" id="L623">			}</span>

<span class="nc" id="L625">		} catch (Exception e) {</span>
<span class="nc" id="L626">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
			
<span class="nc" id="L629">			closePrepareStatement(statement);</span>
<span class="nc" id="L630">			closeResultset(rs);</span>
		}
<span class="nc" id="L632">		return activityLogs;</span>

	}

	@Override
	public ActivityLogs updateContact(RegUpdateDBDto requestHandlerDto) throws CompliancePortalException {
<span class="fc" id="L638">		Connection connection = null;</span>
<span class="fc" id="L639">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L640">		ResultSet resultSet = null;</span>
<span class="fc" id="L641">		Integer tradeAccountId = null;</span>
<span class="fc" id="L642">		Integer tradeContactId = null;</span>
<span class="fc" id="L643">		Connection readOnlyConn = null;</span>
<span class="fc" id="L644">		String registrationStatusReason= null;</span>
		try {
			
<span class="fc" id="L647">			connection = getConnection(Boolean.FALSE);</span>
<span class="fc" id="L648">			readOnlyConn = getConnection(Boolean.TRUE);</span>

<span class="fc" id="L650">			preparedStatement = readOnlyConn</span>
<span class="fc" id="L651">					.prepareStatement(RegistrationQueryConstant.GET_ACCOUNT_CONTACT_IDS_BY_CONTACT_ID.getQuery());</span>
<span class="fc" id="L652">			preparedStatement.setInt(1, requestHandlerDto.getContactId());</span>
<span class="fc" id="L653">			resultSet = preparedStatement.executeQuery();</span>
<span class="pc bpc" id="L654" title="1 of 2 branches missed.">			if(resultSet.next()){</span>
<span class="fc" id="L655">				tradeAccountId = resultSet.getInt(&quot;TradeAccountID&quot;);</span>
<span class="fc" id="L656">				tradeContactId = resultSet.getInt(&quot;TradeContactId&quot;);</span>
			}
<span class="fc" id="L658">			beginTransaction(connection);</span>
			/**added getWatchListStatus() to update watch list status for paymentout and paymentin */
<span class="fc" id="L660">			getWatchListStatus(requestHandlerDto,readOnlyConn);</span>
<span class="fc" id="L661">			deleteWatchlist(requestHandlerDto, connection);</span>
<span class="fc" id="L662">			addWatchlist(requestHandlerDto, connection);</span>
<span class="fc" id="L663">			updateWatchlistStatus(requestHandlerDto,connection);</span>
<span class="fc" id="L664">			deleteReasons(requestHandlerDto, connection);</span>
<span class="fc" id="L665">			addReasons(requestHandlerDto, connection);</span>
<span class="fc" id="L666">			addActivityLogs(requestHandlerDto, connection);</span>

<span class="fc" id="L668">			String contactStatus = requestHandlerDto.getContactStatus();</span>
			/**Added ResponseStatus*/	
<span class="pc bpc" id="L670" title="3 of 4 branches missed.">			if (requestHandlerDto.getAddReasons() != null &amp;&amp; !(requestHandlerDto.getAddReasons().isEmpty())) {</span>
<span class="nc" id="L671">				registrationStatusReason=requestHandlerDto.getAddReasons().toString().replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;);</span>
			}
			
<span class="pc bpc" id="L674" title="2 of 4 branches missed.">			if (contactStatus != null &amp;&amp; !contactStatus.isEmpty()) {</span>
<span class="fc" id="L675">				updateContactStatus(contactStatus, requestHandlerDto, requestHandlerDto.getCreatedBy() ,connection);</span>
			
<span class="fc" id="L677">				ComplianceStatus accountStatus = getAccountStatus(requestHandlerDto.getContactId(),contactStatus,</span>
<span class="fc" id="L678">						requestHandlerDto.getAccountId(), connection);</span>
<span class="fc" id="L679">				String responseCode = null;</span>
<span class="fc" id="L680">				String responseCodeDescription = null ;</span>
				//compares old and new account status.If status are different then update it and add response code &amp; description
<span class="pc bpc" id="L682" title="1 of 2 branches missed.">				if(!getOldAccountStatus(requestHandlerDto.getAccountId(),accountStatus.name(),connection)){</span>
<span class="fc" id="L683">					responseCode=Constants.REGISTRATION_RESPONE_CODE;</span>
<span class="fc" id="L684">					responseCodeDescription= Constants.REGISTRATION_RESPONE_DESCRIPTION;</span>
<span class="fc" id="L685">					updateAccountStatus(requestHandlerDto, accountStatus.name(), connection);</span>
				}				
<span class="pc bpc" id="L687" title="2 of 4 branches missed.">				if(contactStatus.equalsIgnoreCase(ComplianceStatus.ACTIVE.name()) || contactStatus.equalsIgnoreCase(ComplianceStatus.REJECTED.name()) ){</span>
<span class="nc" id="L688">					updateWorkFlowTime(requestHandlerDto.getUserResourceId(),connection);	</span>
				}
<span class="fc" id="L690">				RegistrationAccount account = getAccountAttributes(requestHandlerDto.getAccountId(), connection);</span>
<span class="pc bpc" id="L691" title="1 of 2 branches missed.">				if(account == null){</span>
<span class="nc" id="L692">					throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR);</span>
				}
<span class="fc" id="L694">			    account.setAccountStatus(accountStatus.name());</span>
<span class="fc" id="L695">			    ComplianceAccount responseAccount = buildResponseAccount(accountStatus, requestHandlerDto.getAccountSfId(), </span>
<span class="fc" id="L696">			    		tradeAccountId, responseCode, responseCodeDescription, requestHandlerDto.getRegistrationInDate(),</span>
<span class="fc" id="L697">						requestHandlerDto.getComplianceDoneOn());		</span>
<span class="fc" id="L698">				ComplianceContact responseContact = buildResponseContact(ComplianceStatus.valueOf(contactStatus), </span>
<span class="fc" id="L699">						requestHandlerDto.getContactSfId(), tradeContactId);</span>
				
<span class="fc" id="L701">				saveIntoBroadcastQueue(getBroadCastDBObject(requestHandlerDto.getAccountId(),</span>
<span class="fc" id="L702">						requestHandlerDto.getContactId(), requestHandlerDto.getCreatedBy(),</span>
<span class="fc" id="L703">						getRegistrationResponse(requestHandlerDto.getOrgCode(),responseAccount, </span>
								responseContact, registrationStatusReason),
<span class="fc" id="L705">						requestHandlerDto.getOrgCode()), connection);</span>
<span class="pc bnc" id="L706" title="All 2 branches missed.">			}else if(Boolean.FALSE.equals(StringUtils.isNullOrEmpty(requestHandlerDto.getComment())) </span>
<span class="nc bnc" id="L707" title="All 2 branches missed.">					&amp;&amp; Boolean.TRUE.equals(requestHandlerDto.getIsRequestFromQueue())){</span>
<span class="nc" id="L708">				updateContactIsOnQueueStatus(requestHandlerDto,connection);</span>
			}
<span class="fc" id="L710">			commitTransaction(connection);</span>

<span class="nc" id="L712">		} catch (Exception e) {</span>
<span class="nc" id="L713">			transactionRolledBack(connection);</span>
<span class="nc" id="L714">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
		} finally {
<span class="fc" id="L716">			closePrepareStatement(preparedStatement);</span>
<span class="fc" id="L717">			closeResultset(resultSet);</span>
<span class="fc" id="L718">			closeConnection(readOnlyConn);</span>
<span class="fc" id="L719">			closeConnection(connection);</span>
		}
<span class="fc" id="L721">		return regActivityLogTransformer.transform(requestHandlerDto);</span>
	}


	/**
	 * Update contact is on queue status.
	 * updateContactIsOnQueueStatus() updates IsOnQueue column of contact table
	 * If IsOnQueue is true then PFX record displays on Reg Queue
	 * else record displays on Reg report.
	 * @param requestHandlerDto the request handler dto
	 * @param connection the connection
	 * @throws CompliancePortalException the compliance portal exception
	 * @author abhijeetg
	 */
	private void updateContactIsOnQueueStatus(RegUpdateDBDto requestHandlerDto, Connection connection) throws CompliancePortalException {

<span class="nc" id="L737">		PreparedStatement preparedStatement = null;</span>
		try {
<span class="nc" id="L739">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.UPDATE_CONTACT_IS_ON_QUEUE_STATUS.getQuery());</span>
<span class="nc" id="L740">			preparedStatement.setString(1, requestHandlerDto.getCreatedBy());</span>
<span class="nc" id="L741">			preparedStatement.setTimestamp(2, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L742">			preparedStatement.setBoolean(3, requestHandlerDto.getIsContactOnQueue());</span>
<span class="nc" id="L743">			preparedStatement.setInt(4, requestHandlerDto.getContactId());</span>
<span class="nc" id="L744">			int count = preparedStatement.executeUpdate();</span>
<span class="nc bnc" id="L745" title="All 2 branches missed.">			if (count == 0) {</span>
<span class="nc" id="L746">				throw new CompliancePortalException(CompliancePortalErrors.INVALID_REQUEST);</span>
			}

<span class="nc" id="L749">		} catch (CompliancePortalException exception) {</span>
<span class="nc" id="L750">			throw exception;</span>
<span class="nc" id="L751">		} catch (Exception e) {</span>
<span class="nc" id="L752">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_INSERTING_DATA, e);</span>
		} finally {
<span class="nc" id="L754">			closePrepareStatement(preparedStatement);</span>
		}
		
<span class="nc" id="L757">	}</span>

	private void deleteWatchlist(RegUpdateDBDto requestHandlerDto, Connection connection)
			throws CompliancePortalException {
<span class="fc" id="L761">		Integer contactId = requestHandlerDto.getContactId();</span>
<span class="fc" id="L762">		List&lt;String&gt; delWatchlist = requestHandlerDto.getDeletedWatchlist();</span>

<span class="pc bpc" id="L764" title="2 of 4 branches missed.">		if (delWatchlist != null &amp;&amp; !delWatchlist.isEmpty()) {</span>
<span class="nc" id="L765">			String[] delwatchlistArray = delWatchlist.toArray(new String[delWatchlist.size()]);</span>
<span class="nc" id="L766">			CriteriaBuilder builder = new CriteriaBuilder(RegistrationQueryConstant.GET_WATCHLIST_REASON.getQuery());</span>
<span class="nc" id="L767">			String query = builder.addCriteria(REASON, delwatchlistArray, &quot;AND&quot;, ClauseType.IN).build();</span>
<span class="nc" id="L768">			query = &quot;DELETE ContactWatchList WHERE Contact  =&quot;+ contactId +&quot; AND Reason IN(&quot; + query + &quot;)&quot;;</span>
<span class="nc" id="L769">			deleteWatchlist(query, connection);</span>
		}
<span class="fc" id="L771">	}</span>

	private void addWatchlist(RegUpdateDBDto requestHandlerDto, Connection connection)
			throws CompliancePortalException {
<span class="fc" id="L775">		List&lt;String&gt; addWatchlist = requestHandlerDto.getAddWatchlist();</span>
<span class="pc bpc" id="L776" title="2 of 4 branches missed.">		if (addWatchlist != null &amp;&amp; !addWatchlist.isEmpty()) {</span>
<span class="nc" id="L777">			insertWatchlist(requestHandlerDto, connection);</span>
		}
<span class="fc" id="L779">	}</span>

	private void deleteReasons(RegUpdateDBDto requestHandlerDto, Connection connection)
			throws CompliancePortalException {
<span class="fc" id="L783">		Integer contactId = requestHandlerDto.getContactId();</span>
<span class="fc" id="L784">		List&lt;String&gt; delReasons = requestHandlerDto.getDeletedReasons();</span>
<span class="pc bpc" id="L785" title="3 of 4 branches missed.">		if (delReasons != null &amp;&amp; !delReasons.isEmpty()) {</span>
<span class="nc" id="L786">			String[] delReasonsArray = delReasons.toArray(new String[delReasons.size()]);</span>
<span class="nc" id="L787">			CriteriaBuilder builder = new CriteriaBuilder(RegistrationQueryConstant.GET_STATUS_REASON_ID.getQuery());</span>
<span class="nc" id="L788">			String query = builder.addCriteria(&quot;Module&quot;, new String[] { &quot;CONTACT&quot;, &quot;ALL&quot; }, &quot;AND&quot;, ClauseType.IN)</span>
<span class="nc" id="L789">					.addCriteria(REASON, delReasonsArray, &quot;AND&quot;, ClauseType.IN).build();</span>
<span class="nc" id="L790">			query = &quot;DELETE [ProfileStatusReason] WHERE ContactID=&quot; + contactId + &quot; AND StatusUpdateReasonID IN (&quot;</span>
					+ query + &quot;)&quot;;
<span class="nc" id="L792">			deleteContactReason(query, connection);</span>
		}
<span class="fc" id="L794">	}</span>

	private void addReasons(RegUpdateDBDto requestHandlerDto, Connection connection) throws CompliancePortalException {
<span class="fc" id="L797">		List&lt;String&gt; addReasons = requestHandlerDto.getAddReasons();</span>
<span class="pc bpc" id="L798" title="3 of 4 branches missed.">		if (addReasons != null &amp;&amp; !addReasons.isEmpty()) {</span>
<span class="nc" id="L799">			insertContactReason(requestHandlerDto, connection);</span>
		}
<span class="fc" id="L801">	}</span>

	private void addActivityLogs(RegUpdateDBDto requestHandlerDto, Connection connection)
			throws CompliancePortalException {
<span class="fc" id="L805">		List&lt;ProfileActivityLogDto&gt; activityLogs = requestHandlerDto.getActivityLog();</span>
<span class="pc bpc" id="L806" title="2 of 4 branches missed.">		if (activityLogs != null &amp;&amp; !activityLogs.isEmpty()) {</span>
<span class="fc" id="L807">			insertProfileActivityLogs(activityLogs, connection);</span>
<span class="fc" id="L808">			insertProfileActivityLogDetail(activityLogs, connection);</span>
		}
<span class="fc" id="L810">	}</span>

	@SuppressWarnings(&quot;resource&quot;)
	private void insertWatchlist(RegUpdateDBDto regReqHandlerDto, Connection conn)
			throws CompliancePortalException {
<span class="nc" id="L815">		PreparedStatement stmt = null;</span>
		try {
<span class="nc" id="L817">			stmt = conn.prepareStatement(RegistrationQueryConstant.INSERT_CONTACT_WATCHLIST.getQuery());</span>
<span class="nc bnc" id="L818" title="All 2 branches missed.">			for (String addWatchlistStr : regReqHandlerDto.getAddWatchlist()) {</span>
<span class="nc" id="L819">				stmt.setString(1, addWatchlistStr);</span>
<span class="nc" id="L820">				stmt.setInt(2, regReqHandlerDto.getContactId());</span>
<span class="nc" id="L821">				stmt.setString(3, regReqHandlerDto.getCreatedBy());</span>
<span class="nc" id="L822">				stmt.setTimestamp(4, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L823">			}</span>
<span class="nc" id="L824">			int count = stmt.executeUpdate();</span>
<span class="nc bnc" id="L825" title="All 2 branches missed.">				if (count == 0) {</span>
<span class="nc" id="L826">					throw new CompliancePortalException(CompliancePortalErrors.INVALID_REQUEST);</span>
				}

<span class="nc" id="L829">		} catch (CompliancePortalException exception) {</span>
<span class="nc" id="L830">			throw exception;</span>
<span class="nc" id="L831">		} catch (Exception e) {</span>
<span class="nc" id="L832">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_INSERTING_DATA, e);</span>
		} finally {
<span class="nc" id="L834">			closePrepareStatement(stmt);</span>
		}
<span class="nc" id="L836">	}</span>

	private void updateContactStatus(String status, RegUpdateDBDto requestHandlerDto, String updatedBy ,Connection connection)
			throws CompliancePortalException {

<span class="fc" id="L841">		PreparedStatement preparedStatement = null;</span>
		try {
<span class="fc" id="L843">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.UPDATE_CONTACT_STATUS.getQuery());</span>
<span class="fc" id="L844">			preparedStatement.setString(1, status);</span>
<span class="fc" id="L845">			preparedStatement.setString(2, updatedBy);</span>
<span class="fc" id="L846">			preparedStatement.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L847">			preparedStatement.setBoolean(4, requestHandlerDto.getIsContactOnQueue());</span>
<span class="fc" id="L848">			preparedStatement.setInt(5, requestHandlerDto.getContactId());</span>
			
<span class="fc" id="L850">			int count = preparedStatement.executeUpdate();</span>
<span class="pc bpc" id="L851" title="1 of 2 branches missed.">			if (count == 0) {</span>
<span class="nc" id="L852">				throw new CompliancePortalException(CompliancePortalErrors.INVALID_REQUEST);</span>
			}

<span class="nc" id="L855">		} catch (CompliancePortalException exception) {</span>
<span class="nc" id="L856">			throw exception;</span>
<span class="nc" id="L857">		} catch (Exception e) {</span>
<span class="nc" id="L858">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_INSERTING_DATA, e);</span>
		} finally {
<span class="fc" id="L860">			closePrepareStatement(preparedStatement);</span>
		}

<span class="fc" id="L863">	}</span>

	@SuppressWarnings(&quot;resource&quot;)
	private void insertContactReason(RegUpdateDBDto regReqHandlerDto, Connection connection)
			throws CompliancePortalException {
<span class="nc" id="L868">		PreparedStatement preparedStatement = null;</span>
		try {
<span class="nc" id="L870">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.INSERT_CONTACT_REASON.getQuery());</span>
<span class="nc bnc" id="L871" title="All 2 branches missed.">			for (String addReasonsStr : regReqHandlerDto.getAddReasons()) {</span>
<span class="nc" id="L872">				preparedStatement.setString(1, regReqHandlerDto.getOrgCode());</span>
<span class="nc" id="L873">				preparedStatement.setInt(2, regReqHandlerDto.getAccountId());</span>
<span class="nc" id="L874">				preparedStatement.setInt(3, regReqHandlerDto.getContactId());</span>
<span class="nc" id="L875">				preparedStatement.setString(4, addReasonsStr);</span>
<span class="nc" id="L876">				preparedStatement.setString(5, regReqHandlerDto.getCreatedBy());</span>
<span class="nc" id="L877">				preparedStatement.setTimestamp(6, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L878">				preparedStatement.setString(7, regReqHandlerDto.getCreatedBy());</span>
<span class="nc" id="L879">				preparedStatement.setTimestamp(8, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L880">				int addRowCnt = preparedStatement.executeUpdate();</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">				if (addRowCnt == 0) {</span>
<span class="nc" id="L882">					throw new CompliancePortalException(CompliancePortalErrors.INVALID_REQUEST);</span>
				}
<span class="nc" id="L884">			}</span>

<span class="nc" id="L886">		} catch (CompliancePortalException exception) {</span>
<span class="nc" id="L887">			throw exception;</span>
<span class="nc" id="L888">		} catch (Exception e) {</span>
<span class="nc" id="L889">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_INSERTING_DATA, e);</span>
		} finally {
<span class="nc" id="L891">			closePrepareStatement(preparedStatement);</span>
		}
<span class="nc" id="L893">	}</span>

	private void deleteContactReason(String query, Connection connection) throws CompliancePortalException {
<span class="nc" id="L896">		PreparedStatement preparedStatement = null;</span>
		try {
<span class="nc" id="L898">			preparedStatement = connection.prepareStatement(query);</span>
<span class="nc" id="L899">			int delRowCnt = preparedStatement.executeUpdate();</span>
<span class="nc bnc" id="L900" title="All 2 branches missed.">			if (delRowCnt == 0) {</span>
<span class="nc" id="L901">				throw new CompliancePortalException(CompliancePortalErrors.INVALID_REQUEST);</span>
			}
<span class="nc" id="L903">		} catch (CompliancePortalException exception) {</span>
<span class="nc" id="L904">			throw exception;</span>
<span class="nc" id="L905">		} catch (Exception e) {</span>
<span class="nc" id="L906">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_DELETING_DATA, e);</span>
		} finally {
<span class="nc" id="L908">			closePrepareStatement(preparedStatement);</span>
		}
<span class="nc" id="L910">	}</span>

	@Override
	public ActivityLogs getActivityLogs(ActivityLogRequest actvtyLogRequest) throws CompliancePortalException {
<span class="fc" id="L914">		ActivityLogs actvtyLog = new ActivityLogs();</span>
<span class="fc" id="L915">		List&lt;ActivityLogDataWrapper&gt; actvtyLogDataList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L916">		actvtyLog.setActivityLogData(actvtyLogDataList);</span>
<span class="fc" id="L917">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L918">		Connection connection = null;</span>
<span class="fc" id="L919">		ResultSet rs = null;</span>
		try {
<span class="fc" id="L921">			connection = getConnection(Boolean.TRUE);</span>
<span class="fc" id="L922">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.GET_PROFILE_ACTIVITY_LOGS_BY_ROWS.getQuery());</span>
<span class="fc" id="L923">			preparedStatement.setInt(1, actvtyLogRequest.getEntityId());</span>
<span class="fc" id="L924">			preparedStatement.setInt(2, actvtyLogRequest.getAccountId());</span>
<span class="fc" id="L925">			preparedStatement.setInt(3, actvtyLogRequest.getMinRecord());</span>
<span class="fc" id="L926">			preparedStatement.setInt(4, actvtyLogRequest.getMaxRecord());</span>
<span class="fc" id="L927">			rs = preparedStatement.executeQuery();</span>
<span class="fc bfc" id="L928" title="All 2 branches covered.">			while (rs.next()) {</span>
<span class="fc" id="L929">				ActivityLogDataWrapper activityLogData = new ActivityLogDataWrapper();</span>
<span class="fc" id="L930">				activityLogData.setActivity(rs.getString(&quot;Activity&quot;));</span>
<span class="fc" id="L931">				activityLogData.setActivityType(ActivityType.getActivityLogDisplay(rs.getString(&quot;ActivityType&quot;)));</span>
<span class="fc" id="L932">				activityLogData.setCreatedBy(rs.getString(&quot;User&quot;));</span>
<span class="fc" id="L933">				Timestamp createdOn = rs.getTimestamp(&quot;CreatedOn&quot;);</span>
<span class="pc bpc" id="L934" title="1 of 2 branches missed.">				activityLogData.setCreatedOn(createdOn != null ? DateTimeFormatter.dateTimeFormatter(createdOn) : null);</span>
<span class="fc" id="L935">				activityLogData.setComment(rs.getString(&quot;Comments&quot;));</span>
<span class="fc" id="L936">				actvtyLogDataList.add(activityLogData);</span>
<span class="fc" id="L937">			}</span>

<span class="nc" id="L939">		} catch (Exception e) {</span>
<span class="nc" id="L940">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L942">			closeResultset(rs);</span>
<span class="fc" id="L943">			closePrepareStatement(preparedStatement);</span>
<span class="fc" id="L944">			closeConnection(connection);</span>
		}
<span class="fc" id="L946">		return actvtyLog;</span>
	}

	private ComplianceStatus getAccountStatus(Integer contactId, String contactStatus, Integer accountId,Connection connection) 
			throws CompliancePortalException {
<span class="fc" id="L951">		Boolean inactiveStatusFlag = Boolean.FALSE;</span>
<span class="fc" id="L952">		List&lt;ContactWrapper&gt; contacts = getOtherContacts(accountId, contactId, connection);</span>
<span class="pc bpc" id="L953" title="1 of 2 branches missed.">		for (ContactWrapper contact : contacts) {</span>
<span class="nc bnc" id="L954" title="All 2 branches missed.">			if (ComplianceStatus.ACTIVE.name().equalsIgnoreCase(contact.getComplianceStatus())) {</span>
<span class="nc" id="L955">				return ComplianceStatus.ACTIVE;</span>
			}
<span class="nc bnc" id="L957" title="All 2 branches missed.">			if(!ServiceStatusEnum.PASS.getUiStatus().equalsIgnoreCase(contact.getPreviousBlacklistStatus()) &amp;&amp; </span>
<span class="nc bnc" id="L958" title="All 2 branches missed.">					!ServiceStatusEnum.NOT_REQUIRED.getUiStatus().equalsIgnoreCase(contact.getPreviousBlacklistStatus()) ){</span>
<span class="nc" id="L959">				return ComplianceStatus.INACTIVE;</span>
			}
<span class="nc bnc" id="L961" title="All 2 branches missed.">			if(!ComplianceStatus.ACTIVE.name().equalsIgnoreCase(contact.getComplianceStatus())){</span>
<span class="nc" id="L962">				inactiveStatusFlag = checkInactiveStatus(contactStatus);</span>
			}				
<span class="nc" id="L964">		}</span>
<span class="pc bpc" id="L965" title="2 of 4 branches missed.">		if(null == contacts || contacts.isEmpty()){</span>
<span class="fc" id="L966">			inactiveStatusFlag = checkInactiveStatus(contactStatus);</span>
		}
<span class="pc bpc" id="L968" title="1 of 2 branches missed.">		if(Boolean.TRUE.equals(inactiveStatusFlag)){</span>
<span class="fc" id="L969">			return ComplianceStatus.INACTIVE;</span>
		}		
<span class="nc" id="L971">		return ComplianceStatus.ACTIVE;</span>

	}

	private Boolean checkInactiveStatus(String contactStatus) {
<span class="fc" id="L976">		Boolean result = Boolean.FALSE;</span>
<span class="pc bpc" id="L977" title="1 of 2 branches missed.">		if(contactStatus.equals(ComplianceStatus.REJECTED.toString()) || </span>
<span class="pc bpc" id="L978" title="1 of 2 branches missed.">				contactStatus.equals(ComplianceStatus.INACTIVE.toString())){</span>
<span class="fc" id="L979">			result =  Boolean.TRUE;</span>
		}
<span class="fc" id="L981">		return result;</span>
	}

	private BroadcastEventToDB getBroadCastDBObject(Integer accountId, Integer contactId, String createdBy,
			String statusJson, String orgCode) {
<span class="fc" id="L986">		BroadcastEventToDB db = new BroadcastEventToDB();</span>
<span class="fc" id="L987">		db.setAccountId(accountId);</span>
<span class="fc" id="L988">		db.setContactId(contactId);</span>
<span class="fc" id="L989">		db.setCreatedBy(createdBy);</span>
<span class="fc" id="L990">		db.setCreatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L991">		db.setDeliveredOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L992">		db.setDeliverOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L993">		db.setDeliveryStatus(BroadCastStatusEnum.NEW.getBroadCastStatusAsString());</span>
<span class="fc" id="L994">		db.setEntityType(BroadCastEntityTypeEnum.UPDATE.getBroadCastEntityTypeAsString());</span>
<span class="fc" id="L995">		db.setOrgCode(orgCode);</span>
<span class="fc" id="L996">		db.setStatusJson(statusJson);</span>
<span class="fc" id="L997">		return db;</span>
	}

	private String getRegistrationResponse(String orgCode, ComplianceAccount account, ComplianceContact contact,
			String registrationStatusReason) {
		
<span class="fc" id="L1003">		RegistrationResponse response = new RegistrationResponse();</span>
		
<span class="fc" id="L1005">		account.addContact(contact);</span>
<span class="fc" id="L1006">		response.setOsrID(UUID.randomUUID().toString());</span>
<span class="fc" id="L1007">		response.setAccount(account);</span>
<span class="fc" id="L1008">		response.setOrgCode(orgCode);</span>
		/**Added statusReason for save into BroadCastQueue*/
<span class="fc" id="L1010">		contact.setReasonForInactive(registrationStatusReason);</span>
<span class="fc" id="L1011">		return JsonConverterUtil.convertToJsonWithoutNull(response);</span>

	}

	private ComplianceContact buildResponseContact(ComplianceStatus contactStatus, String conSfId,
			Integer tradeContactId) {
<span class="fc" id="L1017">		ComplianceContact contact = new ComplianceContact();</span>
<span class="fc" id="L1018">		contact.setResponseCode(Constants.REGISTRATION_RESPONE_CODE);</span>
<span class="fc" id="L1019">		contact.setResponseDescription(Constants.REGISTRATION_RESPONE_DESCRIPTION);</span>
<span class="fc" id="L1020">		contact.setCcs(contactStatus);</span>
<span class="fc" id="L1021">		contact.setContactSFID(conSfId);</span>
<span class="fc" id="L1022">		contact.setTradeContactID(tradeContactId);</span>
<span class="fc" id="L1023">		return contact;</span>
	}

	private ComplianceAccount buildResponseAccount(ComplianceStatus accountStatus, String accSfId,
			Integer tradeAccountId, String responseCode, String responseCodeDescription, String registrationInDate,
			String registeredDate) {
<span class="fc" id="L1029">		ComplianceAccount account = new ComplianceAccount();</span>
		/** Added Response Code and Response Description for manual activation : issue AT-461 - Abhijit G */
<span class="pc bpc" id="L1031" title="2 of 4 branches missed.">		if(null !=responseCode &amp;&amp; null!= responseCodeDescription){</span>
<span class="fc" id="L1032">			account.setResponseCode(responseCode);</span>
<span class="fc" id="L1033">			account.setResponseDescription(responseCodeDescription);</span>
		}		
<span class="fc" id="L1035">		account.setAccountSFID(accSfId);</span>
<span class="fc" id="L1036">		account.setAcs(accountStatus);</span>
<span class="fc" id="L1037">		account.setTradeAccountID(tradeAccountId);</span>
<span class="fc" id="L1038">		account.setRegistrationInDate(DateTimeFormatter.removeMillisFromTimeStamp(registrationInDate));</span>
<span class="fc" id="L1039">		account.setRegisteredDate(DateTimeFormatter.removeMillisFromTimeStamp(registeredDate));</span>
<span class="fc" id="L1040">		return account;</span>
	}


	@Override
	public ViewMoreResponse getMoreKycDetails(RegistrationViewMoreRequest viewMoreRequest)
			throws CompliancePortalException {
<span class="fc" id="L1047">		Connection connection = null;</span>
<span class="fc" id="L1048">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L1049">		ResultSet resultSet = null;</span>
<span class="fc" id="L1050">		ViewMoreResponse viewMoreResponse = new ViewMoreResponse();</span>
		try {
<span class="fc" id="L1052">			connection = getConnection(Boolean.TRUE);</span>
<span class="fc" id="L1053">			preparedStatement = connection</span>
<span class="fc" id="L1054">					.prepareStatement(RegistrationQueryConstant.GET_VIEWMORE_REGISTRATION_DETAILS.getQuery());</span>
<span class="fc" id="L1055">			preparedStatement.setString(1, viewMoreRequest.getServiceType());</span>
<span class="fc" id="L1056">			preparedStatement.setInt(2, EntityTypeEnum.getDatabaseStatusFromUiStatus(viewMoreRequest.getEntityType()));</span>
<span class="fc" id="L1057">			preparedStatement.setInt(3, viewMoreRequest.getEntityId());</span>
<span class="fc" id="L1058">			preparedStatement.setInt(4, viewMoreRequest.getMinViewRecord());</span>
<span class="fc" id="L1059">			preparedStatement.setInt(5, viewMoreRequest.getMaxViewRecord());</span>
<span class="fc" id="L1060">			List&lt;IDomain&gt; domainList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1061">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc" id="L1062">			domainList = getMoreKycDetails(resultSet);</span>

<span class="fc" id="L1064">			viewMoreResponse.setServices(domainList);</span>

<span class="fc" id="L1066">			return viewMoreResponse;</span>
<span class="nc" id="L1067">		} catch (Exception e) {</span>
<span class="nc" id="L1068">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L1070">			closeResultset(resultSet);</span>
<span class="fc" id="L1071">			closePrepareStatement(preparedStatement);</span>
<span class="fc" id="L1072">			closeConnection(connection);</span>
		}

	}

	@Override
	public ViewMoreResponse getMoreSanctionDetails(RegistrationViewMoreRequest viewMoreRequest)
			throws CompliancePortalException {
<span class="fc" id="L1080">		ViewMoreResponse viewMoreResponse = new ViewMoreResponse();</span>
<span class="fc" id="L1081">		Connection connection = null;</span>
<span class="fc" id="L1082">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L1083">		ResultSet resultSet = null;</span>
		try {
<span class="fc" id="L1085">			connection = getConnection(Boolean.TRUE);</span>
<span class="fc" id="L1086">			preparedStatement = connection</span>
<span class="fc" id="L1087">					.prepareStatement(RegistrationQueryConstant.GET_VIEWMORE_REGISTRATION_DETAILS.getQuery());</span>
<span class="fc" id="L1088">			preparedStatement.setString(1, viewMoreRequest.getServiceType());</span>
<span class="fc" id="L1089">			preparedStatement.setInt(2, EntityTypeEnum.getDatabaseStatusFromUiStatus(viewMoreRequest.getEntityType()));</span>
<span class="fc" id="L1090">			preparedStatement.setInt(3, viewMoreRequest.getEntityId());</span>
<span class="fc" id="L1091">			preparedStatement.setInt(4, viewMoreRequest.getMinViewRecord());</span>
<span class="fc" id="L1092">			preparedStatement.setInt(5, viewMoreRequest.getMaxViewRecord());</span>
<span class="fc" id="L1093">			List&lt;IDomain&gt; domainList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1094">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc" id="L1095">			domainList = getMoreSanctionDetails(resultSet);</span>
<span class="fc" id="L1096">			viewMoreResponse.setServices(domainList);</span>

<span class="fc" id="L1098">			return viewMoreResponse;</span>
<span class="nc" id="L1099">		} catch (Exception e) {</span>
<span class="nc" id="L1100">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L1102">			closeResultset(resultSet);</span>
<span class="fc" id="L1103">			closePrepareStatement(preparedStatement);</span>
<span class="fc" id="L1104">			closeConnection(connection);</span>
		}

	}

	@Override
	public ViewMoreResponse getMoreFraugsterDetails(RegistrationViewMoreRequest viewMoreRequest)
			throws CompliancePortalException {
<span class="fc" id="L1112">		ViewMoreResponse viewMoreResponse = new ViewMoreResponse();</span>
<span class="fc" id="L1113">		Connection connection = null;</span>
<span class="fc" id="L1114">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L1115">		ResultSet resultSet = null;</span>
		try {
<span class="fc" id="L1117">			connection = getConnection(Boolean.TRUE);</span>
<span class="fc" id="L1118">			preparedStatement = connection</span>
<span class="fc" id="L1119">					.prepareStatement(RegistrationQueryConstant.GET_VIEWMORE_REGISTRATION_DETAILS.getQuery());</span>
<span class="fc" id="L1120">			preparedStatement.setString(1, viewMoreRequest.getServiceType());</span>
<span class="fc" id="L1121">			preparedStatement.setInt(2, EntityTypeEnum.getDatabaseStatusFromUiStatus(viewMoreRequest.getEntityType()));</span>
<span class="fc" id="L1122">			preparedStatement.setInt(3, viewMoreRequest.getEntityId());</span>
<span class="fc" id="L1123">			preparedStatement.setInt(4, viewMoreRequest.getMinViewRecord());</span>
<span class="fc" id="L1124">			preparedStatement.setInt(5, viewMoreRequest.getMaxViewRecord());</span>
<span class="fc" id="L1125">			List&lt;IDomain&gt; domainList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1126">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc" id="L1127">			domainList = getMoreFraugsterDetails(resultSet);</span>
<span class="fc" id="L1128">			viewMoreResponse.setServices(domainList);</span>

<span class="fc" id="L1130">			return viewMoreResponse;</span>
<span class="nc" id="L1131">		} catch (Exception e) {</span>
<span class="nc" id="L1132">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L1134">			closeResultset(resultSet);</span>
<span class="fc" id="L1135">			closePrepareStatement(preparedStatement);</span>
<span class="fc" id="L1136">			closeConnection(connection);</span>
		}
	}

	@Override
	public ViewMoreResponse getMoreCustomCheckDetails(RegistrationViewMoreRequest viewMoreRequest)
			throws CompliancePortalException {
<span class="nc" id="L1143">		ViewMoreResponse viewMoreResponse = new ViewMoreResponse();</span>
<span class="nc" id="L1144">		Connection connection = null;</span>
<span class="nc" id="L1145">		PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1146">		ResultSet resultSet = null;</span>
		try {
<span class="nc" id="L1148">			connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1149">			preparedStatement = connection</span>
<span class="nc" id="L1150">					.prepareStatement(RegistrationQueryConstant.GET_VIEWMORE_REGISTRATION_DETAILS_FOR_CUSTOM_CHECK.getQuery());</span>
<span class="nc" id="L1151">			preparedStatement.setString(1, Constants.IP);</span>
<span class="nc" id="L1152">			preparedStatement.setString(2, Constants.GLOBALCHECK);</span>
<span class="nc" id="L1153">			preparedStatement.setString(3, Constants.COUNTRYCHECK);</span>
<span class="nc" id="L1154">			preparedStatement.setInt(4, EntityTypeEnum.getDatabaseStatusFromUiStatus(viewMoreRequest.getEntityType()));</span>
<span class="nc" id="L1155">			preparedStatement.setInt(5, viewMoreRequest.getEntityId());</span>
<span class="nc" id="L1156">			List&lt;IDomain&gt; domainList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1157">			resultSet = preparedStatement.executeQuery();</span>
<span class="nc" id="L1158">			domainList = getMoreCustomCheckDetails(resultSet);</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">			if (domainList.size() &gt;= viewMoreRequest.getMaxViewRecord()) {</span>
<span class="nc" id="L1160">				domainList = domainList.subList(viewMoreRequest.getMinViewRecord(), viewMoreRequest.getMaxViewRecord());</span>
			} else {
<span class="nc" id="L1162">				domainList = domainList.subList(viewMoreRequest.getMinViewRecord(), domainList.size());</span>
			}
<span class="nc" id="L1164">			viewMoreResponse.setServices(domainList);</span>
<span class="nc" id="L1165">			return viewMoreResponse;</span>
<span class="nc" id="L1166">		} catch (Exception e) {</span>
<span class="nc" id="L1167">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="nc" id="L1169">			closeResultset(resultSet);</span>
<span class="nc" id="L1170">			closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1171">			closeConnection(connection);</span>
		}
	}
	
	private boolean getOldAccountStatus(Integer accountId,String status,Connection connection) 
			throws CompliancePortalException {
		
<span class="fc" id="L1178">		PreparedStatement statement = null;</span>
<span class="fc" id="L1179">		ResultSet rs = null;		</span>
		try {
<span class="fc" id="L1181">			statement = connection.prepareStatement(RegistrationQueryConstant.GET_OLD_ACCOUNT_STATUS.getQuery());</span>
<span class="fc" id="L1182">			statement.setInt(1, accountId);</span>
<span class="fc" id="L1183">			rs = statement.executeQuery();</span>
<span class="fc" id="L1184">			String oldAccountStatus = null;</span>
<span class="fc bfc" id="L1185" title="All 2 branches covered.">			while(rs.next()){</span>
<span class="fc" id="L1186">				oldAccountStatus = ProfileComplianceStatus.getUiStatusFromDatabaseStatus(rs.getInt(&quot;compliancestatus&quot;));</span>
			}
<span class="pc bpc" id="L1188" title="1 of 2 branches missed.">			if(status.equalsIgnoreCase(oldAccountStatus)){</span>
<span class="nc" id="L1189">				return true;</span>
			}
<span class="nc" id="L1191">		} catch (Exception e) {</span>
<span class="nc" id="L1192">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		}finally {
<span class="fc" id="L1194">			closeResultset(rs);</span>
<span class="fc" id="L1195">			closePrepareStatement(statement);</span>
		}
<span class="fc" id="L1197">		return false;</span>
	}
	
	@Override
	public ViewMoreResponse getMoreOnfidoDetails(RegistrationViewMoreRequest viewMoreRequest)
			throws CompliancePortalException {
<span class="nc" id="L1203">		ViewMoreResponse viewMoreResponse = new ViewMoreResponse();</span>
<span class="nc" id="L1204">		Connection connection = null;</span>
<span class="nc" id="L1205">		PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1206">		ResultSet resultSet = null;</span>
		try {
<span class="nc" id="L1208">			connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1209">			preparedStatement = connection</span>
<span class="nc" id="L1210">					.prepareStatement(RegistrationQueryConstant.GET_VIEWMORE_REGISTRATION_DETAILS.getQuery());</span>
<span class="nc" id="L1211">			preparedStatement.setString(1, viewMoreRequest.getServiceType());</span>
<span class="nc" id="L1212">			preparedStatement.setInt(2, EntityTypeEnum.getDatabaseStatusFromUiStatus(viewMoreRequest.getEntityType()));</span>
<span class="nc" id="L1213">			preparedStatement.setInt(3, viewMoreRequest.getEntityId());</span>
<span class="nc" id="L1214">			preparedStatement.setInt(4, viewMoreRequest.getMinViewRecord());</span>
<span class="nc" id="L1215">			preparedStatement.setInt(5, viewMoreRequest.getMaxViewRecord());</span>
<span class="nc" id="L1216">			List&lt;IDomain&gt; domainList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1217">			resultSet = preparedStatement.executeQuery();</span>
<span class="nc" id="L1218">			domainList = getMoreOnfidoDetails(resultSet);</span>
<span class="nc" id="L1219">			viewMoreResponse.setServices(domainList);</span>

<span class="nc" id="L1221">			return viewMoreResponse;</span>
<span class="nc" id="L1222">		} catch (Exception e) {</span>
<span class="nc" id="L1223">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="nc" id="L1225">			closeResultset(resultSet);</span>
<span class="nc" id="L1226">			closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1227">			closeConnection(connection);</span>
		}

	}
	
	/**
	 * Append all values.
	 *
	 * @param values the values
	 * @return the string
	 */
	//Add For AT-3269
	private String appendAllValues(String[] values) {
<span class="nc" id="L1240">		StringBuilder s = new StringBuilder();</span>
<span class="nc bnc" id="L1241" title="All 2 branches missed.">		for (String value : values) {</span>
<span class="nc bnc" id="L1242" title="All 4 branches missed.">			if (value != null &amp;&amp; !value.isEmpty()) {</span>
<span class="nc" id="L1243">				s.append(&quot;'&quot;).append(value).append(&quot;'&quot;).append(',');</span>
			}
		}
<span class="nc bnc" id="L1246" title="All 2 branches missed.">		if (s.length() &gt; 1) {</span>
<span class="nc" id="L1247">			s.setLength(s.length() - 1);</span>
<span class="nc" id="L1248">			return s.toString();</span>
		}
<span class="nc" id="L1250">		return null;</span>

	}

	@Override
	public boolean setPoiExistsFlag(UserProfile user,Contact contact) throws CompliancePortalException {
<span class="nc" id="L1256">		Connection connection = null;</span>
<span class="nc" id="L1257">		PreparedStatement preparedStatement = null;</span>
		try{
<span class="nc" id="L1259">			connection = getConnection(Boolean.TRUE);</span>
			//update contact table to set POI Exists Flag
<span class="nc" id="L1261">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.UPDATE_CONTACT_POI_EXISTS_FLAG.getQuery());	</span>
<span class="nc" id="L1262">			preparedStatement.setString(1, contact.getContactSFID());</span>
<span class="nc" id="L1263">		    preparedStatement.executeUpdate();</span>
<span class="nc" id="L1264">	} catch (Exception e) {</span>
<span class="nc" id="L1265">		transactionRolledBack(connection);</span>
<span class="nc" id="L1266">		throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
	} finally {
<span class="nc" id="L1268">		closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1269">		closeConnection(connection);</span>
	}
<span class="nc" id="L1271">		return true;</span>
	}
	

	@Override
	public ViewMoreResponse getMoreIntuitionDetails(RegistrationViewMoreRequest viewMoreRequest) //AT-4114
			throws CompliancePortalException {
<span class="nc" id="L1278">		ViewMoreResponse viewMoreResponse = new ViewMoreResponse();</span>
<span class="nc" id="L1279">		Connection connection = null;</span>
<span class="nc" id="L1280">		PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1281">		ResultSet resultSet = null;</span>
		try {
<span class="nc" id="L1283">			connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1284">			preparedStatement = connection</span>
<span class="nc" id="L1285">					.prepareStatement(RegistrationQueryConstant.GET_VIEWMORE_REGISTRATION_DETAILS.getQuery());</span>
<span class="nc" id="L1286">			preparedStatement.setString(1, viewMoreRequest.getServiceType());</span>
<span class="nc" id="L1287">			preparedStatement.setInt(2, EntityTypeEnum.getDatabaseStatusFromUiStatus(&quot;ACCOUNT&quot;)); //AT-4170 (TM perform on account level only)</span>
<span class="nc" id="L1288">			preparedStatement.setInt(3, viewMoreRequest.getAccountId()); //AT-4170</span>
<span class="nc" id="L1289">			preparedStatement.setInt(4, viewMoreRequest.getMinViewRecord());</span>
<span class="nc" id="L1290">			preparedStatement.setInt(5, viewMoreRequest.getMaxViewRecord());</span>
<span class="nc" id="L1291">			List&lt;IDomain&gt; domainList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1292">			resultSet = preparedStatement.executeQuery();</span>
<span class="nc" id="L1293">			domainList = getMoreIntuitionDetails(resultSet);</span>
<span class="nc" id="L1294">			viewMoreResponse.setServices(domainList);</span>

<span class="nc" id="L1296">			return viewMoreResponse;</span>
<span class="nc" id="L1297">		} catch (Exception e) {</span>
<span class="nc" id="L1298">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="nc" id="L1300">			closeResultset(resultSet);</span>
<span class="nc" id="L1301">			closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1302">			closeConnection(connection);</span>
		}
	}
	
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>