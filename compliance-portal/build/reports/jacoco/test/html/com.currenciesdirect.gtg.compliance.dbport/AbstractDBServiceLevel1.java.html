<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractDBServiceLevel1.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compliance-portal</a> &gt; <a href="index.source.html" class="el_package">com.currenciesdirect.gtg.compliance.dbport</a> &gt; <span class="el_source">AbstractDBServiceLevel1.java</span></div><h1>AbstractDBServiceLevel1.java</h1><pre class="source lang-java linenums">/*
 * 
 */
package com.currenciesdirect.gtg.compliance.dbport;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Statement;
import java.sql.Timestamp;
import java.sql.Types;
import java.util.ArrayList;
import java.util.List;

import com.currenciesdirect.gtg.compliance.commons.domain.fraugster.FraugsterSummary;
import com.currenciesdirect.gtg.compliance.core.domain.BaseUpdateDBDto;
import com.currenciesdirect.gtg.compliance.core.domain.Constants;
import com.currenciesdirect.gtg.compliance.core.domain.FurtherPaymentDetails;
import com.currenciesdirect.gtg.compliance.core.domain.FurtherPaymentInDetails;
import com.currenciesdirect.gtg.compliance.core.domain.FurtherPaymentOutDetails;
import com.currenciesdirect.gtg.compliance.core.domain.WatchListData;
import com.currenciesdirect.gtg.compliance.core.domain.WatchListDetails;
import com.currenciesdirect.gtg.compliance.core.domain.Watchlist;
import com.currenciesdirect.gtg.compliance.core.domain.registration.ProfileActivityLogDto;
import com.currenciesdirect.gtg.compliance.core.domain.savedsearch.SavedSearch;
import com.currenciesdirect.gtg.compliance.core.domain.savedsearch.SavedSearchData;
import com.currenciesdirect.gtg.compliance.dbport.enums.FragusterWatchListEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.FraugsterReasonsEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.ServiceStatusEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.UserLockResourceTypeEnum;
import com.currenciesdirect.gtg.compliance.dbport.enums.WatchListCategoryEnum;
import com.currenciesdirect.gtg.compliance.dbport.report.WorkEfficiencyReportQueryConstant;
import com.currenciesdirect.gtg.compliance.exception.CompliancePortalErrors;
import com.currenciesdirect.gtg.compliance.exception.CompliancePortalException;
import com.currenciesdirect.gtg.compliance.util.DateTimeFormatter;
import com.currenciesdirect.gtg.compliance.util.DecimalFormatter;
import com.currenciesdirect.gtg.compliance.util.StringUtils;

/**
 * The Class AbstractDBService.
 */
<span class="fc" id="L42">public abstract class AbstractDBServiceLevel1 extends AbstractDao {</span>

	/** The Constant FRAUGSTER_APPROVED. */
	private static final String FRAUGSTER_APPROVED = &quot;fraugsterApproved&quot;;
	
	/** The Constant FRG_TRANS_ID. */
	private static final String FRG_TRANS_ID = &quot;frgTransId&quot;;
	
	private static final String EVENT_SERVICE_LOG = &quot;eventServiceLogId&quot;;

	/**
	 * Gets the watchlist.
	 *
	 * @param contactId the contact id
	 * @param connection the connection
	 * @return the watchlist
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected Watchlist getWatchlist(Integer contactId, Connection connection) throws CompliancePortalException {

<span class="nc" id="L62">		Watchlist watchlist = new Watchlist();</span>
<span class="nc" id="L63">		List&lt;WatchListData&gt; watchlistDataList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L64">		watchlist.setWatchlistData(watchlistDataList);</span>
<span class="nc" id="L65">		PreparedStatement statement = null;</span>
<span class="nc" id="L66">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L68">			statement = connection.prepareStatement(RegistrationQueryConstant.GET_WATCHLIST_OF_CONTACT.getQuery());</span>
<span class="nc" id="L69">			statement.setInt(1, contactId);</span>
<span class="nc" id="L70">			rs = statement.executeQuery();</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L72">				WatchListData watchlistData = new WatchListData();</span>
<span class="nc" id="L73">				watchlistData.setName(rs.getString(Constants.WATCHLISTNAME));</span>
<span class="nc" id="L74">				Integer contactIdDb = rs.getInt(Constants.CONTACTID);</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">				if (contactIdDb != -1) {</span>
<span class="nc" id="L76">					watchlistData.setValue(Boolean.TRUE);</span>
				} else {
<span class="nc" id="L78">					watchlistData.setValue(Boolean.FALSE);</span>
				}
<span class="nc" id="L80">				watchlistDataList.add(watchlistData);</span>
<span class="nc" id="L81">			}</span>
<span class="nc" id="L82">		} catch (Exception e) {</span>
<span class="nc" id="L83">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="nc" id="L85">			closeResultset(rs);</span>
<span class="nc" id="L86">			closePrepareStatement(statement);</span>
		}
<span class="nc" id="L88">		return watchlist;</span>
	}

	/**
	 * Gets the organization.
	 *
	 * @param connection the connection
	 * @return the organization
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;String&gt; getOrganization(Connection connection) throws CompliancePortalException {
<span class="fc" id="L99">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L100">		ResultSet resultSet = null;</span>
<span class="fc" id="L101">		List&lt;String&gt; organization = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L103">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.GET_ORGANIZATION.getQuery());</span>
<span class="fc" id="L104">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc bfc" id="L105" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L106">				organization.add(resultSet.getString(RegQueDBColumns.CODE.getName()));</span>
			}

<span class="nc" id="L109">		} catch (Exception e) {</span>
<span class="nc" id="L110">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L112">			closeResultset(resultSet);</span>
<span class="fc" id="L113">			closePrepareStatement(preparedStatement);</span>
		}

<span class="fc" id="L116">		return organization;</span>
	}

	/**
	 * Gets the currency.
	 *
	 * @param connection the connection
	 * @return the currency
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;String&gt; getCurrency(Connection connection) throws CompliancePortalException {
<span class="fc" id="L127">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L128">		ResultSet resultSet = null;</span>
<span class="fc" id="L129">		List&lt;String&gt; currency = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L131">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.GET_CURRENCY.getQuery());</span>
<span class="fc" id="L132">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L134">				currency.add(resultSet.getString(RegQueDBColumns.CURRENCY.getName()));</span>
			}

<span class="nc" id="L137">		} catch (Exception e) {</span>
<span class="nc" id="L138">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L140">			closeResultset(resultSet);</span>
<span class="fc" id="L141">			closePrepareStatement(preparedStatement);</span>
		}

<span class="fc" id="L144">		return currency;</span>
	}

	/**
	 * Gets the all countries.
	 *
	 * @param connection the connection
	 * @return the all countries
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;String&gt; getAllCountries(Connection connection) throws CompliancePortalException {
<span class="fc" id="L155">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L156">		ResultSet resultSet = null;</span>
<span class="fc" id="L157">		List&lt;String&gt; countries = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L159">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.GET_COUNTRY_LIST.getQuery());</span>
<span class="fc" id="L160">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc bfc" id="L161" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L162">				countries.add(resultSet.getString(&quot;Country&quot;));</span>
			}
<span class="nc" id="L164">		} catch (Exception e) {</span>
<span class="nc" id="L165">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L167">			closeResultset(resultSet);</span>
<span class="fc" id="L168">			closePrepareStatement(preparedStatement);</span>
		}
<span class="fc" id="L170">		return countries;</span>
	}

	/**
	 * Insert Profile Activity Logs.
	 *
	 * @param activityLogDtos the activity log dtos
	 * @param connection the connection
	 * @throws CompliancePortalException the compliance portal exception
	 */
	@SuppressWarnings(&quot;resource&quot;)
	public void insertProfileActivityLogs(List&lt;ProfileActivityLogDto&gt; activityLogDtos, Connection connection)
			throws CompliancePortalException {
<span class="nc" id="L183">		PreparedStatement preparedStatement = null;</span>
		try {
<span class="nc" id="L185">			preparedStatement = connection.prepareStatement(</span>
<span class="nc" id="L186">					RegistrationQueryConstant.INSERT_PROFILE_ACTIVITY_LOG.getQuery(),</span>
					Statement.RETURN_GENERATED_KEYS);
<span class="nc bnc" id="L188" title="All 2 branches missed.">			for (ProfileActivityLogDto activityLog : activityLogDtos) {</span>
<span class="nc" id="L189">				preparedStatement.setTimestamp(1, activityLog.getTimeStatmp());</span>
<span class="nc" id="L190">				preparedStatement.setNString(2, activityLog.getActivityBy());</span>
<span class="nc" id="L191">				preparedStatement.setNString(3, activityLog.getOrgCode());</span>
<span class="nc" id="L192">				preparedStatement.setInt(4, activityLog.getAccountId());</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">				if (null == activityLog.getContactId()) {</span>
<span class="nc" id="L194">					preparedStatement.setNull(5, Types.INTEGER);</span>
				} else {
<span class="nc" id="L196">					preparedStatement.setInt(5, activityLog.getContactId());</span>
				}
<span class="nc" id="L198">				preparedStatement.setNString(6, activityLog.getComment());</span>
<span class="nc" id="L199">				preparedStatement.setNString(7, activityLog.getCreatedBy());</span>
<span class="nc" id="L200">				preparedStatement.setTimestamp(8, activityLog.getCreatedOn());</span>
<span class="nc" id="L201">				preparedStatement.setNString(9, activityLog.getUpdatedBy());</span>
<span class="nc" id="L202">				preparedStatement.setTimestamp(10, activityLog.getUpdatedOn());</span>
<span class="nc bnc" id="L203" title="All 2 branches missed.">				if (null == activityLog.getContactId()) {</span>
<span class="nc" id="L204">					preparedStatement.setInt(11, UserLockResourceTypeEnum.ACCOUNT.getDatabaseStatus());</span>
<span class="nc" id="L205">					preparedStatement.setInt(12, activityLog.getAccountId());</span>
				} else {
<span class="nc" id="L207">					preparedStatement.setInt(11, UserLockResourceTypeEnum.CONTACT.getDatabaseStatus());</span>
<span class="nc" id="L208">					preparedStatement.setInt(12, activityLog.getContactId());</span>
				}

<span class="nc" id="L211">				int updateCount = preparedStatement.executeUpdate();</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">				if (updateCount == 0) {</span>
<span class="nc" id="L213">					throw new CompliancePortalException(CompliancePortalErrors.INVALID_REQUEST);</span>
				}
<span class="nc" id="L215">				ResultSet rs = preparedStatement.getGeneratedKeys();</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">				if (rs.next()) {</span>
<span class="nc" id="L217">					activityLog.setId(rs.getInt(1));</span>
<span class="nc" id="L218">					activityLog.getActivityLogDetailDto().setActivityId(rs.getInt(1));</span>
				}
<span class="nc" id="L220">			}</span>

<span class="nc" id="L222">		} catch (CompliancePortalException e) {</span>
<span class="nc" id="L223">			throw e;</span>
<span class="nc" id="L224">		} catch (Exception e) {</span>
<span class="nc" id="L225">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_INSERTING_DATA, e);</span>
		} finally {
<span class="nc" id="L227">			closePrepareStatement(preparedStatement);</span>
		}
<span class="nc" id="L229">	}</span>

	/**
	 * Gets the watch list reason id.
	 *
	 * @param connection the connection
	 * @param category1 the category 1
	 * @param category2 the category 2
	 * @return the watch list reason id
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected Watchlist getWatchListReasonId(Connection connection, boolean category1, boolean category2)
			throws CompliancePortalException {

<span class="fc" id="L243">		Watchlist watchlist = new Watchlist();</span>
<span class="fc" id="L244">		List&lt;WatchListData&gt; watchlistDataList = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L245">		watchlist.setWatchlistData(watchlistDataList);</span>
<span class="fc" id="L246">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L247">		ResultSet resultSet = null;</span>
<span class="fc" id="L248">		String result = &quot;0&quot;;</span>
		try {
<span class="pc bpc" id="L250" title="2 of 4 branches missed.">			if (category1 &amp;&amp; category2) {</span>
<span class="fc" id="L251">				result = &quot;1,2&quot;;</span>
			} else {
<span class="nc" id="L253">				result = getWatchlistCategory(category1, category2, result);</span>
			}

<span class="fc" id="L256">			String temp = WorkEfficiencyReportQueryConstant.GET_WATCHLIST_CATEGORY.getQuery().replace(&quot;?&quot;, result);</span>
<span class="fc" id="L257">			preparedStatement = connection.prepareStatement(temp);</span>
<span class="fc" id="L258">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc bfc" id="L259" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L260">				WatchListData watchlistData = new WatchListData();</span>
<span class="fc" id="L261">				watchlistData.setName(resultSet.getString(RegQueDBColumns.REASON.getName()));</span>
<span class="fc" id="L262">				watchlistData.setId(resultSet.getInt(RegQueDBColumns.WATCHLISTID.getName()));</span>
<span class="fc" id="L263">				watchlistDataList.add(watchlistData);</span>
<span class="fc" id="L264">			}</span>

<span class="nc" id="L266">		} catch (Exception e) {</span>
<span class="nc" id="L267">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L269">			closeResultset(resultSet);</span>
<span class="fc" id="L270">			closePrepareStatement(preparedStatement);</span>
		}

<span class="fc" id="L273">		return watchlist;</span>
	}

	/**
	 * Gets the watchlist category.
	 *
	 * @param category1 the category 1
	 * @param category2 the category 2
	 * @param result the result
	 * @return the watchlist category
	 */
	private String getWatchlistCategory(boolean category1, boolean category2, String result) {
<span class="nc" id="L285">		String watchlistCategory = result;</span>
<span class="nc bnc" id="L286" title="All 4 branches missed.">		if (category1 &amp;&amp; !category2) {</span>
<span class="nc" id="L287">			watchlistCategory = WatchListCategoryEnum.CATEGORY_1.getCategoryDbStatus().toString();</span>
		} else {
<span class="nc bnc" id="L289" title="All 4 branches missed.">			if (!category1 &amp;&amp; category2) {</span>
<span class="nc" id="L290">				watchlistCategory = WatchListCategoryEnum.CATEGORY_2.getCategoryDbStatus().toString();</span>
			}
		}
<span class="nc" id="L293">		return watchlistCategory;</span>
	}

	/**
	 * Gets the locked user name.
	 *
	 * @param connection the connection
	 * @return the locked user name
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;String&gt; getLockedUserName(Connection connection) throws CompliancePortalException {
<span class="fc" id="L304">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L305">		ResultSet resultSet = null;</span>
<span class="fc" id="L306">		List&lt;String&gt; owner = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L308">			preparedStatement = connection.prepareStatement(WorkEfficiencyReportQueryConstant.GET_OWNER.getQuery());</span>
<span class="fc" id="L309">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc bfc" id="L310" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L311">				owner.add(resultSet.getString(RegQueDBColumns.OWNER.getName()));</span>
			}

<span class="nc" id="L314">		} catch (Exception e) {</span>
<span class="nc" id="L315">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L317">			closeResultset(resultSet);</span>
<span class="fc" id="L318">			closePrepareStatement(preparedStatement);</span>
		}

<span class="fc" id="L321">		return owner;</span>
	}

	/**
	 * Gets the payment status.
	 *
	 * @param connection the connection
	 * @return the payment status
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;String&gt; getPaymentStatus(Connection connection) throws CompliancePortalException {
<span class="fc" id="L332">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L333">		ResultSet resultSet = null;</span>
<span class="fc" id="L334">		List&lt;String&gt; status = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L336">			preparedStatement = connection</span>
<span class="fc" id="L337">					.prepareStatement(WorkEfficiencyReportQueryConstant.GET_PAYMENT_STATUS.getQuery());</span>
<span class="fc" id="L338">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc bfc" id="L339" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L340">				status.add(resultSet.getString(RegQueDBColumns.STATUS.getName()));</span>
			}

<span class="nc" id="L343">		} catch (Exception e) {</span>
<span class="nc" id="L344">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L346">			closeResultset(resultSet);</span>
<span class="fc" id="L347">			closePrepareStatement(preparedStatement);</span>
		}

<span class="fc" id="L350">		return status;</span>
	}

	/**
	 * Gets the final watch list status.
	 *
	 * @param requestHandlerDto the request handler dto
	 * @param watchListPaymentReasons the watch list payment reasons
	 * @param finalWatchList the final watch list
	 * @return the final watch list status
	 */
	protected void getFinalWatchListStatus(BaseUpdateDBDto requestHandlerDto,
			List&lt;WatchListDetails&gt; watchListPaymentReasons, List&lt;String&gt; finalWatchList) {

<span class="pc bpc" id="L364" title="2 of 4 branches missed.">		if (null != finalWatchList &amp;&amp; !finalWatchList.isEmpty()) {</span>
<span class="fc bfc" id="L365" title="All 2 branches covered.">			for (String reason : finalWatchList) {</span>
<span class="fc" id="L366">				getFinalWatchListStatus(requestHandlerDto, watchListPaymentReasons, reason);</span>
<span class="pc bpc" id="L367" title="2 of 4 branches missed.">				if (requestHandlerDto.getOverallPaymentInWatchlistStatus().getDatabaseStatus().equals(2) || requestHandlerDto.getOverallPaymentOutWatchlistStatus().getDatabaseStatus().equals(2)) {</span>
<span class="nc" id="L368">					break;</span>
				}
<span class="fc" id="L370">			}</span>
		} else {
<span class="nc" id="L372">			requestHandlerDto.setOverallPaymentInWatchlistStatus(ServiceStatusEnum.PASS);</span>
<span class="nc" id="L373">			requestHandlerDto.setOverallPaymentOutWatchlistStatus(ServiceStatusEnum.PASS);</span>
		}

<span class="fc" id="L376">	}</span>
	
	protected void getFinalWatchListStatus(BaseUpdateDBDto requestHandlerDto,
			List&lt;WatchListDetails&gt; watchListPaymentReasons, String reason) {
		
<span class="pc bpc" id="L381" title="1 of 2 branches missed.">		for (WatchListDetails paymentReason : watchListPaymentReasons) {</span>
<span class="nc" id="L382">			setWatchlistStatus(requestHandlerDto, reason, paymentReason);</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">			if (requestHandlerDto.getOverallPaymentInWatchlistStatus().getDatabaseStatus().equals(2) || requestHandlerDto.getOverallPaymentOutWatchlistStatus().getDatabaseStatus().equals(2)) {</span>
<span class="nc" id="L384">				break;</span>
			}
<span class="nc" id="L386">		}</span>
<span class="fc" id="L387">	}</span>

	/**
	 * Sets the watchlist status.
	 *
	 * @param requestHandlerDto the request handler dto
	 * @param reason the reason
	 * @param paymentReason the payment reason
	 */
	private void setWatchlistStatus(BaseUpdateDBDto requestHandlerDto, String reason, WatchListDetails paymentReason) {
	
<span class="nc bnc" id="L398" title="All 2 branches missed.">		if(!(requestHandlerDto.getOverallPaymentInWatchlistStatus().getDatabaseStatus()).equals(7)){</span>
<span class="nc" id="L399">			requestHandlerDto.setOverallPaymentInWatchlistStatus(ServiceStatusEnum.PASS);</span>
		}
		
<span class="nc bnc" id="L402" title="All 4 branches missed.">		if (paymentReason.getName().equalsIgnoreCase(reason) &amp;&amp; paymentReason.isStopPaymentIn() </span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">				&amp;&amp; paymentReason.getWatchlistCategory().equals(1)) {// check for category</span>
<span class="nc" id="L404">			requestHandlerDto.setOverallPaymentInWatchlistStatus(ServiceStatusEnum.FAIL);</span>
<span class="nc bnc" id="L405" title="All 4 branches missed.">		} else if(paymentReason.getName().equalsIgnoreCase(reason) &amp;&amp; paymentReason.isStopPaymentIn() </span>
<span class="nc bnc" id="L406" title="All 2 branches missed.">				&amp;&amp; paymentReason.getWatchlistCategory().equals(2)){</span>
<span class="nc" id="L407">			requestHandlerDto.setOverallPaymentInWatchlistStatus(ServiceStatusEnum.WATCH_LIST);</span>
		} 
		
<span class="nc bnc" id="L410" title="All 2 branches missed.">		if(!(requestHandlerDto.getOverallPaymentOutWatchlistStatus().getDatabaseStatus()).equals(7)){</span>
<span class="nc" id="L411">			requestHandlerDto.setOverallPaymentOutWatchlistStatus(ServiceStatusEnum.PASS);</span>
		}
		
<span class="nc bnc" id="L414" title="All 4 branches missed.">		if (paymentReason.getName().equalsIgnoreCase(reason) &amp;&amp; paymentReason.isStopPaymentOut() </span>
<span class="nc bnc" id="L415" title="All 2 branches missed.">				&amp;&amp; paymentReason.getWatchlistCategory().equals(1)) {// check for category</span>
<span class="nc" id="L416">			requestHandlerDto.setOverallPaymentOutWatchlistStatus(ServiceStatusEnum.FAIL);</span>
<span class="nc bnc" id="L417" title="All 4 branches missed.">		} else if(paymentReason.getName().equalsIgnoreCase(reason) &amp;&amp; paymentReason.isStopPaymentOut() </span>
<span class="nc bnc" id="L418" title="All 2 branches missed.">				&amp;&amp; paymentReason.getWatchlistCategory().equals(2)){</span>
<span class="nc" id="L419">			requestHandlerDto.setOverallPaymentOutWatchlistStatus(ServiceStatusEnum.WATCH_LIST);</span>
		}
<span class="nc" id="L421">	}</span>

	/**
	 * Adds the reason to watch list.
	 *
	 * @param finalWatchList the final watch list
	 * @param addWatchlist the add watchlist
	 */
	protected void addReasonToWatchList(List&lt;String&gt; finalWatchList, List&lt;String&gt; addWatchlist) {
<span class="pc bpc" id="L430" title="2 of 4 branches missed.">		if (addWatchlist != null &amp;&amp; !addWatchlist.isEmpty()) {</span>

<span class="nc bnc" id="L432" title="All 2 branches missed.">			for (String addReason : addWatchlist) {</span>
<span class="nc" id="L433">				finalWatchList.add(addReason);</span>
<span class="nc" id="L434">			}</span>
		}
<span class="fc" id="L436">	}</span>

	/**
	 * Removes the deleted reason from watch list.
	 *
	 * @param totalWatchList the total watch list
	 * @param delWatchlist the del watchlist
	 * @param finalWatchList the final watch list
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected void removeDeletedReasonFromWatchList(List&lt;String&gt; totalWatchList, List&lt;String&gt; delWatchlist,
			List&lt;String&gt; finalWatchList) throws CompliancePortalException {
		try {
<span class="pc bpc" id="L449" title="3 of 6 branches missed.">			if (null != totalWatchList &amp;&amp; !totalWatchList.isEmpty() &amp;&amp; delWatchlist != null</span>
<span class="pc bpc" id="L450" title="1 of 2 branches missed.">					&amp;&amp; !delWatchlist.isEmpty()) {</span>

<span class="nc" id="L452">				checkWatchlistToRemove(totalWatchList, delWatchlist, finalWatchList);</span>
			}
<span class="nc" id="L454">		} catch (Exception e) {</span>
<span class="nc" id="L455">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
<span class="fc" id="L456">		}</span>

<span class="fc" id="L458">	}</span>

	/**
	 * Check watchlist to remove.
	 *
	 * @param totalWatchList the total watch list
	 * @param delWatchlist the del watchlist
	 * @param finalWatchList the final watch list
	 */
	private void checkWatchlistToRemove(List&lt;String&gt; totalWatchList, List&lt;String&gt; delWatchlist,
			List&lt;String&gt; finalWatchList) {
<span class="nc bnc" id="L469" title="All 2 branches missed.">		for (String deleteReason : delWatchlist) {</span>
<span class="nc bnc" id="L470" title="All 2 branches missed.">			for (String reason : totalWatchList) {</span>
<span class="nc bnc" id="L471" title="All 2 branches missed.">				if (deleteReason.equalsIgnoreCase(reason)) {</span>
<span class="nc" id="L472">					finalWatchList.remove(deleteReason);</span>
				}
<span class="nc" id="L474">			}</span>
<span class="nc" id="L475">		}</span>
<span class="nc" id="L476">	}</span>

	/**
	 * Gets the total contact watch list reasons.
	 *
	 * @param readOnlyConn the read only conn
	 * @param toatalContactWatchListReason the toatal contact watch list reason
	 * @param accountId the account id
	 * @return the total contact watch list reasons
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected void getTotalContactWatchListReasons(Connection readOnlyConn, List&lt;String&gt; toatalContactWatchListReason,
			BaseUpdateDBDto requestHandlerDto) throws CompliancePortalException {
<span class="fc" id="L489">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L490">		ResultSet resultSet = null;</span>

		try {
<span class="pc bpc" id="L493" title="1 of 2 branches missed.">			if(requestHandlerDto.getCustType().equals(&quot;PFX&quot;)) {</span>
<span class="fc" id="L494">				preparedStatement = readOnlyConn</span>
<span class="fc" id="L495">						.prepareStatement(RegistrationQueryConstant.GET_CONTACT_WATCHLIST_FOR_PFX.getQuery()); //AT-2986</span>
<span class="fc" id="L496">				preparedStatement.setInt(1, requestHandlerDto.getContactId());</span>
			} else {
<span class="nc" id="L498">				preparedStatement = readOnlyConn</span>
<span class="nc" id="L499">						.prepareStatement(RegistrationQueryConstant.GET_CONTACT_WATCHLIST.getQuery());</span>
<span class="nc" id="L500">				preparedStatement.setInt(1, requestHandlerDto.getAccountId());</span>
			}
<span class="fc" id="L502">			resultSet = preparedStatement.executeQuery();</span>

<span class="fc bfc" id="L504" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L505">				toatalContactWatchListReason.add(resultSet.getString(&quot;Reason&quot;));</span>
			}

<span class="nc" id="L508">		} catch (Exception e) {</span>
<span class="nc" id="L509">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
		} finally {
<span class="fc" id="L511">			closeResultset(resultSet);</span>
<span class="fc" id="L512">			closePrepareStatement(preparedStatement);</span>
		}
<span class="fc" id="L514">	}</span>

	/**
	 * Gets the payment watch list reasons.
	 *
	 * @param readOnlyConn the read only conn
	 * @param watchListPaymentReasons the watch list payment reasons
	 * @return the payment watch list reasons
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected void getPaymentWatchListReasons(Connection readOnlyConn, List&lt;WatchListDetails&gt; watchListPaymentReasons)
			throws CompliancePortalException {
<span class="fc" id="L526">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L527">		ResultSet resultSet = null;</span>

		try {

<span class="fc" id="L531">			preparedStatement = readOnlyConn.prepareStatement(</span>
<span class="fc" id="L532">					RegistrationQueryConstant.GET_WATCHLIST_REASON_LIST_FOR_PAYMENTOUT_AND_PAYMENTIN.getQuery());</span>
<span class="fc" id="L533">			resultSet = preparedStatement.executeQuery();</span>

<span class="pc bpc" id="L535" title="1 of 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L536">				WatchListDetails watchlist = new WatchListDetails();</span>
<span class="nc" id="L537">				watchlist.setName(resultSet.getString(&quot;Reason&quot;));</span>
<span class="nc" id="L538">				watchlist.setStopPaymentIn(resultSet.getBoolean(&quot;StopPaymentIn&quot;));</span>
<span class="nc" id="L539">				watchlist.setStopPaymentOut(resultSet.getBoolean(&quot;StopPaymentOut&quot;));</span>
<span class="nc" id="L540">				watchlist.setWatchlistCategory(resultSet.getInt(&quot;Category&quot;));</span>
				
<span class="nc" id="L542">				watchListPaymentReasons.add(watchlist);</span>
<span class="nc" id="L543">			}</span>

<span class="nc" id="L545">		} catch (Exception e) {</span>
<span class="nc" id="L546">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
		} finally {
<span class="fc" id="L548">			closeResultset(resultSet);</span>
<span class="fc" id="L549">			closePrepareStatement(preparedStatement);</span>
		}

<span class="fc" id="L552">	}</span>

	/**
	 * Adds the sort.
	 *
	 * @param columnName the column name
	 * @param isAsc the is asc
	 * @param query the query
	 * @return the string
	 */
	protected String addSort(String columnName, boolean isAsc, String query) {
<span class="fc" id="L563">		String orderByCon = &quot;{ORDER_TYPE}&quot;;</span>
<span class="pc bpc" id="L564" title="1 of 2 branches missed.">		if (columnName != null) {</span>
<span class="fc" id="L565">			query = query.replace(&quot;{SORT_FIELD_NAME}&quot;, columnName);</span>
<span class="pc bpc" id="L566" title="1 of 2 branches missed.">			if (isAsc) {</span>
<span class="nc" id="L567">				query = query.replace(orderByCon, &quot;ASC&quot;);</span>
			} else {
<span class="fc" id="L569">				query = query.replace(orderByCon, &quot;DESC&quot;);</span>
			}
		}
<span class="fc" id="L572">		return query;</span>
	}

	/**
	 * Update fraugster schedular data on WL added.
	 *
	 * @param baseUpdateDBDto the base update DB dto
	 * @param asyncStatus the async status
	 * @param conn the conn
	 * @param summaryList the summary list
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected void updateFraugsterSchedularDataOnWLAdded(BaseUpdateDBDto baseUpdateDBDto, String asyncStatus,
			Connection conn, List&lt;FraugsterSummary&gt; summaryList) throws CompliancePortalException {

<span class="nc" id="L587">		PreparedStatement prepareStatement = null;</span>
		try {
<span class="nc" id="L589">			prepareStatement = conn</span>
<span class="nc" id="L590">					.prepareStatement(RegistrationQueryConstant.UPDATE_FRAUGSTER_SCHEDULAR_DATA_FOR_WL.getQuery());</span>
<span class="nc bnc" id="L591" title="All 2 branches missed.">			for (FraugsterSummary summary : summaryList) {</span>
<span class="nc" id="L592">				prepareStatement.setString(1, asyncStatus);</span>
<span class="nc" id="L593">				prepareStatement.setTimestamp(2, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L594">				prepareStatement.setString(3, baseUpdateDBDto.getCreatedBy());</span>
<span class="nc" id="L595">				prepareStatement.setTimestamp(4, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L596">				prepareStatement.setTimestamp(5, null);</span>
<span class="nc" id="L597">				prepareStatement.setString(6, summary.getFrgTransId());</span>
<span class="nc" id="L598">				prepareStatement.executeUpdate();</span>
<span class="nc" id="L599">			}</span>
<span class="nc" id="L600">		} catch (Exception e) {</span>
<span class="nc" id="L601">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
		} finally {
<span class="nc" id="L603">			closePrepareStatement(prepareStatement);</span>
		}
<span class="nc" id="L605">	}</span>

	/**
	 * Update fraugster schedular data on reason added.
	 *
	 * @param baseUpdateDBDto the base update DB dto
	 * @param asyncStatus the async status
	 * @param conn the conn
	 * @param summaryList the summary list
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected void updateFraugsterSchedularDataOnReasonAdded(BaseUpdateDBDto baseUpdateDBDto, String asyncStatus,
			Connection conn, List&lt;FraugsterSummary&gt; summaryList) throws CompliancePortalException {

<span class="nc" id="L619">		PreparedStatement prepareStatement = null;</span>
		try {
<span class="nc" id="L621">			prepareStatement = conn.prepareStatement(</span>
<span class="nc" id="L622">					RegistrationQueryConstant.UPDATE_FRAUGSTER_SCHEDULAR_DATA_FOR_REASON.getQuery(),</span>
					Statement.RETURN_GENERATED_KEYS);
<span class="nc bnc" id="L624" title="All 2 branches missed.">			for (FraugsterSummary summary : summaryList) {</span>
<span class="nc" id="L625">				prepareStatement.setString(1, asyncStatus);</span>
<span class="nc" id="L626">				prepareStatement.setTimestamp(2, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L627">				prepareStatement.setString(3, baseUpdateDBDto.getCreatedBy());</span>
<span class="nc" id="L628">				prepareStatement.setTimestamp(4, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L629">				prepareStatement.setTimestamp(5, null);</span>
<span class="nc" id="L630">				prepareStatement.setString(6, summary.getFrgTransId());</span>
<span class="nc" id="L631">				prepareStatement.executeUpdate();</span>
<span class="nc" id="L632">			}</span>
<span class="nc" id="L633">		} catch (Exception e) {</span>
<span class="nc" id="L634">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
		} finally {
<span class="nc" id="L636">			closePrepareStatement(prepareStatement);</span>
		}
<span class="nc" id="L638">	}</span>

	/**
	 * Gets the fraugster event service log id.
	 *
	 * @param readOnlyConn            the read only conn
	 * @param accountId the account id
	 * @return the fraugster event service log id
	 * @throws CompliancePortalException             the compliance portal exception This method returns provider
	 *             response from fraugster eventservicelogid.
	 */
	protected List&lt;FraugsterSummary&gt; getFraugsterEventServiceLogByAccountId(Connection readOnlyConn, Integer accountId)
			throws CompliancePortalException {
<span class="nc" id="L651">		PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L652">		ResultSet resultSet = null;</span>
<span class="nc" id="L653">		List&lt;FraugsterSummary&gt; fraugsterSummaryList = null;</span>
<span class="nc" id="L654">		FraugsterSummary fraugsterSummary = null;</span>
		try {
<span class="nc" id="L656">			fraugsterSummaryList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L657">			preparedStatement = readOnlyConn.prepareStatement(</span>
<span class="nc" id="L658">					RegistrationQueryConstant.GET_FRAUGSTER_PROVIDER_RESPONSE_BY_ACCOUNTID.getQuery());</span>
<span class="nc" id="L659">			preparedStatement.setInt(1, accountId);</span>
<span class="nc" id="L660">			resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L661" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L662">				fraugsterSummary = new FraugsterSummary();</span>
<span class="nc" id="L663">				fraugsterSummary.setId(resultSet.getString(EVENT_SERVICE_LOG));</span>
<span class="nc" id="L664">				fraugsterSummary.setFrgTransId(resultSet.getString(FRG_TRANS_ID));</span>
<span class="nc" id="L665">				fraugsterSummary.setUpdatedBy(resultSet.getString(&quot;updatedBy&quot;));</span>
<span class="nc" id="L666">				fraugsterSummary.setFraugsterApproved(resultSet.getString(FRAUGSTER_APPROVED));</span>
<span class="nc" id="L667">				fraugsterSummaryList.add(fraugsterSummary);</span>
			}

<span class="nc" id="L670">		} catch (Exception e) {</span>
<span class="nc" id="L671">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
		} finally {
<span class="nc" id="L673">			closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L674">			closeResultset(resultSet);</span>
		}
<span class="nc" id="L676">		return fraugsterSummaryList;</span>
	}

	/**
	 * Gets the fraugster event service log by contact id.
	 *
	 * @param readOnlyConn the read only conn
	 * @param contactId the contact id
	 * @return the fraugster event service log by contact id
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;FraugsterSummary&gt; getFraugsterEventServiceLogByContactId(Connection readOnlyConn, Integer contactId)
			throws CompliancePortalException {
<span class="nc" id="L689">		PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L690">		ResultSet resultSet = null;</span>
<span class="nc" id="L691">		List&lt;FraugsterSummary&gt; fraugsterSummaryList = null;</span>
<span class="nc" id="L692">		FraugsterSummary fraugsterSummary = null;</span>
		try {
<span class="nc" id="L694">			fraugsterSummaryList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L695">			preparedStatement = readOnlyConn.prepareStatement(</span>
<span class="nc" id="L696">					RegistrationQueryConstant.GET_FRAUGSTER_PROVIDER_RESPONSE_BY_CONTACTID.getQuery());</span>
<span class="nc" id="L697">			preparedStatement.setInt(1, contactId);</span>
<span class="nc" id="L698">			resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L699" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L700">				fraugsterSummary = new FraugsterSummary();</span>
<span class="nc" id="L701">				fraugsterSummary.setId(resultSet.getString(EVENT_SERVICE_LOG));</span>
<span class="nc" id="L702">				fraugsterSummary.setFrgTransId(resultSet.getString(FRG_TRANS_ID));</span>
<span class="nc" id="L703">				fraugsterSummary.setUpdatedBy(resultSet.getString(&quot;updatedBy&quot;));</span>
<span class="nc" id="L704">				fraugsterSummary.setFraugsterApproved(resultSet.getString(FRAUGSTER_APPROVED));</span>
<span class="nc" id="L705">				fraugsterSummary.setScore(resultSet.getString(&quot;score&quot;));</span>
<span class="nc" id="L706">				fraugsterSummaryList.add(fraugsterSummary);</span>
			}
<span class="nc" id="L708">		} catch (Exception e) {</span>
<span class="nc" id="L709">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
		} finally {
<span class="nc" id="L711">			closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L712">			closeResultset(resultSet);</span>
		}
<span class="nc" id="L714">		return fraugsterSummaryList;</span>
	}

	/**
	 * Gets the fraugster event service log for payment.
	 *
	 * @param readOnlyConn the read only conn
	 * @param contactId the contact id
	 * @param eventType the event type
	 * @return the fraugster event service log for payment
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;FraugsterSummary&gt; getFraugsterEventServiceLogForPayment(Connection readOnlyConn, Integer contactId,
			Integer eventType) throws CompliancePortalException {
<span class="nc" id="L728">		PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L729">		ResultSet resultSet = null;</span>
<span class="nc" id="L730">		List&lt;FraugsterSummary&gt; fraugsterSummaryList = null;</span>
<span class="nc" id="L731">		FraugsterSummary fraugsterSummary = null;</span>
		try {
<span class="nc" id="L733">			fraugsterSummaryList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L734">			preparedStatement = readOnlyConn</span>
<span class="nc" id="L735">					.prepareStatement(RegistrationQueryConstant.GET_FRAUGSTER_PROVIDER_RESPONSE_FOR_PAYMENT.getQuery());</span>
<span class="nc" id="L736">			preparedStatement.setInt(1, contactId);</span>
<span class="nc" id="L737">			preparedStatement.setInt(2, eventType);</span>
<span class="nc" id="L738">			resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L739" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L740">				fraugsterSummary = new FraugsterSummary();</span>
<span class="nc" id="L741">				fraugsterSummary.setId(resultSet.getString(EVENT_SERVICE_LOG));</span>
<span class="nc" id="L742">				fraugsterSummary.setFrgTransId(resultSet.getString(FRG_TRANS_ID));</span>
<span class="nc" id="L743">				fraugsterSummary.setFraugsterApproved(resultSet.getString(FRAUGSTER_APPROVED));</span>
<span class="nc" id="L744">				fraugsterSummaryList.add(fraugsterSummary);</span>
			}

<span class="nc" id="L747">		} catch (Exception e) {</span>
<span class="nc" id="L748">			throw new CompliancePortalException(CompliancePortalErrors.DATABASE_GENERIC_ERROR, e);</span>
		} finally {
<span class="nc" id="L750">			closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L751">			closeResultset(resultSet);</span>
		}
<span class="nc" id="L753">		return fraugsterSummaryList;</span>
	}

	/**
	 * Checks if is reason addded.
	 *
	 * @param baseUpdateDBDto the base update DB dto
	 * @return the boolean
	 */
	protected Boolean isReasonAddded(BaseUpdateDBDto baseUpdateDBDto) {
<span class="nc" id="L763">		Boolean isReasonAdded = Boolean.FALSE;</span>
<span class="nc bnc" id="L764" title="All 2 branches missed.">		for (String addReason : baseUpdateDBDto.getAddReasons()) {</span>
<span class="nc" id="L765">			isReasonAdded = FraugsterReasonsEnum.getFraugsterReason(addReason);</span>
<span class="nc" id="L766">		}</span>
<span class="nc" id="L767">		return isReasonAdded;</span>
	}

	/**
	 * Checks if is reason removed.
	 *
	 * @param baseUpdateDBDto the base update DB dto
	 * @return the boolean
	 */
	protected Boolean isReasonRemoved(BaseUpdateDBDto baseUpdateDBDto) {
<span class="nc" id="L777">		Boolean isReasonRemoved = Boolean.FALSE;</span>
<span class="nc bnc" id="L778" title="All 2 branches missed.">		for (String removeReason : baseUpdateDBDto.getDeletedReasons()) {</span>
<span class="nc" id="L779">			isReasonRemoved = FraugsterReasonsEnum.getFraugsterReason(removeReason);</span>
<span class="nc" id="L780">		}</span>
<span class="nc" id="L781">		return isReasonRemoved;</span>
	}

	/**
	 * Checks if is watch list added.
	 *
	 * @param baseUpdateDBDto the base update DB dto
	 * @return the boolean
	 */
	protected Boolean isWatchListAdded(BaseUpdateDBDto baseUpdateDBDto) {
<span class="nc" id="L791">		Boolean isWatchListAdded = Boolean.FALSE;</span>

<span class="nc bnc" id="L793" title="All 2 branches missed.">		for (String addWatchlist : baseUpdateDBDto.getAddWatchlist()) {</span>
<span class="nc" id="L794">			isWatchListAdded = FragusterWatchListEnum.getFraugsterWatchlist(addWatchlist);</span>
<span class="nc" id="L795">		}</span>
<span class="nc" id="L796">		return isWatchListAdded;</span>
	}

	/**
	 * Checks if is watch list removed.
	 *
	 * @param baseUpdateDBDto the base update DB dto
	 * @return the boolean
	 */
	protected Boolean isWatchListRemoved(BaseUpdateDBDto baseUpdateDBDto) {
<span class="nc" id="L806">		Boolean isWatchListRemoved = Boolean.FALSE;</span>

<span class="nc bnc" id="L808" title="All 2 branches missed.">		for (String removeWatchlist : baseUpdateDBDto.getDeletedWatchlist()) {</span>
<span class="nc" id="L809">			isWatchListRemoved = FragusterWatchListEnum.getFraugsterWatchlist(removeWatchlist);</span>
<span class="nc" id="L810">		}</span>
<span class="nc" id="L811">		return isWatchListRemoved;</span>
	}

	/**
	 * Sets the further payment in detail list.
	 *
	 * @param accountId the account id
	 * @param paymentDetails the payment details
	 * @param connection the connection
	 * @return the list
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;FurtherPaymentInDetails&gt; setFurtherPaymentInDetailList(Integer accountId,
			FurtherPaymentDetails paymentDetails, Connection connection) throws CompliancePortalException {
<span class="fc" id="L825">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L826">		ResultSet resultSet = null;</span>
<span class="fc" id="L827">		List&lt;FurtherPaymentInDetails&gt; paymentInDetailsList = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L829">			preparedStatement = connection</span>
<span class="fc" id="L830">					.prepareStatement(RegistrationQueryConstant.GET_PAYMENTINFO_FOR_ACCOUNT_SELECT.getQuery());</span>
<span class="fc" id="L831">			preparedStatement.setInt(1, accountId);</span>
<span class="fc" id="L832">			preparedStatement.setInt(2, 0);// Minrecord</span>
<span class="fc" id="L833">			preparedStatement.setInt(3, 10);// MaxRecord</span>
<span class="fc" id="L834">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc" id="L835">			Integer totalRecords = 0;</span>
<span class="fc bfc" id="L836" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L837">				FurtherPaymentInDetails paymentInDetails = new FurtherPaymentInDetails();</span>
				/**
				 * We are setting account name and number according to payment
				 * method 1) If payment method is 'SWITCH/DEBIT' then we will
				 * show Card holder name and card number on UI else account name
				 * and account number. 2)If account number is not received then
				 * we will show '-' for that.
				 */
<span class="pc bpc" id="L845" title="1 of 2 branches missed.">				if (&quot;SWITCH/DEBIT&quot;.equalsIgnoreCase(resultSet.getString(Constants.PAYMENT_METHOD_IN))) {</span>
<span class="nc" id="L846">					paymentInDetails.setAccountName(resultSet.getString(&quot;Ccfirstname&quot;));</span>
				} else {
<span class="fc" id="L848">					setDebtorName(paymentInDetails, resultSet.getString(&quot;DebtorName&quot;));</span>
				}
<span class="fc" id="L850">				String debtorAccountNumber = resultSet.getString(&quot;DebtorAccountNumber&quot;);</span>
<span class="pc bpc" id="L851" title="3 of 4 branches missed.">				if (null != debtorAccountNumber &amp;&amp; !debtorAccountNumber.isEmpty())</span>
<span class="nc" id="L852">					paymentInDetails.setAccount(debtorAccountNumber);</span>
				else
<span class="fc" id="L854">					paymentInDetails.setAccount(&quot;-&quot;);</span>
				/** Method created to set risk guardian score on UI */
<span class="fc" id="L856">				setRiskGuardianScore(paymentInDetails, resultSet.getString(&quot;RiskScore&quot;), resultSet.getString(&quot;TScore&quot;));</span>
<span class="fc" id="L857">				paymentInDetails.setAmount(StringUtils</span>
<span class="fc" id="L858">						.getNumberFormat(DecimalFormatter.convertToFourDigit(resultSet.getString(Constants.AMOUNT))));</span>
<span class="fc" id="L859">				paymentInDetails.setDateOfPayment(</span>
<span class="fc" id="L860">						DateTimeFormatter.removeTimeFromDate(resultSet.getTimestamp(Constants.DATE_OF_PAYMENT)));</span>
<span class="fc" id="L861">				paymentInDetails.setMethod(resultSet.getString(&quot;PaymentMethodin&quot;));</span>
<span class="fc" id="L862">				paymentInDetails.setSellCurrency(resultSet.getString(&quot;SellCurrency&quot;));</span>
<span class="fc" id="L863">				paymentInDetails.setTradeContractNumber(resultSet.getString(Constants.TRADE_CONTRACT_NUMBER));</span>
				//AT-1731 - SnehaZagade
<span class="fc" id="L865">				paymentInDetails.setBankName(resultSet.getString(&quot;BankName&quot;));</span>
<span class="fc" id="L866">				totalRecords = resultSet.getInt(&quot;TotalRows&quot;);</span>
<span class="fc" id="L867">				paymentInDetailsList.add(paymentInDetails);</span>
<span class="fc" id="L868">			}</span>
<span class="fc" id="L869">			paymentDetails.setPayInDetailsTotalRecords(totalRecords);</span>
<span class="fc" id="L870">			paymentDetails.setFurtherPaymentInDetails(paymentInDetailsList);</span>
<span class="nc" id="L871">		} catch (Exception e) {</span>
<span class="nc" id="L872">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L874">			closeResultset(resultSet);</span>
<span class="fc" id="L875">			closePrepareStatement(preparedStatement);</span>
		}
<span class="fc" id="L877">		return paymentInDetailsList;</span>
	}

	/**
	 * Sets the debtor name.
	 *
	 * @param paymentInDetails the payment in details
	 * @param debtorName the debtor name
	 */
	protected void setDebtorName(FurtherPaymentInDetails paymentInDetails, String debtorName) {
<span class="pc bpc" id="L887" title="3 of 4 branches missed.">		if (null != debtorName &amp;&amp; !debtorName.isEmpty())</span>
<span class="nc" id="L888">			paymentInDetails.setAccountName(debtorName);</span>
		else
<span class="fc" id="L890">			paymentInDetails.setAccountName(&quot;-&quot;);</span>
<span class="fc" id="L891">	}</span>

	/**
	 * Purpose: If tScore field of risk score is empty or null then we need to
	 * show &quot;-&quot; on UI else we will show that score.
	 * 
	 * Implementation: 1)We are checking 'tScore' field of fundsInCreateRequest.
	 * If it is null then we are setting risk score as &quot;-&quot; otherwise actual
	 * score to it.
	 * 
	 * - code changed by Vishal J
	 *
	 * @param paymentInDetails the payment in details
	 * @param riskScore the risk score
	 * @param tScore the t score
	 */
	protected void setRiskGuardianScore(FurtherPaymentInDetails paymentInDetails, String riskScore, String tScore) {
<span class="pc bpc" id="L908" title="1 of 2 branches missed.">		if (riskScore != null) {</span>
<span class="nc bnc" id="L909" title="All 4 branches missed.">			if (tScore == null || tScore.isEmpty())</span>
<span class="nc" id="L910">				paymentInDetails.setRiskGuardianScore(&quot;-&quot;);</span>
			else
<span class="nc" id="L912">				paymentInDetails.setRiskGuardianScore(tScore);</span>
		} else {
<span class="fc" id="L914">			paymentInDetails.setRiskGuardianScore(&quot;-&quot;);</span>
		}
<span class="fc" id="L916">	}</span>

	/**
	 * Sets the further payment out detail list.
	 *
	 * @param accountId the account id
	 * @param paymentDetails the payment details
	 * @param connection the connection
	 * @return the list
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;FurtherPaymentOutDetails&gt; setFurtherPaymentOutDetailList(Integer accountId,
			FurtherPaymentDetails paymentDetails, Connection connection) throws CompliancePortalException {
<span class="fc" id="L929">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L930">		ResultSet resultSet = null;</span>
<span class="fc" id="L931">		List&lt;FurtherPaymentOutDetails&gt; paymentOutDetailsList = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L933">			preparedStatement = connection</span>
<span class="fc" id="L934">					.prepareStatement(RegistrationQueryConstant.GET_PAYMENTOUTINFO_FOR_ACCOUNT_SELECT.getQuery());</span>
<span class="fc" id="L935">			preparedStatement.setInt(1, accountId);</span>
<span class="fc" id="L936">			preparedStatement.setInt(2, 0);// Minrecord</span>
<span class="fc" id="L937">			preparedStatement.setInt(3, 10);// MaxRecord</span>
<span class="fc" id="L938">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc" id="L939">			Integer totalRecords = 0;</span>
<span class="fc bfc" id="L940" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L941">				FurtherPaymentOutDetails paymentOutDetails = new FurtherPaymentOutDetails();</span>
				// change done to fetch attributes json into POJO - Vishal J
<span class="pc bpc" id="L943" title="1 of 2 branches missed.">				if (null != resultSet.getString(Constants.BENEFICIARY_LAST_NAME)</span>
<span class="pc bpc" id="L944" title="1 of 2 branches missed.">						&amp;&amp; !resultSet.getString(Constants.BENEFICIARY_LAST_NAME).isEmpty()) {</span>
<span class="fc" id="L945">					String beneficiaryName = new StringBuilder()</span>
<span class="fc" id="L946">							.append(resultSet.getString(Constants.BENEFICIARY_FIRST_NAME)).append(&quot; &quot;)</span>
<span class="fc" id="L947">							.append(resultSet.getString(Constants.BENEFICIARY_LAST_NAME)).toString();</span>
<span class="fc" id="L948">					paymentOutDetails.setAccountName(beneficiaryName);</span>

<span class="fc" id="L950">				} else {</span>
<span class="nc" id="L951">					paymentOutDetails.setAccountName(resultSet.getString(Constants.BENEFICIARY_FIRST_NAME));</span>
				}
<span class="fc" id="L953">				String accountNumber = resultSet.getString(&quot;AccountNumber&quot;);</span>
<span class="pc bpc" id="L954" title="2 of 4 branches missed.">				if (null != accountNumber &amp;&amp; !accountNumber.isEmpty()) {</span>
<span class="fc" id="L955">					paymentOutDetails.setAccount(accountNumber);</span>
				}
<span class="fc" id="L957">				paymentOutDetails.setAmount(StringUtils</span>
<span class="fc" id="L958">						.getNumberFormat(DecimalFormatter.convertToFourDigit(resultSet.getString(Constants.AMOUNT))));</span>
<span class="fc" id="L959">				paymentOutDetails.setBuyCurrency(resultSet.getString(&quot;BuyCurrency&quot;));</span>
<span class="pc bpc" id="L960" title="1 of 2 branches missed.">				if (null != resultSet.getTimestamp(Constants.DATE_OF_PAYMENT)) {</span>
<span class="fc" id="L961">					paymentOutDetails.setDateOfPayment(</span>
<span class="fc" id="L962">							DateTimeFormatter.removeTimeFromDate(resultSet.getTimestamp(Constants.DATE_OF_PAYMENT)));</span>
				} else {
<span class="nc" id="L964">					paymentOutDetails.setDateOfPayment(Constants.DASH_DETAILS_PAGE);</span>
				}
				// added by neelesh pant
<span class="fc" id="L967">				paymentOutDetails.setValuedate(DateTimeFormatter.dateFormat(resultSet.getString(&quot;MaturityDate&quot;)));</span>
<span class="fc" id="L968">				totalRecords = resultSet.getInt(&quot;TotalRows&quot;);</span>
<span class="fc" id="L969">				paymentOutDetails.setTradeContractNumber(resultSet.getString(Constants.TRADE_CONTRACT_NUMBER));</span>
<span class="pc bpc" id="L970" title="1 of 2 branches missed.">				if (null != resultSet.getString(Constants.PAYMENT_REFERENCE)</span>
<span class="nc bnc" id="L971" title="All 2 branches missed.">						&amp;&amp; !resultSet.getString(Constants.PAYMENT_REFERENCE).isEmpty()) {</span>
<span class="nc" id="L972">					paymentOutDetails.setPaymentReference(resultSet.getString(Constants.PAYMENT_REFERENCE));</span>
				}
				//AT-1731 - SnehaZagade
<span class="fc" id="L975">				paymentOutDetails.setBankName(resultSet.getString(&quot;BankName&quot;));</span>
<span class="fc" id="L976">				paymentOutDetailsList.add(paymentOutDetails);</span>
<span class="fc" id="L977">			}</span>
<span class="fc" id="L978">			paymentDetails.setPayOutDetailsTotalRecords(totalRecords);</span>
<span class="fc" id="L979">			paymentDetails.setFurtherPaymentOutDetails(paymentOutDetailsList);</span>
<span class="nc" id="L980">		} catch (Exception e) {</span>
<span class="nc" id="L981">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L983">			closeResultset(resultSet);</span>
<span class="fc" id="L984">			closePrepareStatement(preparedStatement);</span>
		}
<span class="fc" id="L986">		return paymentOutDetailsList;</span>
	}

	/**
	 * Gets the further payment details list.
	 *
	 * @param accountId the account id
	 * @param connection the connection
	 * @return the further payment details list
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected FurtherPaymentDetails getFurtherPaymentDetailsList(Integer accountId, Connection connection)
			throws CompliancePortalException {
<span class="fc" id="L999">		FurtherPaymentDetails paymentDetails = new FurtherPaymentDetails();</span>
		try {
<span class="fc" id="L1001">			setFurtherPaymentInDetailList(accountId, paymentDetails, connection);</span>
<span class="fc" id="L1002">			setFurtherPaymentOutDetailList(accountId, paymentDetails, connection);</span>
<span class="nc" id="L1003">		} catch (Exception e) {</span>
<span class="nc" id="L1004">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
<span class="fc" id="L1005">		}</span>
<span class="fc" id="L1006">		return paymentDetails;</span>
	}
	
	protected SavedSearch getSaveSearches(Integer userId,String pageType,Connection connection) throws CompliancePortalException {
<span class="fc" id="L1010">		SavedSearch savedSearchResponse = new SavedSearch();</span>
<span class="fc" id="L1011">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L1012">		ResultSet rs = null;</span>
<span class="fc" id="L1013">		List&lt;SavedSearchData&gt; saveSearch = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L1014">		savedSearchResponse.setSavedSearchData(saveSearch);</span>
		try {
<span class="fc" id="L1016">			preparedStatement = connection.prepareStatement(SavedSearchQueryConstant.GET_SAVE_SEARCH.getQuery());</span>
<span class="fc" id="L1017">			preparedStatement.setString(1,pageType);</span>
<span class="fc" id="L1018">			preparedStatement.setInt(2,userId);</span>
<span class="fc" id="L1019">			preparedStatement.executeQuery();</span>
<span class="fc" id="L1020">			rs = preparedStatement.getResultSet();</span>
<span class="fc bfc" id="L1021" title="All 2 branches covered.">			while(rs.next()) {</span>
<span class="fc" id="L1022">				SavedSearchData savedSearchData = new SavedSearchData();</span>
<span class="fc" id="L1023">				savedSearchData.setSaveSearchName(rs.getString(&quot;searchName&quot;));</span>
<span class="fc" id="L1024">				savedSearchData.setSaveSearchFilter(rs.getString(&quot;searchCriteria&quot;));</span>
<span class="fc" id="L1025">				saveSearch.add(savedSearchData);</span>
<span class="fc" id="L1026">			}</span>
		}
<span class="nc" id="L1028">		catch(Exception e) {</span>
<span class="nc" id="L1029">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		}
		finally {
<span class="fc" id="L1032">			closeResultset(rs);</span>
<span class="fc" id="L1033">			closePrepareStatement(preparedStatement);</span>
		}
<span class="fc" id="L1035">		return savedSearchResponse;</span>
	}
	
	/**
	 * Gets the legal entity.
	 *
	 * @param connection the connection
	 * @return the legal entity
	 * @throws CompliancePortalException the compliance portal exception
	 */
	protected List&lt;String&gt; getLegalEntity(Connection connection) throws CompliancePortalException {
<span class="fc" id="L1046">		PreparedStatement preparedStatement = null;</span>
<span class="fc" id="L1047">		ResultSet resultSet = null;</span>
<span class="fc" id="L1048">		List&lt;String&gt; legalEntity = new ArrayList&lt;&gt;();</span>
		try {
<span class="fc" id="L1050">			preparedStatement = connection.prepareStatement(RegistrationQueryConstant.GET_LEGAL_ENTITY.getQuery());</span>
<span class="fc" id="L1051">			resultSet = preparedStatement.executeQuery();</span>
<span class="fc bfc" id="L1052" title="All 2 branches covered.">			while (resultSet.next()) {</span>
<span class="fc" id="L1053">				legalEntity.add(resultSet.getString(RegQueDBColumns.CODE.getName()));</span>
			}

<span class="nc" id="L1056">		} catch (Exception e) {</span>
<span class="nc" id="L1057">			throw new CompliancePortalException(CompliancePortalErrors.ERROR_WHILE_FETCHING_DATA, e);</span>
		} finally {
<span class="fc" id="L1059">			closeResultset(resultSet);</span>
<span class="fc" id="L1060">			closePrepareStatement(preparedStatement);</span>
		}

<span class="fc" id="L1063">		return legalEntity;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>