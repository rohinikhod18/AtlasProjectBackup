<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HttpClientPool.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compliance-service</a> &gt; <a href="index.source.html" class="el_package">com.currenciesdirect.gtg.compliance.compliancesrv.util</a> &gt; <span class="el_source">HttpClientPool.java</span></div><h1>HttpClientPool.java</h1><pre class="source lang-java linenums">package com.currenciesdirect.gtg.compliance.compliancesrv.util;


import javax.ws.rs.client.Entity;
import javax.ws.rs.client.Invocation.Builder;
import javax.ws.rs.core.MediaType;
import javax.ws.rs.core.MultivaluedHashMap;
import javax.ws.rs.core.MultivaluedMap;
import javax.ws.rs.core.Response;

import org.jboss.resteasy.client.jaxrs.ResteasyClient;
import org.jboss.resteasy.client.jaxrs.ResteasyWebTarget;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.integration.support.MessageBuilder;
import org.springframework.messaging.Message;

import com.currenciesdirect.gtg.compliance.commons.domain.msg.ServiceMessage;
import com.currenciesdirect.gtg.compliance.commons.domain.msg.ServiceMessageResponse;
import com.currenciesdirect.gtg.compliance.compliancesrv.InternalProcessingCode;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.MessageContext;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.ServiceTypeEnum;

<span class="nc" id="L24">public final class HttpClientPool {</span>
	private static final String ERROR_CODE_URL_BASE = &quot;Error Code:{}, urlBase:{}&quot;;
<span class="nc" id="L26">	private static final Logger LOG = LoggerFactory.getLogger(HttpClientPool.class);</span>
	private String urlBase;
	private String operation;
	private String method;
	private String responseType;
	private ServiceTypeEnum serviceType;
	private Class&lt;ServiceMessage&gt; requestClass;
	private Class&lt;ServiceMessageResponse&gt; responseClass;

	/** The resteasy client handler. */
<span class="nc" id="L36">	private ResteasyClientHandler resteasyClientHandler = ResteasyClientHandler.getInstance();</span>

	public Class&lt;ServiceMessage&gt; getRequestClass() {
<span class="nc" id="L39">		return requestClass;</span>
	}

	public void setRequestClass(Class&lt;ServiceMessage&gt; requestClass) {
<span class="nc" id="L43">		this.requestClass = requestClass;</span>
<span class="nc" id="L44">	}</span>

	public Class&lt;ServiceMessageResponse&gt; getResponseClass() {
<span class="nc" id="L47">		return responseClass;</span>
	}

	public void setResponseClass(Class&lt;ServiceMessageResponse&gt; responseClass) {
<span class="nc" id="L51">		this.responseClass = responseClass;</span>
<span class="nc" id="L52">	}</span>

	public ServiceTypeEnum getServiceType() {
<span class="nc" id="L55">		return serviceType;</span>
	}

	public void setServiceType(ServiceTypeEnum serviceType) {
<span class="nc" id="L59">		this.serviceType = serviceType;</span>
<span class="nc" id="L60">	}</span>

	public String getResponseType() {
<span class="nc" id="L63">		return responseType;</span>
	}

	public void setResponseType(String responseType) {
<span class="nc" id="L67">		this.responseType = responseType;</span>
<span class="nc" id="L68">	}</span>

	public String getUrlBase() {
<span class="nc" id="L71">		return urlBase;</span>
	}

	public void setUrlBase(String urlBase) {
<span class="nc" id="L75">		this.urlBase = urlBase;</span>
<span class="nc" id="L76">	}</span>

	public String getOperation() {
<span class="nc" id="L79">		return operation;</span>
	}

	public void setOperation(String operation) {
<span class="nc" id="L83">		this.operation = operation;</span>
<span class="nc" id="L84">	}</span>

	public String getMethod() {
<span class="nc" id="L87">		return method;</span>
	}

	public void setMethod(String method) {
<span class="nc" id="L91">		this.method = method;</span>
<span class="nc" id="L92">	}</span>

	public Message&lt;MessageContext&gt; sendRequest(Message&lt;MessageContext&gt; message) {
		try {
<span class="nc bnc" id="L96" title="All 2 branches missed.">			if (message != null) {</span>
<span class="nc" id="L97">				MultivaluedMap&lt;String, Object&gt; headers = new MultivaluedHashMap&lt;&gt;();</span>
<span class="nc" id="L98">				headers.add(&quot;correlationId&quot;, message.getHeaders().get(&quot;correlationID&quot;).toString());</span>
				ServiceMessageResponse response;
<span class="nc" id="L100">				LOG.debug(&quot;serviceType:{}, urlBase:{}&quot;, serviceType, urlBase);</span>
<span class="nc" id="L101">				message.getPayload().setServiceTobeInvoked(serviceType);</span>
<span class="nc" id="L102">				response = sendRequest(urlBase, &quot;POST&quot;,</span>
<span class="nc" id="L103">						message.getPayload().getMessageExchange(serviceType).getRequest(requestClass), responseClass,</span>
						headers);
<span class="nc bnc" id="L105" title="All 4 branches missed.">				if (serviceType != null &amp;&amp; response != null) {</span>
<span class="nc" id="L106">					message.getPayload().getMessageExchange(serviceType).setResponse(response);</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">				} else if (serviceType != null) {</span>
<span class="nc" id="L108">					message.getPayload().getMessageExchange(serviceType).setResponse(null);</span>
				}
			}
<span class="nc" id="L111">		} catch (Exception e) {</span>
<span class="nc" id="L112">			LOG.error(&quot;Error :&quot;, e);</span>
<span class="nc" id="L113">			message.getPayload().setFailed(true);</span>
<span class="nc" id="L114">		}</span>
<span class="nc" id="L115">		return MessageBuilder.fromMessage(message).build();</span>
	}

	public &lt;T&gt; T sendRequest(String url, String method, Object request, Class&lt;T&gt; clazz,
			MultivaluedMap&lt;String, Object&gt; headers) {
<span class="nc" id="L120">		Response response = null;</span>
<span class="nc" id="L121">		T responseObject = null;</span>
		try {
<span class="nc" id="L123">			ResteasyClient resteasyClient = resteasyClientHandler.getRetEasyClient();</span>
<span class="nc" id="L124">			ResteasyWebTarget target = resteasyClient.target(url);</span>
<span class="nc" id="L125">			Builder clientrequest = target.request();</span>
<span class="nc bnc" id="L126" title="All 3 branches missed.">			switch (method) {</span>
			case &quot;POST&quot;:
<span class="nc" id="L128">				response = clientrequest.headers(headers).post(Entity.entity(request, MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L129">				break;</span>
			case &quot;PUT&quot;:
<span class="nc" id="L131">				response = clientrequest.put(Entity.entity(request, MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L132">				break;</span>
			default:
<span class="nc" id="L134">				response = clientrequest.get();</span>
			}
<span class="nc bnc" id="L136" title="All 4 branches missed.">			if (response.getStatus() == 200 &amp;&amp; response.hasEntity()) {</span>
<span class="nc" id="L137">				responseObject = response.readEntity(clazz);</span>
<span class="nc bnc" id="L138" title="All 2 branches missed.">			} else if (response.getStatus() == 404) {</span>
<span class="nc" id="L139">				LOG.error(ERROR_CODE_URL_BASE, InternalProcessingCode.SERVICE_UNAVAILABLE, urlBase);</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">			} else if (response.getStatus() == 500) {</span>
<span class="nc" id="L141">				LOG.error(ERROR_CODE_URL_BASE, InternalProcessingCode.INTERNAL_SERVER_ERROR, urlBase);</span>
			} else {
<span class="nc" id="L143">				LOG.error(ERROR_CODE_URL_BASE, InternalProcessingCode.SERVICE_ERROR, urlBase);</span>
			}
<span class="nc" id="L145">		} catch (Exception e) {</span>
<span class="nc" id="L146">			String logData = &quot;Exception in sendRequest() for &quot;;</span>
<span class="nc" id="L147">			logData = logData.concat(url).concat(&quot; ; &quot;).concat(e.toString());</span>
<span class="nc" id="L148">			LOG.error(logData);</span>
		} finally {
			try {
<span class="nc bnc" id="L151" title="All 2 branches missed.">				if (response != null) {</span>
<span class="nc" id="L152">					response.close();</span>
				}
<span class="nc" id="L154">			} catch (Exception e) {</span>
<span class="nc" id="L155">				String logData = &quot;Error while closing resource : &quot;;</span>
<span class="nc" id="L156">				logData = logData.concat(url).concat(&quot; ; &quot;).concat(e.toString());</span>
<span class="nc" id="L157">				LOG.error(logData);</span>
<span class="nc" id="L158">			}</span>
		}

<span class="nc" id="L161">		return responseObject;</span>
	}

	public Message&lt;MessageContext&gt; sendRequestToDataLake(Message&lt;MessageContext&gt; message) {
		try {
<span class="nc bnc" id="L166" title="All 2 branches missed.">			if (message != null) {</span>
				ServiceMessageResponse response;
<span class="nc" id="L168">				LOG.debug(&quot;serviceType:{}, urlBase:{}&quot;, serviceType, urlBase);</span>
<span class="nc" id="L169">				message.getPayload().setServiceTobeInvoked(serviceType);</span>

<span class="nc" id="L171">				String jsonMQProviderRequest = JsonConverterUtil.convertToJsonWithoutNull(message.getPayload()</span>
<span class="nc" id="L172">								.getMessageExchange(ServiceTypeEnum.SAVE_TO_BROADCAST_SERVICE).getRequest());</span>
<span class="nc" id="L173">				LOG.warn(&quot;\n -------sendRequestToDataLake mqProvider Request Start -------- \n  {}&quot;,</span>
						jsonMQProviderRequest);
<span class="nc" id="L175">				LOG.warn(&quot; \n -----------sendRequestToDataLake mqProvider Request End ---------&quot;);</span>
<span class="nc" id="L176">				response = sendRequestToDataLake(urlBase, &quot;POST&quot;, jsonMQProviderRequest);</span>
<span class="nc bnc" id="L177" title="All 2 branches missed.">				if (serviceType != null) {</span>
<span class="nc" id="L178">					message.getPayload().getMessageExchange(ServiceTypeEnum.SAVE_TO_BROADCAST_SERVICE)</span>
<span class="nc" id="L179">							.setResponse(response);</span>

				}
<span class="nc" id="L182">				message.getPayload().clearAll();</span>
			}
<span class="nc" id="L184">		} catch (Exception e) {</span>
<span class="nc" id="L185">			LOG.error(&quot;Error :&quot;, e);</span>
<span class="nc" id="L186">			message.getPayload().setFailed(true);</span>
<span class="nc" id="L187">		}</span>
<span class="nc" id="L188">		return MessageBuilder.fromMessage(message).build();</span>
	}

	public &lt;T&gt; T sendRequestToDataLake(String url, String method, String request) {
<span class="nc" id="L192">		Response response = null;</span>
<span class="nc" id="L193">		T responseObject = null;</span>
		try {
<span class="nc" id="L195">			ResteasyClient resteasyClient = resteasyClientHandler.getRetEasyClient();</span>
<span class="nc" id="L196">			ResteasyWebTarget target = resteasyClient.target(url);</span>
<span class="nc" id="L197">			Builder clientrequest = target.request();</span>
<span class="nc bnc" id="L198" title="All 3 branches missed.">			switch (method) {</span>
			case &quot;POST&quot;:
<span class="nc" id="L200">				response = clientrequest.post(Entity.entity(request, MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L201">				break;</span>
			case &quot;PUT&quot;:
<span class="nc" id="L203">				response = clientrequest.put(Entity.entity(request, MediaType.APPLICATION_JSON));</span>
<span class="nc" id="L204">				break;</span>
			default:
<span class="nc" id="L206">				response = clientrequest.get();</span>
			}
<span class="nc" id="L208">			String jsonResponse = JsonConverterUtil.convertToJsonWithoutNull(response);</span>
<span class="nc" id="L209">			LOG.warn(&quot;\n -------sendRequestToDataLake mqProvider Response Start -------- \n  {}&quot;, jsonResponse);</span>
<span class="nc" id="L210">			LOG.warn(&quot; \n -----------sendRequestToDataLake mqProvider Response End ---------&quot;);</span>
			
<span class="nc bnc" id="L212" title="All 2 branches missed.">			if (response.getStatus() == 200) {</span>
<span class="nc" id="L213">				LOG.warn(&quot;Successfully dumped into Data Lake for account ID&quot;);</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">			} else if (response.getStatus() == 404) {</span>
<span class="nc" id="L215">				LOG.error(ERROR_CODE_URL_BASE, InternalProcessingCode.SERVICE_UNAVAILABLE, urlBase);</span>
<span class="nc bnc" id="L216" title="All 2 branches missed.">			} else if (response.getStatus() == 500) {</span>
<span class="nc" id="L217">				LOG.error(ERROR_CODE_URL_BASE, InternalProcessingCode.INTERNAL_SERVER_ERROR, urlBase);</span>
			} else {
<span class="nc" id="L219">				LOG.error(ERROR_CODE_URL_BASE, InternalProcessingCode.SERVICE_ERROR, urlBase);</span>
			}
<span class="nc" id="L221">		} catch (Exception e) {</span>
<span class="nc" id="L222">			String logData = &quot;Exception in sendRequestToDataLake() for &quot;;</span>
<span class="nc" id="L223">			logData = logData.concat(url).concat(&quot; ; &quot;).concat(e.toString());</span>
<span class="nc" id="L224">			LOG.error(logData);</span>
		} finally {
			try {
<span class="nc bnc" id="L227" title="All 2 branches missed.">				if (response != null) {</span>
<span class="nc" id="L228">					response.close();</span>
				}
<span class="nc" id="L230">			} catch (Exception e) {</span>
<span class="nc" id="L231">				String logData = &quot;Error while closing resource : &quot;;</span>
<span class="nc" id="L232">				logData = logData.concat(url).concat(&quot; ; &quot;).concat(e.toString());</span>
<span class="nc" id="L233">				LOG.error(logData);</span>
<span class="nc" id="L234">			}</span>
		}

<span class="nc" id="L237">		return responseObject;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>