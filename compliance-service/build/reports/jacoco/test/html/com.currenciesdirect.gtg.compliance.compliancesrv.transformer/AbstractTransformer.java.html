<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AbstractTransformer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compliance-service</a> &gt; <a href="index.source.html" class="el_package">com.currenciesdirect.gtg.compliance.compliancesrv.transformer</a> &gt; <span class="el_source">AbstractTransformer.java</span></div><h1>AbstractTransformer.java</h1><pre class="source lang-java linenums">package com.currenciesdirect.gtg.compliance.compliancesrv.transformer;

import java.sql.Timestamp;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.currenciesdirect.gtg.compliance.commons.domain.fraugster.FraugsterBaseResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.fraugster.FraugsterSummary;
import com.currenciesdirect.gtg.compliance.commons.domain.msg.ServiceMessage;
import com.currenciesdirect.gtg.compliance.commons.domain.msg.ServiceMessageResponse;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.ITransfomer;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.ServiceStatus;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.EventServiceLog;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.MessageExchange;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.ServiceProviderEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.ServiceTypeEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.Constants;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.JsonConverterUtil;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.StringUtils;

<span class="fc" id="L22">public abstract class AbstractTransformer implements ITransfomer {</span>
	
	/** The Constant LOGGER. */
<span class="fc" id="L25">	private static final Logger LOGGER = LoggerFactory.getLogger(AbstractTransformer.class);</span>
	
	/**
	 * Creates the event service log entry.
	 *
	 * @param eventId the event id
	 * @param servceType the servce type
	 * @param providerEnum the provider enum
	 * @param entityID the entity ID
	 * @param entityVersion the entity version
	 * @param entityType the entity type
	 * @param user the user
	 * @param providerResponse the provider response
	 * @param summary the summary
	 * @return the event service log
	 */
	@SuppressWarnings(&quot;squid:S00107&quot;)
	protected EventServiceLog createEventServiceLogEntry(Integer eventId, ServiceTypeEnum servceType,
			ServiceProviderEnum providerEnum, Integer entityID, Integer entityVersion, String entityType, Integer user,
			Object providerResponse, Object summary) {

<span class="fc" id="L46">		return createEventServiceLogEntryWithStatus(eventId, servceType, providerEnum, entityID, entityVersion,</span>
				entityType, user, providerResponse, summary, ServiceStatus.NOT_PERFORMED);
	}

	
	/**
	 * Creates the event service log entry with status.
	 *
	 * @param eventId the event id
	 * @param servceType the servce type
	 * @param providerEnum the provider enum
	 * @param entityID the entity ID
	 * @param entityVersion the entity version
	 * @param entityType the entity type
	 * @param user the user
	 * @param providerResponse the provider response
	 * @param summary the summary
	 * @param serviceStatus the service status
	 * @return the event service log
	 */
	@SuppressWarnings(&quot;squid:S00107&quot;)
	protected EventServiceLog createEventServiceLogEntryWithStatus(Integer eventId, ServiceTypeEnum servceType,
			ServiceProviderEnum providerEnum, Integer entityID, Integer entityVersion, String entityType, Integer user,
			Object providerResponse, Object summary, ServiceStatus serviceStatus) {

		ServiceStatus newStatus;
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">		if(null == serviceStatus)</span>
<span class="nc" id="L73">			newStatus = ServiceStatus.NOT_PERFORMED;</span>
		else
<span class="fc" id="L75">			newStatus = serviceStatus;</span>
		
<span class="fc" id="L77">		EventServiceLog eventServiceLog = new EventServiceLog();</span>
<span class="fc" id="L78">		eventServiceLog.setServiceName(servceType.getShortName());</span>
<span class="fc" id="L79">		eventServiceLog.setServiceProviderName(providerEnum.getProvidername());</span>
<span class="fc" id="L80">		eventServiceLog.setEntityId(entityID);</span>
<span class="fc" id="L81">		eventServiceLog.setEventId(eventId);</span>
<span class="fc" id="L82">		eventServiceLog.setEntityVersion(entityVersion);</span>
<span class="fc" id="L83">		eventServiceLog.setEntityType(entityType);</span>
<span class="fc" id="L84">		eventServiceLog.setStatus(newStatus.name());</span>
<span class="fc" id="L85">		eventServiceLog.setProviderResponse(JsonConverterUtil.convertToJsonWithoutNull(providerResponse));</span>
<span class="fc" id="L86">		eventServiceLog.setSummary(JsonConverterUtil.convertToJsonWithoutNull(summary));</span>
<span class="fc" id="L87">		eventServiceLog.setCratedBy(user);</span>
<span class="fc" id="L88">		eventServiceLog.setUpdatedBy(user);</span>
<span class="fc" id="L89">		eventServiceLog.setCreatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L90">		eventServiceLog.setUpdatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="fc" id="L91">		return eventServiceLog;</span>
	}
	
	/**
	 *  Creates Eventservice log entry for NOT_REQUIRED status. changes done by Abhijit G
	 * @param eventId
	 * @param eventServiceLogs
	 * @param servceType
	 * @param providerEnum
	 * @param entityID
	 * @param entityVersion
	 * @param entityType
	 * @param user
	 * @param providerResponse
	 * @param summary
	 */
	@SuppressWarnings(&quot;squid:S00107&quot;)
	protected EventServiceLog createEventServiceLogEntryNotRequired(Integer eventId, ServiceTypeEnum servceType,
			ServiceProviderEnum providerEnum, Integer entityID, Integer entityVersion, String entityType, Integer user,
			Object providerResponse, Object summary) {

<span class="nc" id="L112">		return createEventServiceLogEntryWithStatus(eventId, servceType, providerEnum, entityID, entityVersion, entityType,</span>
				user, providerResponse, summary, ServiceStatus.NOT_REQUIRED);
	}
	
	protected MessageExchange createMessageExchange(ServiceMessage request, ServiceMessageResponse response, ServiceTypeEnum serviceType) {
<span class="fc" id="L117">		MessageExchange ccExchange = new MessageExchange();</span>
<span class="fc" id="L118">		ccExchange.setRequest(request);</span>
<span class="fc" id="L119">		ccExchange.setResponse(response);</span>
<span class="fc" id="L120">		ccExchange.setServiceTypeEnum(serviceType);</span>
<span class="fc" id="L121">		return ccExchange;</span>
	}
	
	protected void updateEventServiceLogEntry(EventServiceLog eventLog, Object summary, Object providerResponse, String status ) {
<span class="nc bnc" id="L125" title="All 2 branches missed.">		if(null != summary)</span>
<span class="nc" id="L126">			eventLog.setSummary(JsonConverterUtil.convertToJsonWithoutNull(summary));</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">		if(null != providerResponse)</span>
<span class="nc" id="L128">			eventLog.setProviderResponse(JsonConverterUtil.convertToJsonWithoutNull(providerResponse));</span>
<span class="nc" id="L129">		eventLog.setStatus(status);</span>
<span class="nc" id="L130">		eventLog.setUpdatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L131">	}</span>
	
	
	/**
	 * Purpose: 
	 * Method created to show reference ID, sanction ID on the UI
	 * 			Instead of  creating that ID every time, this method can be called by passing appropriate parameters depending upon 
	 * 			business requirement.
	 * 
	 * Implementation:
	 * 1) We are passing organization ID, entity type (CONTACT, BANK, ACCOUNT), and entity ID (ID of that entity) as
	 *    parameters.
	 * 2) Then by manipulating them we will make a respective ID in the format &quot;orgID-character-entityID&quot; 
	 *    which can be shown on UI
	 * @param orgID
	 * @param entityType
	 * @param entityID
	 * @return refernce ID in the format &quot;orgID-character-entityID&quot; (Eg. 001-C-0000237894)
	 */
	protected String createReferenceId(String orgID, String entityType, String entityID) {
<span class="nc" id="L151">		StringBuilder referenceID = new StringBuilder();</span>
	
		try{
<span class="nc" id="L154">			String orgId = StringUtils.leftPadWithZero(3, orgID);</span>
<span class="nc" id="L155">			String ch = &quot;&quot;;</span>
			
			/*
			 * If entity is
			 * Contact then set 'C'
			 * Account then set 'A'
			 * Bank then set 'B'
			 * Beneficiary then set 'P'
			 * Debtor then set 'D'
			 */
			
<span class="nc bnc" id="L166" title="All 6 branches missed.">			switch(entityType.toUpperCase().trim()){</span>
			case Constants.ENTITY_TYPE_CONTACT:
<span class="nc" id="L168">				ch = &quot;-C-&quot;;</span>
<span class="nc" id="L169">				break;</span>
			case Constants.ENTITY_TYPE_ACCOUNT:
<span class="nc" id="L171">				ch = &quot;-A-&quot;;</span>
<span class="nc" id="L172">				break;</span>
			case Constants.ENTITY_TYPE_BENEFICIARY:
<span class="nc" id="L174">				ch = &quot;-P-&quot;;</span>
<span class="nc" id="L175">				break;</span>
			case Constants.ENTITY_TYPE_BANK:
<span class="nc" id="L177">				ch = &quot;-B-&quot;;</span>
<span class="nc" id="L178">				break;</span>
			case Constants.ENTITY_TYPE_DEBTOR:
<span class="nc" id="L180">				ch = &quot;-D-&quot;;</span>
<span class="nc" id="L181">				break;</span>
			default:
				break;
			}
			
<span class="nc" id="L186">			String id = StringUtils.leftPadWithZero(10, entityID);</span>
<span class="nc" id="L187">			referenceID.append(orgId).append(ch).append(id);</span>
<span class="nc" id="L188">			return referenceID.toString();</span>
		}		
<span class="nc" id="L190">		catch (Exception e) {</span>
<span class="nc" id="L191">			LOGGER.error(&quot;{1}&quot;,e);</span>
<span class="nc" id="L192">			throw e;</span>
		}
	}
	
	/**
	 * Read response.
	 *
	 * @param eventServiceLog the event service log
	 * @param frgTransId the frg trans id
	 * @param score the score
	 * @param poc the poc
	 * @param status the status
	 * @param responseJson the response json
	 * @param errorCode the error code
	 * @param errorDesc the error desc
	 */
	protected void readResponse(EventServiceLog eventServiceLog, FraugsterBaseResponse baseResponse) {

<span class="nc" id="L210">		FraugsterSummary fraugsterSummary = JsonConverterUtil.convertToObject(FraugsterSummary.class,</span>
<span class="nc" id="L211">				eventServiceLog.getSummary());</span>
		try {
<span class="nc bnc" id="L213" title="All 2 branches missed.">			if (baseResponse.getErrorCode() != null) {</span>
<span class="nc" id="L214">				fraugsterSummary.setErrorCode(baseResponse.getErrorCode());</span>
<span class="nc" id="L215">				fraugsterSummary.setErrorDescription(baseResponse.getErrorDescription());</span>
			}
<span class="nc" id="L217">			fraugsterSummary.setFrgTransId(baseResponse.getFrgTransId());</span>
			
<span class="nc" id="L219">			setScoreInFraugsterSummaryByProvider(baseResponse, fraugsterSummary);</span>
			
<span class="nc" id="L221">			fraugsterSummary.setFraugsterApproved(baseResponse.getFraugsterApproved());</span>
<span class="nc" id="L222">			fraugsterSummary.setStatus(baseResponse.getStatus());</span>
<span class="nc" id="L223">			eventServiceLog.setProviderResponse(JsonConverterUtil.convertToJsonWithoutNull(baseResponse));</span>
<span class="nc" id="L224">			eventServiceLog.setStatus(baseResponse.getStatus());</span>
<span class="nc" id="L225">			eventServiceLog.setSummary(JsonConverterUtil.convertToJsonWithoutNull(fraugsterSummary));</span>
<span class="nc" id="L226">			eventServiceLog.setUpdatedOn(new Timestamp(System.currentTimeMillis()));</span>
			
<span class="nc" id="L228">		} catch (Exception e) {</span>
<span class="nc" id="L229">			LOGGER.error(&quot;Error in reading Fraugster response&quot;, e);</span>
<span class="nc" id="L230">			fraugsterSummary.setStatus(ServiceStatus.SERVICE_FAILURE.name());</span>
<span class="nc" id="L231">			eventServiceLog.setStatus(ServiceStatus.SERVICE_FAILURE.name());</span>
<span class="nc" id="L232">			eventServiceLog.setSummary(JsonConverterUtil.convertToJsonWithoutNull(fraugsterSummary));</span>
<span class="nc" id="L233">			eventServiceLog.setUpdatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L234">		}</span>
<span class="nc" id="L235">	}</span>


	/**
	 * Sets the score in fraugster summary by provider.
	 *
	 * @param baseResponse the base response
	 * @param fraugsterSummary the fraugster summary
	 */
	private void setScoreInFraugsterSummaryByProvider(FraugsterBaseResponse baseResponse,
			FraugsterSummary fraugsterSummary) {
<span class="nc bnc" id="L246" title="All 2 branches missed.">		if(&quot;Fraugster&quot;.equalsIgnoreCase(System.getProperty(&quot;fraugster.service.provider&quot;))) {</span>
<span class="nc bnc" id="L247" title="All 2 branches missed.">			if(null == baseResponse.getScore())</span>
<span class="nc" id="L248">				fraugsterSummary.setScore(ServiceStatus.NOT_PERFORMED.name());</span>
			else
<span class="nc" id="L250">			    fraugsterSummary.setScore(baseResponse.getScore());</span>
		} else {
<span class="nc bnc" id="L252" title="All 2 branches missed.">			if(null == baseResponse.getPercentageFromThreshold())</span>
<span class="nc" id="L253">				fraugsterSummary.setScore(ServiceStatus.NOT_PERFORMED.name());</span>
			else
<span class="nc" id="L255">			    fraugsterSummary.setScore(baseResponse.getPercentageFromThreshold());</span>
		}
<span class="nc" id="L257">	}</span>
	
	protected void createEventServiceLogForServiceFailureWithFraugsterID(EventServiceLog eventServiceLog, Object response, String fraugsterID ){
<span class="nc" id="L260">		FraugsterSummary fraugsterSummery = new FraugsterSummary();</span>
<span class="nc" id="L261">		fraugsterSummery.setStatus(ServiceStatus.SERVICE_FAILURE.name());</span>
<span class="nc" id="L262">		fraugsterSummery.setCreatedOn(new Timestamp(System.currentTimeMillis()).toString());</span>
		
<span class="nc" id="L264">		fraugsterSummery.setFraugsterId(fraugsterID);</span>
<span class="nc" id="L265">		eventServiceLog.setStatus(ServiceStatus.SERVICE_FAILURE.name());</span>
<span class="nc" id="L266">		eventServiceLog.setSummary(JsonConverterUtil.convertToJsonWithoutNull(fraugsterSummery));</span>
<span class="nc" id="L267">		eventServiceLog.setProviderResponse(JsonConverterUtil.convertToJsonWithoutNull(response));</span>
<span class="nc" id="L268">	}</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>