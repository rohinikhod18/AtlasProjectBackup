<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>IntuitionHistoricPaymentInTransformer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compliance-service</a> &gt; <a href="index.source.html" class="el_package">com.currenciesdirect.gtg.compliance.compliancesrv.transformer.fundsin</a> &gt; <span class="el_source">IntuitionHistoricPaymentInTransformer.java</span></div><h1>IntuitionHistoricPaymentInTransformer.java</h1><pre class="source lang-java linenums">package com.currenciesdirect.gtg.compliance.compliancesrv.transformer.fundsin;

import java.util.ArrayList;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.Message;

import com.currenciesdirect.gtg.compliance.commons.domain.fundsin.request.FundsInCreateRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.transactionmonitoring.IntuitionHistoricPaymentsRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.transactionmonitoring.IntuitionHistoricPaymentRequest;
import com.currenciesdirect.gtg.compliance.compliancesrv.ComplianceException;
import com.currenciesdirect.gtg.compliance.compliancesrv.InternalProcessingCode;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.intuitionpaymentcsv.IntuitionHistoricPaymentEmailAlert;
import com.currenciesdirect.gtg.compliance.compliancesrv.dbport.FundsInDBServiceImpl;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.MessageContext;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.MessageExchange;
import com.currenciesdirect.gtg.compliance.compliancesrv.transformer.AbstractTransformer;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.Constants;

<span class="nc" id="L23">public class IntuitionHistoricPaymentInTransformer extends AbstractTransformer {</span>

	/** The Constant LOG. */
<span class="nc" id="L26">	private static final Logger LOG = LoggerFactory.getLogger(IntuitionHistoricPaymentInTransformer.class);</span>

	/** The funds in DB service impl. */
	@Autowired
	protected FundsInDBServiceImpl fundsInDBServiceImpl;

	/** The Constant CFXETAILER. */
	private static final String CFXETAILER = &quot;CFX-Etailer&quot;;

	/** The Constant CHARACTER. */
	private static final String CHARACTER = &quot;[\r\n]|[\t+]&quot;;
	
	/** The email alert. */
	@Autowired
	private IntuitionHistoricPaymentEmailAlert emailAlert;
	
	/** The Constant EMAIL_BODY_DATE_FORMAT. */
	private static final String EMAIL_BODY_DATE_FORMAT = &quot;yyyy-MM-dd&quot;;

	@Override
	public Message&lt;MessageContext&gt; transformRequest(Message&lt;MessageContext&gt; message) {
<span class="nc" id="L47">		MessageExchange messageExchange = message.getPayload().getGatewayMessageExchange();</span>
<span class="nc" id="L48">		IntuitionHistoricPaymentsRequest intuitionPaymentRequest = (IntuitionHistoricPaymentsRequest) messageExchange.getRequest();</span>
<span class="nc" id="L49">		List&lt;IntuitionHistoricPaymentRequest&gt; intuitionPaymentInRequest = new ArrayList&lt;&gt;();</span>
		try {
<span class="nc" id="L51">			List&lt;FundsInCreateRequest&gt; fundsInRequest = fundsInDBServiceImpl.getIntuitionHistoricPaymentIn();</span>
<span class="nc" id="L52">			setDataForHistoricPaymentIn(fundsInRequest, intuitionPaymentInRequest);</span>
<span class="nc" id="L53">			intuitionPaymentRequest.setIntuitionHistoricPaymentInRequest(intuitionPaymentInRequest);</span>
<span class="nc" id="L54">		} catch (Exception e) {</span>
<span class="nc" id="L55">			LOG.error(&quot;Error in IntuitionHistoricPaymentInTransformer transformRequest() : &quot;, e);</span>
<span class="nc" id="L56">			message.getPayload().setFailed(true);</span>
<span class="nc" id="L57">		}</span>
<span class="nc" id="L58">		return message;</span>
	}

	private void setDataForHistoricPaymentIn(List&lt;FundsInCreateRequest&gt; fundsInRequests,
			List&lt;IntuitionHistoricPaymentRequest&gt; intuitionPaymentInRequests) throws ComplianceException {
		try {
<span class="nc bnc" id="L64" title="All 2 branches missed.">			for (FundsInCreateRequest request : fundsInRequests) {</span>
<span class="nc" id="L65">				IntuitionHistoricPaymentRequest intuitionHistoricPaymentRequest = new IntuitionHistoricPaymentRequest();</span>
<span class="nc" id="L66">				intuitionHistoricPaymentRequest.setTradeIdentificationNumber(</span>
<span class="nc" id="L67">						request.getTrade().getContractNumber() + &quot;_&quot; + request.getFundsInId());</span>
<span class="nc" id="L68">				intuitionHistoricPaymentRequest.setTradeContractNumber(request.getTrade().getContractNumber());</span>
<span class="nc" id="L69">				intuitionHistoricPaymentRequest.setTradePaymentID(request.getTrade().getPaymentFundsInId().toString());</span>
<span class="nc" id="L70">				intuitionHistoricPaymentRequest.setTradeAccountNumber(request.getTradeAccountNumber());</span>
<span class="nc" id="L71">				intuitionHistoricPaymentRequest.setTimestamp(request.getTrade().getPaymentTime());</span>
<span class="nc" id="L72">				String etailer = (String) request.getAdditionalAttribute(Constants.ETAILER);</span>
<span class="nc bnc" id="L73" title="All 4 branches missed.">				if (etailer != null &amp;&amp; etailer.equalsIgnoreCase(&quot;true&quot;)) {</span>
<span class="nc" id="L74">					intuitionHistoricPaymentRequest.setCustType(CFXETAILER);</span>
				} else {
<span class="nc" id="L76">					intuitionHistoricPaymentRequest.setCustType(request.getCustType());</span>
				}
<span class="nc" id="L78">				intuitionHistoricPaymentRequest.setPurposeOfTrade(request.getTrade().getPurposeOfTrade());</span>
<span class="nc" id="L79">				intuitionHistoricPaymentRequest.setSellingAmount(request.getTrade().getSellingAmount());</span>
<span class="nc" id="L80">				intuitionHistoricPaymentRequest.setTransactionCurrency(request.getTrade().getTransactionCurrency());</span>
<span class="nc" id="L81">				intuitionHistoricPaymentRequest.setCustomerLegalEntity(request.getTrade().getCustLegalEntity());</span>
<span class="nc" id="L82">				intuitionHistoricPaymentRequest.setPaymentMethod(request.getTrade().getPaymentMethod());</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">				intuitionHistoricPaymentRequest.setDebtorName((request.getTrade().getDebtorName() == null</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">						|| request.getTrade().getDebtorName().trim().isEmpty()) ? &quot;--&quot;</span>
<span class="nc" id="L85">								: request.getTrade().getDebtorName().replaceAll(CHARACTER, &quot; &quot;).replaceAll(&quot;\&quot;+&quot;, &quot;&quot;));</span>
<span class="nc" id="L86">				intuitionHistoricPaymentRequest</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">						.setDebtorAccountNumber((request.getTrade().getDebtorAccountNumber() == null</span>
<span class="nc bnc" id="L88" title="All 2 branches missed.">								|| request.getTrade().getDebtorAccountNumber().trim().isEmpty()) ? &quot;--&quot;</span>
<span class="nc" id="L89">										: request.getTrade().getDebtorAccountNumber());</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">				intuitionHistoricPaymentRequest.setBillAddressLine((request.getTrade().getBillAddressLine() != null)</span>
<span class="nc" id="L91">						? request.getTrade().getBillAddressLine().replaceAll(CHARACTER, &quot; &quot;).replaceAll(&quot;\&quot;+&quot;, &quot;&quot;)</span>
						: null);
<span class="nc bnc" id="L93" title="All 2 branches missed.">				intuitionHistoricPaymentRequest.setCountryOfFund((request.getTrade().getCountryOfFund() == null</span>
<span class="nc bnc" id="L94" title="All 2 branches missed.">						|| request.getTrade().getCountryOfFund().trim().isEmpty()) ? &quot;--&quot;</span>
<span class="nc" id="L95">								: request.getTrade().getCountryOfFund());</span>
<span class="nc" id="L96">				intuitionHistoricPaymentRequest.setTradeContactId(request.getTrade().getTradeContactId().toString());</span>
<span class="nc" id="L97">				intuitionHistoricPaymentRequest.setTrxType(&quot;FUNDSIN&quot;);</span>
<span class="nc" id="L98">				intuitionHistoricPaymentRequest.setContractNumber(request.getTrade().getContractNumber());</span>
<span class="nc" id="L99">				intuitionHistoricPaymentRequest</span>
<span class="nc" id="L100">						.setSellingAmountBaseValue(request.getTrade().getSellingAmountBaseValue());</span>
<span class="nc" id="L101">				intuitionHistoricPaymentRequest.setThirdPartyPayment(request.getTrade().getThirdPartyPayment());</span>

<span class="nc bnc" id="L103" title="All 2 branches missed.">				intuitionHistoricPaymentRequest.setCcFirstName((request.getTrade().getCcFirstName() != null)</span>
<span class="nc" id="L104">						? request.getTrade().getCcFirstName().replaceAll(CHARACTER, &quot; &quot;).replaceAll(&quot;\&quot;+&quot;, &quot;&quot;)</span>
						: null);
<span class="nc" id="L106">				intuitionHistoricPaymentRequest.setBillAdZip(request.getTrade().getBillAdZip());</span>
<span class="nc" id="L107">				intuitionHistoricPaymentRequest.setIsThreeds(request.getTrade().getIsThreeds());</span>
<span class="nc" id="L108">				intuitionHistoricPaymentRequest.setAvsResult(request.getTrade().getAvsResult());</span>
<span class="nc" id="L109">				intuitionHistoricPaymentRequest.setDebitCardAddedDate(request.getTrade().getDebitCardAddedDate());</span>
<span class="nc" id="L110">				intuitionHistoricPaymentRequest</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">						.setVersion(request.getVersion() != null ? request.getVersion().toString() : null);</span>
<span class="nc" id="L112">				intuitionHistoricPaymentRequest.setCVCCVVResult(request.getTrade().getCvcResult());</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">				if (request.getRiskScore() != null) {</span>
<span class="nc" id="L114">					setRiskScoreData(request, intuitionHistoricPaymentRequest);</span>
				}
<span class="nc bnc" id="L116" title="All 2 branches missed.">				if (request.getFraudSight() != null) {</span>
<span class="nc" id="L117">					intuitionHistoricPaymentRequest.setFraudsightReason(request.getFraudSight().getFsReasonCodes());</span>
<span class="nc" id="L118">					intuitionHistoricPaymentRequest.setFraudsightRiskLevel(request.getFraudSight().getFsMessage());</span>
				}
<span class="nc bnc" id="L120" title="All 2 branches missed.">				if (request.getDeviceInfo() != null) {</span>
<span class="nc" id="L121">					setDeviceInfoData(request, intuitionHistoricPaymentRequest);</span>
				}
<span class="nc" id="L123">				setAllChecksStatusData(request, intuitionHistoricPaymentRequest);</span>
<span class="nc" id="L124">				intuitionHistoricPaymentRequest.setAtlasSTPCodes((String) request.getAdditionalAttribute(&quot;STPFlag&quot;));</span>
<span class="nc" id="L125">				intuitionHistoricPaymentRequest.setUpdateStatus((String) request.getAdditionalAttribute(&quot;status&quot;));</span>
				
<span class="nc" id="L127">				intuitionHistoricPaymentRequest.setAccountId(request.getAccId());</span>
				
<span class="nc" id="L129">				intuitionPaymentInRequests.add(intuitionHistoricPaymentRequest);</span>
<span class="nc" id="L130">			}</span>
<span class="nc" id="L131">		} catch (Exception e) {</span>
<span class="nc" id="L132">			LOG.error(&quot;Error in IntuitionHistoricPaymentInTransformer setDataForHistoricPaymentIn() : &quot;, e);</span>
			
<span class="nc" id="L134">			emailAlert.sendEmailAlertForHistoricPaymentError(</span>
					&quot;Intuition Historic Payment In upload error - batch file generation&quot;,
					&quot;Intuition (Transaction monitoring) Historical Payment In upload failed due to batch file generation error on &quot;
<span class="nc" id="L137">							+ new java.text.SimpleDateFormat(EMAIL_BODY_DATE_FORMAT).format(new java.util.Date())</span>
							+ &quot;. Please alert compliance officer.&quot;);
			
<span class="nc" id="L140">			throw new ComplianceException(InternalProcessingCode.SERVICE_ERROR, e);</span>
<span class="nc" id="L141">		}</span>

<span class="nc" id="L143">	}</span>

	private void setDeviceInfoData(FundsInCreateRequest request,
			IntuitionHistoricPaymentRequest intuitionHistoricPaymentRequest) {
<span class="nc" id="L147">		intuitionHistoricPaymentRequest.setBrwsrType(request.getDeviceInfo().getBrowserName());</span>
<span class="nc" id="L148">		intuitionHistoricPaymentRequest.setBrwsrVersion(request.getDeviceInfo().getBrowserMajorVersion());</span>
<span class="nc" id="L149">		intuitionHistoricPaymentRequest.setBrwsrLang(request.getDeviceInfo().getBrowserLanguage());</span>
<span class="nc" id="L150">		intuitionHistoricPaymentRequest.setBrowserOnline(request.getDeviceInfo().getBrowserOnline());</span>
<span class="nc" id="L151">		intuitionHistoricPaymentRequest.setDeviceName(request.getDeviceInfo().getDeviceName());</span>
<span class="nc" id="L152">		intuitionHistoricPaymentRequest.setDeviceVersion(request.getDeviceInfo().getDeviceVersion());</span>
<span class="nc" id="L153">		intuitionHistoricPaymentRequest.setDeviceId(request.getDeviceInfo().getDeviceId());</span>
<span class="nc" id="L154">		intuitionHistoricPaymentRequest.setDeviceManufacturer(request.getDeviceInfo().getDeviceManufacturer());</span>
<span class="nc" id="L155">		intuitionHistoricPaymentRequest.setDeviceType(request.getDeviceInfo().getDeviceType());</span>
<span class="nc" id="L156">		intuitionHistoricPaymentRequest.setOsType(request.getDeviceInfo().getOsName());</span>
<span class="nc" id="L157">		intuitionHistoricPaymentRequest.setScreenResolution(request.getDeviceInfo().getScreenResolution());</span>
<span class="nc" id="L158">	}</span>

	private void setAllChecksStatusData(FundsInCreateRequest request,
			IntuitionHistoricPaymentRequest intuitionHistoricPaymentRequest) throws ComplianceException {
<span class="nc" id="L162">		intuitionHistoricPaymentRequest.setBlacklist((String) request.getAdditionalAttribute(&quot;BLACKLIST_STATUS&quot;));</span>
<span class="nc" id="L163">		intuitionHistoricPaymentRequest.setSanctionsContact((String) request.getAdditionalAttribute(&quot;SANCTION_STATUS&quot;));</span>
<span class="nc" id="L164">		intuitionHistoricPaymentRequest.setCustomCheck((String) request.getAdditionalAttribute(&quot;CUSTOM_CHECK_STATUS&quot;));</span>
<span class="nc" id="L165">		intuitionHistoricPaymentRequest.setFraudPredict((String) request.getAdditionalAttribute(&quot;FRAUGSTER_STATUS&quot;));</span>

<span class="nc" id="L167">		String countryCheckStatus = fundsInDBServiceImpl.getCountryCheckStatus(request);</span>
<span class="nc" id="L168">		intuitionHistoricPaymentRequest.setCountryCheck(countryCheckStatus);</span>

<span class="nc" id="L170">		String statusUpdateReason = fundsInDBServiceImpl.getPaymentInStatusUpdateReason(request);</span>
<span class="nc" id="L171">		intuitionHistoricPaymentRequest.setStatusUpdateReason(statusUpdateReason);</span>

<span class="nc" id="L173">		List&lt;String&gt; watchList = fundsInDBServiceImpl.getContactWatchlist(request.getContactId());</span>
<span class="nc" id="L174">		intuitionHistoricPaymentRequest.setWatchlist(watchList.toString());</span>
<span class="nc" id="L175">	}</span>

	private void setRiskScoreData(FundsInCreateRequest request,
			IntuitionHistoricPaymentRequest intuitionHistoricPaymentRequest) {
<span class="nc" id="L179">		intuitionHistoricPaymentRequest.setMessage(request.getRiskScore().getMessage());</span>
<span class="nc" id="L180">		intuitionHistoricPaymentRequest.setRGID(request.getRiskScore().getRGID());</span>
<span class="nc bnc" id="L181" title="All 2 branches missed.">		if (request.getRiskScore().getTScore() != null)</span>
<span class="nc" id="L182">			intuitionHistoricPaymentRequest.settScore(request.getRiskScore().getTScore());</span>
<span class="nc bnc" id="L183" title="All 2 branches missed.">		if (request.getRiskScore().getTRisk() != null)</span>
<span class="nc" id="L184">			intuitionHistoricPaymentRequest.settRisk(request.getRiskScore().getTRisk().toString());</span>
<span class="nc" id="L185">	}</span>

	@Override
	public Message&lt;MessageContext&gt; transformResponse(Message&lt;MessageContext&gt; message) {

<span class="nc" id="L190">		return message;</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>