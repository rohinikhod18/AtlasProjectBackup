<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FundsOutDBServiceImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compliance-service</a> &gt; <a href="index.source.html" class="el_package">com.currenciesdirect.gtg.compliance.compliancesrv.dbport</a> &gt; <span class="el_source">FundsOutDBServiceImpl.java</span></div><h1>FundsOutDBServiceImpl.java</h1><pre class="source lang-java linenums">package com.currenciesdirect.gtg.compliance.compliancesrv.dbport;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.sql.Timestamp;
import java.text.DecimalFormat;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

import org.apache.commons.collections.MultiHashMap;
import org.apache.commons.collections.MultiMap;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.messaging.Message;

import com.currenciesdirect.gtg.compliance.commons.domain.DeviceInfo;
import com.currenciesdirect.gtg.compliance.commons.domain.fraugster.FraugsterPaymentsOutResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.fraugster.FundsOutFruagsterResendRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.fundsout.request.FundsOutBaseRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.fundsout.request.FundsOutDeleteRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.fundsout.request.FundsOutRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.fundsout.request.FundsOutUpdateRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.FundsOutBlacklistResendRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.FundsOutPaymentReferenceResendRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.InternalServiceResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.sanction.FundsOutSanctionResendRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.sanction.ReprocessFailedSanctionRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.sanction.SanctionResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.sanction.SanctionUpdateRequest;
import com.currenciesdirect.gtg.compliance.commons.domain.transactionmonitoring.TransactionMonitoringPaymentOutResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.transactionmonitoring.TransactionMonitoringPaymentsOutRequest;
import com.currenciesdirect.gtg.compliance.commons.util.StringUtils;
import com.currenciesdirect.gtg.compliance.compliancesrv.ComplianceException;
import com.currenciesdirect.gtg.compliance.compliancesrv.InternalProcessingCode;
import com.currenciesdirect.gtg.compliance.compliancesrv.MessageContextHeaders;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.EntityEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.OperationEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.ServiceInterfaceType;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.ServiceStatus;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.WatchList;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.fundsout.FundsOutComplianceStatus;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.UserProfile;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.customchecks.response.CustomCheckResendResponse;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.fundsout.response.FundsOutResponse;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.Account;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.Contact;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.EventServiceLog;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.MessageContext;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.MessageExchange;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.ServiceTypeEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.Constants;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.DateTimeFormatter;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.JsonConverterUtil;

/**
 * The Class FundsOutDBServiceImpl.
 */
@SuppressWarnings(&quot;squid:S2095&quot;)
<span class="nc" id="L64">public class FundsOutDBServiceImpl extends PaymentsAbstractDao {</span>
	
	/** The Constant LOG. */
<span class="nc" id="L67">	private static final Logger LOG = LoggerFactory.getLogger(FundsOutDBServiceImpl.class);</span>

	public static final String ENTITY_TYPE = &quot;EntityType&quot;;
	private static final String ACCOUNTID = &quot;accountid&quot;;
	private static final String EXCEPTION_IN_SAVE_FUNDS_OUT_REQUEST = &quot;Exception in saveFundsOutRequest()&quot;;
	private static final String WATCHLISTREASONNAME = &quot;watchlistreasonname&quot;;
	private static final String REASONS_OF_WATCHLIST = &quot;reasonsOfWatchlist&quot;;
	private static final String PO_ATTRIB =&quot;POAttrib&quot;;
	private static final String CONTACT_ID =&quot;ContactID&quot;;
	private static final String PO_COMPLIANCE_STATUS =&quot;POComplianceStatus&quot;;
	private static final String ACCOUNT = &quot;account&quot;;
	private static final String CONTACTID =&quot;contactid&quot;;
	private static final String CONTACT=&quot;contact&quot;;
	private static final String WATCHLIST_ID=&quot;watchlistid&quot;;
	private static final String BLACKLIST_STATUS = &quot;BlacklistStatus&quot;;
	
	/** The Constant FUNDS_OUT_ID. */
	private static final String FUNDS_OUT_ID = &quot;fundsoutId&quot;;
	
	/** The Constant TRADE_CONTACT_ID. */
	private static final String TRADE_CONTACT_ID = &quot;TradeContactID&quot;;
	
	/** The Constant ACCOUNT_TM_FLAG. */
	private static final String ACCOUNT_TM_FLAG = &quot;AccountTMFlag&quot;;
	
	/** The Constant CLIENT_RISK_LEVEL. */
	private static final String CLIENT_RISK_LEVEL = &quot;ClientRiskLevel&quot;;
	
	/** The Constant FRAUGSTER_STATUS. */
	private static final String FRAUGSTER_STATUS = &quot;FraugsterStatus&quot;;
	
	/** The Constant CUSTOM_CHECK_STATUS. */
	private static final String CUSTOM_CHECK_STATUS = &quot;CustomCheckStatus&quot;;
	
	/** The Constant PAYMENT_REFERENCE_STATUS. */
	private static final String PAYMENT_REFERENCE_STATUS = &quot;PaymentReferenceStatus&quot;;
	
	/** The Constant COMPLIANCE_STATUS. */
	private static final String COMPLIANCE_STATUS = &quot;ComplianceStatus&quot;;
	
	/** The Constant ACCOUNT_VERSION. */
	private static final String ACCOUNT_VERSION = &quot;AccountVersion&quot;;
	
	/**
	 * Does funds out exists.
	 *
	 * @param paymentFundsoutId
	 *            the payment fundsout id
	 * @return the integer
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public Integer doesFundsOutExists(Integer paymentFundsoutId) throws ComplianceException {
<span class="nc" id="L120">		Connection conn = null;</span>
<span class="nc" id="L121">		PreparedStatement poStatment = null;</span>
<span class="nc" id="L122">		ResultSet poRS = null;</span>
		try {
<span class="nc" id="L124">			conn = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L125">			poStatment = conn.prepareStatement(DBQueryConstant.DOES_FUNDS_OUT_EXIST.getQuery());</span>
<span class="nc" id="L126">			poStatment.setInt(1, paymentFundsoutId);</span>

<span class="nc" id="L128">			poRS = poStatment.executeQuery();</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">			if (poRS.next()) {</span>
<span class="nc" id="L130">				return poRS.getInt(1);</span>
			}

<span class="nc" id="L133">			closeResultset(poRS);</span>
<span class="nc" id="L134">		} catch (Exception e) {</span>
<span class="nc" id="L135">			LOG.error(&quot;&quot;, e);</span>
		} finally {
<span class="nc" id="L137">			closeResultset(poRS);</span>
<span class="nc" id="L138">			closePrepareStatement(poStatment);</span>
<span class="nc" id="L139">			closeConnection(conn);</span>
		}
<span class="nc" id="L141">		return null;</span>
	}

	/**
	 * Following method calls two function which returns whether for given
	 * trade account number &amp; organization account &amp; contact is present and
	 * whether for given organization funds out id is present.
	 *
	 * @param fundsOutBaseRequest
	 *            the funds out base request
	 * @return the funds out details
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public FundsOutRequest getFundsOutDetails(FundsOutBaseRequest fundsOutBaseRequest) throws ComplianceException {
<span class="nc" id="L156">		Connection conn = null;</span>
<span class="nc" id="L157">		FundsOutRequest details = new FundsOutRequest();</span>
		try {
<span class="nc" id="L159">			conn = getConnection(Boolean.TRUE);</span>

<span class="nc bnc" id="L161" title="All 2 branches missed.">			if(fundsOutBaseRequest instanceof FundsOutSanctionResendRequest){</span>
<span class="nc" id="L162">				FundsOutSanctionResendRequest resendRequest=(FundsOutSanctionResendRequest)fundsOutBaseRequest;</span>
<span class="nc" id="L163">				details = getExistingFundsOutId(conn, fundsOutBaseRequest.getOrgCode(),</span>
<span class="nc" id="L164">						resendRequest.getTradePaymentId());</span>
<span class="nc" id="L165">			}else{</span>
<span class="nc" id="L166">				details = getExistingFundsOutId(conn, fundsOutBaseRequest.getOrgCode(),</span>
<span class="nc" id="L167">						fundsOutBaseRequest.getPaymentFundsoutId());</span>
			}
			
<span class="nc" id="L170">			getFundsOutContactAccountDetails(details, conn, fundsOutBaseRequest.getTradeAccountNumber(),</span>
<span class="nc" id="L171">					fundsOutBaseRequest.getOrgCode());</span>

<span class="nc" id="L173">		} catch (Exception e) {</span>
<span class="nc" id="L174">			LOG.error(&quot;&quot;, e);</span>
		} finally {
<span class="nc" id="L176">			closeConnection(conn);</span>
		}
<span class="nc" id="L178">		return details;</span>
	}
	
	
	
	/**
	 * Following method calls two functions which returns whether for given
	 * trade account number &amp; organization account &amp; contact is present and
	 * whether for given organization funds out id is present.
	 *
	 * @param fundsOutBaseRequest
	 *            the funds out base request
	 * @return the funds out details
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public FundsOutRequest getFundsOutDetailsForBlacklistRepeatCheck(FundsOutBaseRequest fundsOutBaseRequest) throws ComplianceException {
<span class="nc" id="L195">		Connection conn = null;</span>
<span class="nc" id="L196">		FundsOutRequest details = new FundsOutRequest();</span>
		try {
<span class="nc" id="L198">			   conn = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L199">               details = getExistingFundsOutIdForBlacklistRepeatCheck(conn, fundsOutBaseRequest.getOrgCode(),</span>
<span class="nc" id="L200">						fundsOutBaseRequest.getPaymentFundsoutId());</span>
<span class="nc" id="L201">			   getFundsOutContactAccountDetails(details, conn, fundsOutBaseRequest.getTradeAccountNumber(),</span>
<span class="nc" id="L202">					fundsOutBaseRequest.getOrgCode());</span>

<span class="nc" id="L204">		} catch (Exception e) {</span>
<span class="nc" id="L205">			LOG.error(&quot;&quot;, e);</span>
		} finally {
<span class="nc" id="L207">			closeConnection(conn);</span>
		}
<span class="nc" id="L209">		return details;</span>
	}
	
	private FundsOutRequest getExistingFundsOutIdForBlacklistRepeatCheck(Connection conn, String orgCode, Integer fundsOutId)
			throws ComplianceException {

<span class="nc" id="L215">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L216">		ResultSet rs = null;</span>
<span class="nc" id="L217">		FundsOutRequest details = new FundsOutRequest();</span>
		try {
<span class="nc" id="L219">			preparedStatment = conn.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_ID_FOR_BLACKLIST.getQuery());</span>
<span class="nc" id="L220">			preparedStatment.setInt(1, fundsOutId);</span>
<span class="nc" id="L221">			preparedStatment.setString(2, orgCode);</span>
<span class="nc" id="L222">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L223" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L224">				String json = rs.getString(PO_ATTRIB);</span>
<span class="nc bnc" id="L225" title="All 2 branches missed.">				if (null != json) {</span>
<span class="nc" id="L226">					details = JsonConverterUtil.convertToObject(FundsOutRequest.class, rs.getString(PO_ATTRIB));</span>
				}
<span class="nc" id="L228">				details.setFundsOutId(rs.getInt(FUNDS_OUT_ID));</span>
<span class="nc" id="L229">				details.setAccId(rs.getInt(ACCOUNTID));</span>
<span class="nc" id="L230">				details.setContactId(rs.getInt(CONTACT_ID));</span>
<span class="nc" id="L231">				details.addAttribute(Constants.STATUS, rs.getString(PO_COMPLIANCE_STATUS));</span>
<span class="nc" id="L232">				details.addAttribute(Constants.BLACKLIST_STATUS, ServiceStatus.getStatusAsString(rs.getInt(BLACKLIST_STATUS)));</span>
<span class="nc" id="L233">			}</span>
<span class="nc" id="L234">		} catch (Exception e) {</span>
<span class="nc" id="L235">			LOG.error(&quot;&quot;, e);</span>
		} finally {
<span class="nc" id="L237">			closeResultset(rs);</span>
<span class="nc" id="L238">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L240">		return details;</span>
	}

	/**
	 * Gets the funds out contact account details.
	 *
	 * @param request
	 *            the request
	 * @param conn
	 *            the conn
	 * @param tradeAccountNumber
	 *            the trade account number
	 * @param orgCode
	 *            the org code
	 * @return the funds out contact account details
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	void getFundsOutContactAccountDetails(FundsOutRequest request, Connection conn, String tradeAccountNumber,
			String orgCode) throws ComplianceException {
<span class="nc" id="L260">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L261">		ResultSet rs = null;</span>
<span class="nc bnc" id="L262" title="All 2 branches missed.">		String tradeAccNumber = StringUtils.isNullOrEmpty(tradeAccountNumber)?request.getTrade().getTradeAccountNumber():tradeAccountNumber;</span>
		try {
<span class="nc" id="L264">			preparedStatment = conn.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_ACCOUNT_CONTACT_DETAILS.getQuery());</span>
<span class="nc" id="L265">			preparedStatment.setString(1, orgCode);</span>
<span class="nc" id="L266">			preparedStatment.setString(2, tradeAccNumber);</span>
<span class="nc" id="L267">			preparedStatment.setString(3, orgCode);</span>
<span class="nc" id="L268">			rs = preparedStatment.executeQuery();</span>
<span class="nc" id="L269">			Integer count = 1;</span>
<span class="nc" id="L270">			Integer noOfContacts = 0;</span>
<span class="nc" id="L271">			List&lt;String&gt; watchListDetails = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L272">			MultiMap multiMapWatchlistCon = new MultiHashMap();//Add for AT-2986</span>
			
<span class="nc bnc" id="L274" title="All 2 branches missed.">			while (rs.next()) {</span>

<span class="nc" id="L276">				request.setOrgId(rs.getInt(&quot;requestOrgID&quot;));</span>
<span class="nc" id="L277">				Account acc = JsonConverterUtil.convertToObject(Account.class, rs.getString(&quot;acattrib&quot;));</span>
<span class="nc" id="L278">				acc.setCustomerType(rs.getInt(&quot;custType&quot;));</span>
<span class="nc" id="L279">				acc.setId(rs.getInt(ACCOUNTID));</span>
<span class="nc" id="L280">				acc.setAccountStatus(rs.getString(&quot;accountStatus&quot;));</span>
<span class="nc" id="L281">				request.setAccId(acc.getId());</span>
<span class="nc" id="L282">				request.addAttribute(ACCOUNT, acc);</span>
<span class="nc" id="L283">				request.addAttribute(Constants.LE_UPDATE_DATE, rs.getString(&quot;leupdatedate&quot;)); //Add for AT-3349</span>
<span class="nc" id="L284">				Contact con = JsonConverterUtil.convertToObject(Contact.class, rs.getString(&quot;contactattrib&quot;));</span>
<span class="nc" id="L285">				con.setId(rs.getInt(CONTACTID));</span>
<span class="nc" id="L286">				con.setContactStatus(rs.getString(&quot;ContactStatus&quot;));</span>
<span class="nc" id="L287">				con.setPoiExists(rs.getInt(&quot;poiexists&quot;));	//Add for AT-3349	</span>
<span class="nc" id="L288">				request.addAttribute(CONTACT + count, con);</span>
<span class="nc bnc" id="L289" title="All 4 branches missed.">				if (null != rs.getString(WATCHLISTREASONNAME) &amp;&amp; !rs.getString(WATCHLISTREASONNAME).isEmpty()) {</span>
<span class="nc" id="L290">					request.addAttribute(WATCHLIST_ID + count, rs.getInt(WATCHLIST_ID));</span>
<span class="nc" id="L291">					watchListDetails.add(rs.getString(WATCHLISTREASONNAME));</span>
				}
<span class="nc" id="L293">				multiMapWatchlistCon.put(rs.getInt(TRADE_CONTACT_ID), rs.getString(WATCHLISTREASONNAME));</span>
<span class="nc" id="L294">				request.addAttribute(ACCOUNT_TM_FLAG, rs.getInt(ACCOUNT_TM_FLAG));</span>
<span class="nc" id="L295">				request.addAttribute(&quot;DormantFlag&quot;, rs.getInt(&quot;DormantFlag&quot;));</span>
				
<span class="nc" id="L297">				count++;</span>
<span class="nc" id="L298">				noOfContacts++;</span>
<span class="nc" id="L299">			}</span>
<span class="nc" id="L300">			request.addAttribute(&quot;noOfContacts&quot;, noOfContacts);</span>
<span class="nc" id="L301">			request.addAttribute(REASONS_OF_WATCHLIST, watchListDetails);</span>
<span class="nc" id="L302">			request.addAttribute(&quot;watchlist_with_trade&amp;cont&quot;, multiMapWatchlistCon);</span>
<span class="nc" id="L303">		} catch (Exception e) {</span>
<span class="nc" id="L304">			LOG.error(&quot; &quot;, e);</span>
		} finally {
<span class="nc" id="L306">			closeResultset(rs);</span>
<span class="nc" id="L307">			closePrepareStatement(preparedStatment);</span>
		}

<span class="nc" id="L310">	}</span>

	/**
	 * Save funds out request.
	 *
	 * @param message
	 *            the message
	 * @return the message
	 */
	public Message&lt;MessageContext&gt; saveFundsOutRequest(Message&lt;MessageContext&gt; message) {
<span class="nc" id="L320">		Connection conn = null;</span>
		try {
<span class="nc" id="L322">			FundsOutRequest fundsOutRequest = (FundsOutRequest) message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L323">					.getRequest();</span>
<span class="nc" id="L324">			UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc" id="L325">			Account accountID = (Account) fundsOutRequest.getAdditionalAttribute(ACCOUNT);</span>
<span class="nc" id="L326">			Contact contactID = (Contact) fundsOutRequest.getAdditionalAttribute(CONTACT);</span>
<span class="nc" id="L327">			conn = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L328">			beginTransaction(conn);</span>
<span class="nc" id="L329">			saveIntoPaymentsOut(conn, fundsOutRequest, accountID.getId(), contactID.getId(), token.getUserID());</span>
<span class="nc" id="L330">			saveIntoPaymentsOutAttribute(conn, fundsOutRequest, token.getUserID());</span>
<span class="nc" id="L331">			commitTransaction(conn);</span>
<span class="nc" id="L332">		} catch (Exception e) {</span>
			try {
<span class="nc" id="L334">				transactionRolledBack(conn);</span>
<span class="nc" id="L335">			} catch (ComplianceException e1) {</span>
<span class="nc" id="L336">				LOG.error(EXCEPTION_IN_SAVE_FUNDS_OUT_REQUEST, e1);</span>
<span class="nc" id="L337">			}</span>
<span class="nc" id="L338">			LOG.error(EXCEPTION_IN_SAVE_FUNDS_OUT_REQUEST, e);</span>
<span class="nc" id="L339">			message.getPayload().setFailed(true);</span>
		} finally {
			try {
<span class="nc" id="L342">				closeConnection(conn);</span>
<span class="nc" id="L343">			} catch (ComplianceException e) {</span>
<span class="nc" id="L344">				LOG.error(EXCEPTION_IN_SAVE_FUNDS_OUT_REQUEST, e);</span>
<span class="nc" id="L345">			}</span>
		}
<span class="nc" id="L347">		return message;</span>
	}

	/**
	 * Save into payments out.
	 *
	 * @param conn
	 *            the conn
	 * @param fundsOutRequest
	 *            the funds out request
	 * @param accountID
	 *            the account ID
	 * @param contactID
	 *            the contact ID
	 * @param user
	 *            the user
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void saveIntoPaymentsOut(Connection conn, FundsOutRequest fundsOutRequest, Integer accountID,
			Integer contactID, Integer user) throws ComplianceException {
<span class="nc" id="L368">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L369">		ResultSet rs = null;</span>
		try {
			// [OrganizationID], [AccountID], [ContactID], [ContractNumber],
			// [TradePaymentID], [ComplianceStatus],
			// [ComplianceDoneOn], [Deleted], [CreatedBy], [CreatedOn],
			// [UpdatedBy], [UpdatedOn]

<span class="nc" id="L376">			preparedStatment = conn.prepareStatement(DBQueryConstant.INSERT_INTO_PAYMENTS_OUT.getQuery(),</span>
					Statement.RETURN_GENERATED_KEYS);
<span class="nc" id="L378">			preparedStatment.setString(1, fundsOutRequest.getOrgCode());</span>
<span class="nc" id="L379">			preparedStatment.setInt(2, accountID);</span>
<span class="nc" id="L380">			preparedStatment.setInt(3, contactID);</span>
<span class="nc" id="L381">			preparedStatment.setString(4, fundsOutRequest.getTrade().getContractNumber());</span>
<span class="nc" id="L382">			preparedStatment.setInt(5, fundsOutRequest.getBeneficiary().getPaymentFundsoutId());</span>
<span class="nc" id="L383">			preparedStatment.setString(6, FundsOutComplianceStatus.HOLD.name());</span>
<span class="nc" id="L384">			preparedStatment.setTimestamp(7, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L385">			preparedStatment.setBoolean(8, false);</span>
<span class="nc" id="L386">			preparedStatment.setInt(9, user);</span>
<span class="nc" id="L387">			preparedStatment.setTimestamp(10, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L388">			preparedStatment.setInt(11, user);</span>
<span class="nc" id="L389">			preparedStatment.setTimestamp(12, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L390">			preparedStatment.setInt(13, ServiceStatus.getStatusAsInteger(ServiceStatus.NOT_REQUIRED.name()));</span>
<span class="nc" id="L391">			preparedStatment.setInt(14, ServiceStatus.getStatusAsInteger(ServiceStatus.NOT_REQUIRED.name()));</span>
<span class="nc" id="L392">			preparedStatment.setInt(15, ServiceStatus.getStatusAsInteger(ServiceStatus.NOT_REQUIRED.name()));</span>
<span class="nc" id="L393">			preparedStatment.setInt(16, ServiceStatus.getStatusAsInteger(ServiceStatus.NOT_REQUIRED.name()));</span>
<span class="nc" id="L394">			preparedStatment.setTimestamp(17, DateTimeFormatter</span>
<span class="nc" id="L395">					.convertStringToTimestamp(fundsOutRequest.getBeneficiary().getTransactionDateTime()));</span>
<span class="nc" id="L396">			preparedStatment.setBoolean(18, false);</span>

			// Set STPFlag
<span class="nc" id="L399">			preparedStatment.setBoolean(19, false);</span>
<span class="nc" id="L400">			preparedStatment.setString(20, fundsOutRequest.getTrade().getCustLegalEntity());</span>
<span class="nc" id="L401">			preparedStatment.setInt(21, ServiceStatus.getStatusAsInteger(ServiceStatus.NOT_REQUIRED.name()));</span>
<span class="nc" id="L402">			preparedStatment.execute();</span>
<span class="nc" id="L403">			rs = preparedStatment.getGeneratedKeys();</span>
<span class="nc bnc" id="L404" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L405">				fundsOutRequest.setFundsOutId(rs.getInt(1));</span>
			}

<span class="nc" id="L408">		} catch (Exception e) {</span>
<span class="nc" id="L409">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L411">			closeResultset(rs);</span>
<span class="nc" id="L412">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L414">	}</span>

	/**
	 * Save into payments out attribute.
	 *
	 * @param conn
	 *            the conn
	 * @param fundsOutRequest
	 *            the funds out request
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void saveIntoPaymentsOutAttribute(Connection conn, FundsOutRequest fundsOutRequest, Integer userID)
			throws ComplianceException {
<span class="nc" id="L430">		PreparedStatement preparedStatment = null;</span>
		try {
<span class="nc" id="L432">			preparedStatment = conn.prepareStatement(DBQueryConstant.INSERT_INTO_PAYMENTS_OUT_ATTRIBUTE.getQuery());</span>
<span class="nc" id="L433">			preparedStatment.setInt(1, fundsOutRequest.getFundsOutId());</span>
<span class="nc" id="L434">			preparedStatment.setInt(2, 1);</span>
<span class="nc" id="L435">			preparedStatment.setString(3, JsonConverterUtil.convertToJsonWithoutNull(fundsOutRequest));</span>
<span class="nc" id="L436">			preparedStatment.setInt(4, userID);</span>
<span class="nc" id="L437">			preparedStatment.setTimestamp(5, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L438">			preparedStatment.setInt(6, userID);</span>
<span class="nc" id="L439">			preparedStatment.setTimestamp(7, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L440">			preparedStatment.setDouble(8, fundsOutRequest.getBeneficiary().getAmount());</span>
<span class="nc" id="L441">			preparedStatment.execute();</span>

<span class="nc" id="L443">		} catch (Exception e) {</span>
<span class="nc" id="L444">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L446">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L448">	}</span>

	/**
	 * Save into payments out attribute history.
	 *
	 * @param conn
	 *            the conn
	 * @param fundsOutId
	 *            the funds out id
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void saveIntoPaymentsOutAttributeHistory(Connection conn, Integer fundsOutId, Integer userID)
			throws ComplianceException {
<span class="nc" id="L464">		PreparedStatement preparedStatment = null;</span>
		try {
			// [PaymentOutID], [Version], [Attributes], [CreatedBy],
			// [CreatedOn], [UpdatedBy], [UpdatedOn]

<span class="nc" id="L469">			preparedStatment = conn</span>
<span class="nc" id="L470">					.prepareStatement(DBQueryConstant.INSERT_INTO_PAYMENTS_OUT_ATTRIBUTE_HISTORY.getQuery());</span>
<span class="nc" id="L471">			preparedStatment.setInt(1, fundsOutId);</span>
<span class="nc" id="L472">			preparedStatment.setInt(2, fundsOutId);</span>
<span class="nc" id="L473">			preparedStatment.setInt(3, fundsOutId);</span>

<span class="nc" id="L475">			preparedStatment.setInt(4, userID);</span>
<span class="nc" id="L476">			preparedStatment.setTimestamp(5, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L477">			preparedStatment.setInt(6, userID);</span>
<span class="nc" id="L478">			preparedStatment.setTimestamp(7, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L479">			preparedStatment.execute();</span>

<span class="nc" id="L481">		} catch (Exception e) {</span>
<span class="nc" id="L482">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L484">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L486">	}</span>

	/**
	 * Save funds out update request.
	 *
	 * @param message
	 *            the message
	 * @return the message
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public Message&lt;MessageContext&gt; saveFundsOutUpdateRequest(Message&lt;MessageContext&gt; message)
			throws ComplianceException {
<span class="nc" id="L499">		Connection conn = null;</span>
		try {
<span class="nc" id="L501">			FundsOutUpdateRequest fundsOutRequest = (FundsOutUpdateRequest) message.getPayload()</span>
<span class="nc" id="L502">					.getGatewayMessageExchange().getRequest();</span>
<span class="nc" id="L503">			FundsOutRequest oldReuqest = (FundsOutRequest) fundsOutRequest.getAdditionalAttribute(&quot;oldRequest&quot;);</span>
<span class="nc" id="L504">			UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc" id="L505">			conn = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L506">			saveIntoPaymentsOutAttributeHistory(conn, oldReuqest.getFundsOutId(), token.getUserID());</span>
<span class="nc" id="L507">			updateIntoPaymentsOut(conn, oldReuqest.getFundsOutId(), token.getUserID());</span>
<span class="nc" id="L508">			updateIntoPaymentsOutAttribute(conn, oldReuqest, token.getUserID());</span>
<span class="nc" id="L509">		} catch (Exception e) {</span>
<span class="nc" id="L510">			LOG.error(&quot;&quot;, e);</span>
<span class="nc" id="L511">			message.getPayload().setFailed(true);</span>
		} finally {
<span class="nc" id="L513">			closeConnection(conn);</span>
		}
<span class="nc" id="L515">		return message;</span>
	}

	/**
	 * Update into payments out.
	 *
	 * @param conn
	 *            the conn
	 * @param fundsOutId
	 *            the funds out id
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void updateIntoPaymentsOut(Connection conn, Integer fundsOutId, Integer userID) throws ComplianceException {
<span class="nc" id="L531">		PreparedStatement preparedStatment = null;</span>
		try {
<span class="nc" id="L533">			preparedStatment = conn.prepareStatement(DBQueryConstant.UPDATE_PAYMENT_OUT.getQuery());</span>
<span class="nc" id="L534">			preparedStatment.setInt(1, userID);</span>
<span class="nc" id="L535">			preparedStatment.setTimestamp(2, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L536">			preparedStatment.setInt(3, fundsOutId);</span>
<span class="nc" id="L537">			preparedStatment.execute();</span>

<span class="nc" id="L539">		} catch (Exception e) {</span>
<span class="nc" id="L540">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L542">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L544">	}</span>

	/**
	 * Update into payments out attribute.
	 *
	 * @param conn
	 *            the conn
	 * @param request
	 *            the request
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void updateIntoPaymentsOutAttribute(Connection conn, FundsOutRequest request, Integer userID)
			throws ComplianceException {
<span class="nc" id="L560">		PreparedStatement preparedStatment = null;</span>
		try {
			// [Attributes]=?, [UpdatedBy]=?, [UpdatedOn]=? WHERE id = ?
<span class="nc" id="L563">			preparedStatment = conn.prepareStatement(DBQueryConstant.UPDATE_PAYMENT_OUT_ATTRIBUTE.getQuery());</span>
<span class="nc" id="L564">			preparedStatment.setString(1, JsonConverterUtil.convertToJsonWithoutNull(request));</span>
<span class="nc" id="L565">			preparedStatment.setInt(2, userID);</span>
<span class="nc" id="L566">			preparedStatment.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L567">			preparedStatment.setDouble(4, request.getBeneficiary().getAmount());</span>
<span class="nc" id="L568">			preparedStatment.setInt(5, request.getFundsOutId());</span>
<span class="nc" id="L569">			preparedStatment.execute();</span>

<span class="nc" id="L571">		} catch (Exception e) {</span>
<span class="nc" id="L572">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L574">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L576">	}</span>

	/**
	 * Save funds out delete request.
	 *
	 * @param message
	 *            the message
	 * @return the message
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public Message&lt;MessageContext&gt; saveFundsOutDeleteRequest(Message&lt;MessageContext&gt; message)
			throws ComplianceException {
<span class="nc" id="L589">		Connection conn = null;</span>
		try {
<span class="nc" id="L591">			FundsOutDeleteRequest fundsOutRequest = (FundsOutDeleteRequest) message.getPayload()</span>
<span class="nc" id="L592">					.getGatewayMessageExchange().getRequest();</span>
<span class="nc" id="L593">			UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc" id="L594">			conn = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L595">			deletePaymentsOut(conn, fundsOutRequest, token.getUserID());</span>
<span class="nc" id="L596">		} catch (Exception e) {</span>
<span class="nc" id="L597">			LOG.error(&quot;&quot;, e);</span>
<span class="nc" id="L598">			message.getPayload().setFailed(true);</span>
		} finally {
<span class="nc" id="L600">			closeConnection(conn);</span>
		}
<span class="nc" id="L602">		return message;</span>
	}

	/**
	 * Delete payments out.
	 *
	 * @param conn
	 *            the conn
	 * @param fDeleteRequest
	 *            the f delete request
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void deletePaymentsOut(Connection conn, FundsOutDeleteRequest fDeleteRequest, Integer userID)
			throws ComplianceException {
<span class="nc" id="L619">		PreparedStatement preparedStatment = null;</span>
		try {
<span class="nc" id="L621">			preparedStatment = conn.prepareStatement(DBQueryConstant.DELETE_FUNDS_OUT.getQuery());</span>
<span class="nc" id="L622">			preparedStatment.setString(1, FundsOutComplianceStatus.REVERSED.name());</span>
<span class="nc" id="L623">			preparedStatment.setInt(2, userID);</span>
<span class="nc" id="L624">			preparedStatment.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L625">			preparedStatment.setInt(4, fDeleteRequest.getPaymentFundsoutId());</span>
<span class="nc" id="L626">			preparedStatment.execute();</span>
<span class="nc" id="L627">		} catch (Exception e) {</span>
<span class="nc" id="L628">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L630">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L632">	}</span>

	/**
	 * Update payment out status.
	 *
	 * @param message
	 *            the message
	 * @return the message
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public Message&lt;MessageContext&gt; updatePaymentOutStatus(Message&lt;MessageContext&gt; message) throws ComplianceException {
<span class="nc" id="L644">		Connection conn = null;</span>

		try {
<span class="nc" id="L647">			MessageExchange exchange = message.getPayload().getGatewayMessageExchange();</span>
<span class="nc" id="L648">			FundsOutBaseRequest fRequest = (FundsOutBaseRequest) exchange.getRequest();</span>
<span class="nc" id="L649">			OperationEnum operation = exchange.getOperation();</span>
<span class="nc" id="L650">			FundsOutResponse fundsOutResponse = (FundsOutResponse) message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L651">					.getResponse();</span>
<span class="nc" id="L652">			UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc" id="L653">			conn = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L654">			getContactWatchlist(conn, fRequest.getFundsOutId(), fundsOutResponse);//Add for AT-3470</span>
<span class="nc" id="L655">			updateStatusIntoPaymetOut(conn, fundsOutResponse, fRequest.getFundsOutId(), token.getUserID(), operation);</span>
<span class="nc" id="L656">			updateIntoPaymentOutStatusReason(conn, fundsOutResponse, fRequest.getFundsOutId(), token.getUserID());</span>

<span class="nc" id="L658">		} catch (Exception e) {</span>
<span class="nc" id="L659">			LOG.error(&quot;Exception in updatePaymentOutStatus()&quot;, e);</span>
<span class="nc" id="L660">			message.getPayload().setFailed(true);</span>
		} finally {
<span class="nc" id="L662">			closeConnection(conn);</span>
		}
<span class="nc" id="L664">		return message;</span>
	}
	
	/**
	 * Gets the contact watchlist.
	 *
	 * @param conn the conn
	 * @param id the id
	 * @param fundsInCreateResponse the funds in create response
	 * @return the contact watchlist
	 * @throws ComplianceException the compliance exception
	 */
	@SuppressWarnings(&quot;unlikely-arg-type&quot;)
	private void getContactWatchlist(Connection conn, Integer id, FundsOutResponse fundsOutResponse) throws ComplianceException {
<span class="nc" id="L678">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L679">		ResultSet rs = null;</span>
		
<span class="nc" id="L681">		StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L682">		DecimalFormat df = new DecimalFormat(&quot;000&quot;);</span>
		
		try {
			
<span class="nc" id="L686">			preparedStatment = conn.prepareStatement(DBQueryConstant.GET_CONTACT_WATCHLIST_FUNDS_OUT.getQuery());</span>
<span class="nc" id="L687">			preparedStatment.setInt(1, id);</span>
<span class="nc" id="L688">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L689" title="All 2 branches missed.">			while(rs.next()) {</span>
<span class="nc bnc" id="L690" title="All 2 branches missed.">				if (sb.length() &gt; 0) {</span>
<span class="nc" id="L691">					sb.append(&quot;, &quot;);</span>
				}
<span class="nc" id="L693">				String watchListReason=rs.getString(&quot;Reason&quot;);</span>
<span class="nc bnc" id="L694" title="All 2 branches missed.">				if(!watchListReason.contains(&quot;US Client List B client&quot;)) {</span>
<span class="nc bnc" id="L695" title="All 2 branches missed.">					if(rs.getInt(&quot;StopPaymentOut&quot;) == 1) {</span>
<span class="nc bnc" id="L696" title="All 4 branches missed.">						if(fundsOutResponse.getShortResponseCode() != null &amp;&amp; fundsOutResponse.getShortResponseCode().contains(&quot;NSTP&quot;)) {</span>
<span class="nc" id="L697">							sb.append(&quot;WR&quot;).append(df.format(rs.getInt(&quot;ID&quot;)));</span>
						}else {
<span class="nc" id="L699">							fundsOutResponse.setShortResponseCode(&quot;NSTP&quot;);</span>
<span class="nc" id="L700">							sb.append(&quot;WR&quot;).append(df.format(rs.getInt(&quot;ID&quot;)));</span>
						}
					}else {
<span class="nc" id="L703">						sb.append(&quot;WA&quot;).append(df.format(rs.getInt(&quot;ID&quot;)));</span>
						}
<span class="nc bnc" id="L705" title="All 2 branches missed.">				}else if(WatchList.US_CLIENT_LIST_B_CLIENT.getDescription().equals(watchListReason)) {</span>
<span class="nc" id="L706">					setShortCodeForUsClientListBWL(fundsOutResponse, rs, sb, df);</span>
				}
<span class="nc" id="L708">			}</span>
<span class="nc bnc" id="L709" title="All 4 branches missed.">			if (sb.length() != 0 &amp;&amp; fundsOutResponse.getShortResponseCode() != null) {</span>
<span class="nc" id="L710">				String watch = fundsOutResponse.getShortResponseCode().concat(&quot;;&quot;).concat(sb.toString());</span>
<span class="nc" id="L711">				fundsOutResponse.setShortResponseCode(watch);</span>
			}
			
<span class="nc" id="L714">		} catch (Exception e) {</span>
<span class="nc" id="L715">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L717">			closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L718">			closeResultset(rs);</span>
		}
<span class="nc" id="L720">	}</span>

	private void setShortCodeForUsClientListBWL(FundsOutResponse fundsOutResponse, ResultSet rs, StringBuilder sb,
			DecimalFormat df) throws SQLException {
<span class="nc bnc" id="L724" title="All 2 branches missed.">		if (Boolean.TRUE.equals(fundsOutResponse.getUsClientListBClientWLFlag())) {</span>
<span class="nc bnc" id="L725" title="All 4 branches missed.">			if (fundsOutResponse.getShortResponseCode() != null &amp;&amp; fundsOutResponse.getShortResponseCode().contains(&quot;NSTP&quot;)) {</span>
<span class="nc" id="L726">				sb.append(&quot;WR&quot;).append(df.format(rs.getInt(&quot;ID&quot;)));</span>
			} else {
<span class="nc" id="L728">				fundsOutResponse.setShortResponseCode(&quot;NSTP&quot;);</span>
<span class="nc" id="L729">				sb.append(&quot;WR&quot;).append(df.format(rs.getInt(&quot;ID&quot;)));</span>
			}
		} else {
<span class="nc" id="L732">			sb.append(&quot;WA&quot;).append(df.format(rs.getInt(&quot;ID&quot;)));</span>
		}
<span class="nc" id="L734">	}</span>

	/**
	 * Update status into paymet out.
	 *
	 * @param conn
	 *            the conn
	 * @param fundsOutResponse
	 *            the funds out response
	 * @param id
	 *            the id
	 * @param userID
	 *            the user ID
	 * @param operation
	 *            the operation
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void updateStatusIntoPaymetOut(Connection conn, FundsOutResponse fundsOutResponse, Integer id,
			Integer userID, OperationEnum operation) throws ComplianceException {
<span class="nc" id="L754">		PreparedStatement preparedStatment = null;</span>
		try {
			/*
			 * if operation is FUNDS_OUT use query UPDATE_FUNDS_OUT_STATUS else
			 * for UPDATE_OPI and DELETE_OPI use query
			 * UPDATE_FUNDS_OUT_STATUS_FOR_UPDATE_DELETE_API . check added to
			 * update service statuses in Paymentout table : Abhijit G
			 */
<span class="nc bnc" id="L762" title="All 2 branches missed.">			if (operation == OperationEnum.FUNDS_OUT) {</span>
<span class="nc" id="L763">				Boolean paymentOutStatusHold = fundsOutResponse.getStatus().equals(FundsOutComplianceStatus.HOLD.name());</span>
<span class="nc" id="L764">				preparedStatment = conn.prepareStatement(DBQueryConstant.UPDATE_FUNDS_OUT_STATUS.getQuery());</span>
<span class="nc" id="L765">				preparedStatment.setString(1, fundsOutResponse.getStatus());</span>
<span class="nc" id="L766">				preparedStatment.setInt(2,</span>
<span class="nc" id="L767">						ServiceStatus.getStatusAsInteger(fundsOutResponse.getBlacklistCheckStatus()));</span>
<span class="nc" id="L768">				preparedStatment.setInt(3,</span>
<span class="nc" id="L769">						ServiceStatus.getStatusAsInteger(fundsOutResponse.getFraugsterCheckStatus()));</span>
<span class="nc" id="L770">				preparedStatment.setInt(4, ServiceStatus.getStatusAsInteger(fundsOutResponse.getSanctionCheckStatus()));</span>
<span class="nc" id="L771">				preparedStatment.setInt(5, ServiceStatus.getStatusAsInteger(fundsOutResponse.getCustomCheckStatus()));</span>
<span class="nc" id="L772">				preparedStatment.setTimestamp(6, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L773">				preparedStatment.setInt(7, userID);</span>
<span class="nc" id="L774">				preparedStatment.setTimestamp(8, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L775">				preparedStatment.setBoolean(9, paymentOutStatusHold);</span>
<span class="nc" id="L776">				preparedStatment.setBoolean(10, fundsOutResponse.getSTPFlag());				// set STPFlag</span>
<span class="nc" id="L777">				preparedStatment.setString(11, fundsOutResponse.getShortResponseCode());//Add for AT-3470</span>
				//Add for AT-3649
<span class="nc" id="L779">				preparedStatment.setInt(12, ServiceStatus.getStatusAsInteger(fundsOutResponse.getPaymentReferenceCheckStatus()));</span>
<span class="nc" id="L780">				preparedStatment.setString(13,</span>
<span class="nc bnc" id="L781" title="All 2 branches missed.">						fundsOutResponse.getAdditionalAttribute(CLIENT_RISK_LEVEL) != null</span>
<span class="nc" id="L782">								? (String) fundsOutResponse.getAdditionalAttribute(CLIENT_RISK_LEVEL)</span>
								: null); //AT-4451
<span class="nc" id="L784">				preparedStatment.setInt(14, ServiceStatus.getStatusAsInteger(fundsOutResponse.getIntuitionCheckStatus()));</span>
<span class="nc" id="L785">				preparedStatment.setInt(15, id);</span>
<span class="nc" id="L786">				preparedStatment.execute();</span>
<span class="nc bnc" id="L787" title="All 2 branches missed.">			} else if(operation == OperationEnum.RECHECK_FAILURES) {</span>
<span class="nc" id="L788">				Boolean paymentOutStatusHold = fundsOutResponse.getStatus().equals(FundsOutComplianceStatus.HOLD.name());</span>
<span class="nc" id="L789">				preparedStatment = conn.prepareStatement(DBQueryConstant.UPDATE_FUNDS_OUT_STATUS_WITHOUT_INITITAL_STATUS.getQuery());</span>
<span class="nc" id="L790">				preparedStatment.setString(1, fundsOutResponse.getStatus());</span>
<span class="nc" id="L791">				preparedStatment.setInt(2,</span>
<span class="nc" id="L792">						ServiceStatus.getStatusAsInteger(fundsOutResponse.getBlacklistCheckStatus()));</span>
<span class="nc" id="L793">				preparedStatment.setInt(3,</span>
<span class="nc" id="L794">						ServiceStatus.getStatusAsInteger(fundsOutResponse.getFraugsterCheckStatus()));</span>
<span class="nc" id="L795">				preparedStatment.setInt(4, ServiceStatus.getStatusAsInteger(fundsOutResponse.getSanctionCheckStatus()));</span>
<span class="nc" id="L796">				preparedStatment.setInt(5, ServiceStatus.getStatusAsInteger(fundsOutResponse.getCustomCheckStatus()));</span>
<span class="nc" id="L797">				preparedStatment.setTimestamp(6, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L798">				preparedStatment.setInt(7, userID);</span>
<span class="nc" id="L799">				preparedStatment.setTimestamp(8, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L800">				preparedStatment.setBoolean(9, paymentOutStatusHold);</span>
<span class="nc" id="L801">				preparedStatment.setBoolean(10, fundsOutResponse.getSTPFlag());				// set STPFlag</span>
				//Add for AT-3649
<span class="nc" id="L803">				preparedStatment.setInt(11, ServiceStatus.getStatusAsInteger(fundsOutResponse.getPaymentReferenceCheckStatus()));</span>
<span class="nc" id="L804">				preparedStatment.setInt(12, ServiceStatus.getStatusAsInteger(fundsOutResponse.getIntuitionCheckStatus()));</span>
<span class="nc" id="L805">				preparedStatment.setInt(13, id);</span>
<span class="nc" id="L806">				preparedStatment.execute();</span>
<span class="nc" id="L807">			} else {</span>
<span class="nc" id="L808">				preparedStatment = conn</span>
<span class="nc" id="L809">						.prepareStatement(DBQueryConstant.UPDATE_FUNDS_OUT_STATUS_FOR_UPDATE_DELETE_API.getQuery());</span>
<span class="nc" id="L810">				preparedStatment.setString(1, fundsOutResponse.getStatus());</span>
<span class="nc" id="L811">				preparedStatment.setInt(2, id);</span>
<span class="nc" id="L812">				preparedStatment.setInt(3, id);</span>
<span class="nc" id="L813">				preparedStatment.setInt(4, id);</span>
<span class="nc" id="L814">				preparedStatment.setInt(5, id);</span>
<span class="nc" id="L815">				preparedStatment.setTimestamp(6, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L816">				preparedStatment.setInt(7, userID);</span>
<span class="nc" id="L817">				preparedStatment.setTimestamp(8, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L818">				preparedStatment.setInt(9, id);</span>
<span class="nc" id="L819">				preparedStatment.execute();</span>
			}

<span class="nc" id="L822">		} catch (Exception e) {</span>
<span class="nc" id="L823">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L825">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L827">	}</span>

	/**
	 * Update into payment out status reason.
	 *
	 * @param conn
	 *            the conn
	 * @param fundsOutResponse
	 *            the funds out response
	 * @param id
	 *            the id
	 * @param user
	 *            the user
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void updateIntoPaymentOutStatusReason(Connection conn, FundsOutResponse fundsOutResponse, Integer id,
			Integer user) throws ComplianceException {
<span class="nc" id="L845">		PreparedStatement preparedStatment = null;</span>
		try {
<span class="nc bnc" id="L847" title="All 2 branches missed.">			if (null != fundsOutResponse.getResponseReason()</span>
<span class="nc bnc" id="L848" title="All 2 branches missed.">					&amp;&amp; null != fundsOutResponse.getResponseReason().getFundsOutReasonShort()) {</span>
<span class="nc" id="L849">				preparedStatment = conn</span>
<span class="nc" id="L850">						.prepareStatement(DBQueryConstant.INSERT_INTO_FUNDS_OUT_STATUS_REASON.getQuery());</span>
<span class="nc" id="L851">				preparedStatment.setInt(1, id);</span>
<span class="nc" id="L852">				preparedStatment.setString(2, &quot;ALL&quot;);</span>
<span class="nc" id="L853">				preparedStatment.setString(3, fundsOutResponse.getResponseReason().getFundsOutReasonShort());</span>
<span class="nc" id="L854">				preparedStatment.setInt(4, user);</span>
<span class="nc" id="L855">				preparedStatment.setTimestamp(5, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L856">				preparedStatment.setInt(6, user);</span>
<span class="nc" id="L857">				preparedStatment.setTimestamp(7, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L858">				preparedStatment.execute();</span>
			}
<span class="nc" id="L860">		} catch (Exception e) {</span>
<span class="nc" id="L861">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L863">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L865">	}</span>

	/**
	 * Gets the payment out request by id.
	 *
	 * @param fundsOutId
	 *            the funds out id
	 * @return the payment out request by id
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public FundsOutRequest getFundsOutRequestById(Integer fundsOutId) throws ComplianceException {
<span class="nc" id="L877">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L878">		Connection connection = null;</span>
<span class="nc" id="L879">		ResultSet rs = null;</span>
<span class="nc" id="L880">		FundsOutRequest fundsOutRequest = null;</span>
		try {
<span class="nc" id="L882">			connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L883">			preparedStatment = connection</span>
<span class="nc" id="L884">					.prepareStatement(DBQueryConstant.GET_FUNDSOUT_REQUEST_BY_PAYMENTOUTID.getQuery());</span>
<span class="nc" id="L885">			preparedStatment.setInt(1, fundsOutId);</span>
<span class="nc" id="L886">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L887" title="All 2 branches missed.">			if (rs.next()) {</span>
<span class="nc" id="L888">				fundsOutRequest = JsonConverterUtil.convertToObject(FundsOutRequest.class, rs.getString(&quot;Attributes&quot;));</span>
<span class="nc" id="L889">				fundsOutRequest.setAccId(rs.getInt(&quot;AccountID&quot;));</span>
<span class="nc" id="L890">				fundsOutRequest.setContactId(rs.getInt(CONTACT_ID));</span>
<span class="nc" id="L891">				return fundsOutRequest;</span>
			}
<span class="nc" id="L893">			rs.close();</span>
<span class="nc" id="L894">		} catch (Exception e) {</span>
<span class="nc" id="L895">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L897">			closeResultset(rs);</span>
<span class="nc" id="L898">			closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L899">			closeConnection(connection);</span>
		}

<span class="nc" id="L902">		return null;</span>
	}

	/**
	 * Business -- Update sanction and customcheck status into paymentOut table
	 * after performing repeat check.
	 * 
	 * Implementation--- 1) If operation is SANCTION_RESEND then call
	 * updateSanctionServiceStatus() 1.a) Get SANCTION_OVERALLSTATUS as
	 * additional attribute to set sanction status on the basis of sanction
	 * contact, bank and beneficiary status. 2) If operation is
	 * CUSTOMCHECK_RESEND then call updateCustomCheckServiceStatus()
	 *
	 * @param message
	 *            the message
	 * @return the message
	 */
	public Message&lt;MessageContext&gt; updateServiceStatusIntoPaymetOut(Message&lt;MessageContext&gt; message) {

		try {
<span class="nc" id="L922">			MessageExchange messageExchange = message.getPayload().getGatewayMessageExchange();</span>

<span class="nc" id="L924">			ServiceInterfaceType serviceInterfaceType = messageExchange.getServiceInterface();</span>
<span class="nc" id="L925">			OperationEnum operation = messageExchange.getOperation();</span>
<span class="nc" id="L926">			UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc" id="L927">			FundsOutBaseRequest fRequest = (FundsOutBaseRequest) messageExchange.getRequest();</span>
			String status;
<span class="nc bnc" id="L929" title="All 4 branches missed.">			if (serviceInterfaceType == ServiceInterfaceType.FUNDSOUT &amp;&amp; operation == OperationEnum.SANCTION_RESEND) {</span>
<span class="nc" id="L930">				SanctionResponse fResponse = message.getPayload().getMessageExchange(ServiceTypeEnum.SANCTION_SERVICE)</span>
<span class="nc" id="L931">						.getResponse(SanctionResponse.class);</span>
<span class="nc" id="L932">				status = (String) fResponse.getAdditionalAttribute(Constants.SANCTION_OVERALLSTATUS);</span>
<span class="nc" id="L933">				updateSanctionServiceStatus(status, fRequest.getFundsOutId(), token.getUserID());</span>

<span class="nc bnc" id="L935" title="All 4 branches missed.">			} else if (serviceInterfaceType == ServiceInterfaceType.FUNDSOUT</span>
					&amp;&amp; operation == OperationEnum.CUSTOMCHECK_RESEND) {
<span class="nc" id="L937">				CustomCheckResendResponse resendResponse = message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L938">						.getResponse(CustomCheckResendResponse.class);</span>
<span class="nc" id="L939">				status = resendResponse.getResponse().getOverallStatus();</span>
<span class="nc" id="L940">				updateCustomCheckServiceStatus(status, fRequest.getFundsOutId(), token.getUserID());</span>
<span class="nc bnc" id="L941" title="All 4 branches missed.">			} else if (serviceInterfaceType == ServiceInterfaceType.FUNDSOUT</span>
					&amp;&amp; operation == OperationEnum.FRAUGSTER_RESEND) {
<span class="nc" id="L943">				FundsOutFruagsterResendRequest resendRequest = message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L944">						.getRequest(FundsOutFruagsterResendRequest.class);</span>
<span class="nc" id="L945">				FundsOutRequest oldRequest = resendRequest.getAdditionalAttribute(Constants.OLD_REQUEST,</span>
						FundsOutRequest.class);
<span class="nc" id="L947">				MessageExchange fExchange = message.getPayload().getMessageExchange(ServiceTypeEnum.FRAUGSTER_SERVICE);</span>
<span class="nc" id="L948">				FraugsterPaymentsOutResponse fpResponse = fExchange.getResponse(FraugsterPaymentsOutResponse.class);</span>
<span class="nc" id="L949">				status = fpResponse.getStatus();</span>
				
<span class="nc" id="L951">				updateFraugsterServiceStatus(status, oldRequest.getFundsOutId(), token.getUserID());</span>
<span class="nc" id="L952">			}</span>
<span class="nc bnc" id="L953" title="All 4 branches missed.">			else if (serviceInterfaceType == ServiceInterfaceType.FUNDSOUT</span>
					&amp;&amp; operation == OperationEnum.BLACKLIST_RESEND) {
<span class="nc" id="L955">				FundsOutBlacklistResendRequest resendRequest = message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L956">						.getRequest(FundsOutBlacklistResendRequest.class);</span>
<span class="nc" id="L957">				FundsOutRequest oldRequest = resendRequest.getAdditionalAttribute(Constants.OLD_REQUEST,</span>
						FundsOutRequest.class);
<span class="nc" id="L959">				MessageExchange fExchange = message.getPayload().getMessageExchange(ServiceTypeEnum.INTERNAL_RULE_SERVICE);</span>
<span class="nc" id="L960">				InternalServiceResponse fpResponse = (InternalServiceResponse) fExchange.getResponse();</span>
				
<span class="nc" id="L962">				status = fpResponse.getContacts().get(0).getContactStatus();</span>
<span class="nc" id="L963">				updateBlacklistServiceStatus(status, oldRequest.getFundsOutId(), token.getUserID());</span>
<span class="nc" id="L964">			}</span>
			//Added for AT-3658
<span class="nc bnc" id="L966" title="All 4 branches missed.">			else if (serviceInterfaceType == ServiceInterfaceType.FUNDSOUT</span>
					&amp;&amp; operation == OperationEnum.PAYMENT_REFERENCE_RESEND) {
<span class="nc" id="L968">				FundsOutPaymentReferenceResendRequest resendRequest = message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L969">						.getRequest(FundsOutPaymentReferenceResendRequest.class);</span>
<span class="nc" id="L970">				FundsOutRequest oldRequest = resendRequest.getAdditionalAttribute(Constants.OLD_REQUEST,</span>
						FundsOutRequest.class);
<span class="nc" id="L972">				MessageExchange fExchange = message.getPayload().getMessageExchange(ServiceTypeEnum.INTERNAL_RULE_SERVICE);</span>
<span class="nc" id="L973">				InternalServiceResponse fpResponse = (InternalServiceResponse) fExchange.getResponse();</span>
				
<span class="nc" id="L975">				status = fpResponse.getContacts().get(0).getContactStatus();</span>
<span class="nc" id="L976">				updatePaymentReferenceServiceStatus(status, oldRequest.getFundsOutId(), token.getUserID());</span>
			}
						
<span class="nc" id="L979">		} catch (Exception e) {</span>
<span class="nc" id="L980">			LOG.error(&quot;Error while updating Service status for repeat check :: updateServiceStatusIntoPaymetOut() :: &quot;,</span>
					e);
<span class="nc" id="L982">			message.getPayload().setFailed(true);</span>
<span class="nc" id="L983">		}</span>
<span class="nc" id="L984">		return message;</span>
	}

	/**
	 * Update sanction service status.
	 *
	 * @param status
	 *            the status
	 * @param id
	 *            the id
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public void updateSanctionServiceStatus(String status, Integer id, Integer userID) throws ComplianceException {
<span class="nc" id="L1000">		Connection connection = null;</span>
<span class="nc" id="L1001">		PreparedStatement sanctionStatment = null;</span>
		try {
<span class="nc" id="L1003">			connection = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L1004">			sanctionStatment = connection.prepareStatement(DBQueryConstant.UPDATE_FUNDS_OUT_SANCTION_STATUS.getQuery());</span>
<span class="nc" id="L1005">			sanctionStatment.setInt(1, ServiceStatus.getStatusAsInteger(status));</span>
<span class="nc" id="L1006">			sanctionStatment.setInt(2, userID);</span>
<span class="nc" id="L1007">			sanctionStatment.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L1008">			sanctionStatment.setInt(4, id);</span>
<span class="nc" id="L1009">			sanctionStatment.execute();</span>

<span class="nc" id="L1011">		} catch (Exception e) {</span>
<span class="nc" id="L1012">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L1014">			closePrepareStatement(sanctionStatment);</span>
<span class="nc" id="L1015">			closeConnection(connection);</span>
		}
<span class="nc" id="L1017">	}</span>

	/**
	 * Update custom check service status.
	 *
	 * @param status
	 *            the status
	 * @param id
	 *            the id
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public void updateCustomCheckServiceStatus(String status, Integer id, Integer userID) throws ComplianceException {
<span class="nc" id="L1032">		Connection connection = null;</span>
<span class="nc" id="L1033">		PreparedStatement ccStatment = null;</span>
		try {
<span class="nc" id="L1035">			connection = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L1036">			ccStatment = connection.prepareStatement(DBQueryConstant.UPDATE_FUNDS_OUT_CUSTOMCHECK_STATUS.getQuery());</span>
<span class="nc" id="L1037">			ccStatment.setInt(1, ServiceStatus.getStatusAsInteger(status));</span>
<span class="nc" id="L1038">			ccStatment.setInt(2, userID);</span>
<span class="nc" id="L1039">			ccStatment.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L1040">			ccStatment.setInt(4, id);</span>
<span class="nc" id="L1041">			ccStatment.execute();</span>

<span class="nc" id="L1043">		} catch (Exception e) {</span>
<span class="nc" id="L1044">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L1046">			closePrepareStatement(ccStatment);</span>
<span class="nc" id="L1047">			closeConnection(connection);</span>
		}
<span class="nc" id="L1049">	}</span>
	
	
	
	/**
	 * Update Fraugster service status.
	 *
	 * @param status
	 *            the status
	 * @param id
	 *            the id
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public void updateFraugsterServiceStatus(String status, Integer id, Integer userID) throws ComplianceException {
<span class="nc" id="L1066">		Connection connection = null;</span>
<span class="nc" id="L1067">		PreparedStatement fStatment = null;</span>
		try {
<span class="nc" id="L1069">			connection = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L1070">			fStatment = connection.prepareStatement(DBQueryConstant.UPDATE_FUNDS_OUT_FRAUGSTER_STATUS.getQuery());</span>
<span class="nc" id="L1071">			fStatment.setInt(1, ServiceStatus.getStatusAsInteger(status));</span>
<span class="nc" id="L1072">			fStatment.setInt(2, userID);</span>
<span class="nc" id="L1073">			fStatment.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L1074">			fStatment.setInt(4, id);</span>
<span class="nc" id="L1075">			fStatment.execute();</span>

<span class="nc" id="L1077">		} catch (Exception e) {</span>
<span class="nc" id="L1078">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L1080">			closePrepareStatement(fStatment);</span>
<span class="nc" id="L1081">			closeConnection(connection);</span>
		}
<span class="nc" id="L1083">	}</span>

	
	/**
	 * Update Blacklist service status.
	 *
	 * @param status
	 *            the status
	 * @param id
	 *            the id
	 * @param userID
	 *            the user ID
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public void updateBlacklistServiceStatus(String status, Integer id, Integer userID) throws ComplianceException {
<span class="nc" id="L1099">		Connection connection = null;</span>
<span class="nc" id="L1100">		PreparedStatement fStatment = null;</span>
		try {
<span class="nc" id="L1102">			connection = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L1103">			fStatment = connection.prepareStatement(DBQueryConstant.UPDATE_FUNDS_OUT_BLACKLIST_STATUS.getQuery());</span>
<span class="nc" id="L1104">			fStatment.setInt(1, ServiceStatus.getStatusAsInteger(status));</span>
<span class="nc" id="L1105">			fStatment.setInt(2, userID);</span>
<span class="nc" id="L1106">			fStatment.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L1107">			fStatment.setInt(4, id);</span>
<span class="nc" id="L1108">			fStatment.execute();</span>

<span class="nc" id="L1110">		} catch (Exception e) {</span>
<span class="nc" id="L1111">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L1113">			closePrepareStatement(fStatment);</span>
<span class="nc" id="L1114">			closeConnection(connection);</span>
		}
<span class="nc" id="L1116">	}</span>
	
	/**
	 * Gets the existing funds out id.
	 *
	 * @param conn
	 *            the conn
	 * @param orgCode
	 *            the org code
	 * @param fundsOutId
	 *            the funds out id
	 * @return the existing funds out id
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private FundsOutRequest getExistingFundsOutId(Connection conn, String orgCode, Integer fundsOutId)
			throws ComplianceException {

<span class="nc" id="L1134">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1135">		ResultSet rs = null;</span>
<span class="nc" id="L1136">		FundsOutRequest details = new FundsOutRequest();</span>
		try {
<span class="nc" id="L1138">			preparedStatment = conn.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_ID.getQuery());</span>
<span class="nc" id="L1139">			preparedStatment.setInt(1, fundsOutId);</span>
<span class="nc" id="L1140">			preparedStatment.setString(2, orgCode);</span>
<span class="nc" id="L1141">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L1142" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1143">				String json = rs.getString(PO_ATTRIB);</span>
<span class="nc bnc" id="L1144" title="All 2 branches missed.">				if (null != json) {</span>
<span class="nc" id="L1145">					details = JsonConverterUtil.convertToObject(FundsOutRequest.class, rs.getString(PO_ATTRIB));</span>
				}
<span class="nc" id="L1147">				details.setFundsOutId(rs.getInt(FUNDS_OUT_ID));</span>
<span class="nc" id="L1148">				details.setAccId(rs.getInt(ACCOUNTID));</span>
<span class="nc" id="L1149">				details.setContactId(rs.getInt(CONTACT_ID));</span>
<span class="nc" id="L1150">				details.setDeviceInfo(createDeviceInfoObject(rs));</span>
<span class="nc" id="L1151">				details.addAttribute(Constants.STATUS, rs.getString(PO_COMPLIANCE_STATUS));</span>
<span class="nc" id="L1152">				details.addAttribute(Constants.FRAUGSTER_STATUS, ServiceStatus.getStatusAsString(rs.getInt(FRAUGSTER_STATUS)));</span>
<span class="nc" id="L1153">				details.getTrade().setTradeAccountNumber(rs.getString(&quot;TradeAccountNumber&quot;));</span>
<span class="nc" id="L1154">			}</span>
<span class="nc" id="L1155">		} catch (Exception e) {</span>
<span class="nc" id="L1156">			LOG.error(&quot;&quot;, e);</span>
		} finally {
<span class="nc" id="L1158">			closeResultset(rs);</span>
<span class="nc" id="L1159">			closePrepareStatement(preparedStatment);</span>
		}
<span class="nc" id="L1161">		return details;</span>
	}

	private DeviceInfo createDeviceInfoObject(ResultSet rs) throws SQLException{
<span class="nc" id="L1165">		DeviceInfo dInfo = new DeviceInfo();</span>
<span class="nc" id="L1166">		dInfo.setBrowserLanguage(rs.getString(&quot;BrowserLanguage&quot;));</span>
<span class="nc" id="L1167">		dInfo.setBrowserMajorVersion(rs.getString(&quot;BrowserVersion&quot;));</span>
<span class="nc" id="L1168">		dInfo.setBrowserName(rs.getString(&quot;BrowserName&quot;));</span>
		
<span class="nc bnc" id="L1170" title="All 2 branches missed.">		if(null != rs.getString(&quot;BrowserOnline&quot;)) {</span>
<span class="nc bnc" id="L1171" title="All 2 branches missed.">		   if(rs.getString(&quot;BrowserOnline&quot;).equals(&quot;1&quot;)) {</span>
<span class="nc" id="L1172">			dInfo.setBrowserOnline(&quot;true&quot;);</span>
		   }
		else
<span class="nc" id="L1175">			dInfo.setBrowserOnline(&quot;false&quot;);</span>
		}
		
<span class="nc" id="L1178">		dInfo.setScreenResolution(rs.getString(&quot;ScreenResolution&quot;));</span>
<span class="nc" id="L1179">		dInfo.setCdAppId(rs.getString(&quot;CDAppID&quot;));</span>
<span class="nc" id="L1180">		dInfo.setCdAppVersion(rs.getString(&quot;CDAppVersion&quot;));</span>
<span class="nc" id="L1181">		dInfo.setDeviceId(rs.getString(&quot;DeviceID&quot;));</span>
<span class="nc" id="L1182">		dInfo.setDeviceManufacturer(rs.getString(&quot;DeviceManufacturer&quot;));</span>
<span class="nc" id="L1183">		dInfo.setDeviceName(rs.getString(&quot;DeviceName&quot;));</span>
<span class="nc" id="L1184">		dInfo.setDeviceType(rs.getString(&quot;DeviceType&quot;));</span>
<span class="nc" id="L1185">		dInfo.setDeviceVersion(rs.getString(&quot;DeviceVersion&quot;));</span>
<span class="nc" id="L1186">		dInfo.setOsDateAndTime(rs.getString(&quot;OSTimestamp&quot;));</span>
<span class="nc" id="L1187">		dInfo.setUserAgent(rs.getString(&quot;UserAgent&quot;));</span>
		
<span class="nc" id="L1189">		return dInfo;</span>
	}
	
	/**
	 * Business -- Update sanction status into paymentOut table after updating
	 * values from UI.
	 * 
	 * Implementation--- 1) If operation is SANCTION_UPDATE then call
	 * updateSanctionServiceStatus() 2) Get SANCTION_OVERALLSTATUS as additional
	 * attribute to set sanction status on the basis of sanction contact, bank
	 * and beneficiary status.
	 * 
	 *
	 * @param message
	 *            the message
	 * @return the message
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public Message&lt;MessageContext&gt; updateFundsOutSanctionStatus(Message&lt;MessageContext&gt; message)
			throws ComplianceException {

		try {
<span class="nc" id="L1212">			OperationEnum operation = message.getPayload().getGatewayMessageExchange().getOperation();</span>
<span class="nc bnc" id="L1213" title="All 2 branches missed.">			if (operation == OperationEnum.SANCTION_UPDATE) {</span>
<span class="nc" id="L1214">				UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc" id="L1215">				MessageExchange messageExchange = message.getPayload().getGatewayMessageExchange();</span>
<span class="nc" id="L1216">				SanctionUpdateRequest sanctionUpdateRequest = messageExchange.getRequest(SanctionUpdateRequest.class);</span>
<span class="nc" id="L1217">				updateSanctionServiceStatus(</span>
<span class="nc" id="L1218">						(String) messageExchange.getResponse().getAdditionalAttribute(Constants.SANCTION_OVERALLSTATUS),</span>
<span class="nc" id="L1219">						sanctionUpdateRequest.getResourceId(), token.getUserID());</span>
			}
<span class="nc" id="L1221">		} catch (Exception e) {</span>
<span class="nc" id="L1222">			LOG.error(&quot;Error in FundsOutDBServiceImpl updateFundsOutSanctionStatus()&quot;, e);</span>
<span class="nc" id="L1223">			message.getPayload().setFailed(true);</span>
<span class="nc" id="L1224">		}</span>

<span class="nc" id="L1226">		return message;</span>
	}

	/**
	 * Gets the sanction failed records.
	 *
	 * @param request
	 *            the request
	 * @return the sanction failed records
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public Set&lt;FundsOutSanctionResendRequest&gt; getSanctionFailedRecords(ReprocessFailedSanctionRequest request)
			throws ComplianceException {

<span class="nc" id="L1241">		Connection connection = null;</span>
<span class="nc" id="L1242">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1243">		ResultSet rs = null;</span>
<span class="nc" id="L1244">		Set&lt;FundsOutSanctionResendRequest&gt; listToProcess = new HashSet&lt;&gt;();</span>

		try {

<span class="nc" id="L1248">			String query = DBQueryConstant.GET_SANCTION_FAILED_RECORDS.getQuery();</span>
<span class="nc bnc" id="L1249" title="All 4 branches missed.">			if (request.getBatchSize() == null || request.getBatchSize() &lt; 1) {</span>
<span class="nc" id="L1250">				query = query.replace(&quot;{BATCH_SIZE}&quot;, &quot;&quot;);</span>
			} else {
<span class="nc" id="L1252">				query = query.replace(&quot;{BATCH_SIZE}&quot;, &quot; TOP &quot; + request.getBatchSize() + &quot; &quot;);</span>
			}

<span class="nc bnc" id="L1255" title="All 4 branches missed.">			if (request.getPaymentOutId() == null || request.getPaymentOutId() &lt; 1) {</span>
<span class="nc" id="L1256">				query = query.replace(&quot;{PAYMENT_OUT_ID}&quot;, &quot;&quot;);</span>
			} else {
<span class="nc" id="L1258">				query = query.replace(&quot;{PAYMENT_OUT_ID}&quot;, &quot;  AND payout.id=&quot; + request.getPaymentOutId() + &quot; &quot;);</span>
			}

<span class="nc bnc" id="L1261" title="All 4 branches missed.">			if (request.getStartDate() == null || request.getEndDate() == null) {</span>
<span class="nc" id="L1262">				query = query.replace(&quot;{CREATEDON}&quot;, &quot;&quot;);</span>
			} else {
<span class="nc" id="L1264">				query = query.replace(&quot;{CREATEDON}&quot;, &quot;AND  payOut.createdOn BETWEEN '&quot; + request.getStartDate()</span>
<span class="nc" id="L1265">						+ &quot;' AND '&quot; + request.getEndDate() + &quot;'  &quot;);</span>
			}

<span class="nc" id="L1268">			connection = getConnection(Boolean.TRUE);</span>
			// EventID, accountid, c.EntityID,c.EntityType, paymentOutId,
			// sse.status,
<span class="nc" id="L1271">			preparedStatment = connection.prepareStatement(query);</span>
<span class="nc" id="L1272">			rs = preparedStatment.executeQuery();</span>
			
<span class="nc" id="L1274">			Integer status = null;</span>
<span class="nc bnc" id="L1275" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1276">				status = rs.getInt(Constants.STATUS);</span>
<span class="nc bnc" id="L1277" title="All 8 branches missed.">				if(null == status || status == 8 || status == 0 || status == 5) {</span>
<span class="nc" id="L1278">					buildResendRequest(rs, listToProcess);</span>
				}
			}
<span class="nc" id="L1281">		} catch (Exception e) {</span>
<span class="nc" id="L1282">			LOG.error(&quot;&quot;, e);</span>
		} finally {
<span class="nc" id="L1284">			closeResultset(rs);</span>
<span class="nc" id="L1285">			closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L1286">			closeConnection(connection);</span>
		}
<span class="nc" id="L1288">		return listToProcess;</span>
	}

	private void buildResendRequest(ResultSet rs, Set&lt;FundsOutSanctionResendRequest&gt; listToProcess)
			throws SQLException {
<span class="nc" id="L1293">		Integer entityType = rs.getInt(ENTITY_TYPE);</span>
		
<span class="nc" id="L1295">		FundsOutSanctionResendRequest requestToProcess = new FundsOutSanctionResendRequest();</span>
<span class="nc" id="L1296">		requestToProcess.setEventId(rs.getInt(&quot;EventID&quot;));</span>
<span class="nc" id="L1297">		requestToProcess.setAccountId(rs.getInt(ACCOUNTID));</span>
		
<span class="nc" id="L1299">		requestToProcess.setEntityType(EntityEnum.getEntityTypeAsString(entityType));</span>
<span class="nc" id="L1300">		requestToProcess.setPaymentOutId(rs.getInt(&quot;paymentOutId&quot;));</span>
<span class="nc" id="L1301">		requestToProcess.setContactID(rs.getInt(CONTACTID));</span>
<span class="nc" id="L1302">		requestToProcess.setTradeContractNumber(rs.getString(&quot;ContractNumber&quot;));</span>
<span class="nc" id="L1303">		requestToProcess.setOrgCode(rs.getString(&quot;Code&quot;));</span>
<span class="nc" id="L1304">		requestToProcess.setTradePaymentId(rs.getInt(&quot;TradePaymentID&quot;));</span>
		
<span class="nc bnc" id="L1306" title="All 2 branches missed.">		if(EntityEnum.BANK.getEntityTypeAsInteger().equals(entityType)) {</span>
<span class="nc" id="L1307">			requestToProcess.setEntityId(rs.getInt(&quot;vTradeBankID&quot;));</span>
<span class="nc" id="L1308">			requestToProcess.setBankStatus(ServiceStatus.getStatusAsString(8));</span>
		}
<span class="nc bnc" id="L1310" title="All 2 branches missed.">		if(EntityEnum.BENEFICIARY.getEntityTypeAsInteger().equals(entityType)) {</span>
<span class="nc" id="L1311">			requestToProcess.setEntityId(rs.getInt(&quot;vTradeBeneficiaryID&quot;));</span>
<span class="nc" id="L1312">			requestToProcess.setBeneficiaryStatus(ServiceStatus.getStatusAsString(8));</span>
		}
<span class="nc bnc" id="L1314" title="All 2 branches missed.">		if(EntityEnum.CONTACT.getEntityTypeAsInteger().equals(entityType)) {</span>
<span class="nc" id="L1315">			requestToProcess.setEntityId(rs.getInt(CONTACTID));</span>
<span class="nc" id="L1316">			requestToProcess.setContactStatus(ServiceStatus.getStatusAsString(8));</span>
		}
		
<span class="nc" id="L1319">		listToProcess.add(requestToProcess);</span>
<span class="nc" id="L1320">	}</span>

	/**
	 * Gets the other entity status.
	 *
	 * @param request
	 *            the request
	 * @return the other entity status
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public void getOtherEntityStatus(FundsOutSanctionResendRequest request) throws ComplianceException {
<span class="nc" id="L1332">		Connection connection = null;</span>
<span class="nc" id="L1333">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1334">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L1336">			connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1337">			preparedStatment = connection.prepareStatement(DBQueryConstant.GET_OTHER_ENTITY_STATUS.getQuery());</span>
<span class="nc" id="L1338">			preparedStatment.setInt(1, request.getPaymentOutId());</span>
<span class="nc" id="L1339">			preparedStatment.setInt(2, EntityEnum.getEntityTypeAsInteger(request.getEntityType()));</span>
<span class="nc" id="L1340">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L1341" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">				if (null == request.getBeneficiaryStatus()</span>
<span class="nc bnc" id="L1343" title="All 2 branches missed.">						&amp;&amp; EntityEnum.BENEFICIARY.getEntityTypeAsInteger() == rs.getInt(ENTITY_TYPE)) {</span>
<span class="nc" id="L1344">					request.setBeneficiaryStatus(ServiceStatus.getStatusAsString(rs.getInt(Constants.STATUS)));</span>
				}
<span class="nc bnc" id="L1346" title="All 2 branches missed.">				if (null == request.getContactStatus()</span>
<span class="nc bnc" id="L1347" title="All 2 branches missed.">						&amp;&amp; EntityEnum.CONTACT.getEntityTypeAsInteger() == rs.getInt(ENTITY_TYPE)) {</span>
<span class="nc" id="L1348">					request.setContactStatus(ServiceStatus.getStatusAsString(rs.getInt(Constants.STATUS)));</span>
				}
<span class="nc bnc" id="L1350" title="All 2 branches missed.">				if (null == request.getBankStatus()</span>
<span class="nc bnc" id="L1351" title="All 2 branches missed.">						&amp;&amp; EntityEnum.BANK.getEntityTypeAsInteger() == rs.getInt(ENTITY_TYPE)) {</span>
<span class="nc" id="L1352">					request.setBankStatus(ServiceStatus.getStatusAsString(rs.getInt(Constants.STATUS)));</span>
				}
			}
<span class="nc" id="L1355">		} catch (Exception e) {</span>
<span class="nc" id="L1356">			LOG.error(&quot;&quot;, e);</span>
		} finally {
<span class="nc" id="L1358">			closeResultset(rs);</span>
<span class="nc" id="L1359">			closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L1360">			closeConnection(connection);</span>
		}

<span class="nc" id="L1363">	}</span>

	/**
	 * Update payments out compliance status.
	 *
	 * @param fundsOutId
	 *            the funds out id
	 * @param userID
	 *            the user ID
	 * @param status
	 *            the status
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public void updatePaymentsOutComplianceStatus(Integer fundsOutId, Integer userID, FundsOutComplianceStatus status)
			throws ComplianceException {
<span class="nc" id="L1379">		Connection connection = null;</span>
<span class="nc" id="L1380">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1381">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L1383">			connection = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L1384">			preparedStatment = connection.prepareStatement(DBQueryConstant.UPDATE_PAYMENT_OUT_STATUS.getQuery());</span>
<span class="nc" id="L1385">			preparedStatment.setInt(1, userID);</span>
<span class="nc" id="L1386">			preparedStatment.setTimestamp(2, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L1387">			preparedStatment.setInt(3, status.getFundsOutStatusAsInteger());</span>
<span class="nc" id="L1388">			preparedStatment.setInt(4, fundsOutId);</span>
<span class="nc" id="L1389">			preparedStatment.execute();</span>

<span class="nc" id="L1391">		} catch (Exception e) {</span>
<span class="nc" id="L1392">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L1394">			closeResultset(rs);</span>
<span class="nc" id="L1395">			closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L1396">			closeConnection(connection);</span>
		}
<span class="nc" id="L1398">	}</span>

	/**
	 * Gets the sanction status.
	 *
	 * @param fundsOutId
	 *            the funds out id
	 * @return the sanction status
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public String getSanctionStatus(Integer fundsOutId) throws ComplianceException {
<span class="nc" id="L1410">		Connection connection = null;</span>
<span class="nc" id="L1411">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1412">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L1414">			connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1415">			preparedStatment = connection.prepareStatement(DBQueryConstant.GET_SANCTION_STATUS.getQuery());</span>
<span class="nc" id="L1416">			preparedStatment.setInt(1, fundsOutId);</span>
<span class="nc" id="L1417">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L1418" title="All 2 branches missed.">			if (rs.next())</span>
<span class="nc" id="L1419">				return ServiceStatus.getStatusAsString(rs.getInt(&quot;sanctionstatus&quot;));</span>
<span class="nc" id="L1420">		} catch (Exception e) {</span>
<span class="nc" id="L1421">			throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
		} finally {
<span class="nc" id="L1423">			closeResultset(rs);</span>
<span class="nc" id="L1424">			closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L1425">			closeConnection(connection);</span>
		}
<span class="nc" id="L1427">		return null;</span>
	}
	
	void getFailedFundsOutContactAccountDetails(FundsOutRequest request, Connection conn, String tradeAccountNumber,
			String orgCode) throws ComplianceException {
<span class="nc" id="L1432">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1433">		ResultSet rs = null;</span>
		try {
<span class="nc" id="L1435">			String contactJoin = &quot; AND c.id = ? ORDER BY &quot;;</span>
<span class="nc" id="L1436">			String query = DBQueryConstant.GET_FUNDS_OUT_ACCOUNT_CONTACT_DETAILS.getQuery().replace(&quot;ORDER BY&quot;, contactJoin);</span>
<span class="nc" id="L1437">			preparedStatment = conn.prepareStatement(query);</span>
<span class="nc" id="L1438">			preparedStatment.setString(1, orgCode);</span>
<span class="nc" id="L1439">			preparedStatment.setString(2, tradeAccountNumber);</span>
<span class="nc" id="L1440">			preparedStatment.setString(3, orgCode);</span>
<span class="nc" id="L1441">			preparedStatment.setString(4, request.getContactId().toString());</span>
<span class="nc" id="L1442">			rs = preparedStatment.executeQuery();</span>
<span class="nc" id="L1443">			Integer count = 1;</span>
<span class="nc" id="L1444">			Integer noOfContacts = 0;</span>
<span class="nc" id="L1445">			Integer accountTMFlag = 0;</span>
<span class="nc" id="L1446">			List&lt;String&gt; watchListDetails = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1447">			MultiMap multiMapWatchlistCon = new MultiHashMap();//AT-3502</span>
<span class="nc bnc" id="L1448" title="All 2 branches missed.">			while (rs.next()) {</span>

<span class="nc" id="L1450">				request.setOrgId(rs.getInt(&quot;requestOrgID&quot;));</span>
<span class="nc" id="L1451">				Account acc = JsonConverterUtil.convertToObject(Account.class, rs.getString(&quot;acattrib&quot;));</span>
<span class="nc" id="L1452">				acc.setId(rs.getInt(ACCOUNTID));</span>
<span class="nc" id="L1453">				acc.setCustomerType(rs.getInt(&quot;custType&quot;));</span>
<span class="nc" id="L1454">				acc.setAccountStatus(rs.getString(&quot;accountStatus&quot;));</span>
<span class="nc" id="L1455">				request.setAccId(acc.getId());</span>
<span class="nc" id="L1456">				request.addAttribute(ACCOUNT, acc);</span>
<span class="nc" id="L1457">				request.addAttribute(Constants.LE_UPDATE_DATE, rs.getString(&quot;leupdatedate&quot;)); //Add for AT-3349</span>
<span class="nc" id="L1458">				Contact con = JsonConverterUtil.convertToObject(Contact.class, rs.getString(&quot;contactattrib&quot;));</span>
<span class="nc" id="L1459">				con.setId(rs.getInt(CONTACTID));</span>
<span class="nc" id="L1460">				con.setContactStatus(rs.getString(&quot;ContactStatus&quot;));</span>
<span class="nc" id="L1461">				con.setPoiExists(rs.getInt(&quot;poiexists&quot;));	//Add for AT-3349</span>
<span class="nc" id="L1462">				request.addAttribute(CONTACT, con);</span>
<span class="nc bnc" id="L1463" title="All 4 branches missed.">				if (null != rs.getString(WATCHLISTREASONNAME) &amp;&amp; !rs.getString(WATCHLISTREASONNAME).isEmpty()) {</span>
<span class="nc" id="L1464">					request.addAttribute(WATCHLIST_ID+ count, rs.getInt(WATCHLIST_ID));</span>
<span class="nc" id="L1465">					watchListDetails.add(rs.getString(WATCHLISTREASONNAME));</span>
<span class="nc" id="L1466">					request.addAttribute(&quot;watchlistreasonname1&quot;,rs.getString(WATCHLISTREASONNAME));</span>
				}
<span class="nc" id="L1468">				multiMapWatchlistCon.put(rs.getInt(TRADE_CONTACT_ID), rs.getString(WATCHLISTREASONNAME));</span>
<span class="nc" id="L1469">				noOfContacts++;</span>
<span class="nc" id="L1470">				accountTMFlag = rs.getInt(&quot;accountTMFlag&quot;);</span>
<span class="nc" id="L1471">			}</span>
<span class="nc" id="L1472">			request.addAttribute(&quot;noOfContacts&quot;, noOfContacts);</span>
<span class="nc" id="L1473">			request.addAttribute(REASONS_OF_WATCHLIST, watchListDetails);</span>
<span class="nc" id="L1474">			request.addAttribute(&quot;watchlist_with_trade&amp;cont&quot;, multiMapWatchlistCon);</span>
<span class="nc" id="L1475">			request.addAttribute(ACCOUNT_TM_FLAG, accountTMFlag);</span>
<span class="nc" id="L1476">		} catch (Exception e) {</span>
<span class="nc" id="L1477">			LOG.error(&quot; &quot;, e);</span>
		} finally {
<span class="nc" id="L1479">			closeResultset(rs);</span>
<span class="nc" id="L1480">			closePrepareStatement(preparedStatment);</span>
		}

<span class="nc" id="L1483">	}</span>
	
	
	public List&lt;EventServiceLog&gt; getFailedFundsOutESLDetails(FundsOutRequest request) throws ComplianceException {
<span class="nc" id="L1487">		Connection conn = null;</span>
<span class="nc" id="L1488">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1489">		ResultSet rs = null;</span>
<span class="nc" id="L1490">		List&lt;EventServiceLog&gt; eventServiceLogList = new ArrayList&lt;&gt;();</span>
		try {
<span class="nc" id="L1492">			conn = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1493">			String query = DBQueryConstant.GET_ESL_FOR_SERVICE_FAILED_FUNDSOUT.getQuery();</span>
<span class="nc" id="L1494">			preparedStatment = conn.prepareStatement(query);</span>
<span class="nc" id="L1495">			preparedStatment.setString(1, request.getFundsOutId().toString());</span>
<span class="nc" id="L1496">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L1497" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1498">				EventServiceLog eventServiceLog = new EventServiceLog();</span>
<span class="nc" id="L1499">				eventServiceLog.setEntityType(EntityEnum.getEntityTypeAsString(rs.getInt(ENTITY_TYPE)));</span>
<span class="nc" id="L1500">				eventServiceLog.setServiceType(rs.getInt(&quot;ServiceType&quot;));</span>
<span class="nc" id="L1501">				eventServiceLog.setProviderResponse(rs.getString(&quot;ProviderResponse&quot;));</span>
<span class="nc" id="L1502">				eventServiceLog.setStatus(ServiceStatus.getStatusAsString(rs.getInt(&quot;Status&quot;)));</span>
<span class="nc" id="L1503">				eventServiceLog.setSummary(rs.getString(&quot;summary&quot;));</span>
<span class="nc" id="L1504">				eventServiceLog.setEntityId(rs.getInt(&quot;EntityID&quot;));</span>
<span class="nc" id="L1505">				eventServiceLog.setEntityVersion(rs.getInt(&quot;EntityVersion&quot;));</span>
<span class="nc" id="L1506">				eventServiceLog.setEventId(rs.getInt(&quot;eventID&quot;));</span>
<span class="nc" id="L1507">				eventServiceLogList.add(eventServiceLog);</span>
<span class="nc" id="L1508">			}</span>
<span class="nc" id="L1509">		} catch (Exception e) {</span>
<span class="nc" id="L1510">			LOG.error(&quot;Error while fetching eventservicelog details :&quot;, e);</span>
		} finally {
<span class="nc" id="L1512">			closeResultset(rs);</span>
<span class="nc" id="L1513">			closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L1514">			closeConnection(conn);</span>
		}
<span class="nc" id="L1516">		return eventServiceLogList;</span>

	}
	
	/**
	 * Gets the failed funds out details.
	 *
	 * @param paymentOutId the payment out id
	 * @param orgCode the org code
	 * @param message 
	 * @return the failed funds out details
	 * @throws ComplianceException the compliance exception
	 */
	public FundsOutRequest getFailedFundsOutDetails(Integer paymentOutId) throws ComplianceException{
<span class="nc" id="L1530">		Connection connection = null;</span>
<span class="nc" id="L1531">		PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1532">		ResultSet resultSet = null;</span>
<span class="nc" id="L1533">		FundsOutRequest fundsOutDetails = new FundsOutRequest();</span>
		try {
<span class="nc" id="L1535">			connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1536">			preparedStatement = connection.prepareStatement(DBQueryConstant.GET_DETAILS_FOR_FAILED_FUNDS_OUT.getQuery());</span>
<span class="nc" id="L1537">			preparedStatement.setInt(1, paymentOutId);</span>
<span class="nc" id="L1538">			resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L1539" title="All 2 branches missed.">			while (resultSet.next()) {</span>
<span class="nc" id="L1540">				String json = resultSet.getString(PO_ATTRIB);</span>
<span class="nc bnc" id="L1541" title="All 2 branches missed.">				if (null != json) {</span>
<span class="nc" id="L1542">					fundsOutDetails = JsonConverterUtil.convertToObject(FundsOutRequest.class, resultSet.getString(PO_ATTRIB));</span>
				}
<span class="nc" id="L1544">				fundsOutDetails.setFundsOutId(paymentOutId);</span>
<span class="nc" id="L1545">				fundsOutDetails.setAccId(resultSet.getInt(ACCOUNTID));</span>
<span class="nc" id="L1546">				fundsOutDetails.getTrade().setTradeAccountNumber(resultSet.getString(&quot;tradeaccountnumber&quot;));</span>
<span class="nc" id="L1547">				fundsOutDetails.setContactId(resultSet.getInt(CONTACT_ID));</span>
<span class="nc" id="L1548">				fundsOutDetails.setDeviceInfo(createDeviceInfoObject(resultSet));</span>
<span class="nc" id="L1549">				fundsOutDetails.addAttribute(Constants.STATUS, resultSet.getString(PO_COMPLIANCE_STATUS));</span>
<span class="nc" id="L1550">				fundsOutDetails.addAttribute(Constants.FRAUGSTER_STATUS, ServiceStatus.getStatusAsString(resultSet.getInt(FRAUGSTER_STATUS)));</span>
<span class="nc" id="L1551">				fundsOutDetails.addAttribute(Constants.BLACKLIST_STATUS, ServiceStatus.getStatusAsString(resultSet.getInt(BLACKLIST_STATUS)));</span>
<span class="nc" id="L1552">				fundsOutDetails.addAttribute(Constants.SANCTION_STATUS, ServiceStatus.getStatusAsString(resultSet.getInt(&quot;SanctionStatus&quot;)));</span>
<span class="nc" id="L1553">				fundsOutDetails.addAttribute(Constants.CUSTOM_CHECK_STATUS, ServiceStatus.getStatusAsString(resultSet.getInt(CUSTOM_CHECK_STATUS)));</span>
<span class="nc" id="L1554">				fundsOutDetails.addAttribute(Constants.PAYMENT_REFERENCE_STATUS, ServiceStatus.getStatusAsString(resultSet.getInt(PAYMENT_REFERENCE_STATUS))); //AT-4445</span>
<span class="nc" id="L1555">		}</span>
<span class="nc" id="L1556">			getFailedFundsOutContactAccountDetails(fundsOutDetails, connection, fundsOutDetails.getTradeAccountNumber(),</span>
<span class="nc" id="L1557">					fundsOutDetails.getOrgCode());</span>
<span class="nc" id="L1558">		} catch (Exception e) {</span>
<span class="nc" id="L1559">			LOG.error(&quot;Error while fetching service failed funds out details :&quot;, e);</span>
		} finally {
<span class="nc" id="L1561">			closeResultset(resultSet);</span>
<span class="nc" id="L1562">			closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1563">			closeConnection(connection);</span>
		}
<span class="nc" id="L1565">		return fundsOutDetails;</span>
	}
	
	
	/**
	 * AT-3349
	 * Check any funds clear for contact.
	 *
	 * @param tradeContactId the trade contact id
	 * @param tradeAccountuNumber the trade accountu number
	 * @param fundsOutRequest the funds out request
	 * @throws ComplianceException the compliance exception
	 */
	public void checkAnyFundsClearForContact(FundsOutRequest fundsOutRequest, String date) 
			throws ComplianceException {
<span class="nc" id="L1580">		Connection conn = null;</span>
<span class="nc" id="L1581">		PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1582">		ResultSet rs = null;</span>
		
		try {
<span class="nc" id="L1585">			conn = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1586">			int fundsInCount = 0;</span>
<span class="nc" id="L1587">			int fundsOutCount = 0;</span>
<span class="nc" id="L1588">			preparedStatment = conn.prepareStatement(DBQueryConstant.GET_NUMBER_OF_FI_CLEAR_AFTER_LEDATE.getQuery());</span>
<span class="nc" id="L1589">			preparedStatment.setString(1,fundsOutRequest.getTrade().getTradeAccountNumber());</span>
<span class="nc" id="L1590">			preparedStatment.setInt(2,fundsOutRequest.getTrade().getTradeContactId());</span>
<span class="nc" id="L1591">			preparedStatment.setString(3, date);</span>
<span class="nc" id="L1592">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L1593" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1594">				 fundsInCount = rs.getInt(&quot;NumOfFundsInClear&quot;);</span>
			}
<span class="nc" id="L1596">			closeResultset(rs);</span>
<span class="nc" id="L1597">			closePrepareStatement(preparedStatment);</span>
			
<span class="nc" id="L1599">			preparedStatment = conn.prepareStatement(DBQueryConstant.GET_NUMBER_OF_FO_CLEAR_AFTER_LEDATE.getQuery());</span>
<span class="nc" id="L1600">			preparedStatment.setString(1,fundsOutRequest.getTrade().getTradeAccountNumber());</span>
<span class="nc" id="L1601">			preparedStatment.setInt(2,fundsOutRequest.getTrade().getTradeContactId());</span>
<span class="nc" id="L1602">			preparedStatment.setString(3, date);</span>
<span class="nc" id="L1603">			rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L1604" title="All 2 branches missed.">			while (rs.next()) {</span>
<span class="nc" id="L1605">				 fundsOutCount = rs.getInt(&quot;NumOfFundsOutClear&quot;);</span>
			}
			
<span class="nc" id="L1608">			Integer count = fundsInCount + fundsOutCount;</span>
			
<span class="nc bnc" id="L1610" title="All 2 branches missed.">			if(count.equals(0)) {</span>
<span class="nc" id="L1611">				fundsOutRequest.addAttribute(Constants.ZERO_EU_FUNDS_CLEARED_AFTER_LE_DATE,Boolean.TRUE);</span>
			}
			else {
<span class="nc" id="L1614">				fundsOutRequest.addAttribute(Constants.ZERO_EU_FUNDS_CLEARED_AFTER_LE_DATE,Boolean.FALSE);</span>
			}
<span class="nc" id="L1616">		}catch(Exception e) {</span>
<span class="nc" id="L1617">			LOG.error(&quot;Error while fetching checkAnyFundsClearForContact() details :&quot;, e);</span>
		} finally {
<span class="nc" id="L1619">			closeResultset(rs);</span>
<span class="nc" id="L1620">			closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L1621">			closeConnection(conn);</span>
		}
<span class="nc" id="L1623">	}</span>
	
	//Added for AT-3658
		/**
		 * Following method calls two functions which returns whether for given
		 * trade account number &amp; organization account &amp; contact is present and
		 * whether for given organization funds out id is present.
		 *
		 * @param fundsOutBaseRequest
		 *            the funds out base request
		 * @return the funds out details
		 * @throws ComplianceException
		 *             the compliance exception
		 */
		public FundsOutRequest getFundsOutDetailsForPaymentReferenceRepeatCheck(FundsOutBaseRequest fundsOutBaseRequest) throws ComplianceException {
<span class="nc" id="L1638">			Connection conn = null;</span>
<span class="nc" id="L1639">			FundsOutRequest details = new FundsOutRequest();</span>
			try {
<span class="nc" id="L1641">				   conn = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1642">	               details = getExistingFundsOutIdForPaymentReferenceRepeatCheck(conn, fundsOutBaseRequest.getOrgCode(),</span>
<span class="nc" id="L1643">							fundsOutBaseRequest.getPaymentFundsoutId());</span>
<span class="nc" id="L1644">				   getFundsOutContactAccountDetails(details, conn, fundsOutBaseRequest.getTradeAccountNumber(),</span>
<span class="nc" id="L1645">						fundsOutBaseRequest.getOrgCode());</span>

<span class="nc" id="L1647">			} catch (Exception e) {</span>
<span class="nc" id="L1648">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1650">				closeConnection(conn);</span>
			}
<span class="nc" id="L1652">			return details;</span>
		}
		
		//Added for AT-3658
		private FundsOutRequest getExistingFundsOutIdForPaymentReferenceRepeatCheck(Connection conn, String orgCode, Integer fundsOutId)
				throws ComplianceException {

<span class="nc" id="L1659">			PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L1660">			ResultSet rs = null;</span>
<span class="nc" id="L1661">			FundsOutRequest details = new FundsOutRequest();</span>
			try {
<span class="nc" id="L1663">				preparedStatment = conn.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_ID_FOR_PAYMENT_REFERENCE.getQuery());</span>
<span class="nc" id="L1664">				preparedStatment.setInt(1, fundsOutId);</span>
<span class="nc" id="L1665">				preparedStatment.setString(2, orgCode);</span>
<span class="nc" id="L1666">				rs = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L1667" title="All 2 branches missed.">				while (rs.next()) {</span>
<span class="nc" id="L1668">					String json = rs.getString(PO_ATTRIB);</span>
<span class="nc bnc" id="L1669" title="All 2 branches missed.">					if (null != json) {</span>
<span class="nc" id="L1670">						details = JsonConverterUtil.convertToObject(FundsOutRequest.class, rs.getString(PO_ATTRIB));</span>
					}
<span class="nc" id="L1672">					details.setFundsOutId(rs.getInt(FUNDS_OUT_ID));</span>
<span class="nc" id="L1673">					details.setAccId(rs.getInt(ACCOUNTID));</span>
<span class="nc" id="L1674">					details.setContactId(rs.getInt(CONTACT_ID));</span>
<span class="nc" id="L1675">					details.addAttribute(Constants.STATUS, rs.getString(PO_COMPLIANCE_STATUS));</span>
<span class="nc" id="L1676">					details.addAttribute(Constants.PAYMENT_REFERENCE_STATUS, ServiceStatus.getStatusAsString(rs.getInt(PAYMENT_REFERENCE_STATUS)));</span>
<span class="nc" id="L1677">				}</span>
<span class="nc" id="L1678">			} catch (Exception e) {</span>
<span class="nc" id="L1679">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1681">				closeResultset(rs);</span>
<span class="nc" id="L1682">				closePrepareStatement(preparedStatment);</span>
			}
<span class="nc" id="L1684">			return details;</span>
		}
		
		//Added for AT-3658
		/**
		 * Update Payment Reference service status.
		 *
		 * @param status
		 *            the status
		 * @param id
		 *            the id
		 * @param userID
		 *            the user ID
		 * @throws ComplianceException
		 *             the compliance exception
		 */
		public void updatePaymentReferenceServiceStatus(String status, Integer id, Integer userID) throws ComplianceException {
<span class="nc" id="L1701">			Connection connection = null;</span>
<span class="nc" id="L1702">			PreparedStatement fStatment = null;</span>
			try {
<span class="nc" id="L1704">				connection = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L1705">				fStatment = connection.prepareStatement(DBQueryConstant.UPDATE_FUNDS_OUT_PAYMENT_REFERENCE_STATUS.getQuery());</span>
<span class="nc" id="L1706">				fStatment.setInt(1, ServiceStatus.getStatusAsInteger(status));</span>
<span class="nc" id="L1707">				fStatment.setInt(2, userID);</span>
<span class="nc" id="L1708">				fStatment.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L1709">				fStatment.setInt(4, id);</span>
<span class="nc" id="L1710">				fStatment.execute();</span>

<span class="nc" id="L1712">			} catch (Exception e) {</span>
<span class="nc" id="L1713">				throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
			} finally {
<span class="nc" id="L1715">				closePrepareStatement(fStatment);</span>
<span class="nc" id="L1716">				closeConnection(connection);</span>
			}
<span class="nc" id="L1718">		}</span>

		/**
		 * Gets the funds out details for intuition.
		 *
		 * @param tradePayId the trade pay id
		 * @return the funds out details for intuition
		 * @throws ComplianceException the compliance exception
		 */
		//AT-4451
		public FundsOutRequest getFundsOutDetailsForIntuition(Integer tradePayId) throws ComplianceException {
<span class="nc" id="L1729">			Connection connection = null;</span>
<span class="nc" id="L1730">			PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1731">			ResultSet resultSet = null;</span>
<span class="nc" id="L1732">			FundsOutRequest fundsOutDetails = new FundsOutRequest();;</span>
			try {
<span class="nc" id="L1734">				connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1735">				preparedStatement = connection.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_DETAILS_FOR_INTUITION.getQuery());</span>
<span class="nc" id="L1736">				preparedStatement.setInt(1, tradePayId);</span>
<span class="nc" id="L1737">				resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L1738" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L1739">					String json = resultSet.getString(PO_ATTRIB);</span>
<span class="nc bnc" id="L1740" title="All 2 branches missed.">					if (null != json) {</span>
<span class="nc" id="L1741">						fundsOutDetails = JsonConverterUtil.convertToObject(FundsOutRequest.class,</span>
<span class="nc" id="L1742">								resultSet.getString(PO_ATTRIB));</span>
					}
<span class="nc" id="L1744">					fundsOutDetails.setFundsOutId(resultSet.getInt(&quot;payOutId&quot;));</span>
<span class="nc" id="L1745">					fundsOutDetails.setAccId(resultSet.getInt(ACCOUNTID));</span>
<span class="nc" id="L1746">					fundsOutDetails.getTrade().setTradeAccountNumber(resultSet.getString(&quot;Tradeaccountnumber&quot;));</span>
<span class="nc" id="L1747">					fundsOutDetails.getTrade().setTradeContactId(resultSet.getInt(TRADE_CONTACT_ID));</span>
<span class="nc" id="L1748">					fundsOutDetails.setContactId(resultSet.getInt(CONTACT_ID));</span>
<span class="nc" id="L1749">					fundsOutDetails.addAttribute(Constants.STATUS, FundsOutComplianceStatus</span>
<span class="nc" id="L1750">							.getFundsInComplianceStatusAsString(resultSet.getInt(COMPLIANCE_STATUS)));</span>
<span class="nc" id="L1751">					fundsOutDetails.addAttribute(Constants.FRAUGSTER_STATUS,</span>
<span class="nc" id="L1752">							ServiceStatus.getStatusAsString(resultSet.getInt(FRAUGSTER_STATUS)));</span>
<span class="nc" id="L1753">					fundsOutDetails.addAttribute(Constants.BLACKLIST_STATUS,</span>
<span class="nc" id="L1754">							ServiceStatus.getStatusAsString(resultSet.getInt(BLACKLIST_STATUS)));</span>
<span class="nc" id="L1755">					fundsOutDetails.addAttribute(Constants.CUSTOM_CHECK_STATUS,</span>
<span class="nc" id="L1756">							ServiceStatus.getStatusAsString(resultSet.getInt(CUSTOM_CHECK_STATUS)));</span>
<span class="nc" id="L1757">					fundsOutDetails.addAttribute(Constants.PAYMENT_REFERENCE_STATUS,</span>
<span class="nc" id="L1758">							ServiceStatus.getStatusAsString(resultSet.getInt(PAYMENT_REFERENCE_STATUS)));</span>
<span class="nc" id="L1759">					fundsOutDetails.addAttribute(ACCOUNT_VERSION, resultSet.getInt(ACCOUNT_VERSION));</span>
<span class="nc" id="L1760">					fundsOutDetails.addAttribute(ACCOUNT_TM_FLAG, resultSet.getInt(ACCOUNT_TM_FLAG));</span>
<span class="nc" id="L1761">					fundsOutDetails.addAttribute(&quot;STPFlag&quot;, resultSet.getString(&quot;InitialStatus&quot;));</span>
<span class="nc" id="L1762">					fundsOutDetails.addAttribute(&quot;orgcode&quot;, resultSet.getString(&quot;OrganizationCode&quot;));</span>
<span class="nc" id="L1763">					fundsOutDetails.addAttribute(Constants.ETAILER, resultSet.getString(Constants.ETAILER)); //AT-5310</span>
<span class="nc" id="L1764">					fundsOutDetails.addAttribute(&quot;AffiliateName&quot;, resultSet.getString(&quot;AffiliateName&quot;)); // Add For AT-5454</span>
<span class="nc" id="L1765">				}</span>
<span class="nc" id="L1766">			} catch (Exception e) {</span>
<span class="nc" id="L1767">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1769">				closeResultset(resultSet);</span>
<span class="nc" id="L1770">				closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1771">				closeConnection(connection);</span>
			}
<span class="nc" id="L1773">			return fundsOutDetails;</span>
		}

		/**
		 * Gets the country check status for intuition.
		 *
		 * @param fundsOut the funds out
		 * @param transactionMonitoringPaymentsOutRequest the transaction monitoring payments out request
		 * @return the country check status for intuition
		 * @throws ComplianceException the compliance exception
		 */
		//AT-4451
		public String getCountryCheckStatusForIntuition(FundsOutRequest fundsOut) throws ComplianceException {
<span class="nc" id="L1786">			Connection connection = null;</span>
<span class="nc" id="L1787">			ResultSet resultSet = null;</span>
<span class="nc" id="L1788">			PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1789">			String countryCheckStatus = null;</span>
			try {
<span class="nc" id="L1791">				connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1792">				preparedStatement = connection.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_COUNTRY_CHECK_STATUS_FOR_INTUITION.getQuery());</span>
<span class="nc" id="L1793">				preparedStatement.setInt(1, fundsOut.getBeneficiary().getBeneficiaryId());</span>
<span class="nc" id="L1794">				resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L1795" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L1796">					countryCheckStatus = resultSet.getString(&quot;CountryCheckStatus&quot;);</span>
				}

<span class="nc" id="L1799">			} catch (Exception e) {</span>
<span class="nc" id="L1800">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1802">				closeResultset(resultSet);</span>
<span class="nc" id="L1803">				closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1804">				closeConnection(connection);</span>
			}
<span class="nc" id="L1806">			return countryCheckStatus;</span>
		}

		/**
		 * Gets the sanction status for intuition.
		 *
		 * @param fundsOutRequest the funds out request
		 * @param transactionMonitoringPaymentsOutRequest the transaction monitoring payments out request
		 * @return the sanction status for intuition
		 * @throws ComplianceException the compliance exception
		 */
		//AT-4451
		public void getSanctionStatusForIntuition(FundsOutRequest fundsOutRequest,
				TransactionMonitoringPaymentsOutRequest transactionMonitoringPaymentsOutRequest)
				throws ComplianceException {

<span class="nc" id="L1822">			String contactSanctionStatus = getContactSanctionStatus(fundsOutRequest.getContactId(),</span>
<span class="nc" id="L1823">					fundsOutRequest.getFundsOutId());</span>
<span class="nc" id="L1824">			String beneficierySanctionStatus = getBeneficierySanctionStatus(</span>
<span class="nc" id="L1825">					fundsOutRequest.getBeneficiary().getBeneficiaryId(), fundsOutRequest.getFundsOutId());</span>
<span class="nc" id="L1826">			String bankSanctionStatus = getBankSanctionStatus(fundsOutRequest.getBeneficiary().getBeneficiaryBankid(),</span>
<span class="nc" id="L1827">					fundsOutRequest.getFundsOutId());</span>

<span class="nc" id="L1829">			transactionMonitoringPaymentsOutRequest.setSanctionContactStatus(contactSanctionStatus);</span>
<span class="nc" id="L1830">			transactionMonitoringPaymentsOutRequest.setSanctionBeneficiaryStatus(beneficierySanctionStatus);</span>
<span class="nc" id="L1831">			transactionMonitoringPaymentsOutRequest.setSanctionBankStatus(bankSanctionStatus);</span>
<span class="nc" id="L1832">		}</span>

		/**
		 * Gets the contact sanction status.
		 *
		 * @param contactId the contact id
		 * @param fundsOutId the funds out id
		 * @return the contact sanction status
		 * @throws ComplianceException the compliance exception
		 */
		public String getContactSanctionStatus(Integer contactId, Integer fundsOutId) throws ComplianceException {
<span class="nc" id="L1843">			Connection connection = null;</span>
<span class="nc" id="L1844">			ResultSet resultSet = null;</span>
<span class="nc" id="L1845">			PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1846">			String status = null;</span>
			try {
<span class="nc" id="L1848">				connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1849">				preparedStatement = connection.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_CONTACT_SANCTION_STATUS.getQuery());</span>
<span class="nc" id="L1850">				preparedStatement.setInt(1, contactId);</span>
<span class="nc" id="L1851">				preparedStatement.setInt(2, fundsOutId);</span>
<span class="nc" id="L1852">				resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L1853" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L1854">					status = resultSet.getString(&quot;ContactSanctionStatus&quot;);</span>
				}

<span class="nc" id="L1857">			} catch (Exception e) {</span>
<span class="nc" id="L1858">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1860">				closeResultset(resultSet);</span>
<span class="nc" id="L1861">				closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1862">				closeConnection(connection);</span>
			}
<span class="nc" id="L1864">			return status;</span>
		}

		/**
		 * Gets the beneficiery sanction status.
		 *
		 * @param beneficiaryId the beneficiary id
		 * @param fundsOutId the funds out id
		 * @return the beneficiery sanction status
		 * @throws ComplianceException the compliance exception
		 */
		public String getBeneficierySanctionStatus(Integer beneficiaryId, Integer fundsOutId) throws ComplianceException {
<span class="nc" id="L1876">			Connection connection = null;</span>
<span class="nc" id="L1877">			ResultSet resultSet = null;</span>
<span class="nc" id="L1878">			PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1879">			String status = null;</span>
			try {
<span class="nc" id="L1881">				connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1882">				preparedStatement = connection.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_BENEFICIARY_SANCTION_STATUS.getQuery());</span>
<span class="nc" id="L1883">				preparedStatement.setInt(1, beneficiaryId);</span>
<span class="nc" id="L1884">				preparedStatement.setInt(2, fundsOutId);</span>
<span class="nc" id="L1885">				resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L1886" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L1887">					status = resultSet.getString(&quot;BeneficierySanctionStatus&quot;);</span>
				}

<span class="nc" id="L1890">			} catch (Exception e) {</span>
<span class="nc" id="L1891">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1893">				closeResultset(resultSet);</span>
<span class="nc" id="L1894">				closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1895">				closeConnection(connection);</span>
			}
<span class="nc" id="L1897">			return status;</span>
		}

		/**
		 * Gets the bank sanction status.
		 *
		 * @param beneficiaryBankid the beneficiary bankid
		 * @param fundsOutId the funds out id
		 * @return the bank sanction status
		 * @throws ComplianceException the compliance exception
		 */
		public String getBankSanctionStatus(Integer beneficiaryBankid, Integer fundsOutId) throws ComplianceException {
<span class="nc" id="L1909">			Connection connection = null;</span>
<span class="nc" id="L1910">			ResultSet resultSet = null;</span>
<span class="nc" id="L1911">			PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1912">			String status = null;</span>
			try {
<span class="nc" id="L1914">				connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1915">				preparedStatement = connection.prepareStatement(DBQueryConstant.GET_FUNDS_OUT_BANK_SANCTION_STATUS.getQuery());</span>
<span class="nc" id="L1916">				preparedStatement.setInt(1, beneficiaryBankid);</span>
<span class="nc" id="L1917">				preparedStatement.setInt(2, fundsOutId);</span>
<span class="nc" id="L1918">				resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L1919" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L1920">					status = resultSet.getString(&quot;BankSanctionStatus&quot;);</span>
				}

<span class="nc" id="L1923">			} catch (Exception e) {</span>
<span class="nc" id="L1924">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1926">				closeResultset(resultSet);</span>
<span class="nc" id="L1927">				closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1928">				closeConnection(connection);</span>
			}
<span class="nc" id="L1930">			return status;</span>
		}
		
		/**
		 * Gets the status update reason for intuition.
		 *
		 * @param fundsOutRequest the funds out request
		 * @param transactionMonitoringPaymentsOutRequest the transaction monitoring payments out request
		 * @return the status update reason for intuition
		 * @throws ComplianceException the compliance exception
		 */
		//AT-4451
		public String getStatusUpdateReasonForIntuition(FundsOutRequest fundsOutRequest) throws ComplianceException {
<span class="nc" id="L1943">			Connection connection = null;</span>
<span class="nc" id="L1944">			ResultSet resultSet = null;</span>
<span class="nc" id="L1945">			PreparedStatement preparedStatement = null;</span>
<span class="nc" id="L1946">			String statusUpdateReason= null;</span>
			try {
<span class="nc" id="L1948">				connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1949">				preparedStatement = connection.prepareStatement(DBQueryConstant.GET_STATUS_UPDATE_REASON_FOR_PAYMENT_OUT_INTUITION.getQuery());</span>
<span class="nc" id="L1950">				preparedStatement.setInt(1, fundsOutRequest.getFundsOutId());</span>
<span class="nc" id="L1951">				resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L1952" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L1953">					statusUpdateReason = resultSet.getString(&quot;Reason&quot;);</span>
				}

<span class="nc" id="L1956">			} catch (Exception e) {</span>
<span class="nc" id="L1957">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1959">				closeResultset(resultSet);</span>
<span class="nc" id="L1960">				closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1961">				closeConnection(connection);</span>
			}
<span class="nc" id="L1963">			return statusUpdateReason;</span>
		}

		/**
		 * Gets the payment reference match keyword for intuition.
		 *
		 * @param beneficiaryId the beneficiary id
		 * @param transactionMonitoringPaymentsOutRequest the transaction monitoring payments out request
		 * @return the payment reference match keyword for intuition
		 * @throws ComplianceException the compliance exception
		 */
		//AT-4475
		public void getPaymentReferenceMatchKeywordForIntuition(Integer beneficiaryId,
				TransactionMonitoringPaymentsOutRequest transactionMonitoringPaymentsOutRequest) throws ComplianceException {
<span class="nc" id="L1977">			Connection connection = null;</span>
<span class="nc" id="L1978">			ResultSet resultSet = null;</span>
<span class="nc" id="L1979">			PreparedStatement preparedStatement = null;</span>
			try {
<span class="nc" id="L1981">				connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L1982">				preparedStatement = connection.prepareStatement(DBQueryConstant.GET_PAYMENT_REFERENCE_MATCHED_KEYWORD_FOR_INTUITION.getQuery());</span>
<span class="nc" id="L1983">				preparedStatement.setInt(1, beneficiaryId);</span>
<span class="nc" id="L1984">				resultSet = preparedStatement.executeQuery();</span>
<span class="nc bnc" id="L1985" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L1986">					transactionMonitoringPaymentsOutRequest.setPaymentRefMatchedKeyword(resultSet.getString(&quot;SanctionText&quot;));</span>
				}

<span class="nc" id="L1989">			} catch (Exception e) {</span>
<span class="nc" id="L1990">				LOG.error(&quot;&quot;, e);</span>
			} finally {
<span class="nc" id="L1992">				closeResultset(resultSet);</span>
<span class="nc" id="L1993">				closePrepareStatement(preparedStatement);</span>
<span class="nc" id="L1994">				closeConnection(connection);</span>
			}
<span class="nc" id="L1996">		}</span>
		
		/**
		 * Update account intuition client risk level.
		 *
		 * @param message the message
		 * @return the message
		 */
		public Message&lt;MessageContext&gt; updateAccountIntuitionClientRiskLevel(Message&lt;MessageContext&gt; message) {
<span class="nc" id="L2005">	        Connection connection = null;</span>
<span class="nc" id="L2006">	        String paymentStatus = null;</span>
	        try {

<span class="nc" id="L2009">	            FundsOutResponse response = (FundsOutResponse) message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L2010">	                    .getResponse();</span>
	            
<span class="nc" id="L2012">	            TransactionMonitoringPaymentsOutRequest tmRequest = (TransactionMonitoringPaymentsOutRequest) message</span>
<span class="nc" id="L2013">						.getPayload().getMessageExchange(ServiceTypeEnum.TRANSACTION_MONITORING_SERVICE).getRequest();</span>
<span class="nc" id="L2014">	            TransactionMonitoringPaymentOutResponse tmResponse = (TransactionMonitoringPaymentOutResponse) message</span>
<span class="nc" id="L2015">						.getPayload().getMessageExchange(ServiceTypeEnum.TRANSACTION_MONITORING_SERVICE).getResponse();</span>
				
<span class="nc" id="L2017">				TransactionMonitoringPaymentsOutRequest request = (TransactionMonitoringPaymentsOutRequest) message</span>
<span class="nc" id="L2018">						.getPayload().getMessageExchange(ServiceTypeEnum.TRANSACTION_MONITORING_SERVICE).getRequest();</span>

<span class="nc" id="L2020">				OperationEnum operation = message.getPayload().getGatewayMessageExchange().getOperation();</span>
<span class="nc bnc" id="L2021" title="All 4 branches missed.">                if(operation == OperationEnum.FUNDS_OUT || operation == OperationEnum.RECHECK_FAILURES) {</span>
<span class="nc" id="L2022">                    paymentStatus = response.getStatus();</span>
                } else {
<span class="nc" id="L2024">                    paymentStatus = tmResponse.getPaymentStatus();</span>
                }
				
<span class="nc" id="L2027">	            String clientRiskLevel = (String) response.getAdditionalAttribute(CLIENT_RISK_LEVEL);</span>
<span class="nc" id="L2028">	            Integer accountTMFlag = (Integer) request.getAdditionalAttribute(ACCOUNT_TM_FLAG);</span>
<span class="nc bnc" id="L2029" title="All 8 branches missed.">	            if(clientRiskLevel != null &amp;&amp; (accountTMFlag == 1 || accountTMFlag == 2 || accountTMFlag == 4)) {</span>
<span class="nc" id="L2030">		            UserProfile userToken = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc" id="L2031">		            connection = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L2032">		            beginTransaction(connection);</span>
<span class="nc" id="L2033">		            updateAccountIntuitionRiskLevel(request.getAccountId(), clientRiskLevel, userToken, connection);</span>
<span class="nc" id="L2034">		            updatePaymentOutIntuitionStatus(request.getFundsOutId(), tmResponse.getStatus(), userToken, connection);</span>
<span class="nc bnc" id="L2035" title="All 2 branches missed.">					if (tmRequest.getUpdateStatus() != null</span>
<span class="nc bnc" id="L2036" title="All 4 branches missed.">							&amp;&amp; tmRequest.getUpdateStatus().equalsIgnoreCase(FundsOutComplianceStatus.HOLD.name())</span>
							&amp;&amp; paymentStatus != null) {
<span class="nc" id="L2038">						updatePaymentOutStatus(paymentStatus, request.getFundsOutId(), connection);</span>
					}
<span class="nc" id="L2040">		            commitTransaction(connection);</span>
	            }    
<span class="nc" id="L2042">	        } catch (Exception e) {</span>
<span class="nc" id="L2043">	            message.getPayload().setFailed(true);</span>
<span class="nc" id="L2044">	            LOG.error(&quot;Error while updating IntuitionRiskLevel to Account&quot;, e);</span>
	        } finally {
	            try {
<span class="nc" id="L2047">	                closeConnection(connection);</span>
<span class="nc" id="L2048">	            } catch (ComplianceException e) {</span>
<span class="nc" id="L2049">	                message.getPayload().setFailed(true);</span>
<span class="nc" id="L2050">	                LOG.error(&quot;Error while updating IntuitionRiskLevel to Account&quot;, e);</span>
<span class="nc" id="L2051">	            }</span>
	        }
<span class="nc" id="L2053">	        return message;</span>
	    }

	    /**
    	 * Update account intuition risk level.
    	 *
    	 * @param accountId the account id
    	 * @param clientRiskLevel the client risk level
    	 * @param userToken the user token
    	 * @param connection the connection
    	 * @throws ComplianceException the compliance exception
    	 */
    	public void updateAccountIntuitionRiskLevel(Integer accountId, String clientRiskLevel,
	            UserProfile userToken, Connection connection) throws ComplianceException {
<span class="nc" id="L2067">	        PreparedStatement statement = null;</span>
	        try {
<span class="nc" id="L2069">	            statement = connection.prepareStatement(DBQueryConstant.UPDATE_ACCOUNT_INTUITION_RISK_LEVEL.getQuery());</span>

<span class="nc" id="L2071">	            statement.setString(1, clientRiskLevel);</span>
<span class="nc" id="L2072">	            statement.setInt(2, userToken.getUserID());</span>
<span class="nc" id="L2073">	            statement.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L2074">	            statement.setInt(4, accountId);</span>

<span class="nc" id="L2076">	            statement.executeUpdate();</span>
<span class="nc" id="L2077">	        } catch (Exception e) {</span>
<span class="nc" id="L2078">	            throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
	        } finally {
<span class="nc" id="L2080">	            closePrepareStatement(statement);</span>
	        }
<span class="nc" id="L2082">	    }</span>
	    
	    /**
    	 * Update payment out intuition status.
    	 *
    	 * @param fundsOutId the funds out id
    	 * @param status the status
    	 * @param userToken the user token
    	 * @param connection the connection
    	 * @throws ComplianceException the compliance exception
    	 */
    	public void updatePaymentOutIntuitionStatus(Integer fundsOutId, String status,
				UserProfile userToken, Connection connection) throws ComplianceException {
<span class="nc" id="L2095">	        PreparedStatement statement = null;</span>
	        try {
<span class="nc" id="L2097">	            statement = connection.prepareStatement(DBQueryConstant.UPDATE_PAYMENT_OUT_INTUITION_CHECK_STATUS.getQuery());</span>

<span class="nc" id="L2099">	            statement.setInt(1, ServiceStatus.getStatusAsInteger(status));</span>
<span class="nc" id="L2100">	            statement.setInt(2, userToken.getUserID());</span>
<span class="nc" id="L2101">	            statement.setTimestamp(3, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L2102">	            statement.setInt(4, fundsOutId);</span>

<span class="nc" id="L2104">	            statement.executeUpdate();</span>
<span class="nc" id="L2105">	        } catch (Exception e) {</span>
<span class="nc" id="L2106">	            throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
	        } finally {
<span class="nc" id="L2108">	            closePrepareStatement(statement);</span>
	        }
<span class="nc" id="L2110">	    }</span>
	    
	    /**
		 * Add for AT-4752
		 * 
		 * Update short response code.
		 *
		 * @param message the message
		 * @return the message
		 * @throws ComplianceException the compliance exception
		 */
		public Message&lt;MessageContext&gt; updateShortResponseCode(Message&lt;MessageContext&gt; message) throws ComplianceException {
<span class="nc" id="L2122">			Connection conn = null;</span>

			try {
<span class="nc" id="L2125">				MessageExchange exchange = message.getPayload().getGatewayMessageExchange();</span>
<span class="nc" id="L2126">				FundsOutBaseRequest fRequest = (FundsOutBaseRequest) exchange.getRequest();</span>
<span class="nc" id="L2127">				FundsOutResponse fundsOutResponse = (FundsOutResponse) message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L2128">						.getResponse();</span>
<span class="nc" id="L2129">				conn = getConnection(Boolean.FALSE);</span>
<span class="nc" id="L2130">				getContactWatchlist(conn, fRequest.getFundsOutId(), fundsOutResponse);</span>
<span class="nc" id="L2131">				fRequest.addAttribute(&quot;AtlasSTPFlag&quot;, fundsOutResponse.getShortResponseCode());</span>
				
<span class="nc" id="L2133">			} catch (Exception e) {</span>
<span class="nc" id="L2134">				LOG.error(&quot;Exception in updatePaymentOutStatus()&quot;, e);</span>
<span class="nc" id="L2135">				message.getPayload().setFailed(true);</span>
			} finally {
<span class="nc" id="L2137">				closeConnection(conn);</span>
			}
<span class="nc" id="L2139">			return message;</span>
		}
	    
	    public String getPaymentComplianceStatus(Integer payId) throws ComplianceException {
<span class="nc" id="L2143">	        PreparedStatement statement = null;</span>
<span class="nc" id="L2144">	        Connection connection = null;</span>
<span class="nc" id="L2145">	        ResultSet resultSet = null;</span>
<span class="nc" id="L2146">	        String status = null; </span>
<span class="nc" id="L2147">	        String tableName = &quot;PaymentOut&quot;;</span>
	        try {
<span class="nc" id="L2149">	        	connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L2150">	        	statement = connection.prepareStatement(DBQueryConstant.GET_PAYMENT_STATUS.getQuery().replace(&quot;#&quot;,</span>
	        			tableName));
<span class="nc" id="L2152">	        	statement.setInt(1, payId);</span>
<span class="nc" id="L2153">				resultSet = statement.executeQuery();</span>
<span class="nc bnc" id="L2154" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L2155">					status = FundsOutComplianceStatus.getFundsInComplianceStatusAsString(resultSet.getInt(COMPLIANCE_STATUS));</span>
				
				}
<span class="nc" id="L2158">	        } catch (Exception e) {</span>
<span class="nc" id="L2159">	            throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
	        } finally {
<span class="nc" id="L2161">	            closePrepareStatement(statement);</span>
	        }
	        
<span class="nc" id="L2164">	        return status;</span>
	    }
	
		/**
		 * Update payment out status.
		 *
		 * @param paymentStatus the payment status
		 * @param paymentOutID the payment out ID
		 * @param connection the connection
		 * @throws ComplianceException the compliance exception
		 */
		public void updatePaymentOutStatus(String paymentStatus, Integer paymentOutID, Connection connection)
				throws ComplianceException {
<span class="nc" id="L2177">			PreparedStatement statement = null;</span>
			try {
<span class="nc" id="L2179">				statement = connection.prepareStatement(DBQueryConstant.UPDATE_PAYMENT_OUT_STATUS.getQuery());</span>

<span class="nc" id="L2181">				statement.setInt(1, 1);</span>
<span class="nc" id="L2182">				statement.setTimestamp(2, new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L2183">				statement.setInt(3, FundsOutComplianceStatus.getFundsInComplianceStatusAsInteger(paymentStatus));</span>
<span class="nc" id="L2184">				statement.setInt(4, paymentOutID);</span>

<span class="nc" id="L2186">				statement.executeUpdate();</span>
<span class="nc" id="L2187">			} catch (Exception e) {</span>
<span class="nc" id="L2188">				throw new ComplianceException(InternalProcessingCode.INTERNAL_SERVER_ERROR, e);</span>
			} finally {

<span class="nc" id="L2191">				closePrepareStatement(statement);</span>

			}
<span class="nc" id="L2194">		}</span>
		
		/**
		 * Gets the payment out status by trade payment id.
		 *
		 * @param tradePaymentId the trade payment id
		 * @return the payment out status by trade payment id
		 * @throws ComplianceException the compliance exception
		 */
		//AT-4906
		public Integer getPaymentOutStatusByTradePaymentId(Integer tradePaymentId) throws ComplianceException {
<span class="nc" id="L2205">			PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L2206">			ResultSet resultSet = null;</span>
<span class="nc" id="L2207">			Connection conn = null;</span>
<span class="nc" id="L2208">			Integer paymentStatus = 0;</span>
			try {
<span class="nc" id="L2210">				conn = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L2211">				preparedStatment = conn.prepareStatement(</span>
<span class="nc" id="L2212">						DBQueryConstant.GET_PAYMENT_STATUS_BY_PAYMENT_TRADE_ID.getQuery().replace(&quot;#&quot;, &quot;PaymentOut&quot;));</span>
<span class="nc" id="L2213">				preparedStatment.setInt(1, tradePaymentId);</span>
<span class="nc" id="L2214">				resultSet = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L2215" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L2216">					paymentStatus = resultSet.getInt(COMPLIANCE_STATUS);</span>
				}

<span class="nc" id="L2219">			} catch (Exception e) {</span>
<span class="nc" id="L2220">				LOG.error(&quot;Error in getPaymentOutStatusByTradePaymentId() : &quot;, e);</span>
			} finally {
<span class="nc" id="L2222">				closeResultset(resultSet);</span>
<span class="nc" id="L2223">				closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L2224">				closeConnection(conn);</span>
			}

<span class="nc" id="L2227">			return paymentStatus;</span>

		}

		// AT-5304
		public List&lt;FundsOutRequest&gt; getIntuitionHistoricPaymentOut() throws ComplianceException {
<span class="nc" id="L2233">			PreparedStatement preparedStatment = null;</span>
<span class="nc" id="L2234">			ResultSet resultSet = null;</span>
<span class="nc" id="L2235">			Connection connection = null;</span>
<span class="nc" id="L2236">			List&lt;FundsOutRequest&gt; fundsOutRequests = new ArrayList&lt;&gt;();</span>
			try {
<span class="nc" id="L2238">				connection = getConnection(Boolean.TRUE);</span>
<span class="nc" id="L2239">				preparedStatment = connection.prepareStatement(</span>
<span class="nc" id="L2240">						DBQueryConstant.GET_DETAILS_FOR_INTUITION_HISTORIC_PAYMENT_OUT_RECORDS.getQuery());</span>
<span class="nc" id="L2241">				resultSet = preparedStatment.executeQuery();</span>
<span class="nc bnc" id="L2242" title="All 2 branches missed.">				while (resultSet.next()) {</span>
<span class="nc" id="L2243">					FundsOutRequest fundsOutRequest = setFundsOutDetailsForIntuition(resultSet);</span>
<span class="nc" id="L2244">					fundsOutRequest.getBeneficiary().setTransactionDateTime(resultSet.getString(&quot;TransactionTimeDate&quot;)); //Added for AT-5486</span>
<span class="nc" id="L2245">					fundsOutRequests.add(fundsOutRequest);</span>
<span class="nc" id="L2246">				}</span>
<span class="nc" id="L2247">			} catch (Exception e) {</span>
<span class="nc" id="L2248">				LOG.error(&quot;Error in getIntuitionHistoricPaymentOut() : &quot;, e);</span>
			} finally {
<span class="nc" id="L2250">				closeResultset(resultSet);</span>
<span class="nc" id="L2251">				closePrepareStatement(preparedStatment);</span>
<span class="nc" id="L2252">				closeConnection(connection);</span>
			}
<span class="nc" id="L2254">			return fundsOutRequests;</span>
		}

		// AT-5304
		private FundsOutRequest setFundsOutDetailsForIntuition(ResultSet resultSet) throws SQLException {
<span class="nc" id="L2259">			FundsOutRequest fundsOutDetails = new FundsOutRequest();</span>
<span class="nc" id="L2260">			String json = resultSet.getString(PO_ATTRIB);</span>
<span class="nc bnc" id="L2261" title="All 2 branches missed.">			if (null != json) {</span>
<span class="nc" id="L2262">				fundsOutDetails = JsonConverterUtil.convertToObject(FundsOutRequest.class,</span>
<span class="nc" id="L2263">						resultSet.getString(PO_ATTRIB));</span>
			}
<span class="nc" id="L2265">			fundsOutDetails.setFundsOutId(resultSet.getInt(&quot;payOutId&quot;));</span>
<span class="nc" id="L2266">			fundsOutDetails.setAccId(resultSet.getInt(ACCOUNTID));</span>
<span class="nc" id="L2267">			fundsOutDetails.getTrade().setTradeAccountNumber(resultSet.getString(&quot;Tradeaccountnumber&quot;));</span>
<span class="nc" id="L2268">			fundsOutDetails.getTrade().setTradeContactId(resultSet.getInt(TRADE_CONTACT_ID));</span>
<span class="nc" id="L2269">			fundsOutDetails.setContactId(resultSet.getInt(CONTACT_ID));</span>
<span class="nc" id="L2270">			fundsOutDetails.addAttribute(Constants.STATUS, FundsOutComplianceStatus</span>
<span class="nc" id="L2271">					.getFundsInComplianceStatusAsString(resultSet.getInt(PO_COMPLIANCE_STATUS)));</span>
<span class="nc" id="L2272">			fundsOutDetails.addAttribute(Constants.FRAUGSTER_STATUS,</span>
<span class="nc" id="L2273">					ServiceStatus.getStatusAsString(resultSet.getInt(FRAUGSTER_STATUS)));</span>
<span class="nc" id="L2274">			fundsOutDetails.addAttribute(Constants.BLACKLIST_STATUS,</span>
<span class="nc" id="L2275">					ServiceStatus.getStatusAsString(resultSet.getInt(BLACKLIST_STATUS)));</span>
<span class="nc" id="L2276">			fundsOutDetails.addAttribute(Constants.SANCTION_STATUS,</span>
<span class="nc" id="L2277">					ServiceStatus.getStatusAsString(resultSet.getInt(&quot;SanctionStatus&quot;)));</span>
<span class="nc" id="L2278">			fundsOutDetails.addAttribute(Constants.CUSTOM_CHECK_STATUS,</span>
<span class="nc" id="L2279">					ServiceStatus.getStatusAsString(resultSet.getInt(CUSTOM_CHECK_STATUS)));</span>
<span class="nc" id="L2280">			fundsOutDetails.addAttribute(Constants.PAYMENT_REFERENCE_STATUS,</span>
<span class="nc" id="L2281">					ServiceStatus.getStatusAsString(resultSet.getInt(PAYMENT_REFERENCE_STATUS)));</span>
<span class="nc" id="L2282">			fundsOutDetails.addAttribute(ACCOUNT_VERSION, resultSet.getInt(ACCOUNT_VERSION));</span>
<span class="nc" id="L2283">			fundsOutDetails.addAttribute(ACCOUNT_TM_FLAG, resultSet.getInt(ACCOUNT_TM_FLAG));</span>
<span class="nc" id="L2284">			fundsOutDetails.addAttribute(&quot;STPFlag&quot;, resultSet.getString(&quot;InitialStatus&quot;));</span>
<span class="nc" id="L2285">			fundsOutDetails.addAttribute(&quot;orgcode&quot;, resultSet.getString(&quot;OrganizationCode&quot;));</span>
<span class="nc" id="L2286">			fundsOutDetails.addAttribute(Constants.ETAILER, resultSet.getString(Constants.ETAILER)); // AT-5310</span>

<span class="nc" id="L2288">			return fundsOutDetails;</span>
		}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>