<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DataEnricher.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compliance-service</a> &gt; <a href="index.source.html" class="el_package">com.currenciesdirect.gtg.compliance.compliancesrv.core.reg</a> &gt; <span class="el_source">DataEnricher.java</span></div><h1>DataEnricher.java</h1><pre class="source lang-java linenums">/*
 * 
 */
package com.currenciesdirect.gtg.compliance.compliancesrv.core.reg;

import java.sql.Timestamp;
import java.util.ArrayList;
import java.util.List;
import java.util.UUID;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.messaging.Message;
import org.springframework.messaging.handler.annotation.Header;

import com.currenciesdirect.gtg.compliance.commons.domain.ReprocessFailedDetails;
import com.currenciesdirect.gtg.compliance.commons.domain.base.BaseResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.fraugster.FraugsterOnUpdateContactResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.fraugster.FraugsterOnUpdateResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.fraugster.FraugsterSummary;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.BlacklistContactResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.BlacklistSummary;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.ContactResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.CountryCheckContactResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.GlobalCheckContactResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.InternalServiceResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.IpContactResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.internalruleservice.IpSummary;
import com.currenciesdirect.gtg.compliance.commons.domain.kyc.KYCContactResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.kyc.KYCProviderResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.kyc.KYCSummary;
import com.currenciesdirect.gtg.compliance.commons.domain.profile.request.ConversionPrediction;
import com.currenciesdirect.gtg.compliance.commons.domain.sanction.SanctionContactResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.sanction.SanctionResponse;
import com.currenciesdirect.gtg.compliance.commons.domain.sanction.SanctionSummary;
import com.currenciesdirect.gtg.compliance.commons.enums.CustomerTypeEnum;
import com.currenciesdirect.gtg.compliance.commons.enums.TransactionTypeEnum;
import com.currenciesdirect.gtg.compliance.commons.util.ObjectCloner;
import com.currenciesdirect.gtg.compliance.compliancesrv.ComplianceException;
import com.currenciesdirect.gtg.compliance.compliancesrv.InternalProcessingCode;
import com.currenciesdirect.gtg.compliance.compliancesrv.MessageContextHeaders;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.AbstractDataEnricher;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.EntityEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.IEventDBService;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.OperationEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.ProvideCacheLoader;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.ServiceInterfaceType;
import com.currenciesdirect.gtg.compliance.compliancesrv.core.ServiceStatus;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.EntityDetails;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.UserProfile;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.Account;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.Company;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.Contact;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.CorperateCompliance;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.EventServiceLog;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.RegistrationServiceRequest;
import com.currenciesdirect.gtg.compliance.compliancesrv.domain.reg.response.RegistrationResponse;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.MessageContext;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.MessageExchange;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.ServiceProviderEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.msg.ServiceTypeEnum;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.Constants;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.CopyObjectUtil;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.JsonConverterUtil;
import com.currenciesdirect.gtg.compliance.compliancesrv.util.ParseHouseStreetNumber;
import com.currenciesdirect.gtg.compliance.commons.enums.LegalEntityEnum;

/**
 * The Class DataEnricher.
 */
<span class="nc" id="L72">public class DataEnricher extends AbstractDataEnricher {</span>

	/** The Constant FIRST_SANCTION_SUMMARY. */
	private static final String FIRST_SANCTION_SUMMARY = &quot;firstSanctionSummary&quot;;

	/** The Constant CONTACT_LOG_FOR_CONTACT. */
	private static final String CONTACT_LOG_FOR_CONTACT = &quot;contactLogForContact&quot;;

	/** The Constant IS_EID_ELIGIBLE. */
	private static final String IS_EID_ELIGIBLE = &quot;isEidEligible&quot;;

	/** The Constant IS_GLOBAL_CHECK_ELIGIBLE. */
	private static final String IS_GLOBAL_CHECK_ELIGIBLE = &quot;isGlobalCheckEligible&quot;;

	/** The Constant IS_IP_CHECK_ELIGIBLE. */
	private static final String IS_IP_CHECK_ELIGIBLE = &quot;isIpCheckEligible&quot;;

	/** The Constant IS_COUNTRY_CHECK_ELIGIBLE. */
	private static final String IS_COUNTRY_CHECK_ELIGIBLE = &quot;isCountryCheckEligible&quot;;

	/** The Constant IS_BLACKLIST_ELIGIBLE. */
	private static final String IS_BLACKLIST_ELIGIBLE = &quot;isBlacklistEligible&quot;;

	/** The Constant IS_SANCTION_ELIGIBLE2. */
	private static final String IS_SANCTION_ELIGIBLE_FOR_RECHECK = &quot;isSanctionEligible&quot;;

	/** The Constant IS_FRAUGSTER_ELIGIBLE2. */
	private static final String IS_FRAUGSTER_ELIGIBLE_FOR_RECHECK = &quot;isFraugsterEligible&quot;;

	/** The Constant IP_CHECK_STATUS. */
	private static final String IP_CHECK_STATUS = &quot;IpCheckStatus&quot;;

	/** The Constant GLOBAL_CHECK_STATUS. */
	private static final String GLOBAL_CHECK_STATUS = &quot;GlobalCheckStatus&quot;;

	/** The Constant COUNTRY_CHECK_STATUS. */
	private static final String COUNTRY_CHECK_STATUS = &quot;CountryCheckStatus&quot;;

	/** The Constant IS_SANCTION_PERFORMED. */
	public static final String IS_SANCTION_PERFORMED = &quot;isSanctionPerformed&quot;;

	/** The Constant IS_SANCTION_ELIGIBLE. */
	public static final String IS_SANCTION_ELIGIBLE = &quot;isSanctionEligible,&quot;;

	/** The Constant IS_FRAUGSTER_ELIGIBLE. */
	public static final String IS_FRAUGSTER_ELIGIBLE = &quot;isFraugsterEligible,&quot;;

	/** The Constant IS_KYC_ELIGIBLE. */
	public static final String IS_KYC_ELIGIBLE = &quot;isKYCEligible,&quot;;

	/** The Constant SERIAL_VERSION_UID. */
	private static final String SERIAL_VERSION_UID = &quot;serialVersionUID,&quot;;

	/** The Constant GENDER. */
	private static final String GENDER = &quot;gender,&quot;;

	/** The Constant DOB. */
	private static final String DOB = &quot;dob,&quot;;

	/** The Constant REGION. */
	private static final String REGION = &quot;region,&quot;;

	/** The Constant SUB_CITY. */
	private static final String SUB_CITY = &quot;subCity,&quot;;

	/** The Constant UNIT_NUMBER. */
	private static final String UNIT_NUMBER = &quot;unitNumber,&quot;;

	/** The Constant SUB_BUILDINGOR_FLAT. */
	private static final String SUB_BUILDINGOR_FLAT = &quot;subBuildingorFlat,&quot;;

	/** The Constant COUNTRY. */
	private static final String COUNTRY = &quot;country,&quot;;

	/** The Constant POST_CODE. */
	private static final String POST_CODE = &quot;postCode,&quot;;

	/** The Constant STATE_PROVINCE_COUNTY. */
	private static final String STATE_PROVINCE_COUNTY = &quot;state,&quot;;

	/** The Constant SUB_STREET. */
	private static final String SUB_STREET = &quot;subStreet,&quot;;

	/** The Constant STREET_TYPE. */
	private static final String STREET_TYPE = &quot;streetType,&quot;;

	/** The Constant STREET_NUMBER. */
	private static final String STREET_NUMBER = &quot;streetNumber,&quot;;

	/** The Constant BUILDING_NAME. */
	private static final String BUILDING_NAME = &quot;buildingName,&quot;;

	/** The Constant CITY. */
	private static final String CITY = &quot;city,&quot;;

	/** The Constant ADDRESS1. */
	private static final String ADDRESS1 = &quot;address1,&quot;;

	/** The Constant ADDRESS_TYPE. */
	private static final String ADDRESS_TYPE = &quot;addressType,&quot;;

	/** The Constant SECOND_SURNAME. */
	private static final String SECOND_SURNAME = &quot;secondSurname,&quot;;

	/** The Constant LAST_NAME. */
	private static final String LAST_NAME = &quot;lastName,&quot;;

	/** The Constant MIDDLE_NAME. */
	private static final String MIDDLE_NAME = &quot;middleName,&quot;;

	/** The Constant FIRST_NAME. */
	private static final String FIRST_NAME = &quot;firstName,&quot;;

	/** The Constant REQUEST_IS_NOT_VALID. */
	private static final String REQUEST_IS_NOT_VALID = &quot;Request is not valid&quot;;

	/** The Constant ACCOUNT. */
	private static final String ACCOUNT = &quot;oldAccount&quot;;

	/** The Constant BUY_CURRENCY_ID. */
	private static final String BUY_CURRENCY_ID = &quot;BuyCurrencyId&quot;;

	/** The Constant SELL_CURRENCY_ID. */
	private static final String SELL_CURRENCY_ID = &quot;SellCurrencyId&quot;;

	/** The Constant COUNTRY_ID. */
	private static final String COUNTRY_ID = &quot;CountryID&quot;;

	/** The Constant UPDATE_METHOD. */
	private static final String UPDATE_METHOD = &quot;updateMethod&quot;;

	/** The Constant VERSION. */
	private static final String VERSION = &quot;version&quot;;

	/** The Constant AREA_NUMBER. */
	private static final String AREA_NUMBER = &quot;areaNumber,&quot;;

	/** The Constant AZA. */
	private static final String AZA = &quot;aza,&quot;;

	/** The Constant CIVIC_NUMBER. */
	private static final String CIVIC_NUMBER = &quot;civicNumber,&quot;;

	/** The Constant DISTRICT. */
	private static final String DISTRICT = &quot;district,&quot;;

	/** The Constant FLOOR_NUMBER. */
	private static final String FLOOR_NUMBER = &quot;floorNumber,&quot;;

	/** The Constant REGION_SUBURB. */
	private static final String REGION_SUBURB = &quot;regionSuburb,&quot;;

	/** The Constant PREFECTURE. */
	private static final String PREFECTURE = &quot;prefecture,&quot;;

	/** The Constant STREET. */
	private static final String STREET = &quot;street,&quot;;

	/** The Constant YEARS_IN_ADDRESS. */
	private static final String YEARS_IN_ADDRESS = &quot;yearsInAddress,&quot;;

	/** The Constant STREET. */
	private static final String BUILDING_NUMBER = &quot;buildingNumber,&quot;;

	/** The Constant IS_CONTACT_MODIFIED. */
	private static final String IS_CONTACT_MODIFIED = &quot;isContactModified&quot;;
	
	/** The Constant SSN. */
	private static final String SSN = &quot;ssn,&quot;;
	
	/** The Constant CONTACT_ID_FOR_CFX. */
	private static final String CONTACT_ID_FOR_CFX = &quot;ContactIdForCFX&quot;;

	/** The event DB service impl. */
	@Autowired
	protected IEventDBService eventDBServiceImpl;

	/** The country cache. */
<span class="nc" id="L250">	private ProvideCacheLoader countryCache = ProvideCacheLoader.getInstance();</span>
	
	/** The Constant LOGGER. */
<span class="nc" id="L253">	private static final Logger LOGGER = LoggerFactory.getLogger(DataEnricher.class);</span>

	/**
	 * Process.
	 *
	 * @param message
	 *            the message
	 * @param correlationID
	 *            the correlation ID
	 * @return the message
	 */
	@org.springframework.integration.annotation.ServiceActivator
	public Message&lt;MessageContext&gt; process(Message&lt;MessageContext&gt; message, @Header UUID correlationID) {
<span class="nc" id="L266">		MessageExchange messageExchange = message.getPayload().getGatewayMessageExchange();</span>
<span class="nc" id="L267">		RegistrationResponse response = messageExchange.getResponse(RegistrationResponse.class);</span>
<span class="nc" id="L268">		LOGGER.debug(&quot;Gateway message headers=[{}], payload=[{}] validated!!&quot;, message.getHeaders(),</span>
<span class="nc" id="L269">				message.getPayload());</span>

<span class="nc" id="L271">		RegistrationServiceRequest request = messageExchange.getRequest(RegistrationServiceRequest.class);</span>
		
<span class="nc" id="L273">		RegistrationServiceRequest updateRequest = (RegistrationServiceRequest) ObjectCloner.deepCopy(request);</span>
<span class="nc" id="L274">		request.addAttribute(&quot;UpdateRequest&quot;, updateRequest);</span>

<span class="nc" id="L276">		ServiceInterfaceType serviceInterfaceType = messageExchange.getServiceInterface();</span>
<span class="nc" id="L277">		OperationEnum operation = messageExchange.getOperation();</span>
<span class="nc" id="L278">		Boolean isContactModified = Boolean.TRUE;</span>
		try {
<span class="nc" id="L280">			getUserTableId(message);</span>
<span class="nc" id="L281">			getAccountContactDetails(request);</span>
<span class="nc" id="L282">			ParseHouseStreetNumber.getInstance().parseStreetValues(request);</span>

<span class="nc bnc" id="L284" title="All 4 branches missed.">			if (serviceInterfaceType == ServiceInterfaceType.PROFILE &amp;&amp; operation == OperationEnum.NEW_REGISTRATION) {</span>
<span class="nc" id="L285">				setIsContactModified(request, isContactModified);</span>

<span class="nc bnc" id="L287" title="All 4 branches missed.">			} else if (serviceInterfaceType == ServiceInterfaceType.PROFILE</span>
					&amp;&amp; operation == OperationEnum.UPDATE_ACCOUNT) {
<span class="nc" id="L289">				enrichDataForUpdate(request, message);</span>
<span class="nc bnc" id="L290" title="All 4 branches missed.">			} else if (serviceInterfaceType == ServiceInterfaceType.PROFILE &amp;&amp; operation == OperationEnum.ADD_CONTACT) {</span>
<span class="nc" id="L291">				Account oldAccount = (Account) request.getAdditionalAttribute(ACCOUNT);</span>
<span class="nc bnc" id="L292" title="All 2 branches missed.">				if (null != oldAccount) {</span>
					/*** Set previous service statuses to account **/
<span class="nc" id="L294">					request.getAccount().setPreviousBlacklistStatus(oldAccount.getPreviousBlacklistStatus());</span>
<span class="nc" id="L295">					request.getAccount().setPreviousFraugsterStatus(oldAccount.getPreviousFraugsterStatus());</span>
<span class="nc" id="L296">					request.getAccount().setPreviousKycStatus(oldAccount.getPreviousKycStatus());</span>
<span class="nc" id="L297">					request.getAccount().setPreviousSanctionStatus(oldAccount.getPreviousSanctionStatus());</span>
<span class="nc" id="L298">					request.getAccount()</span>
<span class="nc" id="L299">							.setPreviousPaymentinWatchlistStatus(oldAccount.getPreviousPaymentinWatchlistStatus());</span>
<span class="nc" id="L300">					request.getAccount()</span>
<span class="nc" id="L301">							.setPreviousPaymentoutWatchlistStatus(oldAccount.getPreviousPaymentoutWatchlistStatus());</span>
<span class="nc" id="L302">					request.getAccount().setVersion(oldAccount.getVersion() + 1);</span>
<span class="nc" id="L303">					request.getAccount().setChannel(oldAccount.getChannel());</span>
					// needed to save broadcast service
<span class="nc" id="L305">					request.getAccount().setTradeAccountID(oldAccount.getTradeAccountID());</span>
<span class="nc" id="L306">					request.getAccount().setCustLegalEntity(oldAccount.getCustLegalEntity());//Add for AT-3327</span>

<span class="nc" id="L308">					newRegistrationDBServiceImpl.getInternalRuleServiceContactStatus(oldAccount.getId(), request);</span>
				}
<span class="nc" id="L310">				setIsContactModified(request, isContactModified);</span>
			}
<span class="nc" id="L312">		} catch (Exception e) {</span>
<span class="nc" id="L313">			LOGGER.error(REQUEST_IS_NOT_VALID, e);</span>
<span class="nc" id="L314">			response.setDecision(BaseResponse.DECISION.FAIL);</span>
<span class="nc" id="L315">			response.setErrorCode(InternalProcessingCode.INV_REQUEST.toString());</span>
<span class="nc" id="L316">			response.setErrorDescription(InternalProcessingCode.INV_REQUEST.toString());</span>
<span class="nc" id="L317">		}</span>
<span class="nc" id="L318">		response.setOsrID(messageExchange.getRequest().getOsrId());</span>
<span class="nc" id="L319">		messageExchange.setResponse(response);</span>
<span class="nc" id="L320">		return message;</span>
	}

	/**
	 * Gets the account contact details.
	 *
	 * @param request
	 *            the request
	 * @return the account contact details
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void getAccountContactDetails(RegistrationServiceRequest request) throws ComplianceException {
<span class="nc" id="L333">		List&lt;String&gt; contactSFIds = new ArrayList&lt;&gt;(request.getAccount().getContacts().size());</span>
		/**
		 * added by neelesh Pant .... TradeContactID is taken as list because
		 * for multiple contacts we need to check weather any of the
		 * tradeContactId is already present in database if yes Validation error
		 * is given..
		 */
<span class="nc" id="L340">		List&lt;Integer&gt; tradeContactIds = new ArrayList&lt;&gt;(request.getAccount().getContacts().size());</span>
<span class="nc" id="L341">		String country = null;</span>
<span class="nc bnc" id="L342" title="All 2 branches missed.">		for (Contact c : request.getAccount().getContacts()) {</span>
<span class="nc" id="L343">			String formatedContactsfid = c.getContactSFID();</span>
<span class="nc" id="L344">			formatedContactsfid = formatedContactsfid.replace(formatedContactsfid, &quot;'&quot; + formatedContactsfid + &quot;'&quot;);</span>
<span class="nc" id="L345">			contactSFIds.add(formatedContactsfid);</span>

<span class="nc" id="L347">			tradeContactIds.add(c.getTradeContactID());</span>
<span class="nc bnc" id="L348" title="All 4 branches missed.">			if (c.getPrimaryContact() != null &amp;&amp; c.getPrimaryContact())</span>
<span class="nc" id="L349">				country = c.getCountry();</span>
<span class="nc" id="L350">		}</span>

<span class="nc" id="L352">		RegistrationServiceRequest details = newRegistrationDBServiceImpl.getAccountDetails(request.getOrgCode(),</span>
<span class="nc" id="L353">				request.getAccount().getBuyingCurrency(), request.getAccount().getSellingCurrency(), country,</span>
<span class="nc" id="L354">				request.getAccount().getAccSFID(), contactSFIds);</span>
<span class="nc bnc" id="L355" title="All 4 branches missed.">		if (null != details.getAccount() &amp;&amp; null != details.getAccount().getId()) {</span>
<span class="nc" id="L356">			request.addAttribute(ACCOUNT, details.getAccount());</span>
		}

		/**
		 * get Account and Contact trade fields list for validation : Abhijit G
		 */
<span class="nc" id="L362">		Boolean isAccountContactIsExist = newRegistrationDBServiceImpl.getExistingAccountContactId(request.getOrgCode(),</span>
<span class="nc" id="L363">				request.getAccount().getAccSFID(), request.getAccount().getTradeAccountID(),</span>
<span class="nc" id="L364">				request.getAccount().getTradeAccountNumber(), tradeContactIds, contactSFIds, details);</span>

<span class="nc" id="L366">		request.setOrgId(details.getOrgId());</span>
<span class="nc" id="L367">		request.addAttribute(Constants.FIELD_OLD_CONTACTS,</span>
<span class="nc" id="L368">				details.getAdditionalAttribute(Constants.FIELD_OLD_CONTACTS));</span>
<span class="nc" id="L369">		request.addAttribute(BUY_CURRENCY_ID, details.getAdditionalAttribute(BUY_CURRENCY_ID));</span>
<span class="nc" id="L370">		request.addAttribute(SELL_CURRENCY_ID, details.getAdditionalAttribute(SELL_CURRENCY_ID));</span>
<span class="nc" id="L371">		request.addAttribute(COUNTRY_ID, details.getAdditionalAttribute(COUNTRY_ID));</span>
<span class="nc" id="L372">		request.addAttribute(Constants.ACC_ORG_NAME, details.getAdditionalAttribute(Constants.ACC_ORG_NAME));</span>

		/**
		 * Added additional attrubutes for trade Account and contact filed
		 * duplication validation : Abhijit G
		 */
<span class="nc" id="L378">		request.addAttribute(Constants.ACCOUNT_SF_ID_LIST,</span>
<span class="nc" id="L379">				details.getAdditionalAttribute(Constants.ACCOUNT_SF_ID_LIST));</span>
<span class="nc" id="L380">		request.addAttribute(Constants.TRADE_ACCOUNT_NUMBER_LIST,</span>
<span class="nc" id="L381">				details.getAdditionalAttribute(Constants.TRADE_ACCOUNT_NUMBER_LIST));</span>
<span class="nc" id="L382">		request.addAttribute(Constants.CONTACT_SF_ID_LIST,</span>
<span class="nc" id="L383">				details.getAdditionalAttribute(Constants.CONTACT_SF_ID_LIST));</span>
<span class="nc" id="L384">		request.addAttribute(Constants.TRADE_ACCOUNT_ID_LIST,</span>
<span class="nc" id="L385">				details.getAdditionalAttribute(Constants.TRADE_ACCOUNT_ID_LIST));</span>
<span class="nc" id="L386">		request.addAttribute(Constants.TRADE_CONTACT_ID_LIST,</span>
<span class="nc" id="L387">				details.getAdditionalAttribute(Constants.TRADE_CONTACT_ID_LIST));</span>
<span class="nc" id="L388">		request.addAttribute(Constants.IS_ACCOUNT_CONTACT_ID_EXIST, isAccountContactIsExist);</span>
<span class="nc" id="L389">		request.addAttribute(Constants.FIELD_REGISTERED_TIME,</span>
<span class="nc" id="L390">				details.getAdditionalAttribute(Constants.FIELD_REGISTERED_TIME));</span>
<span class="nc" id="L391">		request.addAttribute(Constants.FIELD_REGISTRATION_IN_TIME,</span>
<span class="nc" id="L392">				details.getAdditionalAttribute(Constants.FIELD_REGISTRATION_IN_TIME));</span>
<span class="nc" id="L393">		request.addAttribute(Constants.FIELD_EXPIRY_TIME, details.getAdditionalAttribute(Constants.FIELD_EXPIRY_TIME));</span>
		
<span class="nc" id="L395">		request.addAttribute(&quot;AccountTMFlag&quot;, details.getAdditionalAttribute(&quot;AccountTMFlag&quot;));</span>
<span class="nc" id="L396">		request.addAttribute(&quot;IntuitionRiskLevel&quot;, details.getAdditionalAttribute(&quot;IntuitionRiskLevel&quot;));</span>

<span class="nc" id="L398">	}</span>

	/**
	 * Enrich data for update. Get existing Account, company, contact info check
	 * if any of these are modified For Contact/Account name ignore case
	 * changes, i.e. update the data, but do NOT perform any checks For address
	 * ignore special char changes/formatting changes, i.e. update the data, but
	 * do NOT perform any checks
	 *
	 * @param request
	 *            the request
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	@SuppressWarnings(&quot;unchecked&quot;)
	private void enrichDataForUpdate(RegistrationServiceRequest request, Message&lt;MessageContext&gt; message) throws ComplianceException {
		String isAccountModifiedCaseChangeFields;
		Boolean isAccountContentChanged;
		Boolean isAccountCaseChange;
		Boolean isAccountModified;
<span class="nc" id="L418">		boolean isaddressupdated = false;</span>
<span class="nc" id="L419">		Account oldAccount = (Account) request.getAdditionalAttribute(ACCOUNT);</span>
<span class="nc" id="L420">		List&lt;Contact&gt; oldContacts = (List&lt;Contact&gt;) request.getAdditionalAttribute(Constants.FIELD_OLD_CONTACTS);</span>
		
		// Added for AT-5453
<span class="nc" id="L423">		LOGGER.warn(&quot;\n----------Account status for Trade Account Number : {}, AccountSF ID : {} is {}&quot;,</span>
<span class="nc" id="L424">				oldAccount.getTradeAccountNumber(), oldAccount.getAccSFID(), oldAccount.getAccountStatus());</span>
<span class="nc bnc" id="L425" title="All 2 branches missed.">		for (Contact contact : oldContacts)</span>
<span class="nc" id="L426">			LOGGER.warn(&quot;\nContact Status for Contact SF ID : {} is {}&quot;, contact.getContactSFID(),</span>
<span class="nc" id="L427">					contact.getContactStatus());</span>

<span class="nc" id="L429">		fieldsToNotUpdate(request, oldAccount, oldContacts, message);</span>
		
<span class="nc" id="L431">		CopyObjectUtil.copyNullFields(request.getAccount(), oldAccount, Account.class);</span>
<span class="nc" id="L432">		String accountFieldsModifiedWithoutSpcChar = &quot;&quot;;</span>
		
<span class="nc" id="L434">		isAccountModifiedCaseChangeFields = checkAccountModifiedCaseChangeFields(request, oldAccount);</span>
		
<span class="nc" id="L436">		isAccountCaseChange = checkWhetherCaseOrContentChanged(isAccountModifiedCaseChangeFields);</span>
<span class="nc" id="L437">		isAccountContentChanged = isAccountModified(oldAccount, request.getAccount());</span>
<span class="nc bnc" id="L438" title="All 4 branches missed.">		isAccountModified = isAccountCaseChange || isAccountContentChanged;</span>
<span class="nc" id="L439">		String accountStrFieldsModifiedCaseInsensitive = CopyObjectUtil</span>
<span class="nc" id="L440">				.compareFieldsCaseInsensitive(request.getAccount(), oldAccount);</span>
<span class="nc bnc" id="L441" title="All 4 branches missed.">		if (accountStrFieldsModifiedCaseInsensitive != null &amp;&amp; accountStrFieldsModifiedCaseInsensitive.length() &gt; 2) {</span>
<span class="nc" id="L442">			accountFieldsModifiedWithoutSpcChar = checkAccountFieldsModifiedWithoutSpcChar(request, oldAccount,</span>
					accountStrFieldsModifiedCaseInsensitive);
		} else {
<span class="nc" id="L445">			isAccountContentChanged = Boolean.FALSE;</span>
		}
<span class="nc bnc" id="L447" title="All 2 branches missed.">		if (null != oldAccount) {</span>

<span class="nc" id="L449">			Boolean isAccountModifiedCaseInsensitive = isAccountModifiedCaseInsensitive(</span>
					accountStrFieldsModifiedCaseInsensitive);

<span class="nc" id="L452">			request.addAttribute(&quot;isAccountModified&quot;, isAccountModified);</span>
<span class="nc" id="L453">			Boolean isContactModified = Boolean.FALSE;</span>
<span class="nc" id="L454">			Boolean isContactModifiedCaseInsensitive = Boolean.FALSE;</span>
			Boolean isCompanyModifiedCaseInsensitive;
			Boolean isConversionPredictionModifiedCaseInsensitive;
			Boolean isCorporateComplianceModifiedCaseInsensitive;
			/*** Set previous service statuses to account **/
<span class="nc" id="L459">			Account account = setPreviousServiceStatusToAccount(request, oldAccount);</span>
<span class="nc" id="L460">			isCompanyModifiedCaseInsensitive = checkFroCompanyInfoUpdate(request, oldAccount,</span>
					accountFieldsModifiedWithoutSpcChar);
<span class="nc" id="L462">			request.addAttribute(Constants.FIELD_ACC_ISCOMPANYMODIFIED, isCompanyModifiedCaseInsensitive);</span>

<span class="nc" id="L464">			isConversionPredictionModifiedCaseInsensitive = checkForConversionPredictionInfoUpdated(request,</span>
					oldAccount);
<span class="nc" id="L466">			request.addAttribute(Constants.FIELD_ACC_ISCONVPREDICTIONMODIFIED,</span>
					isConversionPredictionModifiedCaseInsensitive);

<span class="nc" id="L469">			isCorporateComplianceModifiedCaseInsensitive = checkForCorporateComplianceInfoUpdated(request, oldAccount);</span>
<span class="nc" id="L470">			request.addAttribute(Constants.FIELD_ACC_ISCORPORATECOMPLIANCEMODIFIED,</span>
					isCorporateComplianceModifiedCaseInsensitive);

			String contactModifiedFieldsForCaseChange;
			String contactModifiedFieldsForContentChange;
			Boolean isContactCaseChanged;
			Boolean isContactContentChanged;
			Boolean isContactFieldsChangedWithoutSpcChar;
<span class="nc bnc" id="L478" title="All 2 branches missed.">			for (Contact contact : request.getAccount().getContacts()) {</span>
<span class="nc" id="L479">				Contact oldContact = getContactBySFId(contact.getContactSFID(), oldContacts);</span>
<span class="nc bnc" id="L480" title="All 2 branches missed.">				if (null != oldContact) {</span>
<span class="nc" id="L481">					CopyObjectUtil.copyNullFields(contact, oldContact, Contact.class);</span>
					/*** Set previous service statuses to contact **/

<span class="nc" id="L484">					setPreviousServiceStatusToContact(contact, oldContact);</span>

<span class="nc" id="L486">					contactModifiedFieldsForCaseChange = getListOfFieldsModifiedForCaseChange(contact, oldContact);</span>

<span class="nc" id="L488">					isContactCaseChanged = checkWhetherCaseOrContentChanged(contactModifiedFieldsForCaseChange);</span>

<span class="nc" id="L490">					contactModifiedFieldsForContentChange = getListOfFieldsModifiedForContentChange(contact,</span>
							oldContact);

<span class="nc" id="L493">					isContactContentChanged = checkWhetherCaseOrContentChanged(contactModifiedFieldsForContentChange);</span>

<span class="nc bnc" id="L495" title="All 4 branches missed.">					isContactModified = isContactContentChanged || isContactCaseChanged;</span>

<span class="nc" id="L497">					String contactFieldsModifiedWithoutSpcChar = isContactModifiedCaseInsensitiveWithoutSpcChar(contact,</span>
							oldContact, contactModifiedFieldsForCaseChange + contactModifiedFieldsForContentChange);

<span class="nc" id="L500">					isContactFieldsChangedWithoutSpcChar = checkWhetherCaseOrContentChanged(</span>
							contactFieldsModifiedWithoutSpcChar);

<span class="nc" id="L503">					isContactContentChanged = checkForSpcCharUpdate(isContactFieldsChangedWithoutSpcChar);</span>

<span class="nc" id="L505">					isContactModifiedCaseInsensitive = proccessContactChanges(request,</span>
							contactFieldsModifiedWithoutSpcChar, account, contact, isContactContentChanged);

<span class="nc" id="L508">					contact.setVersion(contact.getVersion() + 1);</span>

<span class="nc" id="L510">					String previousInactiveReason = newRegistrationDBServiceImpl</span>
<span class="nc" id="L511">							.getPreviousInactiveReason(contact.getId());</span>
<span class="nc" id="L512">					request.addAttribute(&quot;previousInactiveReason&quot;, previousInactiveReason);</span>

					/* code added to send email after address change(AT-1503) */
<span class="nc" id="L515">					isaddressupdated = checkToSendEmailOnAddressChange(isaddressupdated,</span>
							contactFieldsModifiedWithoutSpcChar);
<span class="nc" id="L517">					setContactKYCEligibleForEULegalEntity(request, contact);//AT-3327</span>
				}
<span class="nc" id="L519">			}</span>

<span class="nc bnc" id="L521" title="All 2 branches missed.">			if (Boolean.TRUE.equals(isAccountContentChanged)) {</span>
<span class="nc" id="L522">				request.addAttribute(Constants.FIELD_ACC_ISACCOUNTMODIFIED, isAccountModifiedCaseInsensitive);</span>
			}

			/**
			 * Added firstSanctionSummary to show values of SanctionID,
			 * WorldCheck, OfacList on UI -Saylee
			 */
<span class="nc" id="L529">			SanctionSummary sanctionSummary = newRegistrationDBServiceImpl</span>
<span class="nc" id="L530">					.getFirstSanctionSummary(request.getAccount().getId(), EntityEnum.ACCOUNT.name());</span>
<span class="nc" id="L531">			request.addAttribute(FIRST_SANCTION_SUMMARY, sanctionSummary);</span>
<span class="nc" id="L532">			setIsContactModified(request, isContactModified);</span>
			// Removed if request.getAccount().getContacts().size() &gt; 0
			// condition, so that Rules Service always find below values.
<span class="nc" id="L535">			newRegistrationDBServiceImpl.getInternalRuleServiceContactStatus(request.getAccount().getId(), request);</span>

<span class="nc" id="L537">			Boolean isUpdateRequestFieldsModified = isUpdateRequestFieldsModified(isAccountModifiedCaseInsensitive,</span>
					isContactModifiedCaseInsensitive, isCompanyModifiedCaseInsensitive,
					isConversionPredictionModifiedCaseInsensitive, isCorporateComplianceModifiedCaseInsensitive);

			// this function will be invoked from loop, which iterates over
			// contact list.
			// if first contact is modified, and seconds is not, PERFORM_CHECKS
			// might be disabled.
			// once its enabled, make sure its not disabled again.
<span class="nc" id="L546">			setPerformChecksFlagInRequest(request, isUpdateRequestFieldsModified);</span>

<span class="nc" id="L548">			accountInfoUpdatedFlagSet(request);</span>

<span class="nc" id="L550">			request.addAttribute(Constants.SEND_EMAIL_ON_ADDRESS_CHANGE, isaddressupdated);</span>
			
			//AT-3241 Amend FraudPredict re-trigger process to include only email, mobile and landline changes
			//if only account update is done Fraudpredict check should not be done
<span class="nc bnc" id="L554" title="All 2 branches missed.">			for (Contact contact : oldContacts) {</span>
<span class="nc" id="L555">				contact.setFraugsterEligible(false);</span>
<span class="nc" id="L556">			}</span>
		}
<span class="nc" id="L558">	}</span>

	private void setContactKYCEligibleForEULegalEntity(RegistrationServiceRequest request, Contact contact) {
<span class="nc bnc" id="L561" title="All 2 branches missed.">		if(LegalEntityEnum.CDLEU.getLECode().equals(request.getAccount().getCustLegalEntity())</span>
<span class="nc bnc" id="L562" title="All 2 branches missed.">				|| LegalEntityEnum.FCGEU.getLECode().equals(request.getAccount().getCustLegalEntity())</span>
<span class="nc bnc" id="L563" title="All 2 branches missed.">				|| LegalEntityEnum.TOREU.getLECode().equals(request.getAccount().getCustLegalEntity())) {</span>
<span class="nc" id="L564">			contact.setKYCEligible(false);</span>
		}
<span class="nc" id="L566">	}</span>

	/**
	 * @param request
	 * @param oldAccount
	 * @param accountStrFieldsModifiedCaseInsensitive
	 * @return
	 */
	private String checkAccountFieldsModifiedWithoutSpcChar(RegistrationServiceRequest request, Account oldAccount,
			String accountStrFieldsModifiedCaseInsensitive) {
		String accountFieldsModifiedWithoutSpcChar;
<span class="nc" id="L577">		accountFieldsModifiedWithoutSpcChar = accountStrFieldsModifiedCaseInsensitive.replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc" id="L578">		accountFieldsModifiedWithoutSpcChar = accountFieldsModifiedWithoutSpcChar.substring(1,</span>
<span class="nc" id="L579">				accountFieldsModifiedWithoutSpcChar.length() - 2);</span>
<span class="nc" id="L580">		accountFieldsModifiedWithoutSpcChar = CopyObjectUtil.removeSpecialCharcterAndCompare(</span>
<span class="nc" id="L581">				accountFieldsModifiedWithoutSpcChar.split(&quot;,&quot;), oldAccount, request.getAccount());</span>
<span class="nc" id="L582">		return accountFieldsModifiedWithoutSpcChar;</span>
	}

	/**
	 * @param isaddressupdated
	 * @param contactFieldsModifiedWithoutSpcChar
	 * @return
	 */
	private boolean checkToSendEmailOnAddressChange(boolean isaddressupdated,
			String contactFieldsModifiedWithoutSpcChar) {
<span class="nc bnc" id="L592" title="All 2 branches missed.">		if(null!=contactFieldsModifiedWithoutSpcChar){</span>
<span class="nc" id="L593">			boolean isOtherFieldsChanged = getChangedFieldsExceptAddress(contactFieldsModifiedWithoutSpcChar);</span>
<span class="nc bnc" id="L594" title="All 2 branches missed.">			if(!isOtherFieldsChanged)</span>
<span class="nc" id="L595">				isaddressupdated = getAddressFieldsToSendEmail1(contactFieldsModifiedWithoutSpcChar);</span>
		}
<span class="nc" id="L597">		return isaddressupdated;</span>
	}

	/**
	 * @param request
	 * @param oldAccount
	 * @return
	 */
	private String checkAccountModifiedCaseChangeFields(RegistrationServiceRequest request, Account oldAccount) {
		String isAccountModifiedCaseChangeFields;
<span class="nc" id="L607">		isAccountModifiedCaseChangeFields = CopyObjectUtil.compareFieldsForCaseChecking(oldAccount,</span>
<span class="nc" id="L608">				request.getAccount());</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">		if (null != isAccountModifiedCaseChangeFields) {</span>
<span class="nc" id="L610">			isAccountModifiedCaseChangeFields = isAccountModifiedCaseChangeFields.replace(&quot;contacts&quot;, &quot;&quot;);</span>
		}
<span class="nc" id="L612">		return isAccountModifiedCaseChangeFields;</span>
	}

	/**
	 * @param request
	 * @param oldAccount
	 * @param oldContacts
	 */
	private void fieldsToNotUpdate(RegistrationServiceRequest request, Account oldAccount, List&lt;Contact&gt; oldContacts, Message&lt;MessageContext&gt; message) {
		//AT-1725
<span class="nc bnc" id="L622" title="All 2 branches missed.">		if(null != oldAccount)	{</span>
<span class="nc" id="L623">			setFieldsNotToUpdate(request,oldAccount,oldContacts, message);</span>
		}
<span class="nc" id="L625">	}</span>

	/**
	 * @param request
	 */
	private void accountInfoUpdatedFlagSet(RegistrationServiceRequest request) {
		// AT-1303
<span class="nc bnc" id="L632" title="All 2 branches missed.">		if (request.getAccount().getCustType().equals(Constants.CFX)</span>
<span class="nc bnc" id="L633" title="All 2 branches missed.">				|| request.getAccount().getCustType().equals(Constants.CFXETAILER)) {</span>
<span class="nc" id="L634">			setAccountInfoUpdatedWatchlistStatusFlag(request);</span>
		}
<span class="nc" id="L636">	}</span>

	/**
	 * Sets the previous service status to contact.
	 *
	 * @param contact the contact
	 * @param oldContact the old contact
	 */
	private void setPreviousServiceStatusToContact(Contact contact, Contact oldContact) {
<span class="nc" id="L645">		contact.setPreviousBlacklistStatus(oldContact.getPreviousBlacklistStatus());</span>
<span class="nc" id="L646">		contact.setPreviousFraugsterStatus(oldContact.getPreviousFraugsterStatus());</span>
<span class="nc" id="L647">		contact.setPreviousKycStatus(oldContact.getPreviousKycStatus());</span>
<span class="nc" id="L648">		contact.setPreviousSanctionStatus(oldContact.getPreviousSanctionStatus());</span>
<span class="nc" id="L649">		contact.setPreviousCountryGlobalCheckStatus(oldContact.getPreviousCountryGlobalCheckStatus());</span>
<span class="nc" id="L650">		contact.setPreviousPaymentinWatchlistStatus(oldContact.getPreviousPaymentinWatchlistStatus());//Added for AT-2986</span>
<span class="nc" id="L651">		contact.setPreviousPaymentoutWatchlistStatus(oldContact.getPreviousPaymentoutWatchlistStatus());//Added for AT-2986</span>
<span class="nc" id="L652">	}</span>

	/**
	 * Sets the previous service status to account.
	 *
	 * @param request the request
	 * @param oldAccount the old account
	 * @return the account
	 */
	private Account setPreviousServiceStatusToAccount(RegistrationServiceRequest request, Account oldAccount) {
<span class="nc" id="L662">		Account account = request.getAccount();</span>
<span class="nc" id="L663">		account.setPreviousBlacklistStatus(oldAccount.getPreviousBlacklistStatus());</span>
<span class="nc" id="L664">		account.setPreviousFraugsterStatus(oldAccount.getPreviousFraugsterStatus());</span>
<span class="nc" id="L665">		account.setPreviousKycStatus(oldAccount.getPreviousKycStatus());</span>
<span class="nc" id="L666">		account.setPreviousSanctionStatus(oldAccount.getPreviousSanctionStatus());</span>
<span class="nc" id="L667">		account.setPreviousPaymentinWatchlistStatus(oldAccount.getPreviousPaymentinWatchlistStatus());</span>
<span class="nc" id="L668">		account.setPreviousPaymentoutWatchlistStatus(oldAccount.getPreviousPaymentoutWatchlistStatus());</span>
<span class="nc" id="L669">		return account;</span>
	}

	/**
	 * AT-1303 This method is added to set account info updated watchlist for
	 * CFX user if KYC and Sanction related fields changed on account and
	 * contact.
	 *
	 * @param request
	 *            the new account info updated watchlist status flag
	 */
	private void setAccountInfoUpdatedWatchlistStatusFlag(RegistrationServiceRequest request) {
<span class="nc" id="L681">		Company company = request.getAccount().getCompany();</span>
<span class="nc" id="L682">		Boolean isKYCEligible = (Boolean) request</span>
<span class="nc" id="L683">				.getAdditionalAttribute(&quot;isCFXConatctligibleForAccountInfoUpdatedWatchlist&quot;);</span>

<span class="nc bnc" id="L685" title="All 2 branches missed.">		for (Contact contact : request.getAccount().getContacts()) {</span>
<span class="nc bnc" id="L686" title="All 6 branches missed.">			if (null != isKYCEligible &amp;&amp; isKYCEligible || contact.isSanctionEligible())</span>
<span class="nc" id="L687">				request.addAttribute(&quot;isKYCSanctionPerformed&quot;, Boolean.TRUE);</span>
<span class="nc" id="L688">		}</span>

<span class="nc bnc" id="L690" title="All 4 branches missed.">		if (company.isKYCEligible() || company.isSanctionEligible()) {</span>
<span class="nc" id="L691">			request.addAttribute(&quot;isKYCSanctionPerformed&quot;, Boolean.TRUE);</span>
		}
<span class="nc" id="L693">	}</span>

	/**
	 * Sets the perform checks flag in request.
	 *
	 * @param request
	 *            the request
	 * @param isUpdateRequestFieldsModified
	 *            the is update request fields modified
	 */
	private void setPerformChecksFlagInRequest(RegistrationServiceRequest request,
			Boolean isUpdateRequestFieldsModified) {
<span class="nc" id="L705">		Boolean performChecks = (Boolean) request.getAdditionalAttribute(Constants.PERFORM_CHECKS);</span>
<span class="nc bnc" id="L706" title="All 2 branches missed.">		if (null == performChecks) {</span>
<span class="nc" id="L707">			performChecks = Boolean.FALSE;</span>
		}
<span class="nc bnc" id="L709" title="All 2 branches missed.">		if (Boolean.FALSE.equals(performChecks))</span>
<span class="nc" id="L710">			request.addAttribute(Constants.PERFORM_CHECKS, isUpdateRequestFieldsModified);</span>
<span class="nc" id="L711">	}</span>

	/**
	 * Check for spc char update.
	 *
	 * @param isContactFieldsChangedWithoutSpcChar
	 *            the is contact fields changed without spc char
	 * @return the boolean
	 */
	private Boolean checkForSpcCharUpdate(Boolean isContactFieldsChangedWithoutSpcChar) {
<span class="nc" id="L721">		Boolean result = Boolean.TRUE;</span>
<span class="nc bnc" id="L722" title="All 2 branches missed.">		if (Boolean.FALSE.equals(isContactFieldsChangedWithoutSpcChar)) {</span>
<span class="nc" id="L723">			result = Boolean.FALSE;</span>
		}
<span class="nc" id="L725">		return result;</span>
	}

	/**
	 * Check fro company info update.
	 *
	 * @param request
	 *            the request
	 * @param oldAccount
	 *            the old account
	 * @param accountFieldsModifiedWithoutSpcChar
	 *            the account fields modified without spc char
	 * @return the boolean
	 */
	private Boolean checkFroCompanyInfoUpdate(RegistrationServiceRequest request, Account oldAccount,
			String accountFieldsModifiedWithoutSpcChar) {
<span class="nc" id="L741">		Boolean result = Boolean.FALSE;</span>
<span class="nc bnc" id="L742" title="All 2 branches missed.">		if (Constants.CFX.equalsIgnoreCase(oldAccount.getCustType())) {</span>
<span class="nc" id="L743">			result = isAccountCompanyInfoChanged(request, oldAccount, accountFieldsModifiedWithoutSpcChar);</span>
		}
<span class="nc" id="L745">		return result;</span>
	}

	/**
	 * Check for conversion prediction info updated.
	 *
	 * @param request
	 *            the request
	 * @param oldAccount
	 *            the old account
	 * @return the boolean
	 */
	private Boolean checkForConversionPredictionInfoUpdated(RegistrationServiceRequest request, Account oldAccount) {

		Boolean isConvPredicModifiedCaseInsensitive;
<span class="nc" id="L760">		ConversionPrediction oldConversionPrediction = oldAccount.getConversionPrediction();</span>
<span class="nc" id="L761">		ConversionPrediction conversionPrediction = request.getAccount().getConversionPrediction();</span>

<span class="nc" id="L763">		CopyObjectUtil.copyNullFields(conversionPrediction, oldConversionPrediction, ConversionPrediction.class);</span>
<span class="nc" id="L764">		String convPredicStrFieldsModifiedCaseInsensitive = CopyObjectUtil</span>
<span class="nc" id="L765">				.compareFieldsCaseInsensitive(conversionPrediction, oldConversionPrediction);</span>

<span class="nc" id="L767">		isConvPredicModifiedCaseInsensitive = isConvPredicModifiedCaseInsensitive(</span>
				convPredicStrFieldsModifiedCaseInsensitive);

<span class="nc" id="L770">		return isConvPredicModifiedCaseInsensitive;</span>

	}

	/**
	 * Check for corporate compliance info updated.
	 *
	 * @param request
	 *            the request
	 * @param oldAccount
	 *            the old account
	 * @return the boolean
	 */
	private Boolean checkForCorporateComplianceInfoUpdated(RegistrationServiceRequest request, Account oldAccount) {

<span class="nc" id="L785">		Boolean result = Boolean.FALSE;</span>
<span class="nc bnc" id="L786" title="All 2 branches missed.">		if (Constants.CFX.equalsIgnoreCase(oldAccount.getCustType())) {</span>
<span class="nc" id="L787">			result = isCorporateComplianceInfoChanged(request, oldAccount);</span>
		}
<span class="nc" id="L789">		return result;</span>
	}

	/**
	 * Check whether case or content changed.
	 *
	 * @param contactModifiedFieldsForCaseChange
	 *            the contact modified fields for case change
	 * @return the boolean
	 */
	private Boolean checkWhetherCaseOrContentChanged(String contactModifiedFieldsForCaseChange) {
<span class="nc" id="L800">		Boolean result = Boolean.FALSE;</span>
<span class="nc bnc" id="L801" title="All 4 branches missed.">		if (null != contactModifiedFieldsForCaseChange &amp;&amp; contactModifiedFieldsForCaseChange.length() &gt; 2) {</span>
<span class="nc" id="L802">			result = Boolean.TRUE;</span>
		}
<span class="nc" id="L804">		return result;</span>
	}

	/**
	 * Proccess contact changes.
	 *
	 * @param request
	 *            the request
	 * @param contactFieldsModifiedWithoutSpcChar
	 *            the contact fields modified without spc char
	 * @param oldAccount
	 *            the old account
	 * @param contact
	 *            the contact
	 * @param isContactContentChanged
	 *            the is contact content changed
	 * @return true, if successful
	 */
	private boolean proccessContactChanges(RegistrationServiceRequest request,
			String contactFieldsModifiedWithoutSpcChar, Account oldAccount, Contact contact,
			Boolean isContactContentChanged) {
		// field Added for jira AT-875
		Boolean addToNewKycWatchList;
<span class="nc" id="L827">		addToNewKycWatchList = (Boolean) request</span>
<span class="nc" id="L828">				.getAdditionalAttribute(Constants.FIELD_ADD_TO_NEW_KYC_WATCHLIST_ON_UPDATE);</span>
<span class="nc bnc" id="L829" title="All 2 branches missed.">		if (null == addToNewKycWatchList)</span>
<span class="nc" id="L830">			addToNewKycWatchList = Boolean.FALSE;</span>

<span class="nc" id="L832">		Boolean isContactModifiedCaseInsensitive = Boolean.FALSE;</span>

<span class="nc bnc" id="L834" title="All 2 branches missed.">		if (Constants.CFX.equalsIgnoreCase(oldAccount.getCustType())) {</span>
<span class="nc" id="L835">			contact.setKYCEligible(false);</span>
<span class="nc" id="L836">			contact.setSanctionEligible(false);</span>

<span class="nc bnc" id="L838" title="All 2 branches missed.">			if (Boolean.FALSE.equals(addToNewKycWatchList) </span>
<span class="nc bnc" id="L839" title="All 2 branches missed.">					&amp;&amp; isCFXContactKYCEligible(contactFieldsModifiedWithoutSpcChar, request)) {</span>
<span class="nc" id="L840">				addToNewKycWatchList = Boolean.TRUE;</span>
<span class="nc" id="L841">				isContactModifiedCaseInsensitive = Boolean.TRUE;</span>
			}
			//AT-3241 Amend FraudPredict re-trigger process to include only email, mobile and landline changes
<span class="nc" id="L844">			contact.setFraugsterEligible(isFraudPredictEligible(contactFieldsModifiedWithoutSpcChar));</span>
		} else {
<span class="nc bnc" id="L846" title="All 2 branches missed.">			if (Boolean.TRUE.equals(isContactContentChanged)) {</span>
<span class="nc" id="L847">				isContactModifiedCaseInsensitive = Boolean.TRUE;</span>
<span class="nc" id="L848">				contact.setKYCEligible(isKYCEligible(contactFieldsModifiedWithoutSpcChar));</span>
<span class="nc" id="L849">				contact.setSanctionEligible(isSanctionEligible(contactFieldsModifiedWithoutSpcChar));</span>
				//AT-3241 Amend FraudPredict re-trigger process to include only email, mobile and landline changes
<span class="nc" id="L851">				contact.setFraugsterEligible(isFraudPredictEligible(contactFieldsModifiedWithoutSpcChar));</span>
			} else {
<span class="nc" id="L853">				contact.setKYCEligible(false);</span>
<span class="nc" id="L854">				contact.setSanctionEligible(false);</span>
<span class="nc" id="L855">				contact.setFraugsterEligible(false);</span>
			}
		}
		// If for CFX, contact fields are modified and
		// Contact is sanction/KYC eligible, make CFX account Inactive - Umesh
		// Contact is added to &quot;Pending KYC on account&quot; watchlist after
		// update(AT-875) - rohit
<span class="nc" id="L862">		request.addAttribute(Constants.FIELD_ADD_TO_NEW_KYC_WATCHLIST_ON_UPDATE, addToNewKycWatchList);</span>
<span class="nc" id="L863">		return isContactModifiedCaseInsensitive;</span>
	}

	/**
	 * Checks if is contact modified case insensitive without spc char.
	 *
	 * @param contact
	 *            the contact
	 * @param oldContact
	 *            the old contact
	 * @param strFieldsModified
	 *            the str fields modified
	 * @return the string
	 */
	private String isContactModifiedCaseInsensitiveWithoutSpcChar(Contact contact, Contact oldContact,
			String strFieldsModified) {

<span class="nc" id="L880">		String contactFieldsModifiedWithoutSpcChar = &quot;&quot;;</span>
<span class="nc bnc" id="L881" title="All 2 branches missed.">		if (null != strFieldsModified) {</span>
			// strFieldsModified has string representation of array, e.g.
			// [f1,f2,f3]
			// remove brackets, spaces and then get array of field names by
			// splitting with comma.
<span class="nc" id="L886">			String tFieldsMod = strFieldsModified.replace(&quot;[&quot;, &quot;&quot;).replace(&quot;]&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>

<span class="nc" id="L888">			contactFieldsModifiedWithoutSpcChar = CopyObjectUtil.removeSpecialCharcterAndCompare(tFieldsMod.split(&quot;,&quot;),</span>
					oldContact, contact);
<span class="nc bnc" id="L890" title="All 2 branches missed.">			if (null != contactFieldsModifiedWithoutSpcChar)</span>
<span class="nc" id="L891">				contactFieldsModifiedWithoutSpcChar = contactFieldsModifiedWithoutSpcChar.replace(&quot; &quot;, &quot;&quot;);</span>
			else
<span class="nc" id="L893">				contactFieldsModifiedWithoutSpcChar = &quot;&quot;;</span>
		}
<span class="nc" id="L895">		return contactFieldsModifiedWithoutSpcChar;</span>
	}

	/**
	 * Checks if is account company info changed.
	 *
	 * @param request
	 *            the request
	 * @param oldAccount
	 *            the old account
	 * @param accountFieldsModifiedWithoutSpcChar
	 *            the account fields modified without spc char
	 * @return the boolean
	 */
	private Boolean isAccountCompanyInfoChanged(RegistrationServiceRequest request, Account oldAccount,
			String accountFieldsModifiedWithoutSpcChar) {
		Boolean isCompanyModifiedCaseInsensitive;
<span class="nc" id="L912">		Company oldCompany = oldAccount.getCompany();</span>
<span class="nc" id="L913">		Company company = request.getAccount().getCompany();</span>

<span class="nc" id="L915">		CopyObjectUtil.copyNullFields(company, oldCompany, Company.class);</span>
<span class="nc" id="L916">		String companyFieldsModifiedWithoutSpcChar = &quot;&quot;;</span>
<span class="nc" id="L917">		String companyStrFieldsModifiedCaseInsensitive = CopyObjectUtil.compareFieldsCaseInsensitive(company,</span>
				oldCompany);
<span class="nc bnc" id="L919" title="All 4 branches missed.">		if (companyStrFieldsModifiedCaseInsensitive != null &amp;&amp; companyStrFieldsModifiedCaseInsensitive.length() &gt; 2) {</span>
<span class="nc" id="L920">			companyFieldsModifiedWithoutSpcChar = companyStrFieldsModifiedCaseInsensitive.replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc" id="L921">			companyFieldsModifiedWithoutSpcChar = companyFieldsModifiedWithoutSpcChar.substring(1,</span>
<span class="nc" id="L922">					companyFieldsModifiedWithoutSpcChar.length() - 2);</span>
<span class="nc" id="L923">			companyFieldsModifiedWithoutSpcChar = CopyObjectUtil.removeSpecialCharcterAndCompare(</span>
<span class="nc" id="L924">					companyFieldsModifiedWithoutSpcChar.split(&quot;,&quot;), oldCompany, company);</span>
		}

<span class="nc" id="L927">		isCompanyModifiedCaseInsensitive = isCompanyModifiedCaseInsensitive(companyStrFieldsModifiedCaseInsensitive);</span>
<span class="nc" id="L928">		company.setSanctionEligible(</span>
<span class="nc" id="L929">				isCompanySanctionEligible(companyFieldsModifiedWithoutSpcChar, accountFieldsModifiedWithoutSpcChar));</span>
<span class="nc" id="L930">		return isCompanyModifiedCaseInsensitive;</span>
	}

	/**
	 * Checks if is corporate compliance info changed.
	 *
	 * @param request
	 *            the request
	 * @param oldAccount
	 *            the old account
	 * @return the boolean
	 */
	private Boolean isCorporateComplianceInfoChanged(RegistrationServiceRequest request, Account oldAccount) {

		Boolean isCorporateComplianceModified;
<span class="nc" id="L945">		CorperateCompliance oldConversionPrediction = oldAccount.getCorperateCompliance();</span>
<span class="nc" id="L946">		CorperateCompliance conversionPrediction = request.getAccount().getCorperateCompliance();</span>

<span class="nc" id="L948">		CopyObjectUtil.copyNullFields(conversionPrediction, oldConversionPrediction, CorperateCompliance.class);</span>
<span class="nc" id="L949">		String corperateComplianceStrFieldsModifiedCaseInsensitive = CopyObjectUtil</span>
<span class="nc" id="L950">				.compareFieldsCaseInsensitive(conversionPrediction, oldConversionPrediction);</span>

<span class="nc" id="L952">		isCorporateComplianceModified = isCorperateComplianceModifiedCaseInsensitive(</span>
				corperateComplianceStrFieldsModifiedCaseInsensitive);

<span class="nc" id="L955">		return isCorporateComplianceModified;</span>

	}

	/**
	 * Checks if is update request fields modified.
	 *
	 * @param isAccountModifiedCaseInsensitive
	 *            the is account modified case insensitive
	 * @param isContactModified
	 *            the is contact modified
	 * @param isCompanyModifiedCaseInsensitive
	 *            the is company modified case insensitive
	 * @param isConversionPredictionCaseInsensitive
	 *            the is conversion prediction case insensitive
	 * @param isCorporateComplianceCaseInsensitive
	 *            the is corporate compliance case insensitive
	 * @return the boolean
	 */
	private Boolean isUpdateRequestFieldsModified(Boolean isAccountModifiedCaseInsensitive, Boolean isContactModified,
			Boolean isCompanyModifiedCaseInsensitive, Boolean isConversionPredictionCaseInsensitive,
			Boolean isCorporateComplianceCaseInsensitive) {
<span class="nc" id="L977">		boolean result = false;</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">		Boolean checkConvPredAndCorpComp = isConversionPredictionCaseInsensitive</span>
<span class="nc bnc" id="L979" title="All 2 branches missed.">				|| isCorporateComplianceCaseInsensitive;</span>
<span class="nc bnc" id="L980" title="All 2 branches missed.">		if (Boolean.TRUE.equals(isAccountModifiedCaseInsensitive) </span>
<span class="nc bnc" id="L981" title="All 2 branches missed.">				|| Boolean.TRUE.equals(isContactModified) </span>
<span class="nc bnc" id="L982" title="All 2 branches missed.">				|| Boolean.TRUE.equals(isCompanyModifiedCaseInsensitive)</span>
<span class="nc bnc" id="L983" title="All 2 branches missed.">				|| Boolean.TRUE.equals(checkConvPredAndCorpComp))</span>
<span class="nc" id="L984">			result = true;</span>
<span class="nc" id="L985">		return result;</span>
	}

	/**
	 * Checks if is account modified.
	 *
	 * @param oldAccount
	 *            the old account
	 * @param newAccount
	 *            the new account
	 * @return true, if is account modified
	 * 
	 *         used regex below to replace previous Status fields [contacts,
	 *         previousPaymentinWatchlistStatus,
	 *         previousPaymentoutWatchlistStatus]
	 */
	private boolean isAccountModified(Account oldAccount, Account newAccount) {
		// serialVersionUID [, contacts, version]
<span class="nc" id="L1003">		String listFileds = CopyObjectUtil.compareFields(oldAccount, newAccount);</span>
<span class="nc bnc" id="L1004" title="All 2 branches missed.">		if (null != listFileds) {</span>
<span class="nc" id="L1005">			listFileds = listFileds.replace(&quot;serialVersionUID&quot;, &quot;&quot;).replace(&quot;contacts&quot;, &quot;&quot;).replace(VERSION, &quot;&quot;)</span>
<span class="nc" id="L1006">					.replaceAll(&quot;previous.[a-zA-z]+&quot;, &quot;&quot;).replace(&quot;,&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L1007" title="All 2 branches missed.">			return (listFileds.length() &gt; 2);</span>
		}
<span class="nc" id="L1009">		return false;</span>
	}

	/**
	 * Checks if is account modified case insensitive.
	 *
	 * @param listFileds
	 *            the list fileds
	 * @return true, if is account modified case insensitive
	 */
	private boolean isAccountModifiedCaseInsensitive(String listFileds) {
<span class="nc bnc" id="L1020" title="All 2 branches missed.">		if (null != listFileds) {</span>
<span class="nc" id="L1021">			String result = listFileds.replace(&quot;,&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L1022" title="All 2 branches missed.">			return (result.length() &gt; 2);</span>
		}
<span class="nc" id="L1024">		return false;</span>
	}

	/**
	 * Checks if is company modified case insensitive.
	 *
	 * @param listFileds
	 *            the list fileds
	 * @return true, if is company modified case insensitive
	 */
	private boolean isCompanyModifiedCaseInsensitive(String listFileds) {
<span class="nc" id="L1035">		boolean output = false;</span>
<span class="nc bnc" id="L1036" title="All 2 branches missed.">		if (null != listFileds) {</span>
<span class="nc" id="L1037">			String result = listFileds.replace(&quot;,&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L1038" title="All 2 branches missed.">			output = (result.length() &gt; 2);</span>
		}
<span class="nc" id="L1040">		return output;</span>
	}

	/**
	 * Checks if is conv predic modified case insensitive.
	 *
	 * @param listModifiedFileds
	 *            the list fileds
	 * @return true, if is conv predic modified case insensitive
	 */
	private boolean isConvPredicModifiedCaseInsensitive(String listModifiedFileds) {
<span class="nc" id="L1051">		boolean output = false;</span>
<span class="nc bnc" id="L1052" title="All 2 branches missed.">		if (null != listModifiedFileds) {</span>
<span class="nc" id="L1053">			String result = listModifiedFileds.replace(&quot;,&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L1054" title="All 2 branches missed.">			output = (result.length() &gt; 2);</span>
		}
<span class="nc" id="L1056">		return output;</span>
	}

	/**
	 * Checks if is corperate compliance modified case insensitive.
	 *
	 * @param listorperateModifiedFileds
	 *            the list fileds
	 * @return true, if is corperate compliance modified case insensitive
	 */
	private boolean isCorperateComplianceModifiedCaseInsensitive(String listorperateModifiedFileds) {
<span class="nc" id="L1067">		boolean output = false;</span>
<span class="nc bnc" id="L1068" title="All 2 branches missed.">		if (null != listorperateModifiedFileds) {</span>
<span class="nc" id="L1069">			String result = listorperateModifiedFileds.replace(&quot;,&quot;, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L1070" title="All 2 branches missed.">			output = (result.length() &gt; 2);</span>
		}
<span class="nc" id="L1072">		return output;</span>
	}

	/**
	 * Gets the contact by SF id.
	 *
	 * @param sfId
	 *            the sf id
	 * @param contacts
	 *            the contacts
	 * @return the contact by SF id
	 */
	private Contact getContactBySFId(String sfId, List&lt;Contact&gt; contacts) {
<span class="nc bnc" id="L1085" title="All 2 branches missed.">		for (Contact c : contacts) {</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">			if (c.getContactSFID().equalsIgnoreCase(sfId))</span>
<span class="nc" id="L1087">				return c;</span>
<span class="nc" id="L1088">		}</span>
<span class="nc" id="L1089">		return null;</span>
	}

	/**
	 * Sets the is contact modified.
	 *
	 * @param request
	 *            the request
	 * @param isContactModified
	 *            the is contact modified
	 */
	private void setIsContactModified(RegistrationServiceRequest request, Boolean isContactModified) {
<span class="nc" id="L1101">		request.addAttribute(IS_CONTACT_MODIFIED, isContactModified);</span>
<span class="nc" id="L1102">	}</span>

	/**
	 * Checks if is KYC eligible.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @return true, if is KYC eligible
	 */
	private static boolean isKYCEligible(String strFieldsModified) {
		boolean result;
<span class="nc" id="L1113">		result = isAddressChanged(strFieldsModified);</span>
<span class="nc" id="L1114">		result = isNameChanged(strFieldsModified, result);</span>
<span class="nc bnc" id="L1115" title="All 6 branches missed.">		if (result || strFieldsModified.contains(DOB) || strFieldsModified.contains(GENDER)</span>
<span class="nc bnc" id="L1116" title="All 2 branches missed.">				|| strFieldsModified.contains(SSN))</span>
<span class="nc" id="L1117">			result = true;</span>

<span class="nc" id="L1119">		return result;</span>
	}

	/**
	 * Checks if is address changed.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @return true, if is address changed
	 */
	private static boolean isAddressChanged(String strFieldsModified) {
		boolean result;
<span class="nc bnc" id="L1131" title="All 4 branches missed.">		boolean addressCheck = strFieldsModified.contains(ADDRESS_TYPE) || strFieldsModified.contains(ADDRESS1)</span>
<span class="nc bnc" id="L1132" title="All 2 branches missed.">				|| strFieldsModified.contains(CITY);</span>
<span class="nc bnc" id="L1133" title="All 2 branches missed.">		boolean stateBuildingstreetCheck = strFieldsModified.contains(STATE_PROVINCE_COUNTY)</span>
<span class="nc bnc" id="L1134" title="All 4 branches missed.">				|| strFieldsModified.contains(BUILDING_NAME) || strFieldsModified.contains(STREET_NUMBER)</span>
<span class="nc bnc" id="L1135" title="All 2 branches missed.">				|| strFieldsModified.contains(STREET_TYPE);</span>
<span class="nc bnc" id="L1136" title="All 4 branches missed.">		boolean subAddress = strFieldsModified.contains(SUB_STREET) || strFieldsModified.contains(STATE_PROVINCE_COUNTY)</span>
<span class="nc bnc" id="L1137" title="All 4 branches missed.">				|| strFieldsModified.contains(POST_CODE) || strFieldsModified.contains(COUNTRY);</span>
<span class="nc" id="L1138">		result = areAddressFieldsChanged(strFieldsModified, addressCheck, stateBuildingstreetCheck, subAddress);</span>
<span class="nc" id="L1139">		return result;</span>
	}

	/**
	 * Are address fields changed.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @param addressCheck
	 *            the address check
	 * @param stateBuildingstreetCheck
	 *            the state buildingstreet check
	 * @param subAddress
	 *            the sub address
	 * @return true, if successful
	 */
	private static boolean areAddressFieldsChanged(String strFieldsModified, boolean addressCheck,
			boolean stateBuildingstreetCheck, boolean subAddress) {
<span class="nc bnc" id="L1157" title="All 2 branches missed.">		boolean subBuildingUnitDetails = strFieldsModified.contains(SUB_BUILDINGOR_FLAT)</span>
<span class="nc bnc" id="L1158" title="All 4 branches missed.">				|| strFieldsModified.contains(UNIT_NUMBER) || strFieldsModified.contains(SUB_CITY)</span>
<span class="nc bnc" id="L1159" title="All 2 branches missed.">				|| strFieldsModified.contains(REGION);</span>
<span class="nc bnc" id="L1160" title="All 4 branches missed.">		boolean isaddrChanged = addressCheck || subAddress;</span>
<span class="nc bnc" id="L1161" title="All 6 branches missed.">		return (isaddrChanged || stateBuildingstreetCheck || subBuildingUnitDetails);</span>

	}

	/**
	 * Checks if is sanction eligible.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @return true, if is sanction eligible
	 */
	private static boolean isSanctionEligible(String strFieldsModified) {
<span class="nc" id="L1173">		boolean result = false;</span>
<span class="nc bnc" id="L1174" title="All 4 branches missed.">		if (strFieldsModified.contains(FIRST_NAME) || strFieldsModified.contains(MIDDLE_NAME)</span>
<span class="nc bnc" id="L1175" title="All 2 branches missed.">				|| strFieldsModified.contains(LAST_NAME))</span>
<span class="nc" id="L1176">			result = true;</span>
<span class="nc bnc" id="L1177" title="All 4 branches missed.">		if (result || strFieldsModified.contains(SECOND_SURNAME))</span>
<span class="nc" id="L1178">			result = true;</span>
<span class="nc bnc" id="L1179" title="All 6 branches missed.">		if (result || strFieldsModified.contains(DOB) || strFieldsModified.contains(GENDER))</span>
<span class="nc" id="L1180">			result = true;</span>
<span class="nc" id="L1181">		result = isCountryModified(strFieldsModified, result);</span>
<span class="nc" id="L1182">		return result;</span>

	}

	/**
	 * Checks if is country modified.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @param result
	 *            the result
	 * @return true, if is country modified
	 */
	private static boolean isCountryModified(String strFieldsModified, boolean result) {
<span class="nc bnc" id="L1196" title="All 4 branches missed.">		return (result || strFieldsModified.contains(COUNTRY));</span>
	}

	/**
	 * Checks if is CFX contact KYC eligible.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @param request
	 *            the request
	 * @return true, if is CFX contact KYC eligible
	 */
	private static boolean isCFXContactKYCEligible(String strFieldsModified, RegistrationServiceRequest request) {
		boolean isKYCEligible;

<span class="nc" id="L1211">		isKYCEligible = isAddressChanged(strFieldsModified);</span>
<span class="nc" id="L1212">		isKYCEligible = isNameChanged(strFieldsModified, isKYCEligible);</span>
<span class="nc bnc" id="L1213" title="All 6 branches missed.">		if (isKYCEligible || strFieldsModified.contains(DOB) || strFieldsModified.contains(GENDER))</span>
<span class="nc" id="L1214">			isKYCEligible = true;</span>
<span class="nc" id="L1215">		isKYCEligible = isEmailChanged(strFieldsModified, isKYCEligible);</span>
<span class="nc bnc" id="L1216" title="All 6 branches missed.">		if (isKYCEligible || strFieldsModified.contains(&quot;address2,&quot;) || strFieldsModified.contains(&quot;address3,&quot;))</span>
<span class="nc" id="L1217">			isKYCEligible = true;</span>
<span class="nc bnc" id="L1218" title="All 6 branches missed.">		if (isKYCEligible || strFieldsModified.contains(&quot;phoneMobile,&quot;) || strFieldsModified.contains(&quot;phoneHome,&quot;))</span>
<span class="nc" id="L1219">			isKYCEligible = true;</span>
<span class="nc" id="L1220">		request.addAttribute(&quot;isCFXConatctligibleForAccountInfoUpdatedWatchlist&quot;, isKYCEligible);</span>
<span class="nc" id="L1221">		return isKYCEligible;</span>
	}

	/**
	 * Checks if is email changed.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @param isKYCEligible
	 *            the is KYC eligible
	 * @return true, if is email changed
	 */
	private static boolean isEmailChanged(String strFieldsModified, boolean isKYCEligible) {
<span class="nc" id="L1234">		Boolean emailChanged = Boolean.FALSE;</span>
<span class="nc bnc" id="L1235" title="All 4 branches missed.">		if (isKYCEligible || strFieldsModified.contains(&quot;email,&quot;))</span>
<span class="nc" id="L1236">			emailChanged = Boolean.TRUE;</span>
<span class="nc" id="L1237">		return emailChanged;</span>
	}

	/**
	 * Checks if is name changed.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @param isKYCEligible
	 *            the is KYC eligible
	 * @return true, if is name changed
	 */
	private static boolean isNameChanged(String strFieldsModified, boolean isKYCEligible) {
<span class="nc" id="L1250">		Boolean nameChanged = Boolean.FALSE;</span>
<span class="nc bnc" id="L1251" title="All 6 branches missed.">		if (isKYCEligible || strFieldsModified.contains(FIRST_NAME) || strFieldsModified.contains(MIDDLE_NAME))</span>
<span class="nc" id="L1252">			nameChanged = Boolean.TRUE;</span>
<span class="nc bnc" id="L1253" title="All 6 branches missed.">		if (isKYCEligible || strFieldsModified.contains(SECOND_SURNAME) || strFieldsModified.contains(LAST_NAME))</span>
<span class="nc" id="L1254">			nameChanged = Boolean.TRUE;</span>
<span class="nc" id="L1255">		return nameChanged;</span>
	}

	/**
	 * Checks if is company sanction eligible.
	 *
	 * @param companyStrFieldsModified
	 *            the company str fields modified
	 * @param accountStrFieldsModified
	 *            the account str fields modified
	 * @return true, if is company sanction eligible
	 */
	private static boolean isCompanySanctionEligible(String companyStrFieldsModified, String accountStrFieldsModified) {
<span class="nc" id="L1268">		boolean result = false;</span>
<span class="nc bnc" id="L1269" title="All 4 branches missed.">		if (companyStrFieldsModified != null &amp;&amp; companyStrFieldsModified.contains(&quot;countryOfEstablishment&quot;)) {</span>
<span class="nc" id="L1270">			result = true;</span>
		}
<span class="nc bnc" id="L1272" title="All 4 branches missed.">		if (accountStrFieldsModified != null &amp;&amp; accountStrFieldsModified.contains(&quot;accountName&quot;)) {</span>
<span class="nc" id="L1273">			result = true;</span>
		}
<span class="nc" id="L1275">		return result;</span>
	}

	/**
	 * Gets the list of fields modified for case change.
	 *
	 * @param contact
	 *            the contact
	 * @param oldContact
	 *            the old contact
	 * @return the list of fields modified for case change
	 */
	private String getListOfFieldsModifiedForCaseChange(Contact contact, Contact oldContact) {
<span class="nc" id="L1288">		String strFieldsModified = CopyObjectUtil.compareFieldsForCaseChecking(oldContact, contact);</span>
<span class="nc bnc" id="L1289" title="All 2 branches missed.">		if (null != strFieldsModified) {</span>
<span class="nc" id="L1290">			strFieldsModified = strFieldsModified.replace(SERIAL_VERSION_UID, &quot;&quot;).replace(IS_KYC_ELIGIBLE, &quot;&quot;)</span>
<span class="nc" id="L1291">					.replace(IS_FRAUGSTER_ELIGIBLE, &quot;&quot;).replace(IS_SANCTION_ELIGIBLE, &quot;&quot;)</span>
<span class="nc" id="L1292">					.replace(IS_SANCTION_PERFORMED, &quot;&quot;).replace(&quot; &quot;, &quot;&quot;);</span>
		} else {
<span class="nc" id="L1294">			strFieldsModified = &quot;&quot;;</span>
		}
<span class="nc" id="L1296">		return strFieldsModified;</span>
	}

	/**
	 * Gets the list of fields modified for content change.
	 *
	 * @param contact
	 *            the contact
	 * @param oldContact
	 *            the old contact
	 * @return the list of fields modified for content change
	 */
	private String getListOfFieldsModifiedForContentChange(Contact contact, Contact oldContact) {
<span class="nc" id="L1309">		String strFieldsModified = CopyObjectUtil.compareFieldsForContentChecking(oldContact, contact);</span>
<span class="nc bnc" id="L1310" title="All 2 branches missed.">		if (null != strFieldsModified) {</span>
<span class="nc" id="L1311">			strFieldsModified = strFieldsModified.replace(SERIAL_VERSION_UID, &quot;&quot;).replace(IS_KYC_ELIGIBLE, &quot;&quot;)</span>
<span class="nc" id="L1312">					.replace(IS_FRAUGSTER_ELIGIBLE, &quot;&quot;).replace(IS_SANCTION_ELIGIBLE, &quot;&quot;)</span>
<span class="nc" id="L1313">					.replace(IS_SANCTION_PERFORMED, &quot;&quot;).replace(UPDATE_METHOD, &quot;&quot;).replace(VERSION, &quot;&quot;)</span>
<span class="nc" id="L1314">					.replace(&quot; &quot;, &quot;&quot;);</span>
		} else {
<span class="nc" id="L1316">			strFieldsModified = &quot;&quot;;</span>
		}
<span class="nc" id="L1318">		return strFieldsModified;</span>
	}

	/**
	 * Enrich data for failed registrations.
	 *
	 * @param message
	 *            the message
	 * @return the message
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	public Message&lt;MessageContext&gt; enrichDataForFailedRegistrations(Message&lt;MessageContext&gt; message, @Header UUID correlationID)
			throws ComplianceException {
<span class="nc" id="L1332">		ReprocessFailedDetails request = message.getPayload().getGatewayMessageExchange()</span>
<span class="nc" id="L1333">				.getRequest(ReprocessFailedDetails.class);</span>
		RegistrationServiceRequest registrationDetails;
<span class="nc" id="L1335">		RegistrationResponse response = new RegistrationResponse();</span>
<span class="nc" id="L1336">		registrationDetails = newRegistrationDBServiceImpl</span>
<span class="nc" id="L1337">				.getAccountDetailsForServiceFailedRegistrationDetails(request.getTransId(), request.getTransType());</span>
<span class="nc" id="L1338">		registrationDetails = newRegistrationDBServiceImpl.getServiceFailedRegistrationDetails(</span>
<span class="nc" id="L1339">				registrationDetails.getAccount().getId(), registrationDetails.getAccount().getCustType(), request.getTransId()); // AT-4288</span>

<span class="nc" id="L1341">		message.getPayload().setOrgCode(registrationDetails.getOrgCode());</span>
<span class="nc bnc" id="L1342" title="All 2 branches missed.">		if (request.getTransType().equals(TransactionTypeEnum.ACCOUNT.getTransactionTypeAsString()))</span>
<span class="nc" id="L1343">			registrationDetails.addAttribute(&quot;accountId&quot;, request.getTransId());</span>
		else
<span class="nc" id="L1345">			registrationDetails.addAttribute(&quot;contactId&quot;, request.getTransId());</span>

<span class="nc" id="L1347">		Integer eventId = (Integer) registrationDetails.getAdditionalAttribute(&quot;EventID&quot;);</span>
<span class="nc" id="L1348">		UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc" id="L1349">		Integer userID = newRegistrationDBServiceImpl.getUserIDFromSSOUserID(token.getPreferredUserName());</span>
<span class="nc" id="L1350">		token.setUserID(userID);</span>
<span class="nc" id="L1351">		SanctionResponse sanctionResponse = new SanctionResponse();</span>
<span class="nc" id="L1352">		List&lt;EventServiceLog&gt; sanctionEntityLogList = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L1353" title="All 2 branches missed.">		if (setServiceChecksEligiblity(registrationDetails)) {</span>
<span class="nc" id="L1354">			registrationDetails.addAttribute(Constants.PERFORM_CHECKS, Boolean.TRUE);</span>
		}
<span class="nc" id="L1356">		ContactResponse contactResponse = new ContactResponse();</span>
<span class="nc" id="L1357">		buildFraugsterExchange(message, eventId, token, registrationDetails);</span>
<span class="nc" id="L1358">		buildSanctionExchange(message, registrationDetails, eventId, token, sanctionResponse, sanctionEntityLogList);</span>
<span class="nc" id="L1359">		buildKYCExchange(message, eventId, token, registrationDetails);</span>
<span class="nc" id="L1360">		buildInternalRuleServiceExchange(message, eventId, registrationDetails, contactResponse, token);</span>
<span class="nc" id="L1361">		setIsConatactModified(registrationDetails);</span>

<span class="nc" id="L1363">		registrationDetails.addAttribute(Constants.PERFORM_CHECKS, Boolean.TRUE);</span>
<span class="nc" id="L1364">		registrationDetails.addAttribute(&quot;FailedRegDetails&quot;, request);</span>
<span class="nc" id="L1365">		registrationDetails.addAttribute(Constants.OLD_REQUEST, registrationDetails);</span>
<span class="nc" id="L1366">		registrationDetails.addAttribute(Constants.SEND_EMAIL_ON_ADDRESS_CHANGE, Boolean.FALSE);</span>
<span class="nc" id="L1367">		registrationDetails.addAttribute(Constants.FIELD_OLD_CONTACTS, registrationDetails.getAccount().getContacts());</span>
<span class="nc" id="L1368">		registrationDetails.addAttribute(&quot;OldAccountStatus&quot;, registrationDetails.getAccount().getAccountStatus()); //AT-5396</span>
		
<span class="nc" id="L1370">		newRegistrationDBServiceImpl.getInternalRuleServiceContactStatus(registrationDetails.getAccount().getId(),</span>
				registrationDetails);
<span class="nc" id="L1372">		accountInfoUpdatedFlagSet(registrationDetails);</span>
<span class="nc" id="L1373">		registrationDetails.setCorrelationID(correlationID); //AT-5514</span>
<span class="nc" id="L1374">		message.getPayload().getGatewayMessageExchange().setRequest(registrationDetails);</span>
<span class="nc" id="L1375">		message.getPayload().getGatewayMessageExchange().setResponse(response);</span>
<span class="nc" id="L1376">		return message;</span>
	}

	/**
	 * Sets the checks if is conatact modified.
	 *
	 * @param registrationDetails
	 *            the new checks if is conatact modified
	 */
	private void setIsConatactModified(RegistrationServiceRequest registrationDetails) {
<span class="nc bnc" id="L1386" title="All 2 branches missed.">		if (CustomerTypeEnum.PFX.name().equals(registrationDetails.getAccount().getCustType())) {</span>
<span class="nc" id="L1387">			registrationDetails.addAttribute(IS_CONTACT_MODIFIED, Boolean.TRUE);</span>
		}
		// AT-5515
<span class="nc" id="L1390">		Integer contactIdForCFX = (Integer) registrationDetails.getAdditionalAttribute(CONTACT_ID_FOR_CFX);</span>

<span class="nc bnc" id="L1392" title="All 2 branches missed.">		for(Contact con: registrationDetails.getAccount().getContacts()){</span>
<span class="nc bnc" id="L1393" title="All 2 branches missed.">			if ((registrationDetails.getAdditionalAttribute(Constants.BLACKLIST_STATUS).equals(Constants.SERVICE_FAILURE)</span>
<span class="nc bnc" id="L1394" title="All 2 branches missed.">					&amp;&amp; null != registrationDetails.getAccount().getId())</span>
<span class="nc bnc" id="L1395" title="All 4 branches missed.">					|| (contactIdForCFX.equals(con.getId()) &amp;&amp; con.getPreviousBlacklistStatus().equals(Constants.SERVICE_FAILURE))</span>
<span class="nc bnc" id="L1396" title="All 4 branches missed.">					|| (contactIdForCFX.equals(con.getId()) &amp;&amp; con.getPreviousFraugsterStatus().equals(Constants.SERVICE_FAILURE)))</span>
			{
<span class="nc" id="L1398">				registrationDetails.addAttribute(IS_CONTACT_MODIFIED, Boolean.TRUE);</span>
			}
<span class="nc" id="L1400">		}</span>
<span class="nc" id="L1401">	}</span>

	/**
	 * Builds the sanction exchange.
	 *
	 * @param message
	 *            the message
	 * @param registrationDetails
	 *            the registration details
	 * @param eventId
	 *            the event id
	 * @param token
	 *            the token
	 * @param sanctionResponse
	 *            the sanction response
	 * @param sanctionEntityLogList
	 *            the sanction entity log list
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void buildSanctionExchange(Message&lt;MessageContext&gt; message, RegistrationServiceRequest registrationDetails,
			Integer eventId, UserProfile token, SanctionResponse sanctionResponse,
			List&lt;EventServiceLog&gt; sanctionEntityLogList) throws ComplianceException {
<span class="nc bnc" id="L1424" title="All 2 branches missed.">		if (CustomerTypeEnum.PFX.name().equals(registrationDetails.getAccount().getCustType()))</span>
<span class="nc" id="L1425">			buildSanctionExchangeForPFX(message, eventId, sanctionResponse, token, sanctionEntityLogList,</span>
					registrationDetails);
		else
<span class="nc" id="L1428">			buildSanctionExchangeForCFX(message, eventId, sanctionResponse, token, sanctionEntityLogList,</span>
					registrationDetails);
<span class="nc" id="L1430">	}</span>

	/**
	 * Sets the service checks eligiblity.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @return true, if successful
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private boolean setServiceChecksEligiblity(RegistrationServiceRequest registrationDetails)
			throws ComplianceException {
<span class="nc" id="L1443">		Boolean result = Boolean.FALSE;</span>
<span class="nc" id="L1444">		Integer accountId = (Integer) registrationDetails.getAdditionalAttribute(&quot;accountId&quot;);</span>
<span class="nc" id="L1445">		result = getIsFraugsterEligiblie(registrationDetails, result);</span>
<span class="nc" id="L1446">		result = getIsSanctionEligible(registrationDetails, result, accountId);</span>
<span class="nc" id="L1447">		result = getIsBlacklistEligible(registrationDetails, result, accountId);</span>
<span class="nc" id="L1448">		result = getIsCountryCheckEligible(registrationDetails, result);</span>
<span class="nc" id="L1449">		result = getIsIPCheckEligible(registrationDetails, result);</span>
<span class="nc" id="L1450">		result = getIsGlobalCheckEligible(registrationDetails, result);</span>
<span class="nc" id="L1451">		result = getIsEIDEligible(registrationDetails, result);</span>
<span class="nc" id="L1452">		return result;</span>
	}

	/**
	 * Gets the checks if is global check eligible.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is global check eligible
	 */
	private Boolean getIsGlobalCheckEligible(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1465">		Boolean globalCheckResult = result;</span>
<span class="nc bnc" id="L1466" title="All 2 branches missed.">		if (null != registrationDetails.getAdditionalAttribute(GLOBAL_CHECK_STATUS)</span>
<span class="nc bnc" id="L1467" title="All 2 branches missed.">				&amp;&amp; registrationDetails.getAdditionalAttribute(GLOBAL_CHECK_STATUS).equals(Constants.SERVICE_FAILURE)) {</span>
<span class="nc" id="L1468">			registrationDetails.addAttribute(IS_GLOBAL_CHECK_ELIGIBLE, Boolean.TRUE);</span>
<span class="nc" id="L1469">			globalCheckResult = Boolean.TRUE;</span>
		} else {
<span class="nc" id="L1471">			registrationDetails.addAttribute(IS_GLOBAL_CHECK_ELIGIBLE, Boolean.FALSE);</span>
		}
<span class="nc" id="L1473">		return globalCheckResult;</span>
	}

	/**
	 * Gets the checks if is IP check eligible.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is IP check eligible
	 */
	private Boolean getIsIPCheckEligible(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1486">		Boolean ipCheckResult = result;</span>
<span class="nc bnc" id="L1487" title="All 2 branches missed.">		if (null != registrationDetails.getAdditionalAttribute(IP_CHECK_STATUS)</span>
<span class="nc bnc" id="L1488" title="All 2 branches missed.">				&amp;&amp; registrationDetails.getAdditionalAttribute(IP_CHECK_STATUS).equals(Constants.SERVICE_FAILURE)) {</span>
<span class="nc" id="L1489">			registrationDetails.addAttribute(IS_IP_CHECK_ELIGIBLE, Boolean.TRUE);</span>
<span class="nc" id="L1490">			ipCheckResult = Boolean.TRUE;</span>
		} else {
<span class="nc" id="L1492">			registrationDetails.addAttribute(IS_IP_CHECK_ELIGIBLE, Boolean.FALSE);</span>
		}
<span class="nc" id="L1494">		return ipCheckResult;</span>
	}

	/**
	 * Gets the checks if is country check eligible.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is country check eligible
	 */
	private Boolean getIsCountryCheckEligible(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1507">		Boolean countryCheckResult = result;</span>
<span class="nc bnc" id="L1508" title="All 2 branches missed.">		if (null != registrationDetails.getAdditionalAttribute(COUNTRY_CHECK_STATUS)</span>
<span class="nc bnc" id="L1509" title="All 2 branches missed.">				&amp;&amp; registrationDetails.getAdditionalAttribute(COUNTRY_CHECK_STATUS).equals(Constants.SERVICE_FAILURE)) {</span>
<span class="nc" id="L1510">			registrationDetails.addAttribute(IS_COUNTRY_CHECK_ELIGIBLE, Boolean.TRUE);</span>
<span class="nc" id="L1511">			countryCheckResult = Boolean.TRUE;</span>
		} else {
<span class="nc" id="L1513">			registrationDetails.addAttribute(IS_COUNTRY_CHECK_ELIGIBLE, Boolean.FALSE);</span>
		}
<span class="nc" id="L1515">		return countryCheckResult;</span>
	}

	/**
	 * Gets the checks if is EID eligible.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is EID eligible
	 */
	private Boolean getIsEIDEligible(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1528">		Boolean eidResult = result;</span>
<span class="nc bnc" id="L1529" title="All 2 branches missed.">		if (registrationDetails.getAccount().getCustType().equals(CustomerTypeEnum.PFX.name()))</span>
<span class="nc" id="L1530">			eidResult = getIsEIDEligibleForPfx(registrationDetails, eidResult);</span>
		else
<span class="nc" id="L1532">			registrationDetails.addAttribute(IS_EID_ELIGIBLE, Boolean.FALSE);</span>
<span class="nc" id="L1533">		return eidResult;</span>
	}

	/**
	 * Gets the checks if is blacklist eligible.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @param accountId
	 *            the account id
	 * @return the checks if is blacklist eligible
	 */
	private Boolean getIsBlacklistEligible(RegistrationServiceRequest registrationDetails, Boolean result,
			Integer accountId) {
<span class="nc" id="L1549">		Boolean blacklistResult = result;</span>
<span class="nc bnc" id="L1550" title="All 2 branches missed.">		if (registrationDetails.getAccount().getCustType().equals(CustomerTypeEnum.PFX.name()))</span>
<span class="nc" id="L1551">			blacklistResult = getIsBlacklistEligibleForPfx(registrationDetails, blacklistResult);</span>
		else
<span class="nc" id="L1553">			blacklistResult = getIsBlacklistEligibleForCfx(registrationDetails, blacklistResult, accountId);</span>
<span class="nc" id="L1554">		return blacklistResult;</span>
	}

	/**
	 * Gets the checks if is sanction eligible.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @param accountId
	 *            the account id
	 * @return the checks if is sanction eligible
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private Boolean getIsSanctionEligible(RegistrationServiceRequest registrationDetails, Boolean result,
			Integer accountId) throws ComplianceException {
<span class="nc" id="L1572">		Boolean sanctionResult = result;</span>
<span class="nc bnc" id="L1573" title="All 2 branches missed.">		if (registrationDetails.getAccount().getCustType().equals(CustomerTypeEnum.PFX.name()))</span>
<span class="nc" id="L1574">			sanctionResult = getIsSanctionEligibleForPfx(registrationDetails, sanctionResult);</span>
		else
<span class="nc" id="L1576">			sanctionResult = getIsSanctionEligibleForCfx(registrationDetails, sanctionResult, accountId);</span>
<span class="nc" id="L1577">		return sanctionResult;</span>
	}

	/**
	 * Gets the checks if is fraugster eligiblie.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is fraugster eligiblie
	 */
	private Boolean getIsFraugsterEligiblie(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1590">		Boolean fraugsterResult = result;</span>
<span class="nc bnc" id="L1591" title="All 2 branches missed.">		if (registrationDetails.getAccount().getCustType().equals(CustomerTypeEnum.PFX.name()))</span>
<span class="nc" id="L1592">			fraugsterResult = getIsFraugsterEligiblieForPfx(registrationDetails, fraugsterResult);</span>
		else
<span class="nc" id="L1594">			fraugsterResult = getIsFraugsterEligiblieForCfx(registrationDetails, fraugsterResult);</span>
<span class="nc" id="L1595">		return fraugsterResult;</span>
	}

	/**
	 * Gets the checks if is sanction eligible for cfx.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @param accountId
	 *            the account id
	 * @return the checks if is sanction eligible for cfx
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private Boolean getIsSanctionEligibleForCfx(RegistrationServiceRequest registrationDetails, Boolean result,
			Integer accountId) throws ComplianceException {
<span class="nc" id="L1613">		Boolean sanctionResult = result;</span>
<span class="nc bnc" id="L1614" title="All 4 branches missed.">		if (registrationDetails.getAdditionalAttribute(Constants.SANCTION_STATUS).equals(Constants.SERVICE_FAILURE)</span>
				&amp;&amp; null != accountId) {
<span class="nc" id="L1616">			registrationDetails.addAttribute(IS_SANCTION_ELIGIBLE_FOR_RECHECK, Boolean.TRUE);</span>
<span class="nc" id="L1617">			Contact contact = (Contact) registrationDetails.getAdditionalAttribute(&quot;contact&quot;);</span>
<span class="nc" id="L1618">			getFirstSanctionSummary(registrationDetails, contact);</span>
<span class="nc" id="L1619">			sanctionResult = Boolean.TRUE;</span>
<span class="nc" id="L1620">		} else {</span>
<span class="nc" id="L1621">			registrationDetails.addAttribute(IS_SANCTION_ELIGIBLE_FOR_RECHECK, Boolean.FALSE);</span>
		}
<span class="nc" id="L1623">		return sanctionResult;</span>
	}

	/**
	 * Gets the checks if is sanction eligible for pfx.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is sanction eligible for pfx
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private Boolean getIsSanctionEligibleForPfx(RegistrationServiceRequest registrationDetails, Boolean result)
			throws ComplianceException {
<span class="nc" id="L1639">		Boolean sanctionResult = result;</span>
<span class="nc bnc" id="L1640" title="All 2 branches missed.">		if (registrationDetails.getAdditionalAttribute(Constants.SANCTION_STATUS).equals(Constants.SERVICE_FAILURE)) {</span>
<span class="nc" id="L1641">			registrationDetails.addAttribute(IS_SANCTION_ELIGIBLE_FOR_RECHECK, Boolean.TRUE);</span>
<span class="nc" id="L1642">			Contact contact = (Contact) registrationDetails.getAdditionalAttribute(&quot;contact&quot;);</span>
<span class="nc" id="L1643">			getFirstSanctionSummary(registrationDetails, contact);</span>
<span class="nc" id="L1644">			sanctionResult = Boolean.TRUE;</span>
<span class="nc" id="L1645">		} else {</span>
<span class="nc" id="L1646">			registrationDetails.addAttribute(IS_SANCTION_ELIGIBLE_FOR_RECHECK, Boolean.FALSE);</span>
		}
<span class="nc" id="L1648">		return sanctionResult;</span>
	}

	/**
	 * Gets the first sanction summary.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param contact
	 *            the contact
	 * @return the first sanction summary
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void getFirstSanctionSummary(RegistrationServiceRequest registrationDetails, Contact contact)
			throws ComplianceException {
		try {
<span class="nc" id="L1665">			SanctionSummary sanctionSummary = newRegistrationDBServiceImpl</span>
<span class="nc" id="L1666">					.getFirstSanctionSummary(registrationDetails.getAccount().getId(), EntityEnum.ACCOUNT.name());</span>

<span class="nc" id="L1668">			registrationDetails.addAttribute(FIRST_SANCTION_SUMMARY + registrationDetails.getAccount().getId(),</span>
					sanctionSummary);

<span class="nc" id="L1671">			EntityDetails entityDetails = eventDBServiceImpl</span>
<span class="nc" id="L1672">					.isSanctionPerformed(registrationDetails.getAccount().getId(), EntityEnum.ACCOUNT.name());</span>

<span class="nc" id="L1674">			contact.setSanctionPerformed(entityDetails.getIsExist());</span>

<span class="nc" id="L1676">		} catch (ComplianceException complianceException) {</span>
<span class="nc" id="L1677">			LOGGER.error(&quot;Exception in setServiceChecksEligiblity()&quot;, complianceException);</span>
<span class="nc" id="L1678">		}</span>
<span class="nc" id="L1679">	}</span>

	/**
	 * Gets the checks if is blacklist eligible for cfx.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @param accountId
	 *            the account id
	 * @return the checks if is blacklist eligible for cfx
	 */
	private Boolean getIsBlacklistEligibleForCfx(RegistrationServiceRequest registrationDetails, Boolean result,
			Integer accountId) {
<span class="nc" id="L1694">		Boolean blacklistResult = result;</span>
		//AT-5487
<span class="nc" id="L1696">		Integer contactIdForCFX = (Integer) registrationDetails.getAdditionalAttribute(CONTACT_ID_FOR_CFX);</span>
<span class="nc bnc" id="L1697" title="All 2 branches missed.">		for(Contact con: registrationDetails.getAccount().getContacts()){</span>
<span class="nc bnc" id="L1698" title="All 4 branches missed.">				if ((registrationDetails.getAdditionalAttribute(Constants.BLACKLIST_STATUS).equals(Constants.SERVICE_FAILURE)</span>
						&amp;&amp; null != accountId)
<span class="nc bnc" id="L1700" title="All 2 branches missed.">						|| (contactIdForCFX.equals(con.getId()) &amp;&amp; con.getPreviousBlacklistStatus()</span>
<span class="nc bnc" id="L1701" title="All 2 branches missed.">								.equals(Constants.SERVICE_FAILURE))) 				</span>
				{
<span class="nc" id="L1703">					registrationDetails.addAttribute(IS_BLACKLIST_ELIGIBLE, Boolean.TRUE);</span>
<span class="nc" id="L1704">					blacklistResult = Boolean.TRUE;</span>
<span class="nc" id="L1705">					break;</span>
				} else {
<span class="nc" id="L1707">					registrationDetails.addAttribute(IS_BLACKLIST_ELIGIBLE, Boolean.FALSE);</span>
				}
<span class="nc" id="L1709">		}</span>
<span class="nc" id="L1710">		return blacklistResult;</span>
	}

	/**
	 * Gets the checks if is blacklist eligible for pfx.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is blacklist eligible for pfx
	 */
	private Boolean getIsBlacklistEligibleForPfx(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1723">		Boolean blacklistResult = result;</span>
<span class="nc bnc" id="L1724" title="All 2 branches missed.">		if (registrationDetails.getAdditionalAttribute(Constants.BLACKLIST_STATUS).equals(Constants.SERVICE_FAILURE)) {</span>
<span class="nc" id="L1725">			registrationDetails.addAttribute(IS_BLACKLIST_ELIGIBLE, Boolean.TRUE);</span>
<span class="nc" id="L1726">			blacklistResult = Boolean.TRUE;</span>
		} else {
<span class="nc" id="L1728">			registrationDetails.addAttribute(IS_BLACKLIST_ELIGIBLE, Boolean.FALSE);</span>
		}
<span class="nc" id="L1730">		return blacklistResult;</span>
	}

	/**
	 * Gets the checks if is EID eligible for pfx.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is EID eligible for pfx
	 */
	private Boolean getIsEIDEligibleForPfx(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1743">		Boolean eidResult = result;</span>
<span class="nc bnc" id="L1744" title="All 2 branches missed.">		if (registrationDetails.getAdditionalAttribute(Constants.EID_STATUS).equals(Constants.SERVICE_FAILURE)) {</span>
<span class="nc" id="L1745">			registrationDetails.addAttribute(IS_EID_ELIGIBLE, Boolean.TRUE);</span>
<span class="nc" id="L1746">			eidResult = Boolean.TRUE;</span>
		} else {
<span class="nc" id="L1748">			registrationDetails.addAttribute(IS_EID_ELIGIBLE, Boolean.FALSE);</span>
		}
<span class="nc" id="L1750">		return eidResult;</span>
	}

	/**
	 * Gets the checks if is fraugster eligiblie for pfx.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is fraugster eligiblie for pfx
	 */
	private Boolean getIsFraugsterEligiblieForPfx(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1763">		boolean fraugsterResult = result;</span>
<span class="nc bnc" id="L1764" title="All 2 branches missed.">		if (registrationDetails.getAdditionalAttribute(Constants.FRAUGSTER_STATUS).equals(Constants.SERVICE_FAILURE)) {</span>
<span class="nc" id="L1765">			registrationDetails.addAttribute(IS_FRAUGSTER_ELIGIBLE_FOR_RECHECK, Boolean.TRUE);</span>
<span class="nc" id="L1766">			fraugsterResult = true;</span>
		} else {
<span class="nc" id="L1768">			registrationDetails.addAttribute(IS_FRAUGSTER_ELIGIBLE_FOR_RECHECK, Boolean.FALSE);</span>
		}
<span class="nc" id="L1770">		return fraugsterResult;</span>
	}

	/**
	 * Gets the checks if is fraugster eligiblie for cfx.
	 *
	 * @param registrationDetails
	 *            the registration details
	 * @param result
	 *            the result
	 * @return the checks if is fraugster eligiblie for cfx
	 */
	private Boolean getIsFraugsterEligiblieForCfx(RegistrationServiceRequest registrationDetails, Boolean result) {
<span class="nc" id="L1783">		Boolean fraugsterResult = result;</span>
		//AT-5487
<span class="nc" id="L1785">		Integer contactIdForCFX = (Integer) registrationDetails.getAdditionalAttribute(CONTACT_ID_FOR_CFX);</span>
<span class="nc bnc" id="L1786" title="All 2 branches missed.">		for(Contact con: registrationDetails.getAccount().getContacts()){</span>
<span class="nc bnc" id="L1787" title="All 2 branches missed.">			if (contactIdForCFX.equals(con.getId()) &amp;&amp; con.getPreviousFraugsterStatus()</span>
<span class="nc bnc" id="L1788" title="All 2 branches missed.">							.equals(Constants.SERVICE_FAILURE)) 				</span>
			{
<span class="nc" id="L1790">				registrationDetails.addAttribute(IS_FRAUGSTER_ELIGIBLE_FOR_RECHECK, Boolean.TRUE);</span>
<span class="nc" id="L1791">				fraugsterResult = Boolean.TRUE;</span>
<span class="nc" id="L1792">				break;</span>
			} else {
<span class="nc" id="L1794">				registrationDetails.addAttribute(IS_FRAUGSTER_ELIGIBLE_FOR_RECHECK, Boolean.FALSE);</span>
			}
<span class="nc" id="L1796">		}</span>
<span class="nc" id="L1797">		return fraugsterResult;</span>
	}

	/**
	 * Builds the fraugster exchange.
	 *
	 * @param message
	 *            the message
	 * @param eventId
	 *            the event id
	 * @param token
	 *            the token
	 * @param registrationDetails
	 *            the registration details
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void buildFraugsterExchange(Message&lt;MessageContext&gt; message, Integer eventId, UserProfile token,
			RegistrationServiceRequest registrationDetails) throws ComplianceException {
<span class="nc bnc" id="L1816" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_FRAUGSTER_ELIGIBLE_FOR_RECHECK)) {</span>
<span class="nc" id="L1817">			ServiceTypeEnum serviceType = ServiceTypeEnum.FRAUGSTER_SERVICE;</span>
<span class="nc" id="L1818">			Integer entityType = EntityEnum.CONTACT.getEntityTypeAsInteger();</span>
<span class="nc" id="L1819">			EventServiceLog esl = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(eventId,</span>
<span class="nc" id="L1820">					registrationDetails.getAccount().getId(), serviceType, registrationDetails, entityType);</span>
<span class="nc" id="L1821">			FraugsterOnUpdateResponse fResponse = new FraugsterOnUpdateResponse();</span>
		try {
<span class="nc" id="L1823">				FraugsterOnUpdateContactResponse fOnUpdateResponses = JsonConverterUtil</span>
<span class="nc" id="L1824">						.convertToObject(FraugsterOnUpdateContactResponse.class, esl.getProviderResponse());</span>
<span class="nc" id="L1825">				List&lt;FraugsterOnUpdateContactResponse&gt; fOnUpdateResponsesList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1826">				fOnUpdateResponsesList.add(fOnUpdateResponses);</span>
<span class="nc" id="L1827">				fResponse.setContactResponses(fOnUpdateResponsesList);</span>
<span class="nc" id="L1828">				fResponse.setStatus(fOnUpdateResponses.getStatus());</span>
<span class="nc" id="L1829">				FraugsterSummary summary = JsonConverterUtil.convertToObject(FraugsterSummary.class, esl.getSummary());</span>
<span class="nc" id="L1830">				MessageExchange ccExchange = new MessageExchange();</span>
<span class="nc" id="L1831">				ccExchange.setResponse(fResponse);</span>
<span class="nc" id="L1832">				ccExchange.setServiceTypeEnum(ServiceTypeEnum.FRAUGSTER_SERVICE);</span>
<span class="nc" id="L1833">				List&lt;Contact&gt; contact = registrationDetails.getAccount().getContacts();</span>
<span class="nc bnc" id="L1834" title="All 2 branches missed.">				for (Contact con : contact) {</span>
<span class="nc" id="L1835">					ccExchange.addEventServiceLog(createEventServiceLogEntryWithStatus(esl.getEventId(),</span>
<span class="nc" id="L1836">							ServiceTypeEnum.FRAUGSTER_SERVICE, ServiceProviderEnum.FRAUGSTER_ONUPDATE_SERVICE, con.getId(),</span>
<span class="nc" id="L1837">							con.getVersion(), EntityEnum.CONTACT.name(), token.getUserID(), fOnUpdateResponses, summary,</span>
<span class="nc" id="L1838">							esl.getStatus()));</span>
<span class="nc" id="L1839">				}</span>
<span class="nc" id="L1840">				message.getPayload().appendMessageExchange(ccExchange);</span>
<span class="nc" id="L1841">			} catch (Exception e) { // Add try catch - For AT-4355</span>
<span class="nc" id="L1842">				LOGGER.error(&quot;Error in reading Fraugster on update contact response&quot;, e);</span>
<span class="nc" id="L1843">			}</span>
		}
<span class="nc" id="L1845">	}</span>

	/**
	 * Builds the KYC exchange.
	 *
	 * @param message
	 *            the message
	 * @param eventId
	 *            the event id
	 * @param token
	 *            the token
	 * @param registrationDetails
	 *            the registration details
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void buildKYCExchange(Message&lt;MessageContext&gt; message, Integer eventId, UserProfile token,
			RegistrationServiceRequest registrationDetails) throws ComplianceException {
<span class="nc bnc" id="L1863" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_EID_ELIGIBLE)) {</span>
<span class="nc" id="L1864">			ServiceTypeEnum serviceType = ServiceTypeEnum.KYC_SERVICE;</span>
<span class="nc" id="L1865">			Integer entityType = EntityEnum.CONTACT.getEntityTypeAsInteger();</span>
<span class="nc" id="L1866">			EventServiceLog esl = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(eventId,</span>
<span class="nc" id="L1867">					registrationDetails.getAccount().getId(), serviceType, registrationDetails, entityType);</span>
<span class="nc" id="L1868">			KYCProviderResponse kycProviderResponse = new KYCProviderResponse();</span>
			try {
<span class="nc" id="L1870">				KYCContactResponse kycContactResponse = JsonConverterUtil.convertToObject(KYCContactResponse.class,</span>
<span class="nc" id="L1871">						esl.getProviderResponse());</span>
<span class="nc" id="L1872">				KYCSummary summary = JsonConverterUtil.convertToObject(KYCSummary.class, esl.getSummary());</span>
<span class="nc" id="L1873">				List&lt;KYCContactResponse&gt; kycContactResponseList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1874">				kycContactResponseList.add(kycContactResponse);</span>
<span class="nc" id="L1875">				kycProviderResponse.setContactResponse(kycContactResponseList);</span>
<span class="nc" id="L1876">				MessageExchange ccExchange = new MessageExchange();</span>
<span class="nc" id="L1877">				ccExchange.setResponse(kycProviderResponse);</span>
<span class="nc" id="L1878">				ccExchange.setServiceTypeEnum(ServiceTypeEnum.KYC_SERVICE);</span>
<span class="nc" id="L1879">				List&lt;Contact&gt; contact = registrationDetails.getAccount().getContacts();</span>
<span class="nc bnc" id="L1880" title="All 2 branches missed.">				for (Contact con : contact) {</span>
<span class="nc" id="L1881">					ccExchange.addEventServiceLog(createEventServiceLogEntryWithStatus(esl.getEventId(),</span>
<span class="nc" id="L1882">							ServiceTypeEnum.KYC_SERVICE, ServiceProviderEnum.KYC_SERVICE, con.getId(), con.getVersion(),</span>
<span class="nc" id="L1883">							EntityEnum.CONTACT.name(), token.getUserID(), kycContactResponse, summary, esl.getStatus()));</span>
<span class="nc" id="L1884">				}</span>

<span class="nc" id="L1886">				message.getPayload().appendMessageExchange(ccExchange);</span>
			}
<span class="nc" id="L1888">			catch (Exception e) { // Add try catch - For AT-4355</span>
<span class="nc" id="L1889">				LOGGER.error(&quot;Error in reading KYC Provider Response&quot;, e);</span>
<span class="nc" id="L1890">			}</span>
		}

<span class="nc" id="L1893">	}</span>

	/**
	 * Builds the internal rule service exchange.
	 *
	 * @param message
	 *            the message
	 * @param eventId
	 *            the event id
	 * @param registrationDetails
	 *            the registration details
	 * @param contactResponse
	 *            the contact response
	 * @param token
	 *            the token
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void buildInternalRuleServiceExchange(Message&lt;MessageContext&gt; message, Integer eventId,
			RegistrationServiceRequest registrationDetails, ContactResponse contactResponse, UserProfile token)
			throws ComplianceException {
<span class="nc" id="L1914">		MessageExchange ccExchange = new MessageExchange();</span>
<span class="nc" id="L1915">		ccExchange.setServiceTypeEnum(ServiceTypeEnum.INTERNAL_RULE_SERVICE);</span>
<span class="nc" id="L1916">		InternalServiceResponse response = new InternalServiceResponse();</span>
<span class="nc" id="L1917">		List&lt;ContactResponse&gt; responseList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L1918">		List&lt;Contact&gt; contact = registrationDetails.getAccount().getContacts();</span>

<span class="nc bnc" id="L1920" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_BLACKLIST_ELIGIBLE)) {</span>
<span class="nc" id="L1921">			ServiceTypeEnum serviceTypeofBlacklist = ServiceTypeEnum.BLACK_LIST_SERVICE;</span>
<span class="nc" id="L1922">			Integer entityType = EntityEnum.CONTACT.getEntityTypeAsInteger();</span>
<span class="nc" id="L1923">			EventServiceLog eslofBlacklist = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(</span>
<span class="nc" id="L1924">					eventId, registrationDetails.getAccount().getId(), serviceTypeofBlacklist, registrationDetails,</span>
					entityType);
			try {
<span class="nc" id="L1927">				BlacklistContactResponse blacklistContactResponse = JsonConverterUtil</span>
<span class="nc" id="L1928">						.convertToObject(BlacklistContactResponse.class, eslofBlacklist.getProviderResponse());</span>
<span class="nc" id="L1929">				contactResponse.setBlacklist(blacklistContactResponse);</span>
			}
<span class="nc" id="L1931">			catch (Exception e) { // Add try catch - For AT-4355</span>
<span class="nc" id="L1932">				LOGGER.error(&quot;Error in reading Blacklist Contact Response&quot;, e);</span>
<span class="nc" id="L1933">			}</span>
		}
<span class="nc bnc" id="L1935" title="All 2 branches missed.">		if (CustomerTypeEnum.PFX.name().equals(registrationDetails.getAccount().getCustType())) {</span>
<span class="nc" id="L1936">			buildInternalRuleServiceExchangeForPFX(message, eventId, registrationDetails, contactResponse, ccExchange, responseList, contact);</span>
		}

<span class="nc bnc" id="L1939" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_BLACKLIST_ELIGIBLE)</span>
<span class="nc bnc" id="L1940" title="All 2 branches missed.">				&amp;&amp; !CustomerTypeEnum.PFX.name().equals(registrationDetails.getAccount().getCustType())) {</span>
<span class="nc" id="L1941">			buildInternalRuleServiceExchangeForCFX(eventId, registrationDetails, contactResponse, token, ccExchange,</span>
					contact);
		}

<span class="nc" id="L1945">		response.setContacts(responseList);</span>
<span class="nc" id="L1946">		ccExchange.setResponse(response);</span>
<span class="nc" id="L1947">		message.getPayload().appendMessageExchange(ccExchange);</span>
<span class="nc" id="L1948">	}</span>

	/**
	 * Builds the internal rule service exchange for CFX.
	 *
	 * @param eventId
	 *            the event id
	 * @param registrationDetails
	 *            the registration details
	 * @param contactResponse
	 *            the contact response
	 * @param token
	 *            the token
	 * @param ccExchange
	 *            the cc exchange
	 * @param contact
	 *            the contact
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void buildInternalRuleServiceExchangeForCFX(Integer eventId, RegistrationServiceRequest registrationDetails,
			ContactResponse contactResponse, UserProfile token, MessageExchange ccExchange, List&lt;Contact&gt; contact)
			throws ComplianceException {
<span class="nc" id="L1971">		ContactResponse contactRes = contactResponse;</span>
<span class="nc" id="L1972">		ccExchange.addEventServiceLog(createEventServiceLogEntryWithStatus(eventId, ServiceTypeEnum.BLACK_LIST_SERVICE,</span>
<span class="nc" id="L1973">				ServiceProviderEnum.BLACKLIST, registrationDetails.getAccount().getId(),</span>
<span class="nc" id="L1974">				registrationDetails.getAccount().getVersion(), EntityEnum.ACCOUNT.name(), token.getUserID(),</span>
<span class="nc" id="L1975">				contactRes, createDefaultBlacklistSummary(contactRes.getBlacklist().getStatus()),</span>
<span class="nc" id="L1976">				ServiceStatus.valueOf(contactRes.getBlacklist().getStatus())));</span>
<span class="nc bnc" id="L1977" title="All 2 branches missed.">		for (Contact con : contact) {</span>
<span class="nc" id="L1978">			contactRes = createDefaultCFXContactResponse(</span>
<span class="nc bnc" id="L1979" title="All 2 branches missed.">					countryCache.getCountryFullName(null != con.getCountry() ? con.getCountry() : &quot;&quot;), contactRes);</span>

<span class="nc" id="L1981">			ccExchange.addEventServiceLog(createEventServiceLogEntryWithStatus(eventId,</span>
<span class="nc" id="L1982">					ServiceTypeEnum.BLACK_LIST_SERVICE, ServiceProviderEnum.BLACKLIST, con.getId(), con.getVersion(),</span>
<span class="nc" id="L1983">					EntityEnum.CONTACT.name(), token.getUserID(), contactRes,</span>
<span class="nc" id="L1984">					createDefaultBlacklistSummary(contactRes.getBlacklist().getStatus()),</span>
<span class="nc" id="L1985">					ServiceStatus.valueOf(contactRes.getBlacklist().getStatus())));</span>

<span class="nc" id="L1987">			ccExchange.addEventServiceLog(</span>
<span class="nc" id="L1988">					createEventServiceLogEntryWithStatus(eventId, ServiceTypeEnum.GLOBAL_CHECK_SERVICE,</span>
<span class="nc" id="L1989">							ServiceProviderEnum.GLOBALCHECK, con.getId(), con.getVersion(), EntityEnum.CONTACT.name(),</span>
<span class="nc" id="L1990">							token.getUserID(), contactRes, contactRes.getGlobalCheck(),</span>
<span class="nc" id="L1991">							ServiceStatus.valueOf(contactRes.getGlobalCheck().getStatus())));</span>

<span class="nc" id="L1993">			ccExchange.addEventServiceLog(createEventServiceLogEntryWithStatus(eventId, ServiceTypeEnum.HRC_SERVICE,</span>
<span class="nc" id="L1994">					ServiceProviderEnum.COUNTRYCHECK, con.getId(), con.getVersion(), EntityEnum.CONTACT.name(),</span>
<span class="nc" id="L1995">					token.getUserID(), contactRes, contactRes.getCountryCheck(),</span>
<span class="nc" id="L1996">					ServiceStatus.valueOf(contactRes.getCountryCheck().getStatus())));</span>
<span class="nc" id="L1997">		}</span>
<span class="nc" id="L1998">	}</span>

	/**
	 * Builds the internal rule service exchange for PFX.
	 *
	 * @param message            the message
	 * @param eventId            the event id
	 * @param registrationDetails            the registration details
	 * @param contactResponse            the contact response
	 * @param ccExchange            the cc exchange
	 * @param responseList            the response list
	 * @param contact            the contact
	 * @throws ComplianceException             the compliance exception
	 */
	private void buildInternalRuleServiceExchangeForPFX(Message&lt;MessageContext&gt; message, Integer eventId,
			RegistrationServiceRequest registrationDetails, ContactResponse contactResponse, MessageExchange ccExchange, List&lt;ContactResponse&gt; responseList, List&lt;Contact&gt; contact)
			throws ComplianceException {
<span class="nc" id="L2015">		UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
<span class="nc bnc" id="L2016" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_COUNTRY_CHECK_ELIGIBLE)) {</span>
<span class="nc" id="L2017">			ServiceTypeEnum serviceTypeofCountry = ServiceTypeEnum.HRC_SERVICE;</span>
<span class="nc" id="L2018">			Integer entityType = EntityEnum.CONTACT.getEntityTypeAsInteger();</span>
<span class="nc" id="L2019">			EventServiceLog eslofCountry = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(eventId,</span>
<span class="nc" id="L2020">					registrationDetails.getAccount().getId(), serviceTypeofCountry, registrationDetails, entityType);</span>
			try {
<span class="nc" id="L2022">				CountryCheckContactResponse countryCheckContactResponse = JsonConverterUtil</span>
<span class="nc" id="L2023">						.convertToObject(CountryCheckContactResponse.class, eslofCountry.getProviderResponse());</span>
<span class="nc" id="L2024">				contactResponse.setCountryCheck(countryCheckContactResponse);</span>
<span class="nc" id="L2025">			}catch (Exception e) { // Add try catch - For AT-4355</span>
<span class="nc" id="L2026">				LOGGER.error(&quot;Error in reading Country Check Contact Response&quot;, e);</span>
<span class="nc" id="L2027">			}</span>
<span class="nc" id="L2028">			message.getPayload().getGatewayMessageExchange().getRequest().addAttribute(COUNTRY_CHECK_STATUS,</span>
<span class="nc" id="L2029">					eslofCountry.getStatus());</span>
		}

<span class="nc bnc" id="L2032" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_IP_CHECK_ELIGIBLE)) {</span>
<span class="nc" id="L2033">			ServiceTypeEnum serviceTypeofIp = ServiceTypeEnum.IP_SERVICE;</span>
<span class="nc" id="L2034">			Integer entityType = EntityEnum.CONTACT.getEntityTypeAsInteger();</span>
<span class="nc" id="L2035">			EventServiceLog eslOfIp = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(eventId,</span>
<span class="nc" id="L2036">					registrationDetails.getAccount().getId(), serviceTypeofIp, registrationDetails, entityType);</span>
			try {
<span class="nc" id="L2038">				IpContactResponse ipContactResponse = JsonConverterUtil.convertToObject(IpContactResponse.class,</span>
<span class="nc" id="L2039">						eslOfIp.getProviderResponse());</span>
<span class="nc" id="L2040">				contactResponse.setIpCheck(ipContactResponse);</span>
<span class="nc" id="L2041">			}catch (Exception e) {</span>
<span class="nc" id="L2042">				LOGGER.error(&quot;Error in reading Ip Contact Response&quot;, e);</span>
<span class="nc" id="L2043">			}</span>
<span class="nc" id="L2044">			message.getPayload().getGatewayMessageExchange().getRequest().addAttribute(IP_CHECK_STATUS,</span>
<span class="nc" id="L2045">					eslOfIp.getStatus());</span>
		}

<span class="nc bnc" id="L2048" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_GLOBAL_CHECK_ELIGIBLE)) {</span>
<span class="nc" id="L2049">			ServiceTypeEnum serviceTypeofGlobalCheck = ServiceTypeEnum.GLOBAL_CHECK_SERVICE;</span>
<span class="nc" id="L2050">			Integer entityType = EntityEnum.CONTACT.getEntityTypeAsInteger();</span>
<span class="nc" id="L2051">			EventServiceLog eslofGlobalCheck = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(</span>
<span class="nc" id="L2052">					eventId, registrationDetails.getAccount().getId(), serviceTypeofGlobalCheck, registrationDetails,</span>
					entityType);
			try {
<span class="nc" id="L2055">				GlobalCheckContactResponse globalCheckContactResponse = JsonConverterUtil</span>
<span class="nc" id="L2056">						.convertToObject(GlobalCheckContactResponse.class, eslofGlobalCheck.getProviderResponse());</span>
<span class="nc" id="L2057">				contactResponse.setGlobalCheck(globalCheckContactResponse);</span>
<span class="nc" id="L2058">			}catch (Exception e) { // Add try catch - For AT-4355</span>
<span class="nc" id="L2059">				LOGGER.error(&quot;Error in reading Global Check Contact Response&quot;, e);</span>
<span class="nc" id="L2060">			}</span>
<span class="nc" id="L2061">			message.getPayload().getGatewayMessageExchange().getRequest().addAttribute(GLOBAL_CHECK_STATUS,</span>
<span class="nc" id="L2062">					eslofGlobalCheck.getStatus());</span>
		}
<span class="nc bnc" id="L2064" title="All 2 branches missed.">		for (Contact con : contact) {</span>
<span class="nc" id="L2065">			contactResponse.setId(con.getId());</span>
<span class="nc" id="L2066">			responseList.add(contactResponse);</span>
<span class="nc bnc" id="L2067" title="All 2 branches missed.">			if (null == contactResponse.getBlacklist()) {</span>
<span class="nc" id="L2068">				BlacklistContactResponse blacklistresponse = new BlacklistContactResponse();</span>
<span class="nc" id="L2069">				blacklistresponse.setStatus(ServiceStatus.NOT_PERFORMED.name());</span>
<span class="nc" id="L2070">				contactResponse.setBlacklist(blacklistresponse);</span>
			}
<span class="nc bnc" id="L2072" title="All 2 branches missed.">			if (null == contactResponse.getIpCheck()) {</span>
<span class="nc" id="L2073">				IpContactResponse ipResponse = new IpContactResponse();</span>
<span class="nc" id="L2074">				ipResponse.setStatus(ServiceStatus.NOT_PERFORMED.name());</span>
<span class="nc" id="L2075">				contactResponse.setIpCheck(ipResponse);</span>
			}
			try {
<span class="nc" id="L2078">				populateAllEventServiceLogs(token, ccExchange, eventId, contactResponse,</span>
<span class="nc" id="L2079">						createDefaultBlacklistSummary(contactResponse.getBlacklist().getStatus()),</span>
<span class="nc" id="L2080">						createDefaultIpSummary(contactResponse.getIpCheck().getStatus(), con.getIpAddress()), con);</span>
<span class="nc" id="L2081">			}catch (Exception e) { // Add try catch - For AT-4355</span>
<span class="nc" id="L2082">				LOGGER.error(&quot;Error in populate all EventServiceLogs&quot;, e);</span>
<span class="nc" id="L2083">			}</span>
<span class="nc" id="L2084">		}</span>
<span class="nc" id="L2085">	}</span>

	/**
	 * Creates the event service log entry with status.
	 *
	 * @param eventId
	 *            the event id
	 * @param servceType
	 *            the servce type
	 * @param providerEnum
	 *            the provider enum
	 * @param entityID
	 *            the entity ID
	 * @param entityVersion
	 *            the entity version
	 * @param entityType
	 *            the entity type
	 * @param user
	 *            the user
	 * @param providerResponse
	 *            the provider response
	 * @param summary
	 *            the summary
	 * @param serviceStatus
	 *            the service status
	 * @return the event service log
	 */
	@SuppressWarnings(&quot;squid:S00107&quot;)
	protected EventServiceLog createEventServiceLogEntryWithStatus(Integer eventId, ServiceTypeEnum servceType,
			ServiceProviderEnum providerEnum, Integer entityID, Integer entityVersion, String entityType, Integer user,
			Object providerResponse, Object summary, String serviceStatus) {

<span class="nc" id="L2117">		EventServiceLog eventServiceLog = new EventServiceLog();</span>
<span class="nc" id="L2118">		eventServiceLog.setServiceName(servceType.getShortName());</span>
<span class="nc" id="L2119">		eventServiceLog.setServiceProviderName(providerEnum.getProvidername());</span>
<span class="nc" id="L2120">		eventServiceLog.setEntityId(entityID);</span>
<span class="nc" id="L2121">		eventServiceLog.setEventId(eventId);</span>
<span class="nc" id="L2122">		eventServiceLog.setEntityVersion(entityVersion);</span>
<span class="nc" id="L2123">		eventServiceLog.setEntityType(entityType);</span>
<span class="nc" id="L2124">		eventServiceLog.setStatus(serviceStatus);</span>
<span class="nc" id="L2125">		eventServiceLog.setProviderResponse(JsonConverterUtil.convertToJsonWithoutNull(providerResponse));</span>
<span class="nc" id="L2126">		eventServiceLog.setSummary(JsonConverterUtil.convertToJsonWithoutNull(summary));</span>
<span class="nc" id="L2127">		eventServiceLog.setCratedBy(user);</span>
<span class="nc" id="L2128">		eventServiceLog.setUpdatedBy(user);</span>
<span class="nc" id="L2129">		eventServiceLog.setCreatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L2130">		eventServiceLog.setUpdatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L2131">		return eventServiceLog;</span>
	}

	/**
	 * Builds the sanction exchange.
	 *
	 * @param message
	 *            the message
	 * @param eventId
	 *            the event id
	 * @param sanctionResponse
	 *            the sanction response
	 * @param token
	 *            the token
	 * @param sanctionEntityLogList
	 *            the sanction entity log list
	 * @param registrationDetails
	 *            the registration details
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void buildSanctionExchangeForPFX(Message&lt;MessageContext&gt; message, Integer eventId,
			SanctionResponse sanctionResponse, UserProfile token, List&lt;EventServiceLog&gt; sanctionEntityLogList,
			RegistrationServiceRequest registrationDetails) throws ComplianceException {
<span class="nc bnc" id="L2155" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_SANCTION_ELIGIBLE_FOR_RECHECK)) {</span>
<span class="nc" id="L2156">			ServiceTypeEnum serviceType = ServiceTypeEnum.SANCTION_SERVICE;</span>
<span class="nc" id="L2157">			Integer entityType = EntityEnum.CONTACT.getEntityTypeAsInteger();</span>
<span class="nc" id="L2158">			Integer contactId = (Integer) registrationDetails.getAdditionalAttribute(&quot;contactId&quot;);</span>
<span class="nc" id="L2159">			EventServiceLog esl = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(eventId,</span>
<span class="nc" id="L2160">					registrationDetails.getAccount().getId(), serviceType, registrationDetails, entityType);</span>

<span class="nc bnc" id="L2162" title="All 2 branches missed.">			for (Contact con : registrationDetails.getAccount().getContacts()) {</span>
<span class="nc bnc" id="L2163" title="All 4 branches missed.">				if (null != contactId &amp;&amp; contactId.equals(con.getId())) {</span>
<span class="nc" id="L2164">					getSanctionContactResponse(esl, sanctionResponse, token, con);</span>
<span class="nc" id="L2165">					sanctionEntityLogList.add((EventServiceLog) sanctionResponse</span>
<span class="nc" id="L2166">							.getAdditionalAttribute(CONTACT_LOG_FOR_CONTACT + con.getId()));</span>
				}
<span class="nc" id="L2168">			}</span>

<span class="nc" id="L2170">			createPreviousSanctionExchange(message, sanctionResponse, sanctionEntityLogList);</span>
		}
<span class="nc" id="L2172">	}</span>

	/**
	 * Builds the sanction exchange for CFX.
	 *
	 * @param message
	 *            the message
	 * @param eventId
	 *            the event id
	 * @param sanctionResponse
	 *            the sanction response
	 * @param token
	 *            the token
	 * @param sanctionEntityLogList
	 *            the sanction entity log list
	 * @param registrationDetails
	 *            the registration details
	 * @throws ComplianceException
	 *             the compliance exception
	 */
	private void buildSanctionExchangeForCFX(Message&lt;MessageContext&gt; message, Integer eventId,
			SanctionResponse sanctionResponse, UserProfile token, List&lt;EventServiceLog&gt; sanctionEntityLogList,
			RegistrationServiceRequest registrationDetails) throws ComplianceException {

<span class="nc" id="L2196">		ServiceTypeEnum serviceType = ServiceTypeEnum.SANCTION_SERVICE;</span>
<span class="nc" id="L2197">		Integer entityType = EntityEnum.CONTACT.getEntityTypeAsInteger();</span>
<span class="nc" id="L2198">		EventServiceLog esl = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(eventId,</span>
<span class="nc" id="L2199">				registrationDetails.getAccount().getId(), serviceType, registrationDetails, entityType);</span>

<span class="nc bnc" id="L2201" title="All 2 branches missed.">		for (Contact con : registrationDetails.getAccount().getContacts()) {</span>
<span class="nc" id="L2202">			getSanctionContactResponse(esl, sanctionResponse, token, con);</span>
<span class="nc" id="L2203">			sanctionEntityLogList.add(</span>
<span class="nc" id="L2204">					(EventServiceLog) sanctionResponse.getAdditionalAttribute(CONTACT_LOG_FOR_CONTACT + con.getId()));</span>
<span class="nc" id="L2205">		}</span>

<span class="nc bnc" id="L2207" title="All 2 branches missed.">		if (!(boolean) registrationDetails.getAdditionalAttribute(IS_SANCTION_ELIGIBLE_FOR_RECHECK)) {</span>
<span class="nc" id="L2208">			Integer entityTypeForAcc = EntityEnum.ACCOUNT.getEntityTypeAsInteger();</span>
<span class="nc" id="L2209">			EventServiceLog eslForAcc = newRegistrationDBServiceImpl.getServiceFailedRegistrationESLDetails(eventId,</span>
<span class="nc" id="L2210">					registrationDetails.getAccount().getId(), serviceType, registrationDetails, entityTypeForAcc);</span>
<span class="nc" id="L2211">			getSanctionAccountResponse(eslForAcc, sanctionResponse, token, registrationDetails);</span>
<span class="nc" id="L2212">			sanctionEntityLogList</span>
<span class="nc" id="L2213">					.add((EventServiceLog) sanctionResponse.getAdditionalAttribute(&quot;contactLogForAccount&quot;));</span>

<span class="nc" id="L2215">			createPreviousSanctionExchange(message, sanctionResponse, sanctionEntityLogList);</span>
		}
<span class="nc" id="L2217">	}</span>

	/**
	 * Creates the previous sanction exchange.
	 *
	 * @param message
	 *            the message
	 * @param sanctionResponse
	 *            the sanction response
	 * @param sanctionEntityLogList
	 *            the sanction entity log list
	 */
	private void createPreviousSanctionExchange(Message&lt;MessageContext&gt; message, SanctionResponse sanctionResponse,
			List&lt;EventServiceLog&gt; sanctionEntityLogList) {
<span class="nc" id="L2231">		MessageExchange ccExchange = new MessageExchange();</span>
<span class="nc" id="L2232">		ccExchange.setResponse(sanctionResponse);</span>
<span class="nc" id="L2233">		ccExchange.setServiceTypeEnum(ServiceTypeEnum.SANCTION_SERVICE);</span>
<span class="nc bnc" id="L2234" title="All 2 branches missed.">		for (EventServiceLog sanctionLog : sanctionEntityLogList) {</span>
<span class="nc bnc" id="L2235" title="All 2 branches missed.">			if (null != sanctionLog)</span>
<span class="nc" id="L2236">				ccExchange.addEventServiceLog(sanctionLog);</span>
<span class="nc" id="L2237">		}</span>
<span class="nc" id="L2238">		message.getPayload().appendMessageExchange(ccExchange);</span>
<span class="nc" id="L2239">	}</span>

	/**
	 * Gets the sanction contact response.
	 *
	 * @param esl
	 *            the esl
	 * @param sanctionResponse
	 *            the sanction response
	 * @param token
	 *            the token
	 * @param con
	 *            the con
	 * @return the sanction contact response
	 */
	private EventServiceLog getSanctionContactResponse(EventServiceLog esl, SanctionResponse sanctionResponse,
			UserProfile token, Contact con) {
<span class="nc bnc" id="L2256" title="All 2 branches missed.">		if (&quot;CONTACT&quot;.equalsIgnoreCase(esl.getEntityType())) {</span>
<span class="nc" id="L2257">			List&lt;SanctionContactResponse&gt; sanctionContactResponseList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2258">			SanctionContactResponse sanctionContactResponse = JsonConverterUtil</span>
<span class="nc" id="L2259">					.convertToObject(SanctionContactResponse.class, esl.getProviderResponse());</span>
<span class="nc" id="L2260">			SanctionSummary sanctionSummary = JsonConverterUtil.convertToObject(SanctionSummary.class,</span>
<span class="nc" id="L2261">					esl.getSummary());</span>
<span class="nc" id="L2262">			sanctionContactResponseList.add(sanctionContactResponse);</span>
<span class="nc" id="L2263">			sanctionResponse.setContactResponses(sanctionContactResponseList);</span>
<span class="nc" id="L2264">			EventServiceLog contactLogForContact = createEventServiceLogEntryWithStatus(esl.getEventId(),</span>
<span class="nc" id="L2265">					ServiceTypeEnum.SANCTION_SERVICE, ServiceProviderEnum.SANCTION_SERVICE, con.getId(),</span>
<span class="nc" id="L2266">					con.getVersion(), EntityEnum.CONTACT.name(), token.getUserID(), sanctionContactResponse,</span>
<span class="nc" id="L2267">					sanctionSummary, esl.getStatus());</span>
<span class="nc" id="L2268">			sanctionResponse.addAttribute(CONTACT_LOG_FOR_CONTACT + con.getId(), contactLogForContact);</span>
<span class="nc" id="L2269">			MessageExchange ccExchange = new MessageExchange();</span>
<span class="nc" id="L2270">			ccExchange.addEventServiceLog(contactLogForContact);</span>
<span class="nc" id="L2271">			return contactLogForContact;</span>
		}
<span class="nc" id="L2273">		return null;</span>
	}

	/**
	 * Gets the sanction account response.
	 *
	 * @param esl
	 *            the esl
	 * @param sanctionResponse
	 *            the sanction response
	 * @param token
	 *            the token
	 * @param registrationDetails
	 *            the registration details
	 * @return the sanction account response
	 */
	private EventServiceLog getSanctionAccountResponse(EventServiceLog esl, SanctionResponse sanctionResponse,
			UserProfile token, RegistrationServiceRequest registrationDetails) {
<span class="nc bnc" id="L2291" title="All 2 branches missed.">		if (&quot;ACCOUNT&quot;.equalsIgnoreCase(esl.getEntityType())) {</span>
<span class="nc" id="L2292">			List&lt;SanctionContactResponse&gt; sanctionContactResponseList = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L2293">			SanctionContactResponse sanctionContactResponse = JsonConverterUtil</span>
<span class="nc" id="L2294">					.convertToObject(SanctionContactResponse.class, esl.getProviderResponse());</span>
<span class="nc" id="L2295">			SanctionSummary sanctionSummary = JsonConverterUtil.convertToObject(SanctionSummary.class,</span>
<span class="nc" id="L2296">					esl.getSummary());</span>
<span class="nc" id="L2297">			sanctionContactResponseList.add(sanctionContactResponse);</span>
<span class="nc" id="L2298">			sanctionResponse.setContactResponses(sanctionContactResponseList);</span>
<span class="nc" id="L2299">			Account account = registrationDetails.getAccount();</span>
<span class="nc" id="L2300">			EventServiceLog contactLogForAccount = createEventServiceLogEntryWithStatus(esl.getEventId(),</span>
<span class="nc" id="L2301">					ServiceTypeEnum.SANCTION_SERVICE, ServiceProviderEnum.SANCTION_SERVICE, account.getId(),</span>
<span class="nc" id="L2302">					account.getVersion(), EntityEnum.ACCOUNT.name(), token.getUserID(), sanctionContactResponse,</span>
<span class="nc" id="L2303">					sanctionSummary, esl.getStatus());</span>
<span class="nc" id="L2304">			sanctionResponse.addAttribute(&quot;contactLogForAccount&quot;, contactLogForAccount);</span>
<span class="nc" id="L2305">			MessageExchange ccExchange = new MessageExchange();</span>
<span class="nc" id="L2306">			ccExchange.addEventServiceLog(contactLogForAccount);</span>
<span class="nc" id="L2307">			return contactLogForAccount;</span>
		}
<span class="nc" id="L2309">		return null;</span>
	}

	/**
	 * Populate all event service logs.
	 *
	 * @param token
	 *            the token
	 * @param exchange
	 *            the exchange
	 * @param eventId
	 *            the event id
	 * @param response
	 *            the response
	 * @param blacklistSummary
	 *            the blacklist summary
	 * @param ip
	 *            the ip
	 * @param contact
	 *            the contact
	 */
	private void populateAllEventServiceLogs(UserProfile token, MessageExchange exchange, Integer eventId,
			ContactResponse response, BlacklistSummary blacklistSummary, IpSummary ip, Contact contact) {
<span class="nc" id="L2332">		exchange.addEventServiceLog(createEventServiceLogEntryWithStatus(eventId, ServiceTypeEnum.BLACK_LIST_SERVICE,</span>
<span class="nc" id="L2333">				ServiceProviderEnum.BLACKLIST, contact.getId(), contact.getVersion(), EntityEnum.CONTACT.name(),</span>
<span class="nc" id="L2334">				token.getUserID(), response, blacklistSummary,</span>
<span class="nc" id="L2335">				ServiceStatus.valueOf(response.getBlacklist().getStatus())));</span>

<span class="nc" id="L2337">		exchange.addEventServiceLog(createEventServiceLogEntryWithStatus(eventId, ServiceTypeEnum.IP_SERVICE,</span>
<span class="nc" id="L2338">				ServiceProviderEnum.IP, contact.getId(), contact.getVersion(), EntityEnum.CONTACT.name(),</span>
<span class="nc" id="L2339">				token.getUserID(), response, ip, ServiceStatus.valueOf(response.getIpCheck().getStatus())));</span>

<span class="nc" id="L2341">		exchange.addEventServiceLog(createEventServiceLogEntryWithStatus(eventId, ServiceTypeEnum.GLOBAL_CHECK_SERVICE,</span>
<span class="nc" id="L2342">				ServiceProviderEnum.GLOBALCHECK, contact.getId(), contact.getVersion(), EntityEnum.CONTACT.name(),</span>
<span class="nc" id="L2343">				token.getUserID(), response, response.getGlobalCheck(),</span>
<span class="nc" id="L2344">				ServiceStatus.valueOf(response.getGlobalCheck().getStatus())));</span>

<span class="nc" id="L2346">		exchange.addEventServiceLog(createEventServiceLogEntryWithStatus(eventId, ServiceTypeEnum.HRC_SERVICE,</span>
<span class="nc" id="L2347">				ServiceProviderEnum.COUNTRYCHECK, contact.getId(), contact.getVersion(), EntityEnum.CONTACT.name(),</span>
<span class="nc" id="L2348">				token.getUserID(), response, response.getCountryCheck(),</span>
<span class="nc" id="L2349">				ServiceStatus.valueOf(response.getCountryCheck().getStatus())));</span>
<span class="nc" id="L2350">	}</span>

	/**
	 * Creates the event service log entry with status.
	 *
	 * @param eventId
	 *            the event id
	 * @param servceType
	 *            the servce type
	 * @param providerEnum
	 *            the provider enum
	 * @param entityID
	 *            the entity ID
	 * @param entityVersion
	 *            the entity version
	 * @param entityType
	 *            the entity type
	 * @param user
	 *            the user
	 * @param providerResponse
	 *            the provider response
	 * @param summary
	 *            the summary
	 * @param serviceStatus
	 *            the service status
	 * @return the event service log
	 */
	@SuppressWarnings(&quot;squid:S00107&quot;)
	private EventServiceLog createEventServiceLogEntryWithStatus(Integer eventId, ServiceTypeEnum servceType,
			ServiceProviderEnum providerEnum, Integer entityID, Integer entityVersion, String entityType, Integer user,
			Object providerResponse, Object summary, ServiceStatus serviceStatus) {

		ServiceStatus newStatus;
<span class="nc bnc" id="L2383" title="All 2 branches missed.">		if (null == serviceStatus)</span>
<span class="nc" id="L2384">			newStatus = ServiceStatus.NOT_PERFORMED;</span>
		else
<span class="nc" id="L2386">			newStatus = serviceStatus;</span>

<span class="nc" id="L2388">		EventServiceLog eventServiceLog = new EventServiceLog();</span>
<span class="nc" id="L2389">		eventServiceLog.setServiceName(servceType.getShortName());</span>
<span class="nc" id="L2390">		eventServiceLog.setServiceProviderName(providerEnum.getProvidername());</span>
<span class="nc" id="L2391">		eventServiceLog.setEntityId(entityID);</span>
<span class="nc" id="L2392">		eventServiceLog.setEventId(eventId);</span>
<span class="nc" id="L2393">		eventServiceLog.setEntityVersion(entityVersion);</span>
<span class="nc" id="L2394">		eventServiceLog.setEntityType(entityType);</span>
<span class="nc" id="L2395">		eventServiceLog.setStatus(newStatus.name());</span>
<span class="nc" id="L2396">		eventServiceLog.setProviderResponse(JsonConverterUtil.convertToJsonWithoutNull(providerResponse));</span>
<span class="nc" id="L2397">		eventServiceLog.setSummary(JsonConverterUtil.convertToJsonWithoutNull(summary));</span>
<span class="nc" id="L2398">		eventServiceLog.setCratedBy(user);</span>
<span class="nc" id="L2399">		eventServiceLog.setUpdatedBy(user);</span>
<span class="nc" id="L2400">		eventServiceLog.setCreatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L2401">		eventServiceLog.setUpdatedOn(new Timestamp(System.currentTimeMillis()));</span>
<span class="nc" id="L2402">		return eventServiceLog;</span>
	}

	/**
	 * Creates the default blacklist summary.
	 *
	 * @param status
	 *            the status
	 * @return the blacklist summary
	 */
	private BlacklistSummary createDefaultBlacklistSummary(String status) {
<span class="nc" id="L2413">		BlacklistSummary blacklistSummary = new BlacklistSummary();</span>
<span class="nc" id="L2414">		blacklistSummary.setStatus(status);</span>
<span class="nc" id="L2415">		return blacklistSummary;</span>
	}

	/**
	 * Creates the default ip summary.
	 *
	 * @param status
	 *            the status
	 * @param ipAddress
	 *            the ip address
	 * @return the ip summary
	 */
	private IpSummary createDefaultIpSummary(String status, String ipAddress) {
<span class="nc" id="L2428">		IpSummary ip = new IpSummary();</span>
<span class="nc" id="L2429">		ip.setIpAddress(ipAddress);</span>
<span class="nc" id="L2430">		ip.setStatus(status);</span>
<span class="nc" id="L2431">		return ip;</span>
	}

	/**
	 * Creates the default blacklist response.
	 *
	 * @param string
	 *            the string
	 * @return the blacklist contact response
	 */
	private BlacklistContactResponse createDefaultBlacklistResponse(String string) {
<span class="nc" id="L2442">		BlacklistContactResponse blacklist = new BlacklistContactResponse();</span>
<span class="nc" id="L2443">		blacklist.setStatus(string);</span>
<span class="nc" id="L2444">		blacklist.setData(null);</span>
<span class="nc" id="L2445">		return blacklist;</span>
	}

	/**
	 * Creates the default CFX contact response.
	 *
	 * @param countryName
	 *            the country name
	 * @param contactResponse
	 *            the contact response
	 * @return the contact response
	 */
	private ContactResponse createDefaultCFXContactResponse(String countryName, ContactResponse contactResponse) {
<span class="nc" id="L2458">		ContactResponse response = new ContactResponse();</span>
<span class="nc" id="L2459">		response.setBlacklist(createDefaultBlacklistResponse(contactResponse.getBlacklist().getStatus()));</span>
<span class="nc" id="L2460">		response.setGlobalCheck(createDefaultGlobalCheckResponse(ServiceStatus.NOT_REQUIRED, countryName));</span>
<span class="nc" id="L2461">		response.setCountryCheck(createDefaultCountryCheckResponse(ServiceStatus.NOT_REQUIRED, countryName));</span>
<span class="nc" id="L2462">		return response;</span>
	}

	/**
	 * Creates the default global check response.
	 *
	 * @param status
	 *            the status
	 * @param country
	 *            the country
	 * @return the global check contact response
	 */
	private GlobalCheckContactResponse createDefaultGlobalCheckResponse(ServiceStatus status, String country) {
<span class="nc" id="L2475">		GlobalCheckContactResponse globalCheck = new GlobalCheckContactResponse();</span>
<span class="nc" id="L2476">		globalCheck.setStatus(status.name());</span>
<span class="nc" id="L2477">		globalCheck.setCountry(country);</span>
<span class="nc" id="L2478">		return globalCheck;</span>
	}

	/**
	 * Creates the default country check response.
	 *
	 * @param status
	 *            the status
	 * @param country
	 *            the country
	 * @return the country check contact response
	 */
	private CountryCheckContactResponse createDefaultCountryCheckResponse(ServiceStatus status, String country) {
<span class="nc" id="L2491">		CountryCheckContactResponse countryCheck = new CountryCheckContactResponse();</span>
<span class="nc" id="L2492">		countryCheck.setStatus(status.name());</span>
<span class="nc" id="L2493">		countryCheck.setCountry(country);</span>
<span class="nc" id="L2494">		return countryCheck;</span>
	}

	/**
	 * Gets the address fields to send email 1.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @return the address fields to send email 1
	 */
	private static boolean getAddressFieldsToSendEmail1(String strFieldsModified) {
		boolean result;
<span class="nc bnc" id="L2506" title="All 4 branches missed.">		boolean address1 = strFieldsModified.contains(ADDRESS_TYPE) || strFieldsModified.contains(AREA_NUMBER)</span>
<span class="nc bnc" id="L2507" title="All 4 branches missed.">				|| strFieldsModified.contains(AZA) || strFieldsModified.contains(BUILDING_NAME)</span>
<span class="nc bnc" id="L2508" title="All 2 branches missed.">				|| strFieldsModified.contains(BUILDING_NUMBER);</span>

<span class="nc bnc" id="L2510" title="All 4 branches missed.">		boolean address2 = strFieldsModified.contains(CIVIC_NUMBER) || strFieldsModified.contains(COUNTRY)</span>
<span class="nc bnc" id="L2511" title="All 4 branches missed.">				|| strFieldsModified.contains(DISTRICT) || strFieldsModified.contains(FLOOR_NUMBER);</span>

<span class="nc" id="L2513">		result = getAddressFieldsToSendEmail2(strFieldsModified, address1, address2);</span>
<span class="nc" id="L2514">		return result;</span>

	}

	/**
	 * Gets the address fields to send email 2.
	 *
	 * @param strFieldsModified
	 *            the str fields modified
	 * @param address1
	 *            the address 1
	 * @param address2
	 *            the address 2
	 * @return the address fields to send email 2
	 */
	private static boolean getAddressFieldsToSendEmail2(String strFieldsModified, boolean address1, boolean address2) {

<span class="nc bnc" id="L2531" title="All 4 branches missed.">		boolean address3 = strFieldsModified.contains(POST_CODE) || strFieldsModified.contains(PREFECTURE)</span>
<span class="nc bnc" id="L2532" title="All 4 branches missed.">				|| strFieldsModified.contains(REGION_SUBURB) || strFieldsModified.contains(STATE_PROVINCE_COUNTY);</span>

<span class="nc bnc" id="L2534" title="All 4 branches missed.">		boolean address4 = strFieldsModified.contains(STREET) || strFieldsModified.contains(STREET_NUMBER)</span>
<span class="nc bnc" id="L2535" title="All 4 branches missed.">				|| strFieldsModified.contains(STREET_TYPE) || strFieldsModified.contains(SUB_BUILDINGOR_FLAT);</span>

<span class="nc bnc" id="L2537" title="All 4 branches missed.">		boolean address5 = strFieldsModified.contains(SUB_CITY) || strFieldsModified.contains(CITY)</span>
<span class="nc bnc" id="L2538" title="All 4 branches missed.">				|| strFieldsModified.contains(UNIT_NUMBER) || strFieldsModified.contains(YEARS_IN_ADDRESS);</span>

<span class="nc bnc" id="L2540" title="All 4 branches missed.">		boolean isaddressChanged1 = address1 || address2;</span>
<span class="nc bnc" id="L2541" title="All 4 branches missed.">		boolean isaddressChanged2 = address3 || address4;</span>

<span class="nc bnc" id="L2543" title="All 6 branches missed.">		return (isaddressChanged1 || isaddressChanged2 || address5);</span>
	}
	
	/**
	 * Gets the other changed fields except address.
	 *
	 * @param strFieldsModified the str fields modified
	 * @return the other changed fields except address
	 */
	private boolean getChangedFieldsExceptAddress(String strFieldsModified) {
<span class="nc" id="L2553">		boolean result = false;</span>
<span class="nc" id="L2554">		result = isNameChanged(strFieldsModified, result);</span>
<span class="nc bnc" id="L2555" title="All 6 branches missed.">		if (result || strFieldsModified.contains(DOB) || strFieldsModified.contains(GENDER))</span>
<span class="nc" id="L2556">			result = true;</span>
		
<span class="nc" id="L2558">		return result;</span>
	}
	
	/**
	 * AT-1725 requirement
	 * Not to update TITAN ID of Account and Contact
	 */
	private void setFieldsNotToUpdate(RegistrationServiceRequest request, Account oldAccount, List&lt;Contact&gt; oldContacts, Message&lt;MessageContext&gt; message) {
		//AT-4474
<span class="nc bnc" id="L2567" title="All 4 branches missed.">		if((&quot;CD SA&quot;).equalsIgnoreCase(request.getOrgCode()) &amp;&amp; !request.getAccount().getTradeAccountNumber().equals(oldAccount.getTradeAccountNumber())) {</span>
<span class="nc" id="L2568">				setValuesForCDSAMigratedCustomer(request, oldAccount, oldContacts, message);</span>
		}
		else {
<span class="nc" id="L2571">			request.getAccount().setTradeAccountID(oldAccount.getTradeAccountID());</span>
<span class="nc" id="L2572">			request.getAccount().setTradeAccountNumber(oldAccount.getTradeAccountNumber());</span>
<span class="nc bnc" id="L2573" title="All 2 branches missed.">			for(Contact contact : request.getAccount().getContacts()) {</span>
<span class="nc" id="L2574">				Contact oldContact = getContactBySFId(contact.getContactSFID(), oldContacts);</span>
<span class="nc bnc" id="L2575" title="All 2 branches missed.">				if(null != oldContact)</span>
<span class="nc" id="L2576">					contact.setTradeContactID(oldContact.getTradeContactID());</span>
<span class="nc" id="L2577">			}</span>
		}
<span class="nc" id="L2579">	}</span>

	/**
	 * @param request
	 * @param oldAccount
	 * @param oldContacts
	 * @param message
	 */
	private void setValuesForCDSAMigratedCustomer(RegistrationServiceRequest request, Account oldAccount,
			List&lt;Contact&gt; oldContacts, Message&lt;MessageContext&gt; message) {
<span class="nc" id="L2589">		request.getAccount().setLegacyTradeAccountNumber(oldAccount.getTradeAccountNumber());</span>
<span class="nc" id="L2590">		request.getAccount().setLegacyTradeAccountID(oldAccount.getTradeAccountID());</span>
<span class="nc bnc" id="L2591" title="All 2 branches missed.">		for(Contact contact : request.getAccount().getContacts()) {</span>
<span class="nc" id="L2592">			Contact oldContact = getContactBySFId(contact.getContactSFID(), oldContacts);</span>
<span class="nc bnc" id="L2593" title="All 2 branches missed.">			if(null != oldContact)</span>
<span class="nc" id="L2594">				contact.setLegacyTradeContactID(oldContact.getTradeContactID());</span>
<span class="nc" id="L2595">		}</span>
<span class="nc bnc" id="L2596" title="All 2 branches missed.">		if((&quot;migrate_customer&quot;).equalsIgnoreCase(request.getEvent())) {</span>
<span class="nc" id="L2597">			UserProfile token = (UserProfile) message.getHeaders().get(MessageContextHeaders.GATEWAY_USER);</span>
			Integer userID;
			try {
<span class="nc" id="L2600">				userID = newRegistrationDBServiceImpl.getUserIDFromSSOUserID(&quot;cd.comp.migration&quot;);</span>
<span class="nc" id="L2601">				token.setUserID(userID);</span>
<span class="nc" id="L2602">			} catch (ComplianceException e) {</span>
<span class="nc" id="L2603">				LOGGER.error(&quot;Exception in setValuesForCDSAMigratedCustomer()&quot;, e);</span>
<span class="nc" id="L2604">			}</span>
		}
<span class="nc" id="L2606">	}</span>
	
	//AT-3241 Amend FraudPredict re-trigger process to include only email, mobile and landline changes
	private static boolean isFraudPredictEligible(String strFieldsModified) {
<span class="nc" id="L2610">		boolean result = false;</span>
<span class="nc bnc" id="L2611" title="All 6 branches missed.">		if (strFieldsModified.contains(&quot;email,&quot;) || strFieldsModified.contains(&quot;phoneMobile,&quot;) || strFieldsModified.contains(&quot;phoneHome,&quot;))</span>
<span class="nc" id="L2612">			result = true;</span>
<span class="nc" id="L2613">		return result;</span>
	}
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>