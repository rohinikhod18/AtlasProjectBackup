<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SanctionCsvRetryHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">compliance-service</a> &gt; <a href="index.source.html" class="el_package">com.currenciesdirect.gtg.compliance.compliancesrv.core.sanctioncsv</a> &gt; <span class="el_source">SanctionCsvRetryHandler.java</span></div><h1>SanctionCsvRetryHandler.java</h1><pre class="source lang-java linenums">package com.currenciesdirect.gtg.compliance.compliancesrv.core.sanctioncsv;

import java.io.IOException;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import com.jcraft.jsch.*;

@Component
<span class="nc" id="L12">public class SanctionCsvRetryHandler {</span>
	
<span class="nc" id="L14">	private static final Logger LOG = LoggerFactory.getLogger(SanctionCsvRetryHandler.class);</span>
	
	/** The Constant SANCTIONCSV_UPLOAD_IP. */
<span class="nc" id="L17">	private static final String SANCTIONCSV_UPLOAD_IP = System.getProperty(&quot;sanction.csv.server.ip&quot;);</span>
	
	/** The Constant SANCTIONCSV_UPLOAD_USERNAME. */
<span class="nc" id="L20">	private static final String SANCTIONCSV_UPLOAD_USERNAME = System.getProperty(&quot;sanction.csv.server.username&quot;);</span>
	
	/** The Constant SANCTIONCSV_UPLOAD_PASSWORD. */
<span class="nc" id="L23">	private static final String SANCTIONCSV_UPLOAD_PASSWORD = System.getProperty(&quot;sanction.csv.server.password&quot;);</span>
	
	/** The Constant SANCTIONCSV_UPLOAD_DIRECTORY. */
<span class="nc" id="L26">	private static final String SANCTIONCSV_UPLOAD_DIRECTORY = System.getProperty(&quot;sanction.csv.server.directory&quot;);</span>
	
	/** The Constant SANCTIONCSV_LOCAL_FILE. */
<span class="nc" id="L29">	private static final String SANCTIONCSV_LOCAL_DIRECTORY = System.getProperty(&quot;sanction.csv.local.directory&quot;);</span>
	
<span class="nc" id="L31">	private int retryCount = 3;</span>
	
<span class="nc" id="L33">	private int retryCounter = 1;</span>
	
	/**
	 * Retry uploading csv.
	 *
	 * @throws IOException Signals that an I/O exception has occurred.
	 */
	public void retryUploadingCsv() throws IOException {
		
<span class="nc" id="L42">		LOG.warn(&quot;-------------------------- Retrying uploading file {} time -------------&quot;,retryCounter);</span>
		
<span class="nc" id="L44">		String fileName = &quot;Full_inactiveclnts_&quot; + new java.text.SimpleDateFormat(&quot;yyyyMMdd&quot;).format(new java.util.Date()) + &quot;.csv&quot;;</span>
<span class="nc" id="L45">		String localLocation = SANCTIONCSV_LOCAL_DIRECTORY.trim();</span>
<span class="nc" id="L46">		String localFilePath = localLocation+fileName;</span>
		
<span class="nc" id="L48">		LOG.warn(fileName);</span>
		
<span class="nc" id="L50">		ChannelSftp channelSftp = new ChannelSftp();</span>
		try {
<span class="nc" id="L52">			channelSftp = getSftpSession();</span>
<span class="nc" id="L53">			channelSftp.connect();</span>
<span class="nc" id="L54">			String remoteDirPath = SANCTIONCSV_UPLOAD_DIRECTORY + fileName;</span>
<span class="nc" id="L55">			LOG.warn(&quot;Remote Directory : {} &quot;,remoteDirPath);</span>
<span class="nc" id="L56">			channelSftp.put(localFilePath,remoteDirPath);</span>
			
<span class="nc" id="L58">			LOG.warn(&quot;-------------------------- Retrying uploading file {} time Completed -------------&quot;,retryCounter);</span>
<span class="nc" id="L59">		}catch(Exception e) {</span>
<span class="nc" id="L60">			LOG.error(&quot;Error in SanctionCsvRetryHandler in retryUploadingCsv method &quot;,e);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">			if(retryCounter &lt; retryCount) {</span>
<span class="nc" id="L62">				retryCounter++;</span>
<span class="nc" id="L63">				retryUploadingCsv();</span>
			}
		}
		finally {
<span class="nc" id="L67">			channelSftp.exit();</span>
<span class="nc" id="L68">			LOG.warn(&quot;-------------------------- Channel close -------------&quot;);</span>
		}
<span class="nc" id="L70">	}</span>
	
	/**
	 * Gets the sftp session.
	 *
	 * @return the sftp session
	 * @throws JSchException the j sch exception
	 */
	private ChannelSftp getSftpSession() throws JSchException {
<span class="nc" id="L79">		JSch jsch = new JSch();</span>
<span class="nc" id="L80">		String remoteHost = SANCTIONCSV_UPLOAD_IP;</span>
<span class="nc" id="L81">	    Session jschSession = jsch.getSession(SANCTIONCSV_UPLOAD_USERNAME, remoteHost, 22);</span>
<span class="nc" id="L82">	    jschSession.setPassword(SANCTIONCSV_UPLOAD_PASSWORD);</span>
<span class="nc" id="L83">	    java.util.Properties config = new java.util.Properties(); </span>
<span class="nc" id="L84">	    config.put(&quot;StrictHostKeyChecking&quot;, &quot;no&quot;);</span>
<span class="nc" id="L85">	    jschSession.setConfig(config);</span>
<span class="nc" id="L86">	    jschSession.connect();</span>
<span class="nc" id="L87">	    return (ChannelSftp) jschSession.openChannel(&quot;sftp&quot;);</span>
	}

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>